"use strict";var odataServerUrl=document.URL.indexOf("localhost/iops/")>0||document.URL.indexOf("localhost/iOPSPro-Development/")>0?"http://localhost/DataServices/ODataV4":"https://www.iopspro.com/DataServices/ODataV4",webRoot=document.URL.indexOf("localhost/iops/")>0?"/iops/":document.URL.indexOf("localhost/iOPSPro-Development")>0?"/iOPSPro-Development/Website/":"/",signalRServerUrl="https://www.iopspro.com/DataServices/SignalR/signalr",Global={User:{},webRoot:"/",SignalR:{}};angular.module("app",["ngResource","ngStorage","ngRoute","ui.router","angular-storage","ODataResources","indexedDB","vs-repeat","cfp.hotkeys","sf.virtualScroll","ui.bootstrap","ui.mask","gridster"]);angular.module("app").config(["$httpProvider","$compileProvider","$provide",function(n,t,i){t.debugInfoEnabled(!1);n.useApplyAsync(!0);i.constant("indexedDB",window.indexedDB);i.constant("_",window._);i.constant("Offline",window.Offline);n.interceptors.push("APIInterceptor");$.ajaxSetup({cache:!1});toastr.options={closeButton:!1,debug:!1,newestOnTop:!1,progressBar:!1,positionClass:"toast-top-right",preventDuplicates:!1,onclick:null,showDuration:"200",hideDuration:"1000",timeOut:"3000",extendedTimeOut:"1000",showEasing:"swing",hideEasing:"linear",showMethod:"fadeIn",hideMethod:"fadeOut"};Highcharts.setOptions({global:{useUTC:!1}})}]);angular.module("app").config(["$routeProvider","$urlRouterProvider","$stateProvider",function(n,t,i){i.state("home",{url:"/",views:{"@":{templateUrl:"app/stateContent/home/layout.html?seq="+Date.now(),controller:"AppCtrl as vm"},"headerPane@home":{templateUrl:"app/stateContent/home/header.html?seq="+Date.now(),controller:"HeaderCtrl as vm"},"loginPane@home":{templateUrl:"app/stateContent/login/login.html?seq="+Date.now(),controller:"LoginCtrl as vm"}}}).state("home.app",{views:{"menuPane@home":{templateUrl:"app/stateContent/home/menu.html?seq="+Date.now(),controller:"MenuCtrl as vm"},"contentPane@home":{templateUrl:"app/stateContent/home/blank.html?seq="+Date.now(),controller:"BlankCtrl as vm"}}}).state("home.app.blank",{views:{"contentPane@home":{templateUrl:"app/stateContent/home/blank.html?seq="+Date.now(),controller:"BlankCtrl as vm"}}}).state("home.app.dashboard",{params:{DashboardId:null},views:{"contentPane@home":{templateUrl:"app/widgetDirectives/dashboardDirectiveHolder.html?seq="+Date.now(),controller:"DashboardCtrl as vm"}}}).state("home.app.editDashboard",{params:{DashboardId:null},views:{"contentPane@home":{templateUrl:"app/stateContent/dashboards/editDashboard.html?seq="+Date.now(),controller:"EditDashboardCtrl as vm"}}}).state("home.app.dashboard.widgetSettings",{params:{widget:null},views:{"contentPane@home.app.dashboard":{templateUrl:"app/widgetDirectives/widgetSettings.html?seq="+Date.now(),controller:"WidgetSettingsCtrl as vm"}}}).state("home.app.dashboard.editDashboard",{params:{DashboardId:null},views:{"contentPane@home.app.dashboard":{templateUrl:"app/stateContent/dashboards/editDashboard.html?seq="+Date.now(),controller:"EditDashboardCtrl as vm"}}}).state("home.app.dashboard.pcaSummaryModal",{params:{widget:null,assetId:null,dashboard:null},views:{"contentPane@home.app.dashboard":{templateUrl:"app/widgetDirectives/pcaSummaryModal.html",controller:"PCASummaryModalCtrl as vm"}}}).state("home.app.dashboard.gpuSummaryModal",{params:{widget:null,assetId:null,dashboard:null},views:{"contentPane@home.app.dashboard":{templateUrl:"app/widgetDirectives/gpuSummaryModal.html",controller:"GPUSummaryModalCtrl as vm"}}}).state("home.app.dashboard.pbbSummaryModal",{params:{widget:null,assetId:null,dashboard:null},views:{"contentPane@home.app.dashboard":{templateUrl:"app/widgetDirectives/pbbSummaryModal.html",controller:"PBBSummaryModalCtrl as vm"}}}).state("home.app.dashboard.editWidget",{params:{WidgetId:null},views:{"contentPane@home.app.dashboard":{templateUrl:"app/stateContent/dashboards/editWidget.html?seq="+Date.now(),controller:"EditWidgetCtrl as vm"}}}).state("home.app.dashboard.addWidget",{params:{DashboardId:null},views:{"contentPane@home.app.dashboard":{templateUrl:"app/stateContent/dashboards/addWidget.html?seq="+Date.now(),controller:"AddWidgetCtrl as vm"}}}).state("home.app.users",{views:{"contentPane@home":{templateUrl:"app/stateContent/admin/security/users.html?seq="+Date.now(),controller:"UsersCtrl as vm"}}}).state("home.app.users.edit",{params:{UserId:null},views:{"contentPane@home.app.users":{templateUrl:"app/stateContent/admin/security/userEdit.html?seq="+Date.now(),controller:"UserEditCtrl as vm"}}}).state("home.app.companies",{views:{"contentPane@home":{templateUrl:"app/stateContent/admin/systemTables/companies.html?seq="+Date.now(),controller:"CompaniesCtrl as vm"}}}).state("home.app.companies.edit",{params:{CompanyId:null},views:{"contentPane@home.app.companies":{templateUrl:"app/stateContent/admin/systemTables/companyEdit.html?seq="+Date.now(),controller:"CompanyEditCtrl as vm"}}}).state("home.app.sites",{views:{"contentPane@home":{templateUrl:"app/stateContent/admin/sites.html?seq="+Date.now(),controller:"SitesCtrl as vm"}}}).state("home.app.widgetTypes",{params:{Path:null},views:{"contentPane@home":{templateUrl:"app/stateContent/admin/systemTables/widgets/widgetTypes.html?seq="+Date.now(),controller:"WidgetTypesCtrl as vm"}}}).state("home.app.widgetTypes.edit",{params:{WidgetTypeId:null},views:{"contentPane@home.app.widgetTypes":{templateUrl:"app/stateContent/admin/systemTables/widgets/widgetTypeEdit.html?seq="+Date.now(),controller:"WidgetTypeEditCtrl as vm"}}}).state("home.app.people",{views:{"contentPane@home":{templateUrl:"app/stateContent/admin/systemTables/people.html?seq="+Date.now(),controller:"PeopleCtrl as vm"}}}).state("home.app.people.edit",{params:{PersonId:null},views:{"contentPane@home.app.people":{templateUrl:"app/stateContent/admin/systemTables/personEdit.html?seq="+Date.now(),controller:"PersonEditCtrl as vm"}}}).state("home.app.sites.assets",{params:{SiteId:null},views:{"contentPane@home.app.sites":{templateUrl:"app/stateContent/admin/systemTables/assets.html?seq="+Date.now(),controller:"AssetsCtrl as vm"}}}).state("home.app.assets",{views:{"contentPane@home":{templateUrl:"app/stateContent/admin/systemTables/assets.html?seq="+Date.now(),controller:"AssetsCtrl as vm"}}}).state("home.app.assetModels",{views:{"contentPane@home":{templateUrl:"app/stateContent/admin/systemTables/assetModels.html?seq="+Date.now(),controller:"AssetModelsCtrl as vm"}}}).state("home.app.assetModels.edit",{params:{AssetModelId:null},views:{"contentPane@home.app.assetModels":{templateUrl:"app/stateContent/admin/systemTables/assetModelEdit.html?seq="+Date.now(),controller:"AssetModelEditCtrl as vm"}}}).state("home.app.assets.standardObservations",{params:{AssetId:null},views:{"contentPane@home.app.assets":{templateUrl:"app/stateContent/admin/systemTables/standardObservations.html?seq="+Date.now(),controller:"StandardObservationsCtrl as vm"}}}).state("home.app.tags",{views:{"contentPane@home":{templateUrl:"app/stateContent/admin/systemTables/tags.html?seq="+Date.now(),controller:"TagsCtrl as vm"}}}).state("home.app.liveTagDataMonitor",{views:{"contentPane@home":{templateUrl:"app/stateContent/admin/dataMonitors/liveTagDataMonitor.html?seq="+Date.now(),controller:"LiveTagDataMonitorCtrl as vm"}}}).state("home.app.liveAssetMonitor",{views:{"contentPane@home":{templateUrl:"app/stateContent/admin/dataMonitors/liveAssetMonitor.html?seq="+Date.now(),controller:"LiveAssetMonitorCtrl as vm"}}}).state("home.app.liveTagDataMonitorPanels",{params:{NoDropOff:!0},views:{"contentPane@home":{templateUrl:"app/stateContent/admin/dataMonitors/liveTagDataMonitorPanels.html?seq="+Date.now(),controller:"LiveTagDataMonitorPanelsCtrl as vm"}}}).state("home.app.liveObservationIndicatorTableCells",{params:{NoDropOff:!0},views:{"contentPane@home":{templateUrl:"app/stateContent/admin/dataMonitors/liveObservationIndicatorTableCells.html?seq="+Date.now(),controller:"LiveObservationIndicatorTableCellsCtrl as vm"}}}).state("home.app.liveObservationIndicatorTableCells.editDashboard",{params:{DashboardId:null},views:{"contentPane@home.app.liveObservationIndicatorTableCells":{templateUrl:"app/stateContent/home/editDashboard.html?seq="+Date.now(),controller:"EditDashboardCtrl as vm"}}}).state("home.app.bhsAlarms",{params:{NoDropOff:!0},views:{"contentPane@home":{templateUrl:"app/stateContent/admin/bna/bnaMonitorDisplay.html?seq="+Date.now(),controller:"BNAMonitorDisplayCtrl as vm"}}}).state("home.app.gateMonitorForSite",{params:{SiteId:null},views:{"contentPane@home":{templateUrl:"app/stateContent/admin/dataMonitors/liveAssetMonitor.html?seq="+Date.now(),controller:"LiveAssetMonitorCtrl as vm"}}});t.otherwise("/")}]),function(){function n(n,t){var i={},r=Date.now();return i.ODataAccessToken=null,i.request=function(n){if(!i.ODataAccessToken||i.ODataAccessToken=="not-authorized"){var u=t.get("currentUser");i.ODataAccessToken=u?u.ODataAccessToken:"not-authorized"}return i.ODataAccessToken&&(n.headers.authorization=i.ODataAccessToken),n.url.indexOf("odataprod")>3&&(r=Date.now()),n},i.responseError=function(n){return n.status===401,n},i}angular.module("app").factory("APIInterceptor",["$rootScope","store","utilityService",n])}(),function(){function n(n,t,i,r,u,f,e,o){function nt(){e.getDBInstance("iOPS",45,[{dataStoreName:"Companies",keyName:"Id"},{dataStoreName:"Systems",keyName:"Id"},{dataStoreName:"Assets",keyName:"Id"},{dataStoreName:"Tags",keyName:"Id"},{dataStoreName:"TagChartDays",keyName:"TagId",indices:[{name:"TagDay",fieldName:""}]},{dataStoreName:"JBTStandardObservations",keyName:"Id"},{dataStoreName:"Units",keyName:"Id"},{dataStoreName:"BHSJamAlarms",keyName:"Id"},{dataStoreName:"AssetGraphics",keyName:"Id"},{dataStoreName:"AssetGraphicVisibleValues",keyName:"Id"},{dataStoreName:"Observations",keyName:"Id",indices:[{name:"TagDateRange",fieldName:"Testing"}]}]).then(function(r){y=r;i.all([it().then(function(n){s.sites=n.select(function(n){return c(n)});console.log("Sites Loaded ="+n.length)}),rt().then(function(n){s.siteCompany=n.select(function(n){return c(n)});console.log("SiteCompany Loaded = "+n.length)}),ut().then(function(n){s.companies=n.select(function(n){return c(n)});console.log("Companies Loaded = "+n.length)}),n.GetCollection("iOPS","WidgetTypes").then(function(n){s.widgetTypes=n}),ct().then(function(n){return f(function(){s.units=n.select(function(n){return c(n)});console.log("Units Loaded = "+n.length)},10)}),ft().then(function(n){s.systems=n.select(function(n){return n.Type=n.SystemType.Name,c(n)});console.log("Systems Loaded = %O",n)}),et().then(function(n){s.assets=n.select(function(n){return c(n)});console.log("Assets Loaded = "+n.length)}),ot().then(function(n){s.assetGraphics=n;console.log("AssetGraphics Loaded = "+n.length)}),st().then(function(n){s.assetGraphicVisibleValues=n;console.log("AssetGraphicVisibleValues Loaded = "+n.length)}),h.GetIOPSCollection("SystemTypes").then(function(n){s.systemTypes=n}),h.GetIOPSCollection("AssetTypes").then(function(n){s.assetTypes=n}),lt().then(function(n){s.tags=n.select(function(n){return c(n)});console.log("Tags Loaded = "+n.length)}),ht().then(function(n){s.jbtStandardObservations=n.select(function(n){return c(n)});console.log("JBTStandardObservations Loaded = "+n.length)})]).then(function(){console.log("Basic Collections Loaded");console.log("Stitch the Comprehensive Object Graph together ");o.JoinGroup("All");var n=performance.now();l={Companies:s.companies.select(function(n){return n.Sites=s.siteCompany.where(function(t){return t.CompanyId==n.Id}).selectMany(function(n){return s.sites.where(function(t){return t.Id==n.SiteId})}),n.Assets=s.assets.where(function(t){return t.CompanyId==n.Id}).select(function(t){return t.Company=n,t}),n.Systems=s.systems.where(function(t){return t.CompanyId==n.Id}).select(function(t){return t.Company=n,t}),n}),SystemTypes:s.systemTypes,AssetTypes:s.assetTypes.where(function(n){return n.IsValidForWidgets}),WidgetTypes:s.widgetTypes,Sites:s.sites.select(function(n){return n.Companies=s.siteCompany.where(function(t){return t.SiteId==n.Id}).selectMany(function(n){return s.companies.where(function(t){return t.Id==n.CompanyId})}),n.Assets=s.assets.where(function(t){return t.SiteId==n.Id}).select(function(t){return t.Site=n,t}),n.Systems=s.systems.where(function(t){return t.SiteId==n.Id}).select(function(t){return t.Site=n,t}),n}),Systems:s.systems.select(function(n){return n.Systems=s.systems.where(function(t){return t.ParentSystemId==n.Id}).select(function(t){return t.ParentSystem=n,t}),n.Assets=s.assets.where(function(t){return t.ParentSystemId==n.Id}),n}),Assets:s.assets.select(function(n){return n.Tags=s.tags.where(function(t){return t.AssetId==n.Id}).select(function(t){return t.Asset=n,t}),n.ParentSystem=s.systems.first(function(t){return t.Id==n.ParentSystemId}),n}),Tags:s.tags.select(function(n){return n.JBTStandardObservation=s.jbtStandardObservations.first(function(t){return t.Id==n.JBTStandardObservationId}),n.LastObservationDate&&(n.LastObservationDate=u.GetNonUTCQueryDate(n.LastObservationDate),n.LastModifiedDate=u.GetNonUTCQueryDate(n.LastModifiedDate)),n}),JBTStandardObservations:s.jbtStandardObservations.select(function(n){n.Tags=s.tags.where(function(t){return t.JBTStandardObservationId==n.Id});n.Unit=s.units.first(function(t){return t.Id==n.UnitId})})};console.log("Complete Object Graph = %O - "+(performance.now()-n),l);console.log("Cache Fully Loaded. Broadcasting service ready.");s.ready=!0;h.ready=!0;t.$broadcast("dataService.ready")})})}function tt(){t.$broadcast("DataService Ready")}function it(){return n.GetCollection("iOPS","Sites")}function rt(){return n.GetCollection("iOPS","SiteCompanies")}function ut(){return n.GetCollection("iOPS","Companies")}function ft(){var i,t;return y.getById("Systems",1).then(function(r){return i=r?r.Systems:[],t=i.length>0?i.max(function(n){return n.DateLastModified}):new Date("1/1/2017"),t=new Date(t),t=t.setDate(t.getDate()-.001),t=u.GetUTCQueryDate(t),n.GetResource("iOPS","SystemGroups").odata().filter("DateLastModified",">",t).expand("SystemType").query().$promise.then(function(n){console.log("odata Systems ="+n.length);var t=n.concat(i).distinct(function(n,t){return n.Id==t.Id});return console.log("combined Systems = "+t.length),t.select(function(n){n.DateLastModified=u.GetNonUTCQueryDate(n.DateLastModified)}),y.upsert("Systems",{Id:1,Systems:t}),t})})}function et(){return p("Assets")}function ot(){return p("AssetGraphics")}function st(){return p("AssetGraphicVisibleValues")}function ht(){return p("JBTStandardObservations")}function ct(){return p("Units")}function p(t){var r,i,f=performance.now();return console.log("Getting localdb "+t+"..."),y.getById(t,1).then(function(e){return e||console.log("dbData for collection of "+t+" not present"),console.log("dbData returned from indexedDB for "+t+" = %O",e),r=e?e.data:[],r||console.log("dbCollection for collection of "+t+" not present"),console.log("localdb "+t+" = "+r.length+" - "+(performance.now()-f)+"ms"),i=r.length>0?r.max(function(n){return n.LastModifiedDate}):new Date("1/1/2017"),i=new Date(i),console.log(t+" maxDate = %O",i),i=u.GetUTCQueryDate(i),console.log("OData Query Date for "+t+" maxdate = %O",i),n.GetResource("iOPS",t).odata().filter("LastModifiedDate",">",i).query().$promise.then(function(n){console.log("odata "+t+" = "+n.length);var i=n.concat(r).distinct(function(n,t){return n.Id==t.Id});return console.log("combined "+t+" = "+i.length),y.upsert(t,{Id:1,data:i}),i})})}function lt(){return i.when([])}function at(n){var t=k(n)}function k(n){var t={};return n=n.substring(n.indexOf(",")+1),n.split("~").select(function(n){var i=n.split("!");t[i[0]]=i[1]}),t}function d(n){var i=s.sites.first(function(t){return t.Id==n.SiteId}),r=h.dataSourceIsLocal?new Date(n.LastObservationDate):u.GetUTCDateFromLocalDate(new Date(n.LastObservationDate)),f=h.dataSourceIsLocal?new Date(n.LastObservationCreationDate):u.GetUTCDateFromLocalDate(new Date(n.LastObservationCreationDate)),t={DataType:"DB",PLCUTCDate:r,ObservationUTCDate:f,IsAlarm:n.IsAlarm,IsWarning:n.IsWarning,AssetId:+n.AssetId,TagId:+n.Id,SiteId:+n.SiteId,ObservationId:+n.LastObservationId,JBTStandardObservationId:+n.JBTStandardObservationId,SiteName:i?i.Name:null,TagName:n.Name||n.TagName,Value:n.LastObservationTextValue,Quality:n.LastObservationQuality,JBTStandardObservation:s.jbtStandardObservations.first(function(t){return t.Id==n.JBTStandardObservationId}),Severity:n.IsCritical?"Critical":n.IsAlarm?"Alarm":n.IsWarning?"Warning":"",ValueWhenActive:n.ValueWhenActive||"1"};return t.PLCUTCDateMS=t.PLCUTCDate.getTime(),t.PLCLocalDate=u.GetLocalDateFromUTCDate(t.PLCUTCDate),t.ObservationUTCDateMS=t.ObservationUTCDate.getTime(),t.ObservationLocalDate=u.GetLocalDateFromUTCDate(t.ObservationUTCDate),b(t),t}function pt(n){var t=performance.now();h.Statistics.SignalR.MessageCount++;n=k(n);n.DataType="signalR";n.PLCUTCDate=new Date(n.PLCUTCDate);n.PLCUTCDateMS=n.PLCUTCDate.getTime();n.PLCLocalDate=u.GetLocalDateFromUTCDate(n.PLCUTCDate);n.ObservationUTCDate=new Date(n.ObservationCreationUTCDate);n.ObservationUTCDateMS=n.ObservationUTCDate.getTime();n.ObservationLocalDate=u.GetLocalDateFromUTCDate(n.ObservationUTCDate);n.AssetId=+n.AssetId;n.TagId=+n.TagId;n.SiteId=+n.SiteId;n.ObservationId=+n.ObservationId;n.JBTStandardObservationId=+n.JBTStandardObservationId;n.JBTStandardObservation=s.jbtStandardObservations.first(function(t){return t.Id==n.JBTStandardObservationId});n.IsWarning=n.IsWarning=="1";n.IsAlarm=n.IsAlarm=="1";n.IsCritical=n.IsCritical=="1";n.ValueWhenActive=n.ValueWhenActive||"1";n.Severity=n.IsCritical?"Critical":n.IsAlarm?"Alarm":n.IsWarning?"Warning":"";b(n);w(n)}function b(n){if(n.TagName){var t=n.TagName.split("|");n.ShortTagName=t.length>4?t.last().replace(".PCA.","").replace(".GPU.","").replace(".PBB.",""):n.TagName.replace("Airport_","")}}function g(n,t){if(n&&n.Metadata&&n.Metadata.Statistics){if(n.Metadata.Statistics.ChangeCount++,n.Metadata.Statistics.MessageCount++,n.ObservationUTCDate){var r=s.sites.first(function(t){return t.Id==n.SiteId}),i=r?r.KepwareSQLTimeDifferenceMSFromCentral:0;n.Metadata.Statistics.KepwareSQLTimeDifferenceMSFromCentral=i;n.DataType=="DB"?(n.Metadata.Statistics.MainDatabaseToBrowserTimeMS=null,n.Metadata.Statistics.KepwareToBrowserTimeMS=null,n.Metadata.Statistics.KepwareToMainDatabaseTimeMS=null):(n.Metadata.Statistics.KepwareToMainDatabaseTimeMS=n.ObservationUTCDateMS-n.PLCUTCDateMS-i,n.Metadata.Statistics.KepwareToMainDatabaseTimeMS>1e4&&(n.Metadata.Statistics.KepwareToMainDatabaseTimeMS=null),n.Metadata.Statistics.MainDatabaseToBrowserTimeMS=u.GetUTCDateFromLocalDate(new Date).getTime()-n.ObservationUTCDateMS,n.Metadata.Statistics.KepwareToBrowserTimeMS=u.GetUTCDateFromLocalDate(new Date).getTime()-n.PLCUTCDateMS-i)}n.Metadata.UpdateCountDowns.OneSecond=n.Metadata.UpdateCountDowns.TenSecond=n.Metadata.UpdateCountDowns.ThirtySecond=n.Metadata.UpdateCountDowns.OneMinute=n.Metadata.UpdateCountDowns.FiveMinute=n.Metadata.UpdateCountDowns.FifteenMinute=n.Metadata.UpdateCountDowns.ThirtyMinute=n.Metadata.UpdateCountDowns.OneHour=1e4;t&&(v.tagsWithOneSecondCountdowns.find(function(t){return t.TagId==n.TagId})||v.tagsWithOneSecondCountdowns.push(n))}}function w(n,i){var r,u,f;return n.IsTest,(n.TagId||n.TagName)&&(i?r=null:(n.TagId&&(i||(r=s.tags.first(function(t){return t.TagId==n.TagId}))),!a&&n.TagName&&(i||(r=s.tags.first(function(t){return t.TagName==n.TagName})))),r?(r.DataType=="DB"&&n.DataType=="signalR"&&(r.DataType="signalR"),r.Observations||(r.Observations=[]),r.Asset||(r.Asset=s.assets.first(function(n){return n.Id==r.AssetId}),r.Asset&&(r.Asset.Tags||(r.Asset.Tags=[]),r.Asset.Tags.push(a))),r.LastObservationTextValue=n.Value,g(r),r.Asset,r.PLCUTCDateMS<=n.PLCUTCDateMS&&r.ObservationId!=n.ObservationId?(r.PLCUTCDate=n.PLCUTCDate,r.PLCUTCDateMS=n.PLCUTCDateMS,r.PLCLocalDate=n.PLCLocalDate,r.ObservationUTCDate=n.ObservationUTCDate,r.ObservationUTCDateMS=n.ObservationUTCDateMS,r.ObservationLocalDate=n.ObservationLocalDate,r.PreviousObservationId=r.ObservationId,r.ObservationId=+n.ObservationId,r.Metadata.Status.LastValueWasHistorical=!1,r.Value=n.Value,r.ValueWhenActive=n.ValueWhenActive||"1"):r.DataType=="signalR"&&r.ObservationId!=n.ObservationId&&(r.Metadata.Status.LastValueWasHistorical=!0),r.JBTStandardObservation=s.jbtStandardObservations.first(function(n){return n.Id==r.JBTStandardObservationId})):(n.IsTest,c(n),i||(u=s.assets.first(function(t){return t.Id==+n.AssetId}),u&&(u.Tags||(u.Tags=[]),u.Tags.unshift(n),u.Tags=u.Tags.distinct(function(n,t){return n.TagId==t.TagId}),n.Asset=u)),f=!0,i||(g(n,f),n.Asset),s.tags.unshift(n),a=n)),isFinite(n.Value)||n.Value.indexOf("oken:")==1||n.Value.indexOf("rue")==1||n.Value.indexOf("alse")==1||Global.User.Username=="jim",a.DataType=="signalR"&&t.$broadcast("dataService.TagUpdate",a),a}function c(n){return n.Metadata={UpdateCountDowns:{OneSecond:0,TenSecond:0,ThirtySecond:0,OneMinute:0,FiveMinute:0,FifteenMinute:0,ThirtyMinute:0,OneHour:0},Statistics:{ChangeCount:0,MessageCount:0,PreviousMessageCount:0,MessagesPerSecond:0,IsLastUpdateHistorical:!1,KepwareToMainDatabaseTimeMS:0,MainDatabaseToBrowserTimeMS:0,KepwareToBrowserTimeMS:0,KepwareSQLTimeDifferenceMSFromCentral:0},Status:{LastValueWasHistorical:!1}},n}var h={},s={companies:[],sites:[],systems:[],systemTypes:[],assets:[],assetTypes:[],tags:[],assetGraphics:[],assetGraphicVisibleValues:[],widgetTypes:[],jbtStandardObservations:[],bhsJamAlarms:[],ready:!1},v={tagsWithOneSecondCountdowns:[]},l={},y,vt,yt,a;return h.ready=!1,h.cache=s,h.Statistics={SignalR:{MessageCount:0,PreviousMessageCount:0,MessagesPerSecond:0,MessagesPerSecondHistory:[]}},t.$on("AssetModel",function(n,t){s.assetModels=[t].concat(s.assetModels).distinct(function(n,t){return n.Id==t.Id});t.Assets=s.assets.where(function(n){return n.AssetModelId==t.Id})}),r(function(){t.$broadcast("System.ClockTick15")},15e3),r(function(){t.$broadcast("System.ClockTick60")},6e4),r(function(){t.$broadcast("System.ClockTick120")},12e4),h.GetAuthorizableActivities=function(){return n.GetCollection("iOPS","AuthorizableActivities")},h.DeleteEntities=function(n){return i.all(n.select(function(n){return n.Id=-n.Id,n.$save()}))},h.GetDashboardTimeScopes=function(){return s.dashboardTimeScopes?i.when(s.dashboardTimeScopes):h.GetIOPSCollection("DashboardTimeScopes").then(function(n){return s.dashboardTimeScopes=n,n})},h.GetIOPSResource=function(t){return n.GetResource("iOPS",t).odata()},h.GetExpandedDashboardById=function(n){return h.GetIOPSResource("Dashboards").expand("DashboardTimeScope").get(n).$promise.then(function(n){return h.SetDashboardDerivedDatesFromDayCount(n),n})},h.SetDashboardDerivedDatesFromDayCount=function(n){if(n&&n.CustomStartDate&&n.CustomEndDate)n.derivedStartDate=n.CustomStartDate,n.derivedEndDate=n.CustomEndDate,n.webApiParameterStartDate=u.GetUTCQueryDate(n.CustomBeginDate),n.webApiParameterEndDate=u.GetUTCQueryDate(n.CustomEndDate),n.oDataFilterStartDate=u.GetUTCQueryDate(n.derivedStartDate),n.oDataFilterEndDate=u.GetUTCQueryDate(n.derivedEndDate);else{var t=new Date;switch(n.DashboardTimeScope.Days){case-1:t.setHours(0,0,0,0);n.derivedEndDate=t;n.derivedStartDate=new Date(new Date((new Date).setDate(t.getDate()-1)).setHours(0,0,0,0));break;case 0:t.setHours(0,0,0,0);n.derivedStartDate=t;n.derivedEndDate=new Date("1/1/2500");break;default:n.derivedStartDate=new Date((new Date).setDate((new Date).getDate()-n.DashboardTimeScope.Days));n.derivedEndDate=new Date("1/1/2500")}}return n.webApiParameterStartDate=u.GetUTCQueryDate(n.derivedStartDate),n.webApiParameterEndDate=u.GetUTCQueryDate(n.derivedEndDate),n.oDataFilterStartDate=u.GetUTCQueryDate(n.derivedStartDate),n.oDataFilterEndDate=u.GetUTCQueryDate(n.derivedEndDate),n},h.GetIOPSWebAPIResource=function(t){return n.GetIOPSWebAPIResource(t)},h.DeleteEntity=function(t,i){return n.DeleteEntity("iOPS",t,i)},h.GetEntityById=function(t,i){return n.GetEntityById("iOPS",t,i)},h.AddEntity=function(t,i){return n.InsertEntity("iOPS",t,i)},h.UpdateEntity=function(t,i){return n.UpdateEntity("iOPS",t,i)},h.GetIOPSCollection=function(t,i,r){return n.GetCollection("iOPS",t,i,r)},h.GetUser=function(n){return h.GetIOPSResource("iOPSUsers").expand("Person").expandPredicate("UserAuthorizedActivities").expand("AuthorizableActivity").finish().expandPredicate("SiteDataReaders").expand("Site").finish().get(n).$promise},h.GetStateAbbreviations=function(){return n.GetCollection("iOPS","StateAbbreviations")},h.AddUser=function(t){return n.InsertEntity("iOPS","iOPSUsers",t).$promise},h.GetMyDashboards=function(){return n.GetCollection("iOPS","Dashboards","CreatorUserId",Global.User.Id)},h.GetLastXBagTagScans=function(t){return n.GetResource("iOPS","BagTagScans").odata().orderByDescending("Timestamp").take(t).query().$promise},h.GetLastXBHSAlarms=function(t){return n.GetResource("iOPS","BHSAlarms").odata().orderBy("AlarmDateTime","desc").take(t).query().$promise},t.$on("securityService:authenticated",function(){f(function(){nt();s.ready=!0;h.ready=!0},500)}),h.IsReady=function(){return s.ready},h.GetCache=function(){return s},t.$on("Company",function(n,t){var i=l.Companies.first(function(n){return n.Id==t.Id});i&&(i.Name=t.Name,i.ShortName=t.ShortName,i.Description=t.Description,i.Address=t.Address)}),t.$on("Company.Deleted",function(n,t){var i=l.Companies.first(function(n){return n.Id==t.Id});i&&(l.Companies=l.Companies.where(function(n){return n.Id!=t.Id}))}),h.GetUsers=function(){return n.GetResource("iOPS","iOPSUsers").odata().expandPredicate("Person").expandPredicate("CompanyContacts").expand("Company").finish().finish().expandPredicate("SiteDataReaders").expand("Site").finish().expandPredicate("UserAuthorizedActivities").expand("AuthorizableActivity").finish().query().$promise.then(function(n){return n.orderBy(function(n){return n.Person.FamilyName})})},h.GetCompanies=function(){return i.when(s.companies)},h.GetSites=function(){return i.when(s.sites)},h.GetSystems=function(){return i.when(s.systems)},h.GetAssets=function(){return i.when(s.assets)},h.GetTags=function(){return i.when(s.tags)},h.GetJBTData=function(){return i.when(l)},t.$on("System.signalR Connected",function(){o.JoinGroup("All");tt()}),t.$on("System.signalR Disconnected",function(){h.dataServerConnected=!1}),t.$on("Observation",function(n,t){pt(t)}),t.$on("Tag",function(n,t){at(t)}),h.GetJsonFromSignalR=function(n){return k(n)},vt=performance.now(),h.PlaceTerminalGraphicsTagsIntoInventory=function(n){n.forEach(function(n){var i=s.sites.first(function(t){return t.Id==n.SiteId}),t={DataType:"DB",PLCUTCDate:h.dataSourceIsLocal?new Date(n.LastObservationDate):u.GetUTCDateFromLocalDate(new Date(n.LastObservationDate)),ObservationUTCDate:h.dataSourceIsLocal?new Date(n.LastObservationDate):u.GetUTCDateFromLocalDate(new Date(n.LastObservationDate)),AssetId:+n.AssetId,TagId:+n.TagId,SiteId:+n.SiteId,ObservationId:+n.LastObservationId,JBTStandardObservationId:+n.JBTStandardObservationId,SiteName:i?i.Name:null,TagName:n.TagName,GateName:n.GateName&&n.GateName.replace(".",""),Value:n.LastObservationTextValue,JBTStandardObservation:s.jbtStandardObservations.first(function(t){return t.Id==n.JBTStandardObservationId})};t.PLCUTCDateMS=t.PLCUTCDate.getTime();t.PLCLocalDate=u.GetLocalDateFromUTCDate(t.PLCUTCDate);t.ObservationUTCDateMS=t.ObservationUTCDate.getTime();t.ObservationLocalDate=u.GetLocalDateFromUTCDate(t.ObservationUTCDate);b(t);w(t)})},h.PlaceTagsIntoInventory=function(n){n.where(function(n){return!n.MarkedForDelete}).forEach(function(n){var i=s.sites.first(function(t){return t.Id==n.SiteId}),t;s.tags.any(function(t){return t.TagId==n.Id})||(t={DataType:"DB",PLCUTCDate:h.dataSourceIsLocal?new Date(n.LastObservationDate):u.GetUTCDateFromLocalDate(new Date(n.LastObservationDate)),ObservationUTCDate:h.dataSourceIsLocal?new Date(n.LastObservationDate):u.GetUTCDateFromLocalDate(new Date(n.LastObservationDate)),AssetId:+n.AssetId,TagId:+n.Id,SiteId:+n.SiteId,ObservationId:+n.LastObservationId,JBTStandardObservationId:+n.JBTStandardObservationId,SiteName:i?i.Name:null,TagName:n.Name,Value:n.LastObservationTextValue,JBTStandardObservation:s.jbtStandardObservations.first(function(t){return t.Id==n.JBTStandardObservationId}),IsCritical:n.IsCritical,IsWarning:n.IsWarning,IsAlarm:n.IsAlarm,ValueWhenActive:n.ValueWhenActive||"1",AssetName:n.AssetName,GateName:n.GateName&&n.GateName.replace(".",""),Severity:n.IsCritical?"Critical":n.IsAlarm?"Alarm":n.IsWarning?"Warning":""},t.PLCUTCDateMS=t.PLCUTCDate.getTime(),t.PLCLocalDate=u.GetLocalDateFromUTCDate(t.PLCUTCDate),t.ObservationUTCDateMS=t.ObservationUTCDate.getTime(),t.ObservationLocalDate=u.GetLocalDateFromUTCDate(t.ObservationUTCDate),b(t),w(t))})},h.GetAllSignalRObservationFormattedTagsForAssetIdIntoInventoryByListOfAssetIds=function(n,r){var f=(""+n).split(",").distinct().where(function(n){if(n!=""){var t=s.assets.first(function(t){return t.Id==+n});return!r&&t&&!t.AllTagsLoaded||r&&t&&!t.AllAlarmTagsLoaded}});return f.length==0?i.when(!0):f.length>0?h.GetIOPSWebAPIResource(r?"GSAlarmTagsByListOfAssetIdsCondensed":"GSTagsByListOfAssetIdsCondensed").query({assetIds:n},function(i){console.log("Raw Data = %O",angular.copy(i));(typeof i[0]=="string"||i[0]instanceof String)&&(i=i.select(function(n){var t=n.split("~");return{Id:+t[0],Name:t[1],SiteId:+t[2],LastObservationCreationDate:u.GetUTCDateFromLocalDate(new Date(+t[3])),LastObservationDate:u.GetUTCDateFromLocalDate(new Date(+t[4])),AssetId:+t[5],LastObservationId:+t[6],JBTStandardObservationId:+t[7],LastObservationTextValue:t[8],LastObservationQuality:+t[9],IsAlarm:+t[10]==1,IsWarning:+t[11]==1,ValueWhenActive:t[12]==""?"1":t[12],DataType:"DB"}}));console.log("Formatted data = %O",angular.copy(i));console.log("Loading tags into inventory Data Arrival = "+i.length+" tags");console.log("Inventory length = "+s.tags.length);i.length>0&&(i.select(function(n){var i=d(n),r=w(i,!0);n.PreviousObservationId&&n.PreviousObservationId!=n.ObservationId&&t.$broadcast("dataService.TagUpdate",r)}),s.tags=s.tags.distinct(function(n,t){return n.TagId==t.TagId}),console.log("attaching tags to assets and assets assets to tags."),n.split(",").forEach(function(n){if(n!=""){var t=s.assets.first(function(t){return t.Id==n});t.Tags=s.tags.where(function(n){return n.AssetId==t.Id});t.Tags.forEach(function(n){n.Asset=t;n.JBTStandardObservation=s.jbtStandardObservations.first(function(t){return t.Id==n.JBTStandardObservationId})})}}),console.log("Loading tags into inventory for list of asset ids - cache processed"),console.log("Inventory length = "+s.tags.length),n.split(",").forEach(function(n){var t=s.assets.first(function(t){return t.Id==+n});t&&!r&&(t.AllTagsLoaded=!0);t&&r&&(t.AllAlarmTagsLoaded=!0)}))}).$promise:void 0},h.RefreshAllSignalRObservationFormattedTagsForAssetIdIntoInventoryByListOfAssetIds=function(n){return h.GetIOPSWebAPIResource("GSTagsUpdatedInLastSecondsByListOfAssetIdsCondensed").query({assetIds:n,seconds:120},function(i){i=i.select(function(n){var t=n.split("~");return{Id:+t[0],Name:t[1],SiteId:+t[2],LastObservationCreationDate:u.GetUTCDateFromLocalDate(new Date(+t[3])),LastObservationDate:u.GetUTCDateFromLocalDate(new Date(+t[4])),AssetId:+t[5],LastObservationId:+t[6],JBTStandardObservationId:+t[7],LastObservationTextValue:t[8],LastObservationQuality:+t[9],IsAlarm:+t[10]==1,IsWarning:+t[11]==1,ValueWhenActive:t[12]==""?"1":t[12],DataType:"DB"}});i.where(function(n){return n.Name.indexOf("|")>0}).where(function(n){return!n.MarkedForDelete}).select(function(n){n=d(n);var i=w(n);i.PreviousObservationId&&i.PreviousObservationId!=i.ObservationId&&t.$broadcast("dataService.TagUpdate",i)});n.split(",").forEach(function(n){var t=s.assets.first(function(t){return t.Id==+n})})})},h.dataSourceIsLocal=document.URL.indexOf("localhost/iops/")>0,yt=0,h.GetAllSignalRObservationFormattedTagsForAssetIdIntoInventory=function(n){return h.GetAllSignalRObservationFormattedTagsForAssetIdIntoInventoryByListOfAssetIds(n.toString(),!1)},a=null,r(function(){h.Statistics.SignalR.MessagesPerSecond=h.Statistics.SignalR.MessageCount-h.Statistics.SignalR.PreviousMessageCount;h.Statistics.SignalR.PreviousMessageCount=h.Statistics.SignalR.MessageCount},1e3),r(function(){s.tags.where(function(n){return n.Metadata.UpdateCountDowns.OneSecond>0}).select(function(n){n.Metadata.UpdateCountDowns.OneSecond-=1e3;n.Metadata.UpdateCountDowns.OneSecond<0&&(n.Metadata.UpdateCountDowns.OneSecond=0)});v.tagsWithOneSecondCountdowns.select(function(n){n.Metadata.UpdateCountDowns.OneSecond-=1e3;n.Metadata.UpdateCountDowns.OneSecond<0&&(n.Metadata.UpdateCountDowns.OneSecond=0)});v.tagsWithOneSecondCountdowns=v.tagsWithOneSecondCountdowns.where(function(n){return n.Metadata.UpdateCountDowns.OneSecond!=0})},100),r(function(){return n.GetEntityById("iOPS","Sites",1)},3e5),h}angular.module("app").factory("dataService",["odataService","$rootScope","$q","$interval","utilityService","$timeout","indexedDBService","signalR","$odata",n])}(),function(){function n(n,t){function r(){var u=$(window).height(),r;i.currentScreenWidth=$(window).width();i.currentScreenHeight=$(window).height();r=5;$("[appContent]").each(function(n,t){$(t).css("height",parseInt(u)-$(t).offset().top-r);$(t).css("overflow-y","hidden");$(t).css("overflow-x","hidden");i.appContentHeight=parseInt($(t).css("height"))});$(".static-panel > .panel-body").each(function(n,t){var i=$(t).offset().top,f=u-i-r-15;$(t).css("height",f);$(t).css("overflow-y","auto")});$(".fullscreen-panel > .panel-body").each(function(n,t){var i=$(t).offset().top,f=u-i-r-15;$(t).css("height",f);$(t).css("overflow-y","auto")});$(".panel > .panel-default > .panel-body").each(function(n,t){var i=$(t).offset().top,f=u-i-r-15;console.log("Element top = "+i);console.log("Setting panel body height = "+f);$(t).css("height",f);$(t).css("overflow-y","auto")});$(".static-panel > .panel-body-iframe").each(function(n,t){$(t).css("height",parseInt(u)-$(t).offset().top-r-5);$(t).css("overflow-y","hidden")});$(".panel-centered-modal-floating > .panel-body").each(function(n,t){var i=$(t).offset().top,f=u-i-r-25;$(t).css("height",f);$(t).css("overflow-y","auto")});$("#siteMenuBody").each(function(n,t){$(t).css("height",parseInt(u)-$(t).offset().top-r);$(t).css("overflow-y","inherit")});$(".single-chart").each(function(n,t){$(t).css("height",parseInt(u)-$(t).offset().top-r-20)});$(".fullscreen-panel-body").each(function(n,t){$(t).css("height",parseInt($(window).height())-$(t).offset().top-10)});$(".fullscreen-tab-panel-body").each(function(n,t){$(t).css("height",parseInt($(window).height())-$(t).offset().top-35)});$("#systemIframePanelScrollable").each(function(n,t){$(t).css("height",parseInt(u)-$(t).offset().top-r)});t(function(){n.$apply()},30);$(".repeater-container").each(function(n,t){$(t).css("height",+$(window).height()-$(t).offset().top-10);$(t).css("overflow-y","auto")})}var i={};return i.suppressSiteHeader=!1,i.suppressAllSiteHeaders=!0,Highcharts.setOptions({global:{useUTC:!1},lang:{thousandsSep:","}}),i.menuButtonClicked=function(){},i.menuParameters={isMenuButtonVisible:!1,activeElement:null,isVerticalFlag:!0,isVertical:function(){return isVerticalFlag},showMenu:!0,allowHorizontalToggle:!0,isMenuVisible:!0},i.currentScreenWidth=$(window).width(),i.currentScreenHeight=$(window).height(),i.MaintainScreenDimensionReferences=function(){i.currentScreenWidth=$(window).width();i.currentScreenHeight=$(window).height();t(function(){n.$apply()},10)},i.SetLoneChartSize=function(n,t){var r=i.GetWidgetPanelBodyDimensions(n);i.SetWidgetPanelBodyDimensions(n);t&&t.setSize(r.width,r.height-10,!1)},$(window).bind("resize",i.MaintainScreenDimensionReferences),i.SetWidgetPanelBodyDimensions=function(n){var t=$("#"+n);if(t[0]){var i=t[0].parentElement,f=$(i).find(".panel-heading")[0],u=i.offsetWidth,r=i.offsetHeight-f.offsetHeight;return t.css("height",r-2),$("."+n+"-repeater-container").each(function(n,t){$(t).css("height",+r-33);$(t).css("width",+u-17);$(t).css("overflow-y","hidden")}),{width:u,height:r}}},i.SetVirtualScrollWidgetPanelBodyDimensions=function(n,t){var u=$("#"+n),i=u[0].parentElement,f=$(i).find(".panel-heading")[0],o=f.offsetHeight,e=i.offsetWidth,r=i.offsetHeight-f.offsetHeight;return u.css("height",r),$("."+t).each(function(n,t){$(t).css("height",+r-30);$(t).css("width",+e-17);$(t).css("overflow-y","auto")}),{width:e,height:r}},i.GetWidgetPanelBodyDimensions=function(n){var i=$("#"+n);if(i[0]){var t=i[0].parentElement,r=$(t).find(".panel-heading")[0],e=r.offsetHeight,u=t.offsetWidth,f=t.offsetHeight-r.offsetHeight;return{width:u,height:f}}},i.GetDivDimensionsById=function(n){var t=$("#"+n)[0],i,r;return t?(i=t.offsetWidth,r=t.offsetHeight,{width:i,height:r}):{width:0,height:0}},i.SetDivHeightById=function(n,t){$(n).css("height",t)},i.ResizeChart=function(n,t){var r=i.SetWidgetPanelBodyDimensions(n);t.setSize(r.width-60,r.height-35,!1)},i.SetPanelDimensions=function(n){if(r(),n)for(var i=1;i<=n;i++)t(function(){r()},i*20)},$(window).bind("resize",function(){r();n.$broadcast("ResizeVirtualScrollContainers",null)}),i.SetPanelBodyWithIdHeight=function(n){t(function(){$("#"+n).each(function(n,t){$(t).css("height",$(t)[0].parentNode.offsetHeight-40);$(t).css("offsetHeight",$(t)[0].parentNode.offsetHeight-40)})},25)},i}angular.module("app").factory("displaySetupService",["$rootScope","$timeout","$interval",n])}(),function(){function n(n){var t={},i={setErrorHandlers:function(n,t){typeof n!="undefined"&&("onerror"in n&&(n.onError=t),"onblocked"in n&&(n.onblocked=t),"onabort"in n&&(n.onabort=t))}};return t.indexedDBPresent=!1,t.getDBInstance=function(r,u,f){var o=n.defer(),e={instance:null,open:function(r,u,f){var o=n.defer(),s;return window.indexedDB?(s=window.indexedDB.open(r,u),i.setErrorHandlers(s,o.reject),s.onupgradeneeded=function(n){var t,u,r,i;for(console.log("localDB Upgrading....."),t=n.target.result,console.log("db = %O",t),u=t.objectStoreNames.length,r=[],i=0;i<u;i++)r.push(t.objectStoreNames[i]);r.forEach(function(n){console.log("Deleting object store "+n);t.deleteObjectStore(n)});f.forEach(function(n){console.log("schema = %O",n);console.log("Creating objectStore "+n.dataStoreName);var i=t.createObjectStore(n.dataStoreName,{keyPath:n.keyName});n.indices&&n.indices.forEach(function(n){i.createIndex(n.name,n.fieldName,{unique:!1})})})},s.onsuccess=function(n){t.indexedDBPresent=!0;e.instance=n.target.result;i.setErrorHandlers(this.instance,o.reject);o.resolve()}):o.resolve(),o.promise},requireOpenDB:function(n,t){e.instance===null&&t.reject("You cannot use an object store when the database has not been opened. Store Name = "+n)},getObjectStore:function(n,i){if(!t.indexedDBPresent)return o.resolve(null),o.promise;i=i||"readonly";var r=this.instance.transaction(n,i);return r.objectStore(n)},requireObjectStoreName:function(n,t){typeof n!="undefined"&&n&&n.length!==0||t.reject("An objectStoreName is required.")},getCount:function(i){var r=n.defer(),u,f,e;return t.indexedDBPresent?(this.requireObjectStoreName(i,r),this.requireOpenDB(i,r),u=this.getObjectStore(i),f=u.count(),f.onsuccess=function(n){e=n.target.result;r.resolve(e)},r.promise):(r.resolve(null),r.promise)},getAll:function(i){var r=n.defer(),u,f,e;return t.indexedDBPresent?(this.requireObjectStoreName(i,r),this.requireOpenDB(i,r),u=this.getObjectStore(i),console.log("getAll Function: store = %O",u),u.getAll?(f=u.getAll(),f.onsuccess=function(n){e=n.target.result;r.resolve(e)}):r.resolve(null),r.promise):(r.resolve(null),r.promise)},upsert:function(i,r){var u=n.defer(),f,e;return t.indexedDBPresent?(this.requireObjectStoreName(i,u),this.requireOpenDB(i,u),r=angular.copy(r),f=this.getObjectStore(i,"readwrite"),e=f.put(r),e.onsuccess=function(){u.resolve(r)},u.promise):(u.resolve(null),u.promise)},"delete":function(i,r){var u=n.defer(),f,o;return t.indexedDBPresent?(this.requireObjectStoreName(i,u),this.requireOpenDB(i,u),f=e.getObjectStore(i,"readwrite"),o=f.delete(r),u.promise):(u.resolve(null),u.promise)},getById:function(i,r){var u=n.defer(),f,e;return t.indexedDBPresent?(this.requireObjectStoreName(i,u),this.requireOpenDB(i,u),f=this.getObjectStore(i),e=f.get(r),e.onsuccess=function(n){u.resolve(n.target.result)},u.promise):(console.log("Indexed DB Not present in browser!"),u.resolve(null),u.promise)},getByIndex:function(i,r,u){var f=n.defer();if(!t.indexedDBPresent)return f.resolve(null),f.promise;this.requireObjectStoreName(i,f);this.requireOpenDB(i,f);var o=this.getObjectStore(i),s=o.index(r),h=IDBKeyRange.only(u),e=[];return s.openCursor(h).onsuccess=function(n){var t=n.target.result;t?(e.push(t.value),t.continue()):f.resolve(e)},f.promise},clear:function(i){var r=n.defer(),u,f;return t.indexedDBPresent?(this.requireObjectStoreName(i,r),this.requireOpenDB(i,r),u=this.getObjectStore(i,"readWrite"),f=u.clear(),f.onsuccess=r.resolve,r.promise):(r.resolve(null),r.promise)}};return e.open(r,u,f).then(function(){o.resolve(e)},function(){console.log("Failed")}),o.promise},t}angular.module("app").factory("indexedDBService",["$q",n])}(),function(){function n(n,t,i,r){function f(t,i,r){return odataServerUrl.indexOf("48773")>0?n(e+"/"+i,{},{},{odatakey:r===null?"Id":r,isodatav4:!0}):n(e+t+"/"+i,{},{},{odatakey:r===null?"Id":r,isodatav4:!0})}var u={},e=odataServerUrl+"/";return u.serverPath=e,u.GetFileImageLibraryCollectionForListOfImageKeys=function(n){var i=[];return t.post("https://odataprod.utmb.edu/FileImageLibrary/ByImageKeyList?$format=application/json;odata.metadata=none",n).then(function(n){var t=n.data.value;return i=t,console.log("fileImageLibraryData = %O",i),i})},u.GetFileImageLibraryEntriesByImageKeyList=function(n){return t.post("https://odataprod.utmb.edu/FileImageLibrary/ByImageKeyList?$format=application/json;odata.metadata=none",n).then(function(n){return n.data.value})},u.GetResource=function(n,t){return f(n,t)},u.GetAngularStandardResource=function(t){return n(t)},u.GetIOPSWebAPIResource=function(n){return r(e+"iOPS/api/"+n)},u.GetCollection=function(n,t,i,r){var u=f(n,t).odata();return i&&r?u.filter(i,r).query().$promise:u.query().$promise},u.GetEntityById=function(n,t,i){return f(n,t).odata().get(parseInt(i)).$promise},u.InsertEntity=function(n,t,i){return i.Id=0,f(n,t).save(i).$promise},u.UpdateEntity=function(n,t,i){return f(n,t).save(i).$promise},u.DeleteEntity=function(n,t,i){return i.Id=-i.Id,f(n,t).save(i).$promise},u}angular.module("app").factory("odataService",["$odataresource","$http","$q","$resource",n])}(),function(){function n(n,t,i,r,u,f,e){function h(n){return t(s+n,{},{},{odatakey:"Id",isodatav4:!0})}function c(){Global.SignalR&&Global.SignalR.Status=="Connected"&&Global.User&&Global.User.AuthorizedActivities&&(Global.User.AuthorizedActivities.contains("AuthorizedActivity.AdministerSystem")&&f.JoinGroup("Admin"),Global.User.ReaderOf.forEach(function(n){var t=n.replace("Site.","");f.JoinGroup(t)}))}function l(){n.get(s+"loginaccesstoken(accesstoken='"+o.currentUser.AccessToken+"')?$format=application/json;odata.metadata=none").then(function(n){var t=n.data;t.UserMasterId>0&&(o.currentUser=t,i.set("currentUser",t),console.log("Local currentUser object refreshed = %O",o.currentUser),r.$broadcast("securityService.currentUserRefreshed"))})}var o={},s;return o.users=[],s=odataServerUrl.indexOf("48773")>0?odataServerUrl:odataServerUrl+"/iOPS",o.IsUserOnline=function(n){var t=o.GetOnlineUsers();return t.any(function(t){return t.Id==n})},o.GetResource=function(n){return h(n)},o.GetCurrentUser=function(){return o.currentUser||(o.currentUser=i.get("currentUser")),o.currentUser},o.UserHasAuthorizedActivity=function(n){return n=n.toUpperCase(),o.currentUser.AuthorizedActivities.any(function(t){return t.toUpperCase()==n})},o.SaveNewApplication=function(n){return h("Applications").save(n)},o.SaveUser=function(n){h("iOPS_Users").update(n)},o.GetAuthorizableActivityById=function(n){return h("AuthorizableActivities").odata().get(parseInt(n)).$promise},o.LoginUserWithUsernameAndPassword=function(t,u){var f=t+"\n"+u,e=s+"/login?$format=application/json;odata.metadata=none";return n.post(e,f).then(function(n){if(console.log("Entire response = %O",n),n.status==401)return r.$broadcast("securityService.invalidAccount",null),"";var t=n.data;return t.Id==0?(r.$broadcast("securityService.invalidAccount",null),""):(console.log("Logged in User = %O",t),n.status!=401&&(t.DateLoggedIn=Date.now(),o.currentUser=t,i.set("currentUser",t),o.showMenu=!0,Global.User=t),t.error&&t.error.innererror&&t.error.innererror.internalexception&&t.error.innererror.internalexception.type&&(t.error.innererror.internalexception.type=="System.Data.Entity.Core.EntityException"||t.error.innererror.internalexception.type=="System.Data.Entity.Core.EntityException")&&alertify.alert("iOPSPro is experiencing database issues. Try again later."),c(),r.$broadcast("securityService:authenticated",o.currentUser),t)})},r.$on("System.signalR Connected",function(){u(function(){c()},50)}),o.LoginUserWithAccessToken=function(){var t=e.GetQuerystringParameterByName("pwt"),u,f,h;return t?(o.currentUser=null,i.remove("currentUser")):(u=o.GetCurrentUser(),u&&(t=u.ODataAccessToken)),f=s+"/login?$format=application/json;odata.metadata=none",h=n.post(f,t).then(function(n){if(n.status==401||n.data.Id==0)return r.$broadcast("securityService.invalidAccount",null),"";var t=n.data;return console.log("Logged in User = %O",t),n.status!=401&&(t.DateLoggedIn=Date.now(),o.currentUser=t,i.set("currentUser",t),Global.User=t),c(),r.$broadcast("securityService:authenticated",o.currentUser),t}),h},o.RefreshUserSecurityForUserId=function(n){if(n==o.currentUser.Id)l();else{var t=o.users;console.log("Someone Elses user data needs to be refreshed. Connected Users = %O",t);o.users.where(function(t){return t.Id==n}).forEach(function(n){f.SignalSpecificClient(t[n].ClientId,"Security.RefreshUser",null)})}},r.$on("Security.RefreshUser",function(){l()}),o}angular.module("app").factory("securityService",["$http","$odataresource","store","$rootScope","$timeout","signalR","utilityService","dataService","$interval",n])}(),function(){function n(n,t,i,r,u){function nt(n,t,i){c&&console.log(" Hub->Me "+n+" %O",i)}function p(n){return f.connectedClients.where(function(t){return t.ClientId===n}).first().User}function a(n,t){f.connectedClients=[{ClientId:n,User:t}].concat(f.connectedClients).distinct(function(n,t){return n.ClientId==t.ClientId})}function w(n){var t=f.connectedClients.first(function(t){return t.ClientId==n});t&&console.log("SignalR Client Disconnect was a browser for client = %O",t);f.connectedClients=f.connectedClients.where(function(t){return t.ClientId!=n})}function b(n,t,i){return{odataSource:n,collection:t,Id:parseInt(i),lockingClientId:f.Me.ClientId}}function v(n){for(var i=!1,t=0;t<f.OdataLockedEntities.length;t++)if(f.OdataLockedEntities[t].Id==n.Id&&f.OdataLockedEntities[t].odataSource==n.odataSource&&f.OdataLockedEntities[t].collection==n.collection){i=!0;break}i||(console.log("Lock entry was unique - adding to the list"),f.OdataLockedEntities.push(n),console.log("Current locks = %O",f.OdataLockedEntities))}function k(n){for(var t=0;t<f.OdataLockedEntities.length;t++)if(f.OdataLockedEntities[t].entityTag==n.entityTag){f.OdataLockedEntities.splice(t,1);break}}function d(n){for(var t=0;t<f.OdataLockedEntities.length;t++)f.OdataLockedEntities[t].clientId==n&&f.OdataLockedEntities.splice(t,1)}function s(){var n=i.get("currentUser");return n?{User:{Username:n.Username,UserId:n.Id,Email:n.Email,FamilyName:n.FamilyName,GivenName:n.GivenName,MiddleName:n.MiddleName},ClientId:$.connection.hub.id,DateLoggedIn:n.DateLoggedIn,DateLoggedInFormatted:moment(n.DateLoggedIn).format("YYYY-MM-DD HH:mm:ss")}:null}function h(){}function rt(){o=performance.now();console.log("signalR Client = %O",f.Me);f.Me&&f.SignalSpecificClient(f.Me.ClientId,"signalRPerformanceTest",!0)}function y(){$.connection.hub.start({withCredentials:!1,transport:["webSockets","serverSentEvents","longPolling"]}).done(function(){var t,r;f.connected||(f.connected=!0,console.log("Client Connect - Local ClientId:"+$.connection.hub.id),t=s(),t&&(f.Me=t,a(t.ClientId,t),r=i.get("currentUser"),Global.SignalR={ClientId:$.connection.hub.id,DateLoggedIn:r.DateLoggedIn,DateLoggedInFormatted:moment(r.DateLoggedIn).format("YYYY-MM-DD HH:mm:ss")},f.SignalAllClients("System.ClientConnectionEstablished",s())),f.connectionState="connected",Global.SignalR.Status="Connected",n.$broadcast("System.signalR Connected"),rt())}).fail(function(){f.connected=!1;u(function(){y()},1e3)})}var f={},e,g,c,o,l,tt,it;return f.serverPath=signalRServerUrl,f.OdataLockedEntities=[],f.connectedClients=[],f.connected=!1,e=$.connection.jbthub,g="",$.connection.hub.logging=!1,c=!1,$.connection.hub.url=f.serverPath,o=0,l=null,r(function(){f.connectionState=="disconnected"&&(f.connected=!1,y())},1e4),tt=0,it="",e.client.SignalRNotification=function(t,i,r,u){var b=Date.now()-o,e,c,y;u||(u="");nt(t,r,i,u);switch(t){case"System.InformationalMessage":if(e=p(r),e){c=e.User.GivenName+" "+e.User.FamilyName;toastr.info(i,"Message from "+c);break}case"System.AlertMessage":e=p(r);console.log("Alert Message from user = %O",e);e&&(c=e.User.GivenName+" "+e.User.FamilyName,alertify.set({labels:{ok:"Ok, I Got It!"}}),y=Global.User,alertify.alert("<div class='panel panel-default'><div class='panel-heading'>Message from "+c+"<\/div><div class='panel-body'>"+i+"<\/div><\/div>",function(){f.SignalSpecificClient(r,"System.InformationalMessage","......message acknowledged.")}));break;case"System.ClientConnectionEstablished":a(r,i);f.SignalSpecificClient(i.ClientId,"System.OnLineReportResponse",s());h();n.$broadcast(t,i);break;case"System.ClientLogout":i&&(w(i.ClientId),h(),d(i.ClientId),n.$broadcast(t,i));break;case"System.SignalR.ClientDisconnected":w(i.ClientId);h();d(i);n.$broadcast(t,i);break;case"System.OnLineReportResponse":i&&(a(i.ClientId,i),l||(l=i,f.SignalSpecificClient(i.ClientId,"System.ReportLockedEntities",null)),h());break;case"System.ReportLockedEntities":f.SignalSpecificClient(r,"System.LockedEntitiesReport",f.OdataLockedEntities);break;case"System.LockedEntitiesReport":i.forEach(function(n){v(n)});console.log("Current Locked Entities = %O",f.OdataLockedEntities);break;case"System.EntityLocked":v(i);console.log("Entity Has Been Locked. OdataLockedEntitiesList now = %O",f.OdataLockedEntities);n.$broadcast("System.EntityLocked",i);break;case"System.EntityUnlocked":k(i);console.log("Entity Has Been Unlocked. OdataLockedEntitiesList now = %O",f.OdataLockedEntities);n.$broadcast("System.EntityUnlocked",i);break;default:n.$broadcast(t,i)}},f.LockEntity=function(n,t,i){var r=b(n,t,i);v(r);f.SignalAllClients("System.EntityLocked",r)},f.GetLockingUserForEntity=function(n,t,i){var r,u,e;if(console.log("Checking for locks....."),f.OdataLockedEntities.length>0){for(console.log("Global Locks are present....%O",f.OdataLockedEntities),r=0;r<f.OdataLockedEntities.length;r++)if(f.OdataLockedEntities[r].Id==parseInt(i)&&f.OdataLockedEntities[r].odataSource==n&&f.OdataLockedEntities[r].collection==t&&(u=f.OdataLockedEntities[r],console.log("entity lock is present - Applicable lock = %O",u),u.lockingClientId!=f.Me.ClientId)){if(e=datacache.GetFromNamedCache("SignalRUsersByClientId",u.lockingClientId),e)return console.log("Lock User = %O",e.User),e.User;console.log("signalR did not find the locking client ID in the cache for users!!!!");console.log("Cache for Users by Client Id = %O",datacache.GetAllValuesFromCache("SignalRUsersByClientId"))}return null}},f.UnlockEntity=function(n,t,i){var r=b(n,t,i);k(r);console.log("Current locks = %O",f.OdataLockedEntities);f.SignalAllClients("System.EntityUnlocked",r)},f.SignalAllClients=function(t,i){return n.$broadcast(t,i),f.SignalOnlyOtherClients(t,i)},f.SignalAllClientsInGroup=function(t,i,r){return console.log("Broadcasting "+i),n.$broadcast(i,r),f.SignalOnlyOtherClientsInGroup(t,i,r)},f.SignalOnlyOtherClients=function(n,t){return e.server.notifyOtherClients(n,t)},f.SignalOnlyOtherClientsInGroup=function(n,t,i){return e.server.notifyOtherClientsInGroup(n,t,i)},f.JoinGroup=function(n){return e.server.joinGroup(n).then(function(){console.log("Joined signalR Group "+n)})},f.LeaveGroup=function(n){return e.server.leaveGroup(n).then(function(){})},f.SignalSpecificClient=function(n,t,i){return e.server.notifySpecificClient(n,t,i)},f.SendEmail=function(n){console.log("Sending Email.....");$.connection.hub.start({transport:["webSockets","serverSentEvents","longPolling"]}).done(function(){e.server.sendEmail(n)}).fail(function(n){console.log("SignalR Error "+n)})},f.SignalClientsForLogout=function(){f.SignalAllClients("System.ClientLogout",s())},t.onbeforeunload=f.SignalClientsForLogout,$.connection.hub.stateChanged(function(t){var i={0:"connecting",1:"connected",2:"reconnecting",4:"disconnected"};console.log("SignalR state changed from: "+i[t.oldState]+" to: "+i[t.newState]);f.connectionState=i[t.newState];f.connectionState=="connected"&&(n.$broadcast("System.signalR Connected"),Global.SignalR&&(Global.SignalR.Status="Connected"));f.connectionState=="disconnected"&&(n.$broadcast("System.signalR Disconnected"),Global.SignalR&&(Global.SignalR.Status="Disconnected"))}),f.connectionState="",n.$on("signalRPerformanceTest",function(){console.log("SignalR Trip Time = "+(performance.now()-o)/2)}),y(),f}angular.module("app").factory("signalR",["$rootScope","$window","store","$interval","$timeout","$q",n])}(),function(){function n(n,t,i,r){function e(n){return n._d}var u={},f;return u.ReplaceItemInArrayById=function(n,t){for(var r=!1,i=0;i<n.length;i++)if(n[i].Id==t.Id){n[i]=t;r=!0;break}r||n.push(t)},u.GetQuerystringParameterByName=function(n){n=n.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");var i=new RegExp("[\\?&]"+n+"=([^&#]*)"),t=i.exec(location.search);return t===null?"":decodeURIComponent(t[1].replace(/\+/g," "))},u.ReplaceItemInArrayByIdOnlyIfPresent=function(n,t){for(var r=!1,i=0;i<n.length;i++)if(n[i].Id==t.Id){n[i]=t;r=!0;break}},u.ToFixed=function(n,t){var i=+(Math.round(+(n.toString()+"e"+t)).toString()+"e"+-t);return i=i.toString(),i.indexOf(".")<0&&(i+=".0"),i},u.SecondsToString=function(n){if(!n||n=="NULL"||n=="null"||+n!=n)return"";var t=Math.floor(n/86400),i=Math.floor(n%86400/3600),r=Math.floor(n%86400%3600/60),u=n%86400%3600%60;return(t>0?t+(t==1?" day ":" days "):"")+(i>9?i:"0"+i)+":"+(r>9?r:"0"+r)+":"+(u>9?u:"0"+u)},u.DateDifferenceToString=function(n,t){var i=moment.utc(moment(t,"DD/MM/YYYY HH:mm:ss").diff(moment(n,"DD/MM/YYYY HH:mm:ss")))/1e3;return u.SecondsToString(i)},u.GetElapsedTimeAsDisplayString=function(n,t){var i=moment.utc(moment(t,"DD/MM/YYYY HH:mm:ss").diff(moment(n,"DD/MM/YYYY HH:mm:ss")))/1e3;return u.SecondsToString(i)},u.RemoveItemFromArrayById=function(n,t){var i,r;if(t)for(i=0;i<n.length;i++)if(r=t.Id,r||(r=t),n[i].Id==r){n.splice(i,1);break}},u.IsItemInArray=function(n,t){for(var i=0;i<n.length;i++)if(n[i].Id==t.Id)return!0;return!1},u.GetFormattedDisplayDate=function(n){return moment(n).format("YYYY-MM-DD HH:mm:ss")},u.GetFormattedLocalDisplayDateFromUTCDate=function(n){return moment(u.GetLocalDateFromUTCDate(n)).format("YYYY-MM-DD HH:mm:ss")},u.GetHighResolutionFormattedDisplayDate=function(n){return moment(n).format("YYYY-MM-DD HH:mm.SSS")},u.GetFormattedDisplayDateOnly=function(n){return moment(n).format("MM/DD/YYYY")},u.SetupSelectpickerDropdown=function(n,r){n.$$postDigest(function(){var e=r.split(".").pop(),f=i(r),u="#"+e;$(u).selectpicker();$(u).on("change",function(){var i=$(u+" > option:selected").val();f.assign(n,i);t(function(){n.$apply()},1)});$(u).selectpicker("val",f(n))})},u.FormatNumberWithCommas=function(n){var t=n.toString().split(".");return t[0]=t[0].replace(/\B(?=(\d{3})+(?!\d))/g,","),t.join(".")},f=(new Date).getTimezoneOffset()/60,console.log("utilityService timeZoneOffsetHoursFromUTC = %O",f),u.GetLocalDateFromUTCDate=function(n){if(n){var t=moment(n).subtract(f,"hours");return e(t)}},u.GetUTCDateFromLocalDate=function(n){if(n){var t=angular.copy(n);return t.setHours(t.getHours()+f),t}},u.GetLocalDateFromUTCDateString=function(n){if(n){var t=new Date(angular.copy(n));return t.setHours(t.getHours()-f),t}},u.FormatDateToODataParameter=function(n){return moment(n).format("YYYY-MM-DDTHH:mm:ss")},u.FormatSaveDate=function(n){return moment(n).format("YYYY-MM-DDTHH:mm:ss")},u.GetUTCQueryDate=function(n){var t=moment(n);return e(t)},u.GetUTCQueryDateMinutesAgo=function(n){var t=moment(n);return e(t)},u.GetODataQueryDateFromUTCDate=function(n){var t=moment(n).subtract(f,"hours");return e(t)},u.GetNonUTCQueryDate=function(n){var t=moment(n);return e(t)},u.GetQueryDateForNow=function(){var n=moment().add(f,"hours");return e(n)},u.GetQueryDateSecondsAgo=function(n){var t=moment().add(f,"hours").subtract(n,"seconds");return e(t)},u.GetQueryDateMinutesAgo=function(n){var t=moment().add(f,"hours").subtract(n,"minutes");return e(t)},u.GetQueryDateHoursAgo=function(n){var t=moment().add(f,"hours").subtract(n,"hours");return e(t)},u.GetQueryDateDaysAgo=function(n){var t=moment().add(f,"hours").subtract(n,"days");return e(t)},u.GetOdataUpdateableCurrentDateTime=function(){var n=(new Date).toISOString();return console.log("utc = %O",n),n},u.DeleteResourceItemWithConfirmation=function(n,t,i,f,e,o){alertify.set({labels:{ok:"Yes, Delete the "+t,cancel:"Cancel, I don't want to do this"},buttonFocus:"cancel"});var s="Are you SURE you want to delete this "+t+"? ";f&&(s=f);alertify.confirm(s,function(f){f?(n.$delete(),u.RemoveItemFromArrayById(i,n),odataSource&&odataCollection&&r.SignalAllClients(e+"."+o+" Deleted",n.Id),toastr.success(n.Name,t+" was deleted!")):toastr.info(n.Name,t+" was NOT deleted!")})},u}angular.module("app").factory("utilityService",["$rootScope","$timeout","$parse","signalR",n])}(),function(){angular.module("app").directive("faSuspendable",function(){return{link:function(n){var t;n.$on("suspend",function(){t=n.$$watchers;n.$$watchers=[]});n.$on("resume",function(){t&&(n.$$watchers=t);t=void 0})}}})}(),function(){angular.module("app").directive("checkboxInputField",function(){return{restrict:"E",templateUrl:"angular/common/directives/formFields/checkboxInputFieldTemplate.html?"+Date.now,replace:!0,scope:{labelText:"@",isChecked:"=",model:"=",checkboxName:"@",bootstrapLabelColumns:"@",bootstrapInputColumns:"@"}}})}(),function(){angular.module("app").directive("checkboxInputTdField",function(){return{restrict:"E",templateUrl:"angular/common/directives/formFields/checkboxInputTdFieldTemplate.html?"+Date.now,replace:!0,scope:{model:"="}}})}(),function(){angular.module("app").directive("dropdownInputField",["$timeout","$rootScope","$parse",function(){return{restrict:"E",templateUrl:"app/directives/formFields/dropdownInputFieldTemplate.html?"+Date.now,replace:!0,scope:{labelText:"@",bootstrapLabelColumns:"@",bootstrapInputColumns:"@",idText:"@",displayWidth:"@",liveSearch:"@",instructions:"@",dropdownData:"="},link:function(){}}}])}(),function(){angular.module("app").directive("dropdownInputMultipleField",["$timeout","$rootScope","$parse",function(){return{restrict:"E",templateUrl:"angular/common/directives/formFields/dropdownInputMultipleFieldTemplate.html?"+Date.now,replace:!0,scope:{labelText:"@",bootstrapLabelColumns:"@",bootstrapInputColumns:"@",idText:"@",liveSearch:"@",instructions:"@",dropdownData:"="}}}])}();angular.module("app").directive("ngEnter",function(){return function(n,t,i){t.bind("keydown keypress",function(t){t.which===13&&(n.$apply(function(){n.$eval(i.ngEnter)}),t.preventDefault())})}}),function(){var n=angular.module("app");n.directive("entityLocking",["$state","signalR",function(n,t){var i=function(i){function u(){r.entityId&&(r.LockingUser=t.GetLockingUserForEntity(r.odataSource,r.collection,r.entityId),r.LockingUser?(console.log("signalR returned a locking user = %O",r.LockingUser),r.EntityIsLocked=!0,r.showLockBackdrop=!0,r.lockedNameDisplay=r.LockingUser.GivenName+" "+r.LockingUser.FamilyName):r.EntityIsLocked||(console.log("Entity was not locked by someone else, locking entity for us."),t.LockEntity(r.odataSource,r.collection,r.entityId),r.showLockBackdrop=!1))}var r=this,f;r.stateName=n.current.name;f=t.OdataLockedEntities;r.EntityIsLocked=!1;r.lockedNameDisplay="";r.showLockBackdrop=!1;u();i.$on("$destroy",function(){t.UnlockEntity(r.odataSource,r.collection,r.entityId)});i.$on("System.EntityUnlocked",function(n,i){(i.odataSource!=r.odataSource||i.collection!=r.collection||i.Id!=r.entityId||t.Me.ClientId!=i.lockingClientId)&&(r.LockingUser=null,r.EntityIsLocked=!1,r.showLockBackdrop=!1,r.lockedNameDisplay="",console.log("entityLocking directive - checking for locks"),u())})};return i.$inject=["$scope"],{restrict:"E",replace:!0,templateUrl:"angular/common/directives/formFields/entityLockingTemplate.html?"+Date.now(),scope:{odataSource:"@",collection:"@",entityId:"="},controllerAs:"vm",controller:i,bindToController:!0}}])}();angular.module("app").directive("focus",function(){return{link:function(n,t){t[0].focus();t[0].focus();t[0].focus();t[0].focus();t[0].focus();t[0].focus()}}}),function(){var n=angular.module("app");n.directive("personnelSelectorList",["odataService","personnelService","utilityService","$odata","dataCache","$state","hotkeys",function(n,t,i,r,u,f,e){var o=function(n){function u(n){if(r.people){for(var t=0;t<r.people.length;t++)if(r.people[t].MasterId==n.MasterId)return!0;return!1}return!1}var r=this;r.stateName=f.current.name;r.personnelService=t;console.log("personnelSelectorList directive - vm.people = %O",r.people);r.SelectContact=function(n){t.GetPersonById(n.MasterId).then(function(n){console.log("Person Model from personnelService = %O",n);u(n)||(i.ReplaceItemInArrayById(r.people,n),r.addPersonFunction()(n));r.Person=null})};r.searchPeople=function(n){return n.length>2?(r.searchingPeople=!0,t.GenericSearch(n)):null};r.RemovePerson=function(n){i.RemoveItemFromArrayById(r.people,n);r.removePersonFunction()(n)};e.bindTo(n).add({combo:"esc",description:"Cancel and close any input form",allowIn:["INPUT","SELECT","TEXTAREA"],callback:function(){f.go("^")}})};return o.$inject=["$scope"],{restrict:"E",templateUrl:"angular/common/directives/panels/personnelSelectorListDirectiveTemplate.html?"+Date.now(),scope:{people:"=",listTitle:"@",removePersonFunction:"&",addPersonFunction:"&"},controllerAs:"vm",controller:o,bindToController:!0}}])}(),function(){angular.module("app").directive("dropdownInputField",["$timeout","$rootScope","$parse",function(){return{restrict:"E",templateUrl:"angular/common/directives/formFields/dropdownInputFieldTemplate.html?"+Date.now,replace:!0,scope:{labelText:"@",bootstrapLabelColumns:"@",bootstrapInputColumns:"@",idText:"@",displayWidth:"@",liveSearch:"@",instructions:"@",dropdownData:"="},link:function(){}}}])}(),function(){angular.module("app").directive("selectpicker",["$parse",function(n){return{restrict:"A",link:function(t,i,r){i.selectpicker(n(r.selectpicker)());i.selectpicker("refresh");t.$watch(r.ngModel,function(n){t.$parent[r.ngModel]=n;t.$evalAsync(function(){(!r.ngOptions||/track by/.test(r.ngOptions))&&i.val(n);i.selectpicker("refresh")})});t.$on("$destroy",function(){t.$evalAsync(function(){i.selectpicker("destroy")})})}}}])}(),function(){angular.module("app").directive("systemDropdown",function(n){return{restrict:"E",scope:{items:"=dropdownData",doSelect:"&selectVal",selectedItem:"=preselectedItem"},link:function(t,i,r){var f="",u;switch(r.menuType){case"button":f+='<div class="btn-group"><button class="btn button-label btn-info">Action<\/button><button class="btn btn-info dropdown-toggle" data-toggle="dropdown"><span class="caret"><\/span><\/button>';break;default:f+='<div class="dropdown"><a class="dropdown-toggle" role="button" data-toggle="dropdown"  href="javascript:;">Dropdown<b class="caret"><\/b><\/a>'}for(f+='<ul class="dropdown-menu"><li ng-repeat="item in items"><a tabindex="-1" data-ng-click="selectVal(item)">{{item.name}}<\/a><\/li><\/ul><\/div>',i.append(n(f)(t)),u=0;u<t.items.length;u++)if(t.items[u].id===t.selectedItem){t.bSelectedItem=t.items[u];break}t.selectVal=function(n){switch(r.menuType){case"button":$("button.button-label",i).html(n.name);break;default:$("a.dropdown-toggle",i).html('<b class="caret"><\/b> '+n.name)}t.doSelect({selectedVal:n.id})};t.selectVal(t.bSelectedItem)}}})}(),function(){angular.module("app").directive("textareaInputField",function(){return{restrict:"E",templateUrl:"app/directives/formFields/textareaInputFieldTemplate.html?"+Date.now(),replace:!0,scope:{labelText:"@",cols:"@",rows:"@",placeholderText:"@",model:"=",inputName:"@",bootstrapLabelColumns:"@",bootstrapInputColumns:"@"},link:function(n,t){t[0].focus()}}})}(),function(){angular.module("app").directive("textInputField",function(){return{restrict:"E",templateUrl:"app/directives/formFields/textInput.html?"+Date.now,replace:!0,priority:1e4,scope:{labelText:"@",model:"=",idText:"@",inputName:"@",inputType:"@",bootstrapLabelColumns:"@",bootstrapInputColumns:"@",placeholderText:"@",inputWidth:"@"}}})}(),function(){angular.module("app").directive("widgetTextareaInputField",function(){return{restrict:"E",templateUrl:"app/directives/formFields/widgetTextareaInputFieldTemplate.html?"+Date.now(),replace:!0,scope:{labelText:"@",cols:"@",rows:"@",idText:"@",placeholderText:"@",model:"=",inputName:"@",bootstrapLabelColumns:"@",bootstrapInputColumns:"@"},link:function(n,t){t[0].focus()}}})}(),function(){angular.module("app").directive("widgetTextInputField",function(){return{restrict:"E",templateUrl:"app/directives/formFields/widgetTextInput.html?"+Date.now,replace:!0,priority:1e4,scope:{labelText:"@",model:"=",idText:"@",inputName:"@",inputType:"@",bootstrapLabelColumns:"@",bootstrapInputColumns:"@",placeholderText:"@",inputWidth:"@"}}})}(),function(){var n=angular.module("app");n.directive("fileUploadList",["odataService","personnelService","utilityService","$odata","dataCache","$state","hotkeys","displaySetupService","$timeout","FileUploader","$http","appSettings","$odataresource","$window","$interval","signalR","securityService",function(n,t,i,r,u,f,e,o,s,h,c,l,a,v,y,p,w){var b=function(n){function d(n,t){if(t=t||"",n.isFile)n.file(function(n){r.addToQueue(n)});else if(n.isDirectory){var i=n.createReader();i.readEntries(function(i){for(var r=0;r<i.length;r++)d(i[r],t+n.name+"/")})}}function g(){$("#pasteTarget").focus();$("#pasteTarget").click()}function st(){var n,r,f;i.imageKeys&&i.imageKeys.length>0&&(n=i.imageKeys.distinct().join(","),r=0,i.fileImageLibraryData=[],f=u+"ByImageKeyList?$format=application/json;odata.metadata=none",c.post(f,n).then(function(n){var f=n.data.value.orderByDescending(function(n){return n.CreationDate}).distinct(function(n,t){return n.ImageKey==t.ImageKey});i.fileImageLibraryData=f;i.fileImageLibraryData.forEach(function(n){var f=!1,i;n.FileName=="Pasted Image"&&(f=!0);i=n.FileName.split(".").pop().toLowerCase();(i=="jpg"||i=="png"||i=="jpg"||i=="gif"||i=="bmp")&&(f=!0);k.indexOf(i.toLowerCase())>-1&&(n.iconFile="images/FileUpload/icon-"+i+".png");f&&(n.thumbnailUrl=u+"downloads/imagekey?ImageKey="+n.ImageKey);n.Reordinal=r+=10;n.Ordinal!=n.Reordinal&&(n.Ordinal=n.Reordinal,n.DescriptionModified=!0);t.GetPersonById(n.CreatorUserMasterId).then(function(t){n.CreatorPerson=t});t.GetPersonById(n.ModifierUserMasterId).then(function(t){n.ModifierPerson=t})})}))}function ht(n){l=window.screen.availWidth*n*.6;b=window.screen.availHeight*n;ut=(window.screen.availHeight-b)/2;ft=(window.screen.availWidth-l)/2;et="top="+ut+",left="+ft+",height="+b+",width="+l+", scrollbars=yes, resizable=yes, location=no"}function ct(n){var t=window.open(n,"SRWindow",et)}function lt(t){var f,e,u,o,h;if(!i.readOnly)for(t.clipboardData.types.forEach(function(){}),f=0;f<t.clipboardData.items.length;f++){if(e=(t.clipboardData||t.originalEvent.clipboardData).items[f],e.type.indexOf(!1)){u=e.getAsFile();o=window.URL||window.webkitURL;try{h=o.createObjectURL(u);u.name="Pasted Image";u.imageDisplayUrl=h;r.addToQueue(u);s(function(){n.$apply()},100)}catch(c){}}t.preventDefault()}}var i=this,k="doc,docx,xls,xlsm,xlsx,msg,pdf,ppt,js,css,mp4,mp3,wav,zip,txt,json,config,cs,aspx,html,tif,tiff,,vsd,chm,asp,sql,hl7,xml,linq,rdl,wma,msi,exe.reg",u="https://odataprod.utmb.edu/FileImageLibrary/",ot=1e5,r,nt,tt,it,rt;t.GetPersonById(w.GetCurrentUser().UserMasterId).then(function(n){i.CurrentUserPerson=n});i.state=f;i.mode&&(i.readOnly=i.mode=="readOnly"?!0:!1);r=n.uploader=new h({url:u+"upload"});nt=angular.element(v).on("focus",g);tt=y(function(){i.SaveAllModifiedDescriptions()},1e3);n.$on("$destroy",function(){nt.off("focus",g);y.cancel(tt)});s(function(){document.getElementById("pasteTarget").addEventListener("drop",function(n){var u,t,i;for(n.preventDefault(),u=n.dataTransfer.items,t=0;t<u.length;t++)i=u[t].webkitGetAsEntry(),i&&!i.isFile&&(r.queue.pop(),d(i))},!1)},200);it=function(n,t){var r=t.children(),i=t.clone();return i.children().each(function(n){$(this).width(r.eq(n).width())}),i};rt=function(){var n=0;$("#fileUploadTable tbody tr").each(function(){var t=$(this).attr("ImageKey");i.fileImageLibraryData&&i.fileImageLibraryData.forEach(function(i){i.ImageKey==t&&(i.Reordinal=n+=10,i.Ordinal!=i.Reordinal&&(i.Ordinal=i.Reordinal,i.DescriptionModified=!0,i.ModifierUserMasterId=w.GetCurrentUser().UserMasterId))});r.queue.forEach(function(i){i.ImageKey==t&&(i.Reordinal=n+=10,i.Ordinal!=i.Reordinal&&(i.Ordinal=i.Reordinal,i.DescriptionModified=!0,i.ModifierUserMasterId=w.GetCurrentUser().UserMasterId))});i.SaveAllModifiedDescriptions()})};i.readOnly||s(function(){$("textarea").each(function(n,t){t.style.height="1px";t.style.height=15+t.scrollHeight+"px"});$("#fileUploadTable tbody").sortable({helper:it,stop:rt}).disableSelection()},150);st();n.$watchCollection("vm.imageKeys",function(n,t){if(t!=n){var u=[],f=[];t.forEach(function(t){var i=!1;n.forEach(function(n){t==n&&(i=!0)});i||u.push(t)});n.forEach(function(n){var i=!1;t.forEach(function(t){t==n&&(i=!0)});i||f.push(n)});u.forEach(function(n){i.fileImageLibraryData.forEach(function(t,r){t.ImageKey==n&&i.fileImageLibraryData.splice(r,1)});r.queue.forEach(function(t,i){t.fileImageLibraryEntry.ImageKey==n&&r.queue.splice(i,1)})});f.forEach(function(n){c.post("https://odataprod.utmb.edu/FileImageLibrary/ByImageKeyList?$format=application/json;odata.metadata=none",n).then(function(n){var r=n.data.value[0],u,t;r&&(u=!1,r.FileName=="Pasted Image"&&(u=!0),t=r.FileName.split(".").pop().toLowerCase(),(t=="jpg"||t=="png"||t=="jpg"||t=="gif"||t=="bmp")&&(u=!0),k.indexOf(t.toLowerCase())>-1&&(r.iconFile="images/FileUpload/icon-"+t+".png"),u&&(r.thumbnailUrl="https://odatatest.utmb.edu/FileImageLibrary/downloads/imagekey?ImageKey="+r.ImageKey),i.fileImageLibraryData||(i.fileImageLibraryData=[]))})})}});i.markDescriptionModified=function(n){n.DescriptionModified=!0};var l=window.screen.availWidth*.7,b=window.screen.availHeight*.7,ut=(window.screen.availHeight-b)/2,ft=(window.screen.availWidth-l)/2,et="";ht(.85);r.isHTML5&&(i.showHtml5CtrlVInstruction="(To paste a clipboard image here: click on this panel, then Ctrl-V)");i.readOnly||(i.panelSubtitle="Drop files anywhere below. Descriptions are editable. Drag item to re-order. Esc to exit. "+i.showHtml5CtrlVInstruction);i.SaveAndClose=function(){i.SaveAllModifiedDescriptions();f.go("^")};n.$on("FileImageLibrary.ImageKeyDescription Changed",function(){});i.SaveAllModifiedDescriptions=function(){i.fileImageLibraryData&&i.fileImageLibraryData.forEach(function(n){if(n.DescriptionModified){var t={ImageKey:n.ImageKey,Description:n.Description,Ordinal:n.Ordinal,CreatorUserMasterId:n.CreatorUserMasterId,ModifierUserMasterId:w.GetCurrentUser().UserMasterId};a(u+"Downloads/SaveDescription/").update(t).$promise.then(function(){p.SignalAllClients("FileImageLibrary.ImageKeyDescription Changed",t)});n.DescriptionModified=!1}});r.queue.forEach(function(n){if(n.DescriptionModified){var t={ImageKey:n.fileImageLibraryEntry.ImageKey,Description:n.Description,Ordinal:n.Ordinal,CreatorUserMasterId:w.GetCurrentUser().UserMasterId};a(u+"Downloads/SaveDescription/").update(t);n.DescriptionModified=!1;p.SignalAllClients("FileImageLibrary.ImageKeyDescription Changed",t)}})};i.removeAllUploads=function(){confirm("You have just chosen to remove and delete all the uploads below!. Are you sure you want to do this?")&&(r.queue.forEach(function(n){i.removeUploadFunction()(n.fileImageLibraryEntry.ImageKey)}),r.clearQueue(),i.fileImageLibraryData&&(i.fileImageLibraryData.forEach(function(n){i.removeUploadFunction()(n.ImageKey)}),i.fileImageLibraryData=null))};i.receivedFile=function(){};s(function(){document.getElementById("pasteTarget").addEventListener("paste",lt)},200);i.viewItem=function(n){var t=u+"downloads/imagekey?ImageKey="+n.ImageKey;ct(t)};i.ViewItemIfReadOnly=function(n){i.mode=="readOnly"&&i.viewItem(n)};i.imageSourceUrl=function(n){var t="";n&&(t=u+"downloads/imagekey?ImageKey="+n)};r.filters.push({name:"customFilter",fn:function(){return this.queue.length<1e3}});r.onWhenAddingFileFailed=function(){};r.onAfterAddingFile=function(n){n.upload();var t=n.file.name.split(".").pop();k.indexOf(t.toLowerCase())>-1&&(n.iconFile="images/FileUpload/icon-"+t+".png");n.DescriptionModified=!1};r.onAfterAddingAll=function(){};r.onBeforeUploadItem=function(){};r.onProgressItem=function(){};r.onProgressAll=function(){};r.onSuccessItem=function(n,t){var o=!1,e,h,f;r.queue.forEach(function(n){n.fileImageLibraryEntry&&n.fileImageLibraryEntry.ImageKey==t.ImageKey&&(o=!0)});i.fileImageLibraryData&&i.fileImageLibraryData.forEach(function(n){n.ImageKey==t.ImageKey&&(o=!0)});e={ImageKey:t.ImageKey,size:{original:t.intOriginal_Size,compressed:t.intCompressed_Size},name:t.strFilename};n.ImageKey=t.ImageKey;n.FileName=t.strFilename;n.CreatorUserMasterId=w.GetCurrentUser().UserMasterId;n.CreatorPerson=i.CurrentUserPerson;n.fileImageLibraryEntry=e;n.Description=t.Description==null||t.Description==""?n.file.name.split(".").shift():t.Description;h=!1;f=n.file.name.split(".").pop().toLowerCase();(f=="jpg"||f=="png"||f=="gif"||f=="bmp")&&(h=!0);h&&(n.thumbnailUrl=u+"downloads/imagekey?ImageKey="+t.ImageKey);o||(i.imageKeys.push(e.ImageKey),i.addUploadFunction()(e.ImageKey));n.Ordinal=ot++;s(function(){$("textarea").each(function(n,t){t.style.height="1px";t.style.height=15+t.scrollHeight+"px"})},150);n.DescriptionModified=!0};i.removeUploaderItem=function(n){confirm("You have just chosen to remove and delete an upload!. Are you sure you want to do this?")&&(i.removeUploadFunction()(n.fileImageLibraryEntry.ImageKey),n.remove())};i.removePreviousFile=function(n){if(confirm("You have just chosen to remove and delete an upload!. Are you sure you want to do this?")){for(var t=0;t<i.fileImageLibraryData.length;t++)i.fileImageLibraryData[t].ImageKey==n.ImageKey&&i.fileImageLibraryData.splice(t,1);i.removeUploadFunction()(n.ImageKey)}};r.onErrorItem=function(){};r.onCancelItem=function(){};r.onCompleteItem=function(){};r.onCompleteAll=function(){};s(function(){o.SetPanelDimensions()},100);e.bindTo(n).add({combo:"esc",allowIn:["INPUT","SELECT","TEXTAREA"],callback:function(){i.SaveAllModifiedDescriptions();s(function(){f.go("^")},150)}})};return b.$inject=["$scope"],{restrict:"E",templateUrl:"angular/common/directives/panels/fileUploadListDirectiveTemplate.html?"+Date.now(),scope:{imageKeys:"=",listTitle:"@",removeUploadFunction:"&",updateDescriptionFunction:"&",addUploadFunction:"&",hideCloseButton:"=",mode:"@"},controllerAs:"vm",controller:b,bindToController:!0}}])}(),function(){var n=angular.module("app");n.directive("personnelSelectorList",["odataService","personnelService","utilityService","$odata","dataCache","$state","hotkeys","displaySetupService","$timeout",function(n,t,i,r,u,f,e,o,s){var h=function(n){function u(n){if(r.people){for(var t=0;t<r.people.length;t++)if(r.people[t].MasterId==n.MasterId)return!0;return!1}return!1}var r=this;r.stateName=f.current.name;r.personnelService=t;console.log("personnelSelectorList directive - vm.people = %O",r.people);r.SelectContact=function(n){t.GetPersonById(n.MasterId).then(function(n){console.log("Person Model from personnelService = %O",n);u(n)||(i.ReplaceItemInArrayById(r.people,n),r.addPersonFunction()(n));r.Person=null})};r.searchPeople=function(n){return n.length>2?(r.searchingPeople=!0,t.GenericSearch(n)):null};r.RemovePerson=function(n){i.RemoveItemFromArrayById(r.people,n);r.removePersonFunction()(n)};e.bindTo(n).add({combo:"esc",description:"Cancel and close any input form",allowIn:["INPUT","SELECT","TEXTAREA"],callback:function(){f.go("^")}});s(function(){o.SetPanelDimensions()},10)};return h.$inject=["$scope"],{restrict:"E",templateUrl:"angular/common/directives/panels/personnelSelectorListDirectiveTemplate.html?"+Date.now(),scope:{people:"=",listTitle:"@",removePersonFunction:"&",addPersonFunction:"&"},controllerAs:"vm",controller:h,bindToController:!0}}])}(),function(){angular.module("app").directive("sglclick",["$parse",function(n){return{restrict:"A",link:function(t,i,r){var e=n(r.sglclick),o=200,u=0,f=null;i.on("click",function(n){u++;u===1?f=setTimeout(function(){t.$apply(function(){e(t,{$event:n})});u=0},o):(clearTimeout(f),u=0)})}}}])}(),function(){angular.module("app").directive("systemForm",function(){return{restrict:"E",templateUrl:"app/directives/panels/systemForm.html?"+Date.now,replace:!0,scope:{name:"@"},transclude:!0}})}(),function(){angular.module("app").directive("systemFullscreenPanel",function(){return{restrict:"E",templateUrl:"angular/common/directives/panels/systemFullscreenPanel.html?"+Date.now,replace:!0,transclude:!0}})}(),function(){angular.module("app").directive("systemModalPanel",function(){return{restrict:"E",templateUrl:"angular/common/directives/panels/systemModalPanel.html?"+Date.now(),priority:-1,replace:!0,transclude:!0,scope:{maxWidth:"@"}}})}(),function(){angular.module("app").directive("systemPanelHeading",function(){return{restrict:"E",templateUrl:"angular/common/directives/panels/systemPanelHeading.html?"+Date.now,replace:!0,scope:{panelTitle:"@",panelSubTitle:"@",panelHeadingId:"@"},transclude:!0}})}(),function(){angular.module("app").directive("systemPanelHeadingButtons",function(){return{restrict:"E",templateUrl:"angular/common/directives/panels/systemPanelHeadingButtons.html?"+Date.now,replace:!0,transclude:!0}})}(),function(){angular.module("app").directive("systemStaticPanel",function(){return{restrict:"E",templateUrl:"angular/common/directives/panels/systemStaticPanel.html?"+Date.now,replace:!0,transclude:!0,scope:{maxPanelWidth:"@"}}})}(),function(){function n(n,t,i,r,u,f){var e=this;console.log("SystemIframeCtrl invoked");u.SetPanelDimensions();e.reportTitle=t.title;e.state=n;e.url=i.trustAsResourceUrl(t.url);console.log(t);r.$emit("dataLoaded",null);f(function(){u.SetPanelDimensions()},500)}angular.module("app").controller("SystemIframeCtrl",["$state","$stateParams","$sce","$scope","displaySetupService","$timeout","hotkeys",n])}(),function(){var n=angular.module("app");n.directive("bhsActiveAlarms",["dataService","utilityService","$state","hotkeys","displaySetupService","$timeout","$window","$interval","signalR",function(n,t,i,r,u,f,e,o){var s=function(r){function h(){if(e.widgetDimensions=u.GetWidgetPanelBodyDimensions(e.widget.Id),e.widgetDimensions){var n=e.widgetDimensions.width*a,t=e.widgetDimensions.height*a*1.5,i=n>t?t:n;e.largeTextSize=i;e.largeTextSize>v&&(e.largeTextSize=v)}}function c(i){n.GetIOPSWebAPIResource(e.diffDays>5?"BHSActiveAlarmSummaryByDayWithAverageDurationInSeconds":"BHSActiveAlarmSummaryByHourWithAverageDurationInSeconds").query({beginDate:e.dashboard.webApiParameterStartDate,endDate:e.dashboard.webApiParameterEndDate,siteId:81463},function(n){e.chartData=n.select(function(n){return[t.GetLocalDateFromUTCDate(new Date(n.AlarmDay||n.AlarmHour)).getTime(),n.AlarmCount]});i?(e.chart.series[0].setData(e.chartData),e.chart.setTitle({text:e.diffDays>5?"Alarms Per Day":"Alarms Per Hour"})):w();s(e.widget.Id,e.chart);h()})}function s(n,t){var i=u.GetWidgetPanelBodyDimensions(n);t&&i&&t.setSize(i.width*.8,i.height*.4-10,!1)}function w(){$(function(){u.SetWidgetPanelBodyDimensions(e.widget.Id);f(function(){b();s(e.widget.Id,e.chart)},100)})}function b(){try{e.chart=Highcharts.chart("containerBhsActiveAlarms"+e.widget.Id,{chart:{type:"spline",animation:!1,marginRight:10,events:{load:function(){e.chartSeries=this.series[0]}}},animation:!1,credits:{enabled:!1},title:{text:e.diffDays>5?"Alarms Per Day":"Alarms Per Hour",style:{fontSize:".8em"}},xAxis:{type:"datetime",dateTimeLabelFormats:{day:e.diffDays>5?"%m/%d":"%m/%d %H:00",month:"%b '%y"},labels:{autoRotation:[-10,-20,-30,-40,-50,-60,-70,-80,-90],style:{fontSize:"10px",fontFamily:"Verdana, sans-serif"}}},yAxis:{title:{text:""},plotLines:[{value:0,width:1,color:"#808080"}]},tooltip:{formatter:function(){return"<b>"+this.series.name+"<\/b><br/>"+Highcharts.dateFormat(e.diffDays>5?"%m/%d/%Y":"%m/%d/%Y %H:00",this.x)+"<br/>"+Highcharts.numberFormat(this.y,0)+" Alarms"}},legend:{enabled:!1},exporting:{enabled:!0},series:[{name:"Alarms",data:e.chartData}]})}catch(n){}}function k(){n.GetIOPSResource("BHSCurrentAlarms").query().$promise.then(function(n){n.forEach(function(n){p(n);l(n)});e.alarms=n.where(function(n){return n.TransactionType!="Inactive"&&n.Hide==0});u.SetPanelBodyWithIdHeight(e.widget.Id);o(function(){s(e.widget.Id,e.chart)},50,20)})}function l(n){!n.ReturnToNormalTime||n.ReturnToNormalTime.getTime()<1e3?(n.ReturnToNormalTime=null,n.Duration=t.GetElapsedTimeAsDisplayString(n.ActiveDateTime,new Date)):n.Duration=t.GetElapsedTimeAsDisplayString(n.ActiveDateTime,n.ReturnToNormalTime)}function p(n){n.ActiveDateTime=t.GetLocalDateFromUTCDateString(n.ActiveDateTime);n.AcknowledgeTime=t.GetLocalDateFromUTCDateString(n.AcknowledgeTime);n.ReturnToNormalTime&&(n.ReturnToNormalTime=t.GetLocalDateFromUTCDateString(n.ReturnToNormalTime));n.TransactionType=n.TransactionType.replace("Alarm ","")}var e=this,a=.01,v=20,y;r.$on("$destroy",function(){o.cancel(e.updateInterval)});r.$on("WidgetResize",function(n,t){(e.widget.Id==t||t==0)&&(u.SetPanelBodyWithIdHeight(e.widget.Id),s(e.widget.Id,e.chart),h())});r.$on("WidgetResize.Stop",function(n,t){(e.widget.Id==t||t==0)&&o(function(){u.SetPanelBodyWithIdHeight(e.widget.Id);s(e.widget.Id,e.chart);h()},50,20)});r.$on("Dashboard",function(n,t){if(console.log("bhsActiveAlarms Dashboard event. Modified Dashboard = %O",t),t.Id==e.dashboard.Id){e.dashboard=t;e.diffDays=Math.round(Math.abs((e.dashboard.derivedStartDate.getTime()-(new Date).getTime())/864e5));c(!0)}});e.state=i;Highcharts.setOptions({global:{useUTC:!1}});e.widgetDimensions=u.GetWidgetPanelBodyDimensions(e.widget.Id);y=864e5;e.diffDays=Math.round(Math.abs((e.dashboard.derivedStartDate.getTime()-(new Date).getTime())/y));c();r.$on("BHS.CurrentAlarm",function(t,i){i=n.GetJsonFromSignalR(i);p(i);l(i);e.alarms=[i].concat(e.alarms).distinct(function(n,t){return+n.Id==+t.Id}).where(function(n){return n.TransactionType!="Inactive"&&(!n.Hide||n.Hide==0)});c(!0)});r.$on("BHS.CurrentAlarm.Delete",function(t,i){i=n.GetJsonFromSignalR(i);console.log("BHS.CurrentAlarm.Delete event. Alarm = %O",i);e.alarms=e.alarms.where(function(n){return+i.Id!=+n.Id})});k();e.sortField="-ActiveDateTime";e.SetSortField=function(n){var t=performance.now();e.sortField=e.sortField.substr(1,50)==n||e.sortField==n?e.sortField.substr(0,1)=="-"?n:"-"+n:n};e.secondInterval=o(function(){e.alarms&&e.alarms.forEach(function(n){l(n)})},1e3);r.$on("$destroy",function(){o.cancel(e.secondInterval)})};return s.$inject=["$scope"],{restrict:"E",templateUrl:"app/widgetDirectives/bhsActiveAlarms.html?"+Date.now(),scope:{dashboard:"=",widget:"=",signalUpdateFunction:"&",setPanelHeadingColorFunction:"&",mode:"@"},controllerAs:"vm",controller:s,bindToController:!0}}])}(),function(){var n=angular.module("app");n.directive("bhsAlarmHistoryTable",["dataService","utilityService","$state","hotkeys","displaySetupService","$timeout","$window","$interval","signalR",function(n,t,i,r,u,f,e,o){var s=function(r){function h(n){n.ActiveDateTime=t.GetLocalDateFromUTCDateString(n.ActiveDateTime);n.AcknowledgeDateTime=t.GetLocalDateFromUTCDateString(n.AcknowledgeDateTime);n.InactiveDateTime&&(n.InactiveDateTime=t.GetLocalDateFromUTCDateString(n.InactiveDateTime));n.DurationActiveToAcknowledge=t.SecondsToString(n.DurationActiveToAcknowledgeSeconds);n.DurationActiveToInactive=t.SecondsToString(n.DurationActiveToInactiveSeconds)}function s(t){t||(t=999999999999);u.SetPanelBodyWithIdHeight(e.widget.Id);n.GetIOPSWebAPIResource("BHSAlarmsHistoryByAlarmTypeAndDateRangeWithDurationInSeconds").query({beginDate:e.dashboard.webApiParameterStartDate,endDate:e.dashboard.webApiParameterEndDate,siteId:81463,alarmType:"%"},function(n){e.data=n;n.forEach(function(n){h(n)});e.alarms=n;u.SetPanelBodyWithIdHeight(e.widget.Id);e.widgetDimensions=u.GetWidgetPanelBodyDimensions(e.widget.Id);r.$$postDigest(function(){f(function(){u.SetPanelBodyWithIdHeight(e.widget.Id)},1)})})}var e=this;e.state=i;e.alarms=[];e.widgetDimensions=u.GetWidgetPanelBodyDimensions(e.widget.Id);r.$on("BHS.AlarmHistory",function(){s()});r.$on("Dashboard",function(){s()});e.columnwidths={ActiveDateTime:10,BHSName:10,Location:12,Alarm:20,AcknowledgeDateTime:10,InactiveDateTime:10,DurationActiveToAcknowledgeSeconds:10,DurationActiveToInactiveSeconds:10};r.$on("BHS.AlarmHistory.Delete",function(t,i){i=n.GetJsonFromSignalR(i);console.log("BHS.CurrentAlarm.Delete event. Alarm = %O",i);e.alarms=e.alarms.where(function(n){return+i.Id!=+n.Id})});s();e.sortField="-ActiveDateTime";e.SetSortField=function(n){var t=performance.now();e.sortField=e.sortField.substr(1,50)==n||e.sortField==n?e.sortField.substr(0,1)=="-"?n:"-"+n:n};r.$on("Dashboard",function(n,t){t.Id==e.dashboard.Id&&(e.dashboard=t)});e.leastId=0;r.$on("WidgetResize",function(n,t){(e.widget.Id==t||t==0)&&(e.widgetDimensions=u.GetWidgetPanelBodyDimensions(e.widget.Id),u.SetPanelBodyWithIdHeight(e.widget.Id))});r.$on("WidgetResize.Stop",function(n,t){(e.widget.Id==t||t==0)&&o(function(){e.widgetDimensions=u.GetWidgetPanelBodyDimensions(e.widget.Id);u.SetPanelBodyWithIdHeight(e.widget.Id)},50,20)});e.scrolledToEnd=function(){console.log("Scrolled to end fired")}};return s.$inject=["$scope"],{restrict:"E",templateUrl:"app/widgetDirectives/bhsAlarmHistoryTable.html?"+Date.now(),scope:{dashboard:"=",widget:"=",widgetId:"@",signalUpdateFunction:"&",setPanelHeadingColorFunction:"&",mode:"@"},controllerAs:"vm",controller:s,bindToController:!0}}])}(),function(){var n=angular.module("app");n.directive("bhsBagDimensionerReadAccuracySummary",["dataService","utilityService","$state","hotkeys","displaySetupService","$timeout","$window","$interval","signalR",function(n,t,i,r,u,f,e,o){var s=function(t){function h(){n.GetIOPSWebAPIResource("BHSBagDimensionerPercentReadRateReportGroupedByDateRange").query({beginDate:r.dashboard.webApiParameterStartDate,endDate:r.dashboard.webApiParameterEndDate,siteId:81463},function(n){r.detailReadRates=n.take(n.length-1);r.summaryReadRates=n.skip(n.length-1).first();r.totalInGaugeReadsMessage=(r.summaryReadRates.PercentInGaugeReads||0)+"% In";r.totalOutOfGaugeReadsMessage=(r.summaryReadRates.PercentOutOfGaugeReads||0)+"% Out";r.widgetDimensions=u.GetWidgetPanelBodyDimensions(r.widget.Id);r.widgetDimensions&&(r.largeTextSize=r.widgetDimensions.width*s,r.largeTextSize>e&&(r.largeTextSize=e),f(function(){u.SetPanelBodyWithIdHeight(r.widget.Id)},100))});u.SetPanelBodyWithIdHeight(r.widget.Id)}var r=this,s=.0055,e=3;t.$on("Dashboard",function(n,t){t.Id==r.dashboard.Id&&(r.dashboard=t,r.overallGoodReadRate=null,r.overallFailedReadRate=null,r.scannerReadRates=null,h())});r.state=i;Highcharts.setOptions({global:{useUTC:!1}});h();r.updateInterval=o(function(){h()},12e4);t.$on("$destroy",function(){o.cancel(r.updateInterval)});t.$on("WidgetResize",function(n,t){(r.widget.Id==t||t==0)&&(u.SetPanelBodyWithIdHeight(r.widget.Id),r.widgetDimensions=u.GetWidgetPanelBodyDimensions(r.widget.Id),r.largeTextSize=r.widgetDimensions.width*s,r.largeTextSize>e&&(r.largeTextSize=e))});t.$on("WidgetResize.Stop",function(n,t){(r.widget.Id==t||t==0)&&o(function(){u.SetPanelBodyWithIdHeight(r.widget.Id);r.widgetDimensions=u.GetWidgetPanelBodyDimensions(r.widget.Id);r.largeTextSize=r.widgetDimensions.width*s;r.largeTextSize>e&&(r.largeTextSize=e)},50,20)})};return s.$inject=["$scope"],{restrict:"E",templateUrl:"app/widgetDirectives/bhsBagDimensionerReadAccuracySummary.html?"+Date.now(),scope:{dashboard:"=",widget:"=",signalUpdateFunction:"&",setPanelHeadingColorFunction:"&",mode:"@"},controllerAs:"vm",controller:s,bindToController:!0}}])}(),function(){var n=angular.module("app");n.directive("bhsBagJamsWithHistoryChart",["dataService","utilityService","$state","hotkeys","displaySetupService","$timeout","$window","$interval","signalR",function(n,t,i,r,u,f,e,o){var s=function(r){function h(){if(e.widgetDimensions=u.GetWidgetPanelBodyDimensions(e.widget.Id),e.widgetDimensions){var n=e.widgetDimensions.width*a,t=e.widgetDimensions.height*a*1.5,i=n>t?t:n;e.largeTextSize=i;e.largeTextSize>v&&(e.largeTextSize=v)}}function c(i){n.GetIOPSWebAPIResource(e.diffDays>5?"BHSActiveAlarmSummaryByAlarmTypeAndDayWithAverageDurationInSeconds":"BHSActiveAlarmSummaryByAlarmTypeAndHourWithAverageDurationInSeconds").query({beginDate:e.dashboard.webApiParameterStartDate,endDate:e.dashboard.webApiParameterEndDate,siteId:81463,alarmType:"Jam"},function(n){e.chartData=n.select(function(n){return[t.GetLocalDateFromUTCDate(new Date(n.AlarmDay||n.AlarmHour)).getTime(),n.AlarmCount]});i?(e.chart.series[0].setData(e.chartData),e.chart.setTitle({text:e.diffDays>5?"Jams Per Day":"Jams Per Hour"})):w();s(e.widget.Id,e.chart);h()})}function s(n,t){var i=u.GetWidgetPanelBodyDimensions(n);t&&i&&t.setSize(i.width*.8,i.height*.4-10,!1)}function w(){$(function(){u.SetWidgetPanelBodyDimensions(e.widget.Id);f(function(){b();s(e.widget.Id,e.chart)},100)})}function b(){try{e.chart=Highcharts.chart("containerBhsBagJamsWithHistoryChart"+e.widget.Id,{chart:{type:"spline",animation:!1,marginRight:10,events:{load:function(){e.chartSeries=this.series[0]}}},animation:!1,credits:{enabled:!1},title:{text:e.diffDays>5?"Jams Per Day":"Jams Per Hour",style:{fontSize:".8em"}},xAxis:{type:"datetime",dateTimeLabelFormats:{day:e.diffDays>5?"%m/%d":"%m/%d %H:00",month:"%b '%y"},labels:{autoRotation:[-10,-20,-30,-40,-50,-60,-70,-80,-90],style:{fontSize:"10px",fontFamily:"Verdana, sans-serif"}}},yAxis:{title:{text:""},plotLines:[{value:0,width:1,color:"#808080"}]},tooltip:{formatter:function(){return"<b>"+this.series.name+"<\/b><br/>"+Highcharts.dateFormat(e.diffDays>5?"%m/%d/%Y":"%m/%d/%Y %H:00",this.x)+"<br/>"+Highcharts.numberFormat(this.y,0)+" Jams"}},legend:{enabled:!1},exporting:{enabled:!0},series:[{name:"Jams",data:e.chartData}]})}catch(n){}}function k(){n.GetIOPSResource("BHSCurrentAlarms").filter("Description","Jam").query().$promise.then(function(n){n.forEach(function(n){p(n);l(n)});e.alarms=n.where(function(n){return n.TransactionType!="Inactive"});u.SetPanelBodyWithIdHeight(e.widget.Id);o(function(){s(e.widget.Id,e.chart)},50,20)})}function l(n){!n.ReturnToNormalTime||n.ReturnToNormalTime.getTime()<1e3?(n.ReturnToNormalTime=null,n.Duration=t.GetElapsedTimeAsDisplayString(n.ActiveDateTime,new Date)):n.Duration=t.GetElapsedTimeAsDisplayString(n.ActiveDateTime,n.ReturnToNormalTime)}function p(n){n.ActiveDateTime=t.GetLocalDateFromUTCDateString(n.ActiveDateTime);n.AcknowledgeTime=t.GetLocalDateFromUTCDateString(n.AcknowledgeTime);n.ReturnToNormalTime&&(n.ReturnToNormalTime=t.GetLocalDateFromUTCDateString(n.ReturnToNormalTime));n.TransactionType=n.TransactionType.replace("Alarm ","")}var e=this,a=.01,v=20,y;r.$on("$destroy",function(){o.cancel(e.updateInterval)});r.$on("WidgetResize",function(n,t){(e.widget.Id==t||t==0)&&(u.SetPanelBodyWithIdHeight(e.widget.Id),s(e.widget.Id,e.chart),h())});r.$on("WidgetResize.Stop",function(n,t){(e.widget.Id==t||t==0)&&o(function(){u.SetPanelBodyWithIdHeight(e.widget.Id);s(e.widget.Id,e.chart);h()},50,20)});r.$on("Dashboard",function(n,t){if(t.Id==e.dashboard.Id){e.dashboard=t;e.diffDays=Math.round(Math.abs((e.dashboard.derivedStartDate.getTime()-(new Date).getTime())/864e5));c(!0)}});e.state=i;Highcharts.setOptions({global:{useUTC:!1}});e.widgetDimensions=u.GetWidgetPanelBodyDimensions(e.widget.Id);y=864e5;e.diffDays=Math.round(Math.abs((e.dashboard.derivedStartDate.getTime()-(new Date).getTime())/y));c();r.$on("BHS.CurrentAlarm",function(t,i){i=n.GetJsonFromSignalR(i);p(i);l(i);e.alarms=[i].concat(e.alarms).distinct(function(n,t){return+n.Id==+t.Id}).where(function(n){return n.TransactionType!="Inactive"&&n.Description=="Jam"});c(!0)});r.$on("BHS.CurrentAlarm.Delete",function(t,i){i=n.GetJsonFromSignalR(i);e.alarms=e.alarms.where(function(n){return+i.Id!=+n.Id})});k();e.sortField="-ActiveDateTime";e.SetSortField=function(n){var t=performance.now();e.sortField=e.sortField.substr(1,50)==n||e.sortField==n?e.sortField.substr(0,1)=="-"?n:"-"+n:n};e.secondInterval=o(function(){e.alarms&&e.alarms.forEach(function(n){l(n)})},1e3);r.$on("$destroy",function(){o.cancel(e.secondInterval)})};return s.$inject=["$scope"],{restrict:"E",templateUrl:"app/widgetDirectives/bhsBagJamsWithHistoryChart.html?"+Date.now(),scope:{dashboard:"=",widget:"=",signalUpdateFunction:"&",setPanelHeadingColorFunction:"&",mode:"@"},controllerAs:"vm",controller:s,bindToController:!0}}])}(),function(){var n=angular.module("app");n.directive("bhsCurrentAlarmsTable",["dataService","utilityService","$state","hotkeys","displaySetupService","$timeout","$window","$interval","signalR",function(n,t,i,r,u,f,e,o){var s=function(r){function h(){n.GetIOPSResource("BHSCurrentAlarms").query().$promise.then(function(n){n.forEach(function(n){s(n);e(n)});f.alarms=n.where(function(n){return n.TransactionType!="Inactive"});u.SetPanelBodyWithIdHeight(f.widget.Id)})}function e(n){!n.ReturnToNormalTime||n.ReturnToNormalTime.getTime()<1e3?(n.ReturnToNormalTime=null,n.Duration=t.GetElapsedTimeAsDisplayString(n.ActiveDateTime,new Date)):n.Duration=t.GetElapsedTimeAsDisplayString(n.ActiveDateTime,n.ReturnToNormalTime)}function s(n){n.ActiveDateTime=t.GetLocalDateFromUTCDateString(n.ActiveDateTime);n.AcknowledgeTime=t.GetLocalDateFromUTCDateString(n.AcknowledgeTime);n.ReturnToNormalTime&&(n.ReturnToNormalTime=t.GetLocalDateFromUTCDateString(n.ReturnToNormalTime));n.TransactionType=n.TransactionType.replace("Alarm ","")}var f=this;f.state=i;console.log("bhsCurrentAlarmsTable widgetId = %O",f.widget.Id);r.$on("BHS.CurrentAlarm",function(t,i){i=n.GetJsonFromSignalR(i);s(i);e(i);f.alarms=[i].concat(f.alarms).distinct(function(n,t){return+n.Id==+t.Id}).where(function(n){return n.TransactionType!="Inactive"})});r.$on("BHS.CurrentAlarm.Delete",function(t,i){i=n.GetJsonFromSignalR(i);console.log("BHS.CurrentAlarm.Delete event. Alarm = %O",i);f.alarms=f.alarms.where(function(n){return+i.Id!=+n.Id})});h();f.sortField="-ActiveDateTime";f.SetSortField=function(n){var t=performance.now();f.sortField=f.sortField.substr(1,50)==n||f.sortField==n?f.sortField.substr(0,1)=="-"?n:"-"+n:n};f.secondInterval=o(function(){f.alarms&&f.alarms.forEach(function(n){e(n)})},1e3);r.$on("$destroy",function(){o.cancel(f.secondInterval)});r.$on("WidgetResize",function(n,t){(f.widget.Id==t||t==0)&&u.SetPanelBodyWithIdHeight(f.widget.Id)});r.$on("WidgetResize.Stop",function(n,t){(f.widget.Id==t||t==0)&&o(function(){u.SetPanelBodyWithIdHeight(f.widget.Id)},50,20)})};return s.$inject=["$scope"],{restrict:"E",templateUrl:"app/widgetDirectives/bhsCurrentAlarmsTable.html?"+Date.now(),scope:{widget:"=",dashboard:"=",signalUpdateFunction:"&",setPanelHeadingColorFunction:"&",mode:"@"},controllerAs:"vm",controller:s,bindToController:!0}}])}(),function(){var n=angular.module("app");n.directive("bhsJamAlarmsTable",["dataService","utilityService","$state","hotkeys","displaySetupService","$timeout","$window","$interval","signalR",function(n,t,i,r,u,f,e,o){var s=function(r){function e(){n.GetIOPSResource("BHSJamAlarms").orderBy("Id","desc").take(100).query().$promise.then(function(n){console.log("data from OData Source = %O",angular.copy(n));n.forEach(function(n){n.AlarmDateTime=t.GetLocalDateFromUTCDateString(n.AlarmDateTime);n.ReturnToNormalTime&&(n.ReturnToNormalTime=t.GetLocalDateFromUTCDateString(n.ReturnToNormalTime));(n.TransactionType=="Alarm Active"||n.TransactionType=="Alarm Acknowledge")&&(n.ReturnToNormalTime&&n.ReturnToNormalTime.getTime()<1e3?(n.ReturnToNormalTime=null,(n.TransactionType=="Alarm Active"||n.TransactionType=="Alarm Acknowledge")&&(n.Duration=moment.utc(moment(new Date,"DD/MM/YYYY HH:mm:ss").diff(moment(n.AlarmDateTime,"DD/MM/YYYY HH:mm:ss"))).format("HH:mm:ss"))):n.Duration=moment.utc(moment(n.ReturnToNormalTime,"DD/MM/YYYY HH:mm:ss").diff(moment(n.AlarmDateTime,"DD/MM/YYYY HH:mm:ss"))).format("HH:mm:ss"))});f.alarms=n;u.SetPanelBodyWithIdHeight(f.widget.Id)})}var f=this;f.state=i;e();f.sortField="-AlarmDateTime";f.SetSortField=function(n){var t=performance.now();f.sortField.substr(1,50)==n||f.sortField==n?f.sortField.substr(0,1)=="-"?(f.sortField=n,f.alarms=f.alarms.orderBy(function(t){return t[n]})):(f.sortField="-"+n,f.alarms=f.alarms.orderByDescending(function(t){return t[n]})):(f.sortField=n,f.alarms=f.alarms.orderBy(function(t){return t[n]}))};f.secondInterval=o(function(){f.alarms&&f.alarms.forEach(function(n){(n.TransactionType=="Alarm Active"||n.TransactionType=="Alarm Acknowledge")&&(!n.ReturnToNormalTime||n.ReturnToNormalTime.getTime()<1e3?(n.ReturnToNormalTime=null,n.Duration=moment.utc(moment(new Date,"DD/MM/YYYY HH:mm:ss").diff(moment(n.AlarmDateTime,"DD/MM/YYYY HH:mm:ss"))).format("HH:mm:ss")):n.Duration=moment.utc(moment(n.ReturnToNormalTime,"DD/MM/YYYY HH:mm:ss").diff(moment(n.AlarmDateTime,"DD/MM/YYYY HH:mm:ss"))).format("HH:mm:ss"))})},1e3);r.$on("$destroy",function(){o.cancel(f.secondInterval)});r.$on("WidgetResize",function(n,t){(f.widget.Id==t||t==0)&&u.SetPanelBodyWithIdHeight(f.widget.Id)});r.$on("WidgetResize.Stop",function(n,t){(f.widget.Id==t||t==0)&&o(function(){u.SetPanelBodyWithIdHeight(f.widget.Id)},50,20)});r.$on("BHS.JamAlarm",function(i,r){var u=n.GetJsonFromSignalR(r);u.AlarmDateTime=t.GetLocalDateFromUTCDateString(u.AlarmDateTime);u.ReturnToNormalTime=t.GetLocalDateFromUTCDateString(u.ReturnToNormalTime);(u.TransactionType=="Alarm Active"||u.TransactionType=="Alarm Acknowledge")&&(u.ReturnToNormalTime.getTime()<1e3?(u.ReturnToNormalTime=null,u.Duration=moment.utc(moment(new Date,"DD/MM/YYYY HH:mm:ss").diff(moment(u.AlarmDateTime,"DD/MM/YYYY HH:mm:ss"))).format("HH:mm:ss")):u.Duration=moment.utc(moment(u.ReturnToNormalTime,"DD/MM/YYYY HH:mm:ss").diff(moment(u.AlarmDateTime,"DD/MM/YYYY HH:mm:ss"))).format("HH:mm:ss"));f.alarms=[u].concat(f.alarms).distinct(function(n,t){return n.Id==t.Id}).orderByDescending(function(n){return n.Id})})};return s.$inject=["$scope"],{restrict:"E",templateUrl:"app/widgetDirectives/bhsJamAlarmsTable.html?"+Date.now(),scope:{imageKeys:"=",signalUpdateFunction:"&",setPanelHeadingColorFunction:"&",mode:"@"},controllerAs:"vm",controller:s,bindToController:!0}}])}(),function(){var n=angular.module("app");n.directive("bhsPercentBagsToCbra",["dataService","utilityService","$state","hotkeys","displaySetupService","$timeout","$window","$interval","signalR",function(n,t,i,r,u,f,e,o){var s=function(t){function e(t){n.GetIOPSWebAPIResource("BHSPercentCBRAPerDay").query({beginDate:r.dashboard.webApiParameterStartDate,endDate:r.dashboard.webApiParameterEndDate,siteId:81463},function(n){console.log("BHSPercentCBRAPerDay initial data = %O",n);t?(n.forEach(function(n){r.chart.series[0].data.first(function(t){return t.category==n.BHSName}).update(n.TotalCBRABags,!1)}),r.chart.redraw()):$(function(){u.SetWidgetPanelBodyDimensions(r.widget.Id);f(function(){s(n);f(function(){u.SetWidgetPanelBodyDimensions(r.widget.Id);u.SetLoneChartSize(r.widget.Id,r.chart)},50)},50)});r.data=n})}function s(t){var i={chart:{type:"bar",renderTo:"bhsPercentBagsToCbra"+r.widget.Id},animation:!1,credits:{enabled:!1},title:{text:"Percent Bags to CBRA",style:{fontSize:".8em"}},xAxis:{type:"category",categories:t.select(function(n){return n.BHSName}),labels:{autoRotation:[-10,-20,-30,-40,-50,-60,-70,-80,-90],style:{fontSize:"10px",wordWrap:"break word",fontFamily:"Verdana, sans-serif"}}},yAxis:{min:0,title:{text:"",style:{fontSize:"10px"}},stackLabels:{enabled:!0,style:{fontWeight:"bold"}}},legend:{enabled:!1},tooltip:{pointFormat:"CBRA Bags : <b>{point.y:.0f} <\/b><br/>Click for details"},plotOptions:{stacking:"normal",bar:{dataLabels:{enabled:!0}},series:{cursor:"pointer",point:{events:{click:function(t){console.log("this = %O",this);console.log("window = %O",window);var i=this.category,u=this;n.GetIOPSWebAPIResource("BHSPercentCBRAPerDay").query({beginDate:r.dashboard.webApiParameterStartDate,endDate:r.dashboard.webApiParameterEndDate,siteId:81463},function(n){console.log("data from OData Source = %O",angular.copy(n));hs.htmlExpand(null,{pageOrigin:{x:t.pageX||t.clientX,y:t.pageY||t.clientY},headingText:"CBRA Percent of Bags",maincontentText:"<table class='table table-condensed table-striped' style='font-size: .75em;'><thead><th>Area-Date<\/th><th>Total Bag Count<\/th><th>CBRA Bags<\/th><th>CBRA Percent<\/th><\/thead><tbody>"+n.select(function(n){return"<tr><td>"+n.BHSName+"<td>"+n.TokenCount+"<td>"+n.TotalCBRABags+"<td>"+n.CBRAPercentOfTotal+"%<\/tr>"}).join("")+"<\/tbody><\/table>",width:500,height:window.outerHeight*.3})})}}},marker:{lineWidth:1}}},series:[{data:t.select(function(n){return n.TotalCBRABags})}]};r.chart=Highcharts.chart("bhsPercentBagsToCbra"+r.widget.Id,i)}var r=this;t.$on("WidgetResize",function(n,t){(r.widget.Id==t||t==0)&&u.SetLoneChartSize(r.widget.Id,r.chart)});t.$on("WidgetResize.Stop",function(n,t){(r.widget.Id==t||t==0)&&o(function(){u.SetLoneChartSize(r.widget.Id,r.chart)},50,20)});t.$on("Dashboard",function(n,t){t.Id==r.dashboard.Id&&(r.dashboard=t,e(!1))});r.state=i;Highcharts.setOptions({global:{useUTC:!1}});e();t.$on("System.ClockTick15",function(){e()})};return s.$inject=["$scope"],{restrict:"E",templateUrl:"app/widgetDirectives/bhsPercentBagsToCbra.html?"+Date.now(),scope:{dashboard:"=",widget:"=",signalUpdateFunction:"&",setPanelHeadingColorFunction:"&",mode:"@"},controllerAs:"vm",controller:s,bindToController:!0}}])}(),function(){var n=angular.module("app");n.directive("bhsPercentOfFailsafe",["dataService","utilityService","$state","hotkeys","displaySetupService","$timeout","$window","$interval","signalR",function(n,t,i,r,u,f,e,o){var s=function(r){function s(i){n.GetIOPSWebAPIResource(e.diffDays>5?"BHSPercentOfFailSafePerDay":"BHSPercentOfFailSafePerHour").query({beginDate:e.dashboard.webApiParameterStartDate,endDate:e.dashboard.webApiParameterEndDate,siteId:81463},function(n){console.log("data = %O",n);var r=n.select(function(n){return{BHSName:n.BHSName,TimeWindow:t.GetLocalDateFromUTCDate(n.Hour||n.Day),NormalBagCount:n.PEBagCount-n.AlarmCount,FailsafeBagCount:n.AlarmCount,PercentFailsafe:n.Percent}}).orderBy(function(n){return n.BHSName}).thenBy(function(n){return n.TimeWindow});console.log("FormattedData = %O",r);i?(n.forEach(function(n){e.chart.series[0].data.first(function(t){return t.category==n.DeviceName}).update(n.AlarmCount,!1)}),e.chart.redraw()):$(function(){u.SetWidgetPanelBodyDimensions(e.widget.Id);f(function(){c(n);f(function(){u.SetWidgetPanelBodyDimensions(e.widget.Id);u.SetLoneChartSize(e.widget.Id,e.chart)},50)},50)});e.data=n})}function c(n){var i={chart:{type:"spline",renderTo:"bhsPercentOfFailsafe"+e.widget.Id},animation:!1,credits:{enabled:!1},title:{text:"Percent of Failsafe Bags",style:{fontSize:".8em"}},xAxis:{type:"category",categories:n.select(function(n){return n.AlarmType+" ("+n.DeviceNameList+")"}),labels:{autoRotation:[-10,-20,-30,-40,-50,-60,-70,-80,-90],style:{fontSize:"10px",wordWrap:"break word",fontFamily:"Verdana, sans-serif"}}},yAxis:{min:0,title:{text:"",style:{fontSize:"10px"}},stackLabels:{enabled:!0,style:{fontWeight:"bold"}},tickInterval:3600,labels:{formatter:function(){var n=this.value/3600;return n==0?"":n+" Hr"}}},legend:{enabled:!1},tooltip:{pointFormat:"Longest Duration: <b>{point.y:.0f} seconds<\/b>"},plotOptions:{stacking:"normal",bar:{dataLabels:{color:"black",align:"center",enabled:!0,borderRadius:5,backgroundColor:"rgba(255,255,255, .5)",borderWidth:1,borderColor:"#aaa",style:{fontSize:".85em",fontWeight:"normal"},formatter:function(){return t.SecondsToString(this.y)}}}},series:[{data:n.select(function(n){return n.MaxDurationSec})}]};try{e.chart=Highcharts.chart("bhsPercentOfFailsafe"+e.widget.Id,i)}catch(r){}}var e=this,h;console.log("bhsPercentOfFailsafe controller invoked");r.$on("WidgetResize",function(n,t){(e.widget.Id==t||t==0)&&u.SetLoneChartSize(e.widget.Id,e.chart)});r.$on("WidgetResize.Stop",function(n,t){(e.widget.Id==t||t==0)&&o(function(){u.SetLoneChartSize(e.widget.Id,e.chart)},50,20)});r.$on("Dashboard",function(n,t){if(t.Id==e.dashboard.Id){e.dashboard=t;e.diffDays=Math.round(Math.abs((e.dashboard.derivedStartDate.getTime()-(new Date).getTime())/864e5));s(!1)}});e.state=i;h=864e5;e.diffDays=Math.round(Math.abs((e.dashboard.derivedStartDate.getTime()-(new Date).getTime())/h));s();e.updateInterval=o(function(){s()},12e4);r.$on("$destroy",function(){o.cancel(e.updateInterval)})};return s.$inject=["$scope"],{restrict:"E",templateUrl:"app/widgetDirectives/bhsPercentOfFailsafe.html?"+Date.now(),scope:{dashboard:"=",widget:"=",signalUpdateFunction:"&",setPanelHeadingColorFunction:"&",mode:"@"},controllerAs:"vm",controller:s,bindToController:!0}}])}(),function(){var n=angular.module("app");n.directive("bhsReadRatesHistoryChart",["dataService","utilityService","$state","hotkeys","displaySetupService","$timeout","$window","$interval","signalR",function(n,t,i,r,u,f,e,o){var s=function(r){function c(){e.diffDays=Math.round(Math.abs((e.dashboard.derivedStartDate.getTime()-(new Date).getTime())/864e5))}function s(n){var t=u.GetDivDimensionsById(n.ChartContainerId);n.ChartObject&&n.ChartObject.setSize(t.width,t.height-30,!1)}function h(i){n.GetIOPSWebAPIResource(e.diffDays>5?"BHSAutomaticTokenReaderPercentReadRateReportGroupedByDay":"BHSAutomaticTokenReaderPercentReadRateReportGroupedByHour").query({beginDate:e.dashboard.webApiParameterStartDate,endDate:e.dashboard.webApiParameterEndDate,siteId:81463},function(n){var r=n.groupBy(function(n){return n.Location}).orderBy(function(n){return n.key}).select(function(n){var r={Scanner:n.key,ChartObject:null,ChartContainerId:"chartContainer-"+e.widget.Id+"-"+n.key,Data:n.orderBy(function(n){return n.ScanHour||n.ScanDay}).select(function(n){return{TimeWindow:t.GetLocalDateFromUTCDate(n.ScanHour||n.ScanDay),TimeWindowAsString:"",BadReads:n.BadReads,GoodReads:n.GoodReads,PercentFailedReads:n.PercentFailedReads,PercentGoodReads:n.PercentReads,TotalReads:n.TotalReads}})};return r.totalGoodReads=r.Data.sum(function(n){return n.GoodReads}),r.totalBadReads=r.Data.sum(function(n){return n.BadReads}),(!e.data||i)&&f(function(){u.SetWidgetPanelBodyDimensions(e.widget.Id);r.ChartObject=l(r);s(r)}),r});!e.data||i?e.data=r:e.data.forEach(function(n){var t=r.first(function(t){return t.Scanner==n.Scanner});n.Data=t.Data;n.ChartObject.series[0].setData(t.Data.select(function(n){return{y:n.GoodReads}}));n.ChartObject.series[1].setData(t.Data.select(function(n){return{y:n.BadReads}}))})})}function l(n){try{return Highcharts.chart(n.ChartContainerId,{chart:{type:"area"},title:{text:n.Scanner+" - Read Rate "+(e.diffDays>5?"Per Day":"Per Hour")+" - "+n.totalGoodReads+" Good Reads - "+n.totalBadReads+" Bad Reads",style:{fontSize:".8em"}},animation:!1,credits:{enabled:!1},xAxis:{dateTimeLabelFormats:{day:e.diffDays>5?"%m/%d":"%m/%d %H:00",month:"%b '%y"},labels:{autoRotation:[-10,-20,-30,-40,-50,-60,-70,-80,-90],style:{fontSize:"10px",fontFamily:"Verdana, sans-serif"}},categories:n.Data.select(function(n){return e.diffDays>5?moment(n.TimeWindow).format("MM/DD"):moment(n.TimeWindow).format("MM/DD HH:00")}),tickmarkPlacement:"on",title:{enabled:!1}},yAxis:{title:{text:""},visible:!1},tooltip:{pointFormat:"<span>{series.name}<\/span>: <b>{point.percentage:.1f}%<\/b> ({point.y:,.0f} Times)<br/>",split:!0,hideDelay:2e3},plotOptions:{series:{animation:!1},area:{stacking:"percent",lineColor:"#ffffff",lineWidth:1,marker:{lineWidth:1,lineColor:"#ffffff"}}},legend:{enabled:!1},series:[{name:"Good Reads",data:n.Data.select(function(n){return{y:n.GoodReads}}),color:{linearGradient:{x1:0,y1:0,x2:0,y2:1},stops:[[0,"#bbbbbb"],[1,"#ffffff"]]}},{name:"Failed Reads",data:n.Data.select(function(n){return{y:n.BadReads}}),color:{linearGradient:{x1:0,y1:0,x2:0,y2:1},stops:[[0,"#ff0000"],[1,"#f4a4a4"]]}}]})}catch(t){}}var e=this;u.SetWidgetPanelBodyDimensions(e.widget.Id);c();r.$on("Dashboard",function(n,t){t.Id==e.dashboard.Id&&(e.dashboard=t,c(),h(!0))});r.$on("WidgetResize",function(n,t){(e.widget.Id==t||t==0)&&e.data.forEach(function(n){s(n)})});r.$on("WidgetResize.Stop",function(n,t){(e.widget.Id==t||t==0)&&o(function(){e.data.forEach(function(n){s(n)})},100,40)});e.state=i;e.widgetDimensions=u.GetWidgetPanelBodyDimensions(e.widget.Id);u.SetWidgetPanelBodyDimensions(e.widget.Id);h(!1);e.updateInterval=o(function(){h()},12e4);r.$on("$destroy",function(){o.cancel(e.updateInterval)})};return s.$inject=["$scope"],{restrict:"E",templateUrl:"app/widgetDirectives/bhsReadRatesHistoryChart.html?"+Date.now(),scope:{dashboard:"=",widget:"=",signalUpdateFunction:"&",setPanelHeadingColorFunction:"&",mode:"@"},controllerAs:"vm",controller:s,bindToController:!0}}])}(),function(){var n=angular.module("app");n.directive("bhsReadRatesSummary",["dataService","utilityService","$state","hotkeys","displaySetupService","$timeout","$window","$interval","signalR",function(n,t,i,r,u,f,e,o){var s=function(t){function s(){n.GetIOPSWebAPIResource("BHSAutomaticTokenReaderPercentReadRateReportGroupedByDateRange").query({beginDate:r.dashboard.webApiParameterStartDate,endDate:r.dashboard.webApiParameterEndDate,siteId:81463},function(n){r.scannerReadRates=n.skip(1);r.overallGoodReadRate=(n[0].PercentGoodReads||0)+"% - "+(n[0].GoodReads||0)+" Reads";r.overallFailedReadRate=(n[0].PercentFailedReads||0)+"% - "+(n[0].BadReads||0)+" Reads";r.widgetDimensions=u.GetWidgetPanelBodyDimensions(r.widget.Id);r.widgetDimensions&&(r.largeTextSize=r.widgetDimensions.width*e,r.largeTextSize>f&&(r.largeTextSize=f),r.data=n,u.SetPanelBodyWithIdHeight(r.widget.Id))});u.SetPanelBodyWithIdHeight(r.widget.Id)}var r=this,e=.003,f=8;t.$on("Dashboard",function(n,t){t.Id==r.dashboard.Id&&(r.dashboard=t,r.overallGoodReadRate=null,r.overallFailedReadRate=null,r.scannerReadRates=null,s())});r.state=i;Highcharts.setOptions({global:{useUTC:!1}});r.widgetDimensions=u.GetWidgetPanelBodyDimensions(r.widget.Id);s();r.updateInterval=o(function(){s()},12e4);t.$on("$destroy",function(){o.cancel(r.updateInterval)});t.$on("WidgetResize",function(n,t){(r.widget.Id==t||t==0)&&(u.SetPanelBodyWithIdHeight(r.widget.Id),r.widgetDimensions=u.GetWidgetPanelBodyDimensions(r.widget.Id),r.largeTextSize=r.widgetDimensions.width*e,r.largeTextSize>f&&(r.largeTextSize=f))});t.$on("WidgetResize.Stop",function(n,t){(r.widget.Id==t||t==0)&&o(function(){r.data.forEach(function(){u.SetPanelBodyWithIdHeight(r.widget.Id);r.widgetDimensions=u.GetWidgetPanelBodyDimensions(r.widget.Id);r.largeTextSize=r.widgetDimensions.width*e;r.largeTextSize>f&&(r.largeTextSize=f)})},50,20)})};return s.$inject=["$scope"],{restrict:"E",templateUrl:"app/widgetDirectives/bhsReadRatesSummary.html?"+Date.now(),scope:{dashboard:"=",widget:"=",signalUpdateFunction:"&",setPanelHeadingColorFunction:"&",mode:"@"},controllerAs:"vm",controller:s,bindToController:!0}}])}(),function(){var n=angular.module("app");n.directive("bhsSystemBagsProcessed",["dataService","utilityService","$state","hotkeys","displaySetupService","$timeout","$window","$interval","signalR",function(n,t,i,r,u,f,e,o){var s=function(t){function e(){return{beginDate:r.dashboard.webApiParameterStartDate,endDate:r.dashboard.webApiParameterEndDate,siteId:81463}}function h(t){n.GetIOPSWebAPIResource("BHSTotalSystemThroughput").query(e(),function(n){r.data=n;t?l(n):c()})}function c(){$(function(){u.SetWidgetPanelBodyDimensions(r.widget.Id);f(function(){a();u.SetLoneChartSize(r.widget.Id,r.chart)},100)})}function a(){var n={chart:{type:"column"},colors:["#e5e04c","#849d8c","#8085e9","#f15c80","#e4d354","#2b908f","#f45b5b","#91e8e1"],animation:!1,credits:{enabled:!1},title:{text:"",style:{fontSize:".8em"}},xAxis:{type:"category",labels:{autoRotation:[-10,-20,-30,-40,-50,-60,-70,-80,-90],style:{fontSize:"10px",fontFamily:"Verdana, sans-serif"}},categories:r.data.select(function(n){return n.Location}).distinct()},yAxis:{allowDecimals:!1,min:0,title:{text:""},stackLabels:{enabled:!0,style:{fontWeight:"bold","font-size":".8em",color:Highcharts.theme&&Highcharts.theme.textColor||"gray"}}},plotOptions:{column:{stacking:"normal",dataLabels:{color:"black",align:"center",shadow:!0,enabled:!0,borderRadius:5,backgroundColor:"rgba(255,255,255, 1)",style:{fontSize:".75em",fontWeight:"normal"},formatter:function(){return this.y!=0?this.y:null}}},legend:{enabled:!0},tooltip:{enabled:!1,headerFormat:"<b>{point.x}<\/b><br/>",pointFormat:"{series.name}:<br/>Bags: {point.stackTotal}"},series:{cursor:"pointer",point:{events:{click:function(n){console.log("this = %O",this);console.log("window = %O",window);var t=this.category,i=this;hs.htmlExpand(null,{pageOrigin:{x:n.pageX||n.clientX,y:n.pageY||n.clientY},headingText:"Data Details",maincontentText:"<table class='table table-condensed table-striped' style='font-size: .75em;'><thead><th>System<\/th><th>Array<\/th><th>Count<\/th><\/thead><tbody>"+r.data.select(function(n){return"<tr><td>"+n.BHSName+"<\/td><td>"+n.Location+"<\/td><td>"+n.BagCount+"<\/td><\/tr>"}).join("")+"<\/tbody><\/table>",width:800})}}},marker:{lineWidth:1}}},series:r.data.select(function(n){return n.BHSName}).distinct().select(function(n){return{name:n,data:r.data.where(function(t){return t.BHSName==n}).select(function(n){return n.BagCount})}})};try{r.chart=Highcharts.chart("bhsSystemBagsProcessed"+r.widget.Id,n)}catch(t){}}function v(){n.GetIOPSWebAPIResource("BHSTotalSystemThroughput").query(e(),function(n){r.data&&r.data.length==n.length?(r.data=n,l(n)):(r.data=n,c())})}function l(n){r.data=n;r.locationCategoryIndex=0;r.bhsCounter=0;r.data.select(function(n){return n.Location}).distinct().forEach(function(n){r.data.select(function(n){return n.BHSName}).distinct().forEach(function(t){var i=r.data.first(function(i){return i.Location==n&&i.BHSName==t}),f=i?i.BagCount:0,u;r.chart&&r.chart.series&&(u=r.chart.series[r.bhsCounter++].data[r.locationCategoryIndex],u.update(f,!1))});r.bhsCounter=0;r.locationCategoryIndex++});r.chart.redraw();r.bhsCounter=0;r.locationCategoryIndex=0}var r=this,s;t.$on("WidgetResize",function(n,t){(r.widget.Id==t||t==0)&&u.SetLoneChartSize(r.widget.Id,r.chart)});t.$on("WidgetResize.Stop",function(n,t){(r.widget.Id==t||t==0)&&o(function(){u.SetLoneChartSize(r.widget.Id,r.chart)},50,20)});t.$on("Dashboard",function(n,t){if(console.log("bhsSystemBagsProcessed Dashboard event. Modified Dashboard = %O",t),t.Id==r.dashboard.Id){r.dashboard=t;r.diffDays=Math.round(Math.abs((r.dashboard.derivedStartDate.getTime()-(new Date).getTime())/864e5));h(!0)}});r.state=i;Highcharts.setOptions({global:{useUTC:!1}});r.widgetDimensions=u.GetWidgetPanelBodyDimensions(r.widget.Id);s=864e5;r.diffDays=Math.round(Math.abs((r.dashboard.derivedStartDate.getTime()-(new Date).getTime())/s));h();r.updateInterval=o(function(){v()},12e4);t.$on("$destroy",function(){o.cancel(r.updateInterval)})};return s.$inject=["$scope"],{restrict:"E",templateUrl:"app/widgetDirectives/bhsSystemBagsProcessed.html?"+Date.now(),scope:{dashboard:"=",widget:"=",signalUpdateFunction:"&",setPanelHeadingColorFunction:"&",mode:"@"},controllerAs:"vm",controller:s,bindToController:!0}}])}(),function(){var n=angular.module("app");n.directive("bhsTopFiveAlarmAreas",["dataService","utilityService","$state","hotkeys","displaySetupService","$timeout","$window","$interval","signalR",function(n,t,i,r,u,f,e,o){var s=function(r){function s(t){var i={beginDate:e.dashboard.webApiParameterStartDate,endDate:e.dashboard.webApiParameterEndDate,siteId:81463};n.GetIOPSWebAPIResource("BHSAlarmAreaCount").query(i,function(n){n=n.orderByDescending(function(n){return n.AlarmCount}).take(5).orderBy(function(n){return n.Area});t?(n.forEach(function(n){e.chart.series[0].data.first(function(t){return t.category==n.BHSName+" - "+n.Area}).update(n.AlarmCount,!1)}),e.chart.redraw()):$(function(){u.SetWidgetPanelBodyDimensions(e.widget.Id);f(function(){h(n);u.SetLoneChartSize(e.widget.Id,e.chart)},100)});e.data=n})}function h(i){var r={chart:{type:"bar",renderTo:"bhsTopFiveAlarmAreas"+e.widget.Id},animation:!1,credits:{enabled:!1},title:{text:"Top 5 Alarm Areas",style:{fontSize:".8em"}},xAxis:{type:"category",categories:i.select(function(n){return n.BHSName+" - "+n.Area}),labels:{autoRotation:[-10,-20,-30,-40,-50,-60,-70,-80,-90],style:{fontSize:"10px",wordWrap:"break word",fontFamily:"Verdana, sans-serif"}}},yAxis:{min:0,title:{text:"",style:{fontSize:"10px"}},stackLabels:{enabled:!0,style:{fontWeight:"bold"}}},legend:{enabled:!1},tooltip:{pointFormat:"Alarm Count: <b>{point.y:.0f} Alarms<\/b><br/>Click for details"},plotOptions:{stacking:"normal",bar:{dataLabels:{enabled:!0}},series:{cursor:"pointer",point:{events:{click:function(i){console.log("this = %O",this);console.log("window = %O",window);var r=this.category,f=r.split(" - ")[0],o=r.split(" - ")[1],u=this;n.GetIOPSWebAPIResource("BHSAlarmAreaCountDetails").query({beginDate:e.dashboard.webApiParameterStartDate,endDate:e.dashboard.webApiParameterEndDate,bhsName:f,area:o,siteId:81463},function(n){n=n.orderBy(function(n){return n.ActiveDateTime});var r=hs.htmlExpand(null,{pageOrigin:{x:i.pageX||i.clientX,y:i.pageY||i.clientY},headingText:u.y+" Total Alarms for "+u.category,maincontentText:"<table class='table table-condensed table-striped' style='font-size: .75em;'><thead><th>Active Date<\/th><th>Alarm<\/th><th>Device<\/th><th>Duration<\/th><\/thead><tbody>"+n.select(function(n){return"<tr><td>"+t.GetFormattedLocalDisplayDateFromUTCDate(n.ActiveDateTime)+"<\/td><td>"+n.Alarm+"<\/td><td>"+n.DeviceNameList+"<\/td><td>"+t.SecondsToString(n.duration)+"<\/td><\/tr>"}).join("")+"<\/tbody><\/table>",width:800,height:window.outerHeight*.6})})}}},marker:{lineWidth:1}}},series:[{data:i.select(function(n){return n.AlarmCount})}]};try{e.chart=Highcharts.chart("bhsTopFiveAlarmAreas"+e.widget.Id,r)}catch(u){}}var e=this;r.$on("WidgetResize",function(n,t){(e.widget.Id==t||t==0)&&u.SetLoneChartSize(e.widget.Id,e.chart)});r.$on("WidgetResize.Stop",function(n,t){(e.widget.Id==t||t==0)&&o(function(){u.SetLoneChartSize(e.widget.Id,e.chart)},50,20)});r.$on("Dashboard",function(n,t){t.Id==e.dashboard.Id&&(e.dashboard=t,s(!1))});e.state=i;Highcharts.setOptions({global:{useUTC:!1}});s();e.updateInterval=o(function(){s()},12e4);r.$on("$destroy",function(){o.cancel(e.updateInterval)})};return s.$inject=["$scope"],{restrict:"E",templateUrl:"app/widgetDirectives/bhsTopFiveAlarmAreas.html?"+Date.now(),scope:{dashboard:"=",widget:"=",signalUpdateFunction:"&",setPanelHeadingColorFunction:"&",mode:"@"},controllerAs:"vm",controller:s,bindToController:!0}}])}(),function(){var n=angular.module("app");n.directive("bhsTopFiveAlarmDurations",["dataService","utilityService","$state","hotkeys","displaySetupService","$timeout","$window","$interval","signalR",function(n,t,i,r,u,f,e,o){var s=function(r){function s(t){n.GetIOPSWebAPIResource("BHSTop5AlarmTypeLongestDuration").query({beginDate:e.dashboard.webApiParameterStartDate,endDate:e.dashboard.webApiParameterEndDate,siteId:81463},function(n){t?(n.forEach(function(n){e.chart.series[0].data.first(function(t){return t.category==n.AlarmType+" ("+n.DeviceNameList+")"}).update(n.MaxDurationSec,!1)}),e.chart.redraw()):$(function(){u.SetWidgetPanelBodyDimensions(e.widget.Id);f(function(){h(n);u.SetLoneChartSize(e.widget.Id,e.chart)},100)});e.data=n})}function h(n){var i={chart:{type:"bar",renderTo:"bhsTopFiveAlarmDurations"+e.widget.Id},animation:!1,credits:{enabled:!1},title:{text:"Top 5 Alarm Durations",style:{fontSize:".8em"}},xAxis:{type:"category",categories:n.select(function(n){return n.AlarmType+" ("+n.DeviceNameList+")"}),labels:{autoRotation:[-10,-20,-30,-40,-50,-60,-70,-80,-90],style:{fontSize:"10px",wordWrap:"break word",fontFamily:"Verdana, sans-serif"}}},yAxis:{min:0,title:{text:"",style:{fontSize:"10px"}},stackLabels:{enabled:!0,style:{fontWeight:"bold"}},tickInterval:3600,labels:{formatter:function(){var n=this.value/3600;return n==0?"":n+" Hr"}}},legend:{enabled:!1},tooltip:{pointFormat:"Longest Duration: <b>{point.y:.0f} seconds<\/b>"},plotOptions:{stacking:"normal",bar:{dataLabels:{color:"black",align:"center",enabled:!0,borderRadius:5,backgroundColor:"rgba(255,255,255, .5)",borderWidth:1,borderColor:"#aaa",style:{fontSize:".85em",fontWeight:"normal"},formatter:function(){return t.SecondsToString(this.y)}}}},series:[{data:n.select(function(n){return n.MaxDurationSec})}]};try{e.chart=Highcharts.chart("bhsTopFiveAlarmDurations"+e.widget.Id,i)}catch(r){}}var e=this;r.$on("WidgetResize",function(n,t){(e.widget.Id==t||t==0)&&u.SetLoneChartSize(e.widget.Id,e.chart)});r.$on("WidgetResize.Stop",function(n,t){(e.widget.Id==t||t==0)&&o(function(){u.SetLoneChartSize(e.widget.Id,e.chart)},50,20)});r.$on("Dashboard",function(n,t){t.Id==e.dashboard.Id&&(e.dashboard=t,s(!1))});e.state=i;Highcharts.setOptions({global:{useUTC:!1}});s();e.updateInterval=o(function(){s()},12e4);r.$on("$destroy",function(){o.cancel(e.updateInterval)})};return s.$inject=["$scope"],{restrict:"E",templateUrl:"app/widgetDirectives/bhsTopFiveAlarmDurations.html?"+Date.now(),scope:{dashboard:"=",widget:"=",signalUpdateFunction:"&",setPanelHeadingColorFunction:"&",mode:"@"},controllerAs:"vm",controller:s,bindToController:!0}}])}(),function(){var n=angular.module("app");n.directive("bhsTopFiveAlarmTypes",["dataService","utilityService","$state","hotkeys","displaySetupService","$timeout","$window","$interval","signalR",function(n,t,i,r,u,f,e,o){var s=function(r){function s(t){n.GetIOPSWebAPIResource("BHSTop5AlarmTypes").query({beginDate:e.dashboard.webApiParameterStartDate,endDate:e.dashboard.webApiParameterEndDate,siteId:81463},function(n){t?(n.forEach(function(n){e.chart.series[0].data.first(function(t){return t.category==n.AlarmType}).update(n.AlarmCount,!1)}),e.chart.redraw()):$(function(){u.SetWidgetPanelBodyDimensions(e.widget.Id);f(function(){h(n);u.SetLoneChartSize(e.widget.Id,e.chart)},100)});e.data=n})}function h(i){var r={chart:{type:"bar",renderTo:"bhsTopFiveAlarmTypes"+e.widget.Id},animation:!1,credits:{enabled:!1},title:{text:"Top 5 Alarm Types",style:{fontSize:".8em"}},xAxis:{type:"category",categories:i.select(function(n){return n.AlarmType}),labels:{autoRotation:[-10,-20,-30,-40,-50,-60,-70,-80,-90],style:{fontSize:"10px",wordWrap:"break word",fontFamily:"Verdana, sans-serif"}}},yAxis:{min:0,title:{text:"",style:{fontSize:"10px"}},stackLabels:{enabled:!0,style:{fontWeight:"bold"}}},legend:{enabled:!1},tooltip:{pointFormat:"Alarm Count: <b>{point.y:.0f} Alarms<\/b><br/>Click for details"},plotOptions:{stacking:"normal",bar:{dataLabels:{enabled:!0}},series:{cursor:"pointer",point:{events:{click:function(i){console.log("this = %O",this);console.log("window = %O",window);var u=this.category,r=this;n.GetIOPSResource("BHSAlarmHistories").orderBy("Id","desc").filter("ActiveDateTime","!=",null).filter("ActiveDateTime",">",e.dashboard.webApiParameterStartDate).filter("ActiveDateTime","<",e.dashboard.webApiParameterEndDate).filter("Alarm",u).query().$promise.then(function(n){hs.htmlExpand(null,{pageOrigin:{x:i.pageX||i.clientX,y:i.pageY||i.clientY},headingText:r.y+" "+r.category+"s",maincontentText:"<table class='table table-condensed table-striped' style='font-size: .75em;'><thead><th>Active Date<\/th><th>Location<\/th><th>Acknowledge Time<\/th><\/thead><tbody>"+n.select(function(n){return"<tr><td>"+t.GetFormattedLocalDisplayDateFromUTCDate(n.ActiveDateTime)+"<\/td><td>"+n.Location+"<\/td><td>"+t.GetFormattedLocalDisplayDateFromUTCDate(n.AcknowledgeTime||"")+"<\/td><\/tr>"}).join("")+"<\/tbody><\/table>",width:800,height:window.outerHeight*.6})})}}},marker:{lineWidth:1}}},series:[{data:i.select(function(n){return n.AlarmCount})}]};try{e.chart=Highcharts.chart("bhsTopFiveAlarmTypes"+e.widget.Id,r)}catch(u){}}var e=this;r.$on("WidgetResize",function(n,t){(e.widget.Id==t||t==0)&&u.SetLoneChartSize(e.widget.Id,e.chart)});r.$on("WidgetResize.Stop",function(n,t){(e.widget.Id==t||t==0)&&o(function(){u.SetLoneChartSize(e.widget.Id,e.chart)},50,20)});r.$on("Dashboard",function(n,t){console.log("bhsTopFiveAlarmTypes Dashboard event. Modified Dashboard = %O",t);t.Id==e.dashboard.Id&&(e.dashboard=t,s(!1))});e.state=i;Highcharts.setOptions({global:{useUTC:!1}});n.GetIOPSWebAPIResource("Top5ObservationExceptions").query({beginDate:e.dashboard.webApiParameterStartDate,endDate:e.dashboard.webApiParameterEndDate,siteId:2},function(n){console.log("Top5ObservationExceptions initial data = %O",n)});s();e.updateInterval=o(function(){s()},12e4);r.$on("$destroy",function(){o.cancel(e.updateInterval)})};return s.$inject=["$scope"],{restrict:"E",templateUrl:"app/widgetDirectives/bhsTopFiveAlarmTypes.html?"+Date.now(),scope:{dashboard:"=",widget:"=",signalUpdateFunction:"&",setPanelHeadingColorFunction:"&",mode:"@"},controllerAs:"vm",controller:s,bindToController:!0}}])}(),function(){var n=angular.module("app");n.directive("bhsTopFiveJamDevicesWithCount",["dataService","utilityService","$state","hotkeys","displaySetupService","$timeout","$window","$interval","signalR",function(n,t,i,r,u,f,e,o){var s=function(t){function e(t){n.GetIOPSWebAPIResource("BHSTop5JamDevicesWithCount").query({beginDate:r.dashboard.webApiParameterStartDate,endDate:r.dashboard.webApiParameterEndDate,siteId:81463},function(n){t?(n.forEach(function(n){r.chart.series[0].data.first(function(t){return t.category==n.DeviceName}).update(n.AlarmCount,!1)}),r.chart.redraw()):$(function(){u.SetWidgetPanelBodyDimensions(r.widget.Id);f(function(){s(n);f(function(){u.SetWidgetPanelBodyDimensions(r.widget.Id);u.SetLoneChartSize(r.widget.Id,r.chart)},50)},50)});r.data=n})}function s(n){var t={chart:{type:"bar",renderTo:"bhsTopFiveJamDevicesWithCount"+r.widget.Id},animation:!1,credits:{enabled:!1},title:{text:"Top 5 Jam Alarm Devices - With Count",style:{fontSize:".8em"}},xAxis:{type:"category",categories:n.select(function(n){return n.DeviceName}),labels:{autoRotation:[-10,-20,-30,-40,-50,-60,-70,-80,-90],style:{fontSize:"10px",wordWrap:"break word",fontFamily:"Verdana, sans-serif"}}},yAxis:{min:0,title:{text:"",style:{fontSize:"10px"}},stackLabels:{enabled:!0,style:{fontWeight:"bold"}}},legend:{enabled:!1},tooltip:{pointFormat:"Alarm Count: <b>{point.y:.0f} Alarms<\/b>"},plotOptions:{stacking:"normal",bar:{dataLabels:{enabled:!0}}},series:[{data:n.select(function(n){return n.AlarmCount})}]};try{r.chart=Highcharts.chart("bhsTopFiveJamDevicesWithCount"+r.widget.Id,t)}catch(i){}}var r=this;t.$on("WidgetResize",function(n,t){(r.widget.Id==t||t==0)&&u.SetLoneChartSize(r.widget.Id,r.chart)});t.$on("WidgetResize.Stop",function(n,t){(r.widget.Id==t||t==0)&&o(function(){u.SetLoneChartSize(r.widget.Id,r.chart)},50,20)});t.$on("Dashboard",function(n,t){console.log("bhsTopFiveJamDevicesWithCount Dashboard event. Modified Dashboard = %O",t);t.Id==r.dashboard.Id&&(r.dashboard=t,e(!1))});r.state=i;Highcharts.setOptions({global:{useUTC:!1}});e();r.updateInterval=o(function(){e()},12e4);t.$on("$destroy",function(){o.cancel(r.updateInterval)})};return s.$inject=["$scope"],{restrict:"E",templateUrl:"app/widgetDirectives/bhsTopFiveJamDevicesWithCount.html?"+Date.now(),scope:{dashboard:"=",widget:"=",signalUpdateFunction:"&",setPanelHeadingColorFunction:"&",mode:"@"},controllerAs:"vm",controller:s,bindToController:!0}}])}(),function(){var n=angular.module("app");n.directive("bhsTopFiveJamDevicesWithLongestDuration",["dataService","utilityService","$state","hotkeys","displaySetupService","$timeout","$window","$interval","signalR",function(n,t,i,r,u,f,e,o){var s=function(r){function s(t){n.GetIOPSWebAPIResource("BHSTop5JamDevicesWithLongestDuration").query({beginDate:e.dashboard.webApiParameterStartDate,endDate:e.dashboard.webApiParameterEndDate,siteId:81463},function(n){t?(n.forEach(function(n){e.chart.series[0].data.first(function(t){return t.category==n.DeviceName}).update(n.AlarmCount,!1)}),e.chart.redraw()):$(function(){u.SetWidgetPanelBodyDimensions(e.widget.Id);f(function(){h(n);f(function(){u.SetWidgetPanelBodyDimensions(e.widget.Id);u.SetLoneChartSize(e.widget.Id,e.chart)},50)},50)});e.data=n})}function h(n){var i={chart:{type:"bar",renderTo:"bhsTopFiveJamDevicesWithCount"+e.widget.Id},animation:!1,credits:{enabled:!1},title:{text:"Top 5 Jam Alarm Devices - With Longest Durations",style:{fontSize:".8em"}},xAxis:{type:"category",categories:n.select(function(n){return n.DeviceName}),labels:{autoRotation:[-10,-20,-30,-40,-50,-60,-70,-80,-90],style:{fontSize:"10px",wordWrap:"break word",fontFamily:"Verdana, sans-serif"}}},yAxis:{min:0,title:{text:"",style:{fontSize:"10px"}},stackLabels:{enabled:!0,style:{fontWeight:"bold"}},tickInterval:3600,labels:{formatter:function(){var n=this.value/3600;return n==0?"":n+" Hr"}}},legend:{enabled:!1},tooltip:{pointFormat:"Longest Alarm Duration: <b>{point.y:.0f} Seconds<\/b><br/>Click for details"},plotOptions:{stacking:"normal",bar:{dataLabels:{color:"black",align:"center",enabled:!0,borderRadius:5,backgroundColor:"rgba(255,255,255, .5)",borderWidth:1,borderColor:"#aaa",style:{fontSize:".85em",fontWeight:"normal"},formatter:function(){return t.SecondsToString(this.y)}}},series:{cursor:"pointer",point:{events:{click:function(n){console.log("this = %O",this);console.log("window = %O",window);var i=this.category,t=this;hs.htmlExpand(null,{pageOrigin:{x:n.pageX||n.clientX,y:n.pageY||n.clientY},headingText:t.y+" "+t.category+"s",maincontentText:"<table class='table table-condensed table-striped' style='font-size: .75em;'><tr><td>Alarm Count<\/td><td>"+e.data.first(function(n){return n.DeviceName==t.category}).AlarmCount+"<\/td><\/tr><\/table>",width:150,height:250})}}},marker:{lineWidth:1}}},series:[{data:n.select(function(n){return n.MaxDurationSec})}]};console.log("chartOptions = %O",i);try{e.chart=Highcharts.chart("bhsTopFiveJamDevicesWithLongestDuration"+e.widget.Id,i)}catch(r){}}var e=this;r.$on("WidgetResize",function(n,t){(e.widget.Id==t||t==0)&&u.SetLoneChartSize(e.widget.Id,e.chart)});r.$on("WidgetResize.Stop",function(n,t){(e.widget.Id==t||t==0)&&o(function(){u.SetLoneChartSize(e.widget.Id,e.chart)},50,20)});r.$on("Dashboard",function(n,t){console.log("bhsTopFiveJamDevicesWithLongestDuration Dashboard event. Modified Dashboard = %O",t);t.Id==e.dashboard.Id&&(e.dashboard=t,s(!1))});e.state=i;Highcharts.setOptions({global:{useUTC:!1}});s();e.updateInterval=o(function(){s()},12e4);r.$on("$destroy",function(){o.cancel(e.updateInterval)})};return s.$inject=["$scope"],{restrict:"E",templateUrl:"app/widgetDirectives/bhsTopFiveJamDevicesWithLongestDuration.html?"+Date.now(),scope:{dashboard:"=",widget:"=",signalUpdateFunction:"&",setPanelHeadingColorFunction:"&",mode:"@"},controllerAs:"vm",controller:s,bindToController:!0}}])}(),function(){var n=angular.module("app");n.directive("bhsTopFiveJamTypeCount",["dataService","utilityService","$state","hotkeys","displaySetupService","$timeout","$window","$interval","signalR",function(n,t,i,r,u,f,e,o){var s=function(t){function e(t){n.GetIOPSWebAPIResource("BHSFilterByAlarmTypesbyArea").query({beginDate:r.dashboard.webApiParameterStartDate,endDate:r.dashboard.webApiParameterEndDate,alarmTypeList:"Jam",topNumber:5,siteId:81463},function(n){console.log("bhsTopFiveJamTypeCount initial data = %O",n);t?(n.forEach(function(n){r.chart.series[0].data.first(function(t){return t.category==n.Area}).update(n.AlarmCount,!1)}),r.chart.redraw()):$(function(){u.SetWidgetPanelBodyDimensions(r.widget.Id);f(function(){s(n);f(function(){u.SetWidgetPanelBodyDimensions(r.widget.Id);u.SetLoneChartSize(r.widget.Id,r.chart)},50)},50)});r.data=n})}function s(n){var t={chart:{type:"bar",renderTo:"bhsTopFiveJamTypeCount"+r.widget.Id},animation:!1,credits:{enabled:!1},title:{text:"Top 5 Jam Area",style:{fontSize:".8em"}},xAxis:{type:"category",categories:n.select(function(n){return n.Area}),labels:{autoRotation:[-10,-20,-30,-40,-50,-60,-70,-80,-90],style:{fontSize:"10px",wordWrap:"break word",fontFamily:"Verdana, sans-serif"}}},yAxis:{min:0,title:{text:"",style:{fontSize:"10px"}},stackLabels:{enabled:!0,style:{fontWeight:"bold"}}},legend:{enabled:!1},tooltip:{pointFormat:"Alarm Count: <b>{point.y:.0f} Alarms<\/b>"},plotOptions:{stacking:"normal",bar:{dataLabels:{enabled:!0}}},series:[{data:n.select(function(n){return n.AlarmCount})}]};r.chart=Highcharts.chart("bhsTopFiveJamTypeCount"+r.widget.Id,t)}var r=this;t.$on("WidgetResize",function(n,t){(r.widget.Id==t||t==0)&&u.SetLoneChartSize(r.widget.Id,r.chart)});t.$on("WidgetResize.Stop",function(n,t){(r.widget.Id==t||t==0)&&o(function(){u.SetLoneChartSize(r.widget.Id,r.chart)},50,20)});t.$on("Dashboard",function(n,t){t.Id==r.dashboard.Id&&(r.dashboard=t,e(!1))});r.state=i;Highcharts.setOptions({global:{useUTC:!1}});e();t.$on("System.ClockTick15",function(){e()})};return s.$inject=["$scope"],{restrict:"E",templateUrl:"app/widgetDirectives/bhsTopFiveJamTypeCount.html?"+Date.now(),scope:{dashboard:"=",widget:"=",signalUpdateFunction:"&",setPanelHeadingColorFunction:"&",mode:"@"},controllerAs:"vm",controller:s,bindToController:!0}}])}(),function(){var n=angular.module("app");n.directive("dashboard",["$rootScope","$state","displaySetupService","dataService","signalR","$interval","$stateParams","$timeout","$q","uibButtonConfig","utilityService",function(n,t,i,r,u,f,e,o,s,h){var c=function(e){function l(){}function k(){var n=c.widgets.where(function(n){return n.assetIds}).selectMany(function(n){return n.assetIds.split(",")}),t=c.widgets.select(function(n){return n.WidgetResource.AssetId}).where(function(n){return n}).concat(n).distinct().join(",");c.assetIdList=t}function a(){r.GetExpandedDashboardById(c.dashboardId).then(function(n){c.dashboard=n;c.dashboard.tagsToGraph=[];v()}).then(function(){r.GetIOPSResource("Widgets").filter("ParentDashboardId",c.dashboardId).filter("ParentWidgetId",null).expand("WidgetType").expand("EmbeddedDashboard").query().$promise.then(function(n){l(6);var t=n.select(function(n){return{sizeX:n.Width,sizeY:n.Height,row:n.Row,col:n.Col,prevRow:n.Row,prevCol:n.Col,Id:n.Id,Name:n.Name,WidgetResource:n,HasChanged:!1}}),u=t.where(function(n){return n.WidgetResource.AssetId}).select(function(n){return n.WidgetResource.AssetId+""}).join(",");console.log("Dashboard assetId list = "+u);r.GetAllSignalRObservationFormattedTagsForAssetIdIntoInventoryByListOfAssetIds(u,!1).then(function(){c.widgets=t;c.dashboard.widgets=c.widgets});l(7);c.widget?i.SetWidgetPanelBodyDimensions(c.widget.Id):i.SetPanelDimensions()})})}function v(){c.subTitle=c.dashboard.DashboardTimeScope?c.dashboard.DashboardTimeScope.Description:c.dashboard.CustomStartDate+" to "+c.dashboard.CustomEndDate}function y(n){r.GetJBTData().then(function(t){n.WidgetType=t.WidgetTypes.first(function(t){return t.Id==n.WidgetTypeId});var i={sizeX:n.Width,sizeY:n.Height,row:n.Row,col:n.Col,prevRow:n.Row,prevCol:n,Id:n.Id,Name:n.Name,WidgetResource:n,HasChanged:!1};c.widgets.push(i)})}function p(n){r.GetIOPSResource("Widgets").filter("Id",n.Id).query().$promise.then(function(t){var i=t[0];s.all([r.GetIOPSCollection("WidgetGraphTags","WidgetId",n.Id).then(function(n){return s.all(n.select(function(n){return n.Id=-n.Id,n.$save()}))})]).then(function(){i.Id=-i.Id;i.$save().then(function(){console.log("Widget Deleted");i.Id=-i.Id;u.SignalAllClients("Widget.Deleted",i)})})})}function w(n){(n.WidgetResource.$save&&!n.WidgetResource.EmbeddedDashboard?s.when(n.WidgetResource):r.GetIOPSResource("Widgets").filter("Id",n.Id).expand("WidgetType").query().$promise.then(function(t){return n.WidgetResource=t[0],n.WidgetResource})).then(function(t){n.WidgetResource=t;n.WidgetResource.Row=n.row;n.WidgetResource.Col=n.col;n.prevCol=n.col;n.prevRow=n.row;n.WidgetResource.Width=n.sizeX;n.WidgetResource.Height=n.sizeY;n.WidgetResource.$save().then(function(n){u.SignalAllClients("Widget",n)});c.widgets.where(function(t){return(t.col!=t.prevCol||t.row!=t.prevRow)&&t.Id!=n.Id}).forEach(function(n){n.WidgetResource.Row=n.row;n.WidgetResource.Col=n.col;n.prevCol=n.col;n.prevRow=n.row;n.WidgetResource.Width=n.sizeX;n.WidgetResource.Height=n.sizeY;n.WidgetResource.$save().then(function(n){u.SignalAllClients("Widget",n)})})})}function b(){c.widgets&&c.widgets.where(function(n){return n.col!=n.prevCol||n.row!=n.prevRow}).forEach(function(n){n.WidgetResource.Row=n.row;n.WidgetResource.Col=n.col;n.prevCol=n.col;n.prevRow=n.row;n.WidgetResource.Width=n.sizeX;n.WidgetResource.Height=n.sizeY;n.WidgetResource.$save().then(function(n){u.SignalAllClients("Widget.Updated",n)})})}var c=this;console.log("Dashboard directive invoked. $scope = %O",e);console.log("vm = %O",c);console.log("$scope = %O",e);c.widget?i.SetWidgetPanelBodyDimensions(c.widget.Id):i.SetPanelDimensions();l(1);c.openSettingsDash=function(n,i){t.go(".widgetSettings",{widget:i})};l(2);c.AddTagsToSpecificWidgetGraph=function(t){n.$broadcast("Widget.AddTagsToGraph",t)};c.AddTagsToGraph=function(t){c.dashboard.tagsToGraph=t.concat(c.dashboard.tagsToGraph).distinct(function(n,t){return n.TagId==t.TagId}).where(function(n){return n.Enabled});console.log("Dashboard vm.dashboard.tagsToGraph = %O",c.dashboard.tagsToGraph);c.dashboard.tagsToGraph.length>0?n.$broadcast("Dashboard.TagsToGraph",c.dashboard.tagsToGraph):n.$broadcast("Dashboard.TagsToGraph",null)};l(3);c.AddGraphWidgetToDashboard=function(){r.GetIOPSCollection("WidgetTypes","AngularDirectiveName","tagGraph").then(function(t){var i=t[0];r.AddEntity("Widgets",{Name:"Tag History",WidgetTypeId:i.Id,ParentDashboardId:c.dashboard.Id,EmbeddedDashboardId:null,Width:i.InitialWidth,Height:i.InitialHeight,Row:0,Col:0}).then(function(t){s.all(c.dashboard.tagsToGraph.select(function(n){return r.AddEntity("WidgetGraphTags",{WidgetId:t.Id,TagId:n.TagId})})).then(function(){n.$broadcast("GraphWidgetAdded",t);c.dashboard.tagsToGraph=[]})})})};l(4);h.activeClass="radio-active";c.widget?(c.widget.WidgetResource.EmbeddedDashboard?(c.dashboardId=c.widget.WidgetResource.EmbeddedDashboard.Id,c.dashboard=c.widget.WidgetResource.EmbeddedDashboard,a(),i.SetWidgetPanelBodyDimensions(c.widget.Id)):c.widget.WidgetResource.EmbeddedDashboardId&&r.GetEntityById("Dashboards",c.widget.WidgetResource.EmbeddedDashboardId).then(function(n){c.dashboardId=n.Id;c.dashboard=n;a();i.SetWidgetPanelBodyDimensions(c.widget.Id)}),c.supressWidgetHeaders=!0):(c.dashboardId?c.dashboardId=+c.dashboardId:c.dashboard&&(c.dashboardId=c.dashboard.Id),c.supressWidgetHeaders=!1,a());l(5);c.CamelCaseToSnakeCase=function(n){return n.replace(/([A-Z])/g,function(n){return"-"+n.toLowerCase()})};c.openSettings=function(n){return console.log("Opening Settings. widget = %O",n),hs.htmlExpand(this,{contentId:"highslide-html"+n.Id,headingText:n.Name+" Settings"})};c.fullscreen=!1;c.screenSwitchClass="static-panel";c.ToggleFullScreen=function(){c.fullscreen=!c.fullscreen;c.screenSwitchClass=c.fullscreen?"fullscreen-panel":"static-panel";e.$$postDigest(function(){f(function(){n.$broadcast("WidgetResize",0);i.SetPanelDimensions()},25,10)})};e.$on("Dashboard",function(n,t){t.Id==c.dashboardId&&(c.dashboard=t,v())});c.SetTimeScope=function(n){c.timeScopeDays=n;r.GetDashboardTimeScopes().then(function(t){var i=t.first(function(t){return t.Days==n});i&&(c.dashboard.DashboardTimeScope=i,c.dashboard.TimescopeId=i.Id,c.dashboard.CustomStartDate=null,c.dashboard.CustomEndDate=null,r.GetEntityById("Dashboards",c.dashboard.Id).then(function(n){n.TimeScopeId=i.Id;n.CustomStartDate=null;n.CustomEndDate=null;n.$save().then(function(){r.SetDashboardDerivedDatesFromDayCount(c.dashboard);u.SignalAllClients("Dashboard",c.dashboard)})}))})};c.timeScopeUpdateInterval=f(function(){r.SetDashboardDerivedDatesFromDayCount(c.dashboard)},1e3);e.$on("$destroy",function(){f.cancel(c.timeScopeUpdateInterval)});e.$on("WidgetAdded",function(n,t){console.log("Widget Event - widget passed = %O",t);t.ParentDashboardId==c.dashboardId&&y(t)});e.$on("GraphWidgetAdded",function(n,t){console.log("Widget Event");t.ParentDashboardId==c.dashboardId&&y(t)});e.$on("Widget.Deleted",function(n,t){console.log("Deleted widget = %O",t);console.log("vm.dashboard = %O",c.dashboard);t.ParentDashboardId==c.dashboard.Id&&(c.widgets=c.widgets.where(function(n){return n.Id!=t.Id}),c.dashboard.widgets=c.widgets,o(function(){b()},500))});e.$on("Dashboard.Deleted",function(n,i){i.Id==c.dashboardId&&t.go("^")});c.deleteWidget=function(n,t){if(t){alertify.set({labels:{ok:'Yes, Delete the "'+n.Name+'" Widget',cancel:"Cancel, I don't want to do this"},buttonFocus:"cancel"});var i='Are you SURE you want to delete the "'+n.Name+'" widget from this dashboard? ';alertify.confirm(i,function(t){t?p(n):toastr.info(n.Name,"Widget was NOT deleted!")})}else p(n)};c.gridsterOpts={columns:60,pushing:!0,floating:!0,swapping:!0,width:3800,colWidth:"auto",rowHeight:"match",margins:c.widget&&c.widget.WidgetResource.EmbeddedDashboard?[0,0]:[5,5],outerMargin:!0,sparse:!0,isMobile:!1,mobileBreakPoint:600,mobileModeEnabled:!0,minColumns:1,minRows:2,maxRows:5e3,defaultSizeX:2,defaultSizeY:1,minSizeX:1,maxSizeX:null,minSizeY:1,maxSizeY:null,resizable:{enabled:!0,handles:["n","e","s","w","ne","se","sw","nw"],start:function(){},resize:function(t,r,u){u.HasChanged=!0;i.SetPanelBodyWithIdHeight(u.Id);n.$broadcast("WidgetResize",u.Id)},stop:function(t,i,r){n.$broadcast("WidgetResize.Stop",r.Id);w(r)}},draggable:{enabled:!0,handle:".panel-heading",start:function(){},drag:function(n,t,i){i.HasChanged=!0},stop:function(n,t,i){w(i)}}};c.logWidget=function(n){console.log("Widget Clicked = %O",n)};c.saveChangeInterval=f(function(){b()},1e3);c.saveChangeInterval=f(function(){k();r.RefreshAllSignalRObservationFormattedTagsForAssetIdIntoInventoryByListOfAssetIds(c.assetIdList)},6e4);e.$on("$destroy",function(){f.cancel(c.saveChangeInterval)});c.LogWidget=function(n){console.log("Clicked Widget data = %O",n)}};return c.$inject=["$scope"],{restrict:"E",templateUrl:"app/widgetDirectives/dashboard.html?"+Date.now(),replace:!0,scope:{dashboardId:"=",dashboard:"=",widget:"=",signalUpdateFunction:"&",setPanelHeadingColorFunction:"&",mode:"@"},controllerAs:"vm",controller:c,bindToController:!0}}])}(),function(){function n(n,t,i,r,u,f,e,o,s,h,c,l,a,v){console.log("EditWidgetCtrl invoked");var y=this;y.state=t;y.bootstrapLabelColumns=4;y.bootstrapInputColumns=8;y.showScreen=!1;h.activeClass="radio-active";e.DashboardId<0&&(e.DashboardId=0);f.GetEntityById("Widgets",e.WidgetId).then(function(n){y.widget=n;y.showScreen=!0;console.log("widget = %O",y.widget)});c.bindTo(r).add({combo:"ctrl+s",description:"Save and Close any form data input form",allowIn:["INPUT","SELECT","TEXTAREA"],callback:function(){event.preventDefault();y.Save()}}).add({combo:"esc",description:"Cancel and close any input form",allowIn:["INPUT","SELECT","TEXTAREA"],callback:function(){t.go("^")}});y.Save=function(){y.widget.$save().then(function(n){v.SignalAllClients("Widget",n);t.go("^");s(function(){t.go("^");s(function(){t.go("home.app.dashboard",{DashboardId:e.DashboardId})},10)},10)})}}angular.module("app").controller("EditWidgetCtrl",["$q","$state","$rootScope","$scope","securityService","dataService","$stateParams","utilityService","$timeout","uibButtonConfig","hotkeys","$interval","displaySetupService","signalR",n])}(),function(){var n=angular.module("app");n.directive("gpuSummary",["$rootScope","dataService","utilityService","$state","hotkeys","displaySetupService","$timeout","$window","$interval","signalR","uibButtonConfig",function(n,t,i,r,u,f,e,o,s,h,c){var l=function(i){function v(){return" - "+u.Asset.Site.Name+" Gate "+u.Asset.ParentSystem.Name+(u.Asset.ModelGenericName?" - "+u.Asset.ModelGenericName:"")}function o(){var n=angular.copy(u.widget.WidgetResource);angular.equals(u.originalWidgetResource,n)||(u.widget.WidgetResource.$save(),u.originalWidgetResource=n)}function y(){t.GetJBTData().then(function(n){u.JBTData=n;u.gpu=u.JBTData.Assets.first(function(n){return n.ParentSystemId==u.widget.WidgetResource.GateSystemId&&n.Name=="GPU"});u.Asset=u.gpu;u.widget.WidgetResource.GateSystemId&&(u.GateSystem=u.JBTData.Systems.first(function(n){return n.Id==u.widget.WidgetResource.GateSystemId}));u.widget.WidgetResource.AssetId=u.gpu.Id;o();t.GetAllSignalRObservationFormattedTagsForAssetIdIntoInventory(u.gpu.Id).then(function(){u.AssetGraphics=t.cache.assetGraphics.where(function(n){return n.AssetId==u.gpu.Id});u.AssetGraphics.forEach(function(n){n.AssetGraphicVisibleValues=t.cache.assetGraphicVisibleValues.where(function(t){return t.AssetGraphicId==n.Id&&t.JBTStandardObservationId});n.showImage=!1});e(function(){b();l(5)},50);u.gpu.Tags.forEach(function(n){w(n)});u.atLeastOneGraphicIsVisible=a();u.widget.displaySettings.obscureGraphics=!a();p();u.widget.displaySettings.headingExtraTitle=v();u.GenerateVoltsCharts();u.GenerateAmpsCharts();var n=[4331,4445,4765,12255];u.alarms=u.gpu.Tags.where(function(t){return t.AssetId==u.widget.WidgetResource.AssetId&&t.IsAlarm&&!n.any(function(n){return n==t.JBTStandardObservationId})});u.warnings=u.gpu.Tags.where(function(n){return n.AssetId==u.widget.WidgetResource.AssetId&&n.IsWarning});u.commLossTag=u.gpu.Tags.first(function(t){return n.any(function(n){return n==t.JBTStandardObservationId})});u.widget.displaySettings.commLossTag=u.commLossTag;u.widget.searchText=u.widget.WidgetResource.DefaultSearchText||"";e(function(){u.showWidget=!0},200)})})}function l(n){s(function(){f.SetWidgetPanelBodyDimensions(u.widget.Id);var t=f.GetWidgetPanelBodyDimensions(u.widget.Id),i=f.GetDivDimensionsById("nav-pills"+u.widget.Id),n=0;t&&(n=u.widget.WidgetResource.IsModalPopUp?t.height-i.height-20:t.height-i.height-3,$("#tab-content"+u.widget.Id).css("height",n),$("#repeater-container-data"+u.widget.Id).css("height",n),$("#repeater-container-alarms"+u.widget.Id).css("height",n),$("#repeater-container-warnings"+u.widget.Id).css("height",n),u.showTags=!0)},50,n)}function p(){if(u.alarms&&u.alarms.length>0&&u.alarms.any(function(n){return n.ValueWhenActive==n.Value})){u.widget.displaySettings.headingBackground="linear-gradient(to bottom,#FF0000, #FFDDDD)";return}u.widget.displaySettings.headingBackground=a()&&(!u.commLossTag||u.commLossTag.Value!="1")?"linear-gradient(to bottom,#3eff3e, #eefeee)":"linear-gradient(to bottom,#dedede, #fefefe)"}function a(){return u.AssetGraphics?u.AssetGraphics.any(function(n){return n.showImage})||u.gpu.Tags.where(function(n){return n.JBTStandardObservationId==12246}).any(function(n){return+n.Value==1}):!1}function b(){u.splitterIsSetup||i.$$postDigest(function(){f.SetPanelBodyWithIdHeight(u.widget.Id);i.$$postDigest(function(){u.widget.WidgetResource.SplitLeftPercentage=u.widget.WidgetResource.SplitLeftPercentage||50;u.widget.WidgetResource.SplitRightPercentage=u.widget.WidgetResource.SplitRightPercentage||50;u.splitter=Split(["#containerData"+u.widget.Id,"#containerGraphics"+u.widget.Id],{elementStyle:function(n,t,i){return{"flex-basis":"calc("+t+"% - "+i+"px)"}},gutterStyle:function(n,t){return{"flex-basis":t+"px","background-image":"url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAUAAAAeCAYAAADkftS9AAAAIklEQVQoU2M4c+bMfxAGAgYYmwGrIIiDjrELjpo5aiZeMwF+yNnOs5KSvgAAAABJRU5ErkJggg==')","background-repeat":"no-repeat","background-position":"50%","background-color":"transparent",cursor:"col-resize"}},sizes:[u.widget.WidgetResource.SplitLeftPercentage,u.widget.WidgetResource.SplitRightPercentage],minSize:0,onDragEnd:function(){var n=u.splitter.getSizes();u.widget.WidgetResource.SplitLeftPercentage=n[0];u.widget.WidgetResource.SplitRightPercentage=n[1];o()}});u.splitterIsSetup=!0})})}function w(n){n&&u.gpu&&n.AssetId==u.gpu.Id&&u.AssetGraphics&&u.AssetGraphics.forEach(function(t){t.AssetGraphicVisibleValues.forEach(function(t){t.JBTStandardObservationId==n.JBTStandardObservationId&&(t.showImage=+n.Value==+t.ValueWhenVisible||n.Value==t.ValueWhenVisible)});t.showImage=t.AssetGraphicVisibleValues.length>0&&t.AssetGraphicVisibleValues.all(function(n){return n.showImage})});u.widget.displaySettings.obscureGraphics=!a()}function k(){u.ampsInAverageDataTag=u.gpu.Tags.where(function(n){return[2242].any(function(t){return t==n.JBTStandardObservationId})}).orderByDescending(function(n){return n.PLCLocalDate}).first();u.ampsInAverageDataTag&&(u.ampsInAverage=+u.ampsInAverageDataTag.Value)}function d(n){u.ampsInAverageDataTag&&n.TagId==u.ampsInAverageDataTag.TagId&&(u.ampsInAverage=+u.ampsInAverageDataTag.Value)}function g(){u.ampsOutAverageDataTag=u.gpu.Tags.where(function(n){return[1942].any(function(t){return t==n.JBTStandardObservationId})}).orderByDescending(function(n){return n.PLCLocalDate}).first();u.ampsOutAverageDataTag&&(u.ampsOutAverage=+u.ampsOutAverageDataTag.Value)}function nt(n){u.ampsOutAverageDataTag&&n.TagId==u.ampsOutAverageDataTag.TagId&&(u.ampsOutAverage=+u.ampsOutAverageDataTag.Value)}function tt(){u.phaseAAmpsOutDataTag=u.gpu.Tags.where(function(n){return[1857,4439].any(function(t){return t==n.JBTStandardObservationId})}).orderByDescending(function(n){return n.PLCLocalDate}).first();u.phaseAAmpsOutDataTag&&(u.phaseAAmpsOut=+u.phaseAAmpsOutDataTag.Value)}function it(n){u.phaseAAmpsOutDataTag&&n.TagId==u.phaseAAmpsOutDataTag.TagId&&(u.phaseAAmpsOut=+u.phaseAAmpsOutDataTag.Value)}function rt(){u.phaseBAmpsOutDataTag=u.gpu.Tags.where(function(n){return[1858,4441,2754].any(function(t){return t==n.JBTStandardObservationId})}).orderByDescending(function(n){return n.PLCLocalDate}).first();u.phaseBAmpsOutDataTag&&(u.phaseBAmpsOut=+u.phaseBAmpsOutDataTag.Value)}function ut(n){u.phaseBAmpsOutDataTag&&n.TagId==u.phaseBAmpsOutDataTag.TagId&&(u.phaseBAmpsOut=+u.phaseBAmpsOutDataTag.Value)}function ft(){u.phaseCAmpsOutDataTag=u.gpu.Tags.where(function(n){return[1859,4443].any(function(t){return t==n.JBTStandardObservationId})}).orderByDescending(function(n){return n.PLCLocalDate}).first();u.phaseCAmpsOutDataTag&&(u.phaseCAmpsOut=+u.phaseCAmpsOutDataTag.Value)}function et(n){u.phaseCAmpsOutDataTag&&n.TagId==u.phaseCAmpsOutDataTag.TagId&&(u.phaseCAmpsOut=+u.phaseCAmpsOutDataTag.Value)}function ot(){u.voltsInAverageDataTag=u.gpu.Tags.where(function(n){return[2244].any(function(t){return t==n.JBTStandardObservationId})}).orderByDescending(function(n){return n.PLCLocalDate}).first();u.voltsInAverageDataTag&&(u.voltsInAverage=+u.voltsInAverageDataTag.Value)}function st(n){u.voltsInAverageDataTag&&n.TagId==u.voltsInAverageDataTag.TagId&&(u.voltsInAverage=+u.voltsInAverageDataTag.Value)}function ht(){u.voltsOutAverageDataTag=u.gpu.Tags.where(function(n){return[1935].any(function(t){return t==n.JBTStandardObservationId})}).orderByDescending(function(n){return n.PLCLocalDate}).first();u.voltsOutAverageDataTag&&(u.voltsOutAverage=+u.voltsOutAverageDataTag.Value)}function ct(n){u.voltsOutAverageDataTag&&n.TagId==u.voltsOutAverageDataTag.TagId&&(u.voltsOutAverage=+u.voltsOutAverageDataTag.Value)}function lt(){u.phaseAVoltsOutDataTag=u.gpu.Tags.where(function(n){return[4440,1860].any(function(t){return t==n.JBTStandardObservationId})}).orderByDescending(function(n){return n.PLCLocalDate}).first();u.phaseAVoltsOutDataTag&&(u.phaseAVoltsOut=+u.phaseAVoltsOutDataTag.Value)}function at(n){u.phaseAVoltsOutDataTag&&n.TagId==u.phaseAVoltsOutDataTag.TagId&&(u.phaseAVoltsOut=+u.phaseAVoltsOutDataTag.Value)}function vt(){u.phaseBVoltsOutDataTag=u.gpu.Tags.where(function(n){return[4442,1861].any(function(t){return t==n.JBTStandardObservationId})}).orderByDescending(function(n){return n.PLCLocalDate}).first();u.phaseBVoltsOutDataTag&&(u.phaseBVoltsOut=+u.phaseBVoltsOutDataTag.Value)}function yt(n){u.phaseBVoltsOutDataTag&&n.TagId==u.phaseBVoltsOutDataTag.TagId&&(u.phaseBVoltsOut=+u.phaseBVoltsOutDataTag.Value)}function pt(){u.phaseCVoltsOutDataTag=u.gpu.Tags.where(function(n){return[4444,1862].any(function(t){return t==n.JBTStandardObservationId})}).orderByDescending(function(n){return n.PLCLocalDate}).first();u.phaseCVoltsOutDataTag&&(u.phaseCVoltsOut=+u.phaseCVoltsOutDataTag.Value)}function wt(n){u.phaseCVoltsOutDataTag&&n.TagId==u.phaseCVoltsOutDataTag.TagId&&(u.phaseCVoltsOut=+u.phaseCVoltsOutDataTag.Value)}var u=this;u.widget.headingBackground="linear-gradient(to bottom,#dedede, #fefefe)";u.widget.displaySettings={headingBackground:"linear-gradient(to bottom,#dedede, #fefefe)",tagDataSortField:"-PLCLocalDate",alarmDataSortField:"-PLCLocalDate",warningsDataSortField:"-PLCLocalDate",headingExtraTitle:"",obscureGraphics:!0,commLossTag:!1,headingSearchField:!0};u.scrolledToEnd=function(){};u.originalWidgetResource=angular.copy(u.widget.WidgetResource);u.tagsToGraph=[];u.alarmFilterFunction=function(n){return n.ValueWhenActive==n.Value};u.bootstrapLabelColumns=2;u.bootstrapInputColumns=10;c.activeClass="radio-active";u.user=Global.User;f.SetWidgetPanelBodyDimensions(u.widget.Id);u.showWidget=!1;u.SetSortField=function(n){var t=performance.now();u.widget.displaySettings.tagDataSortField=u.widget.displaySettings.tagDataSortField.substr(1,50)==n||u.widget.displaySettings.tagDataSortField==n?u.widget.displaySettings.tagDataSortField.substr(0,1)=="-"?n:"-"+n:n};u.OpenSettingsIfNoAssetAndCloseIfAssetIsPresent=function(){u.gpu||r.go(".widgetSettings",{widget:u.widget})};u.ProcessTagsToGraph=function(){u.tagsToGraphObjects=[];u.tagsToGraph.forEach(function(n,t){u.tagsToGraphObjects.push({TagId:t,Enabled:n})});console.log("vm in vm.ProcessTagsToGraph = %O",u);u.dashboard.tagsToGraph=u.tagsToGraphObjects.concat(u.dashboard.tagsToGraph).distinct(function(n,t){return n.TagId==t.TagId}).where(function(n){return n.Enabled});console.log("Dashboard vm.dashboard.tagsToGraph = %O",u.dashboard.tagsToGraph);u.dashboard.tagsToGraph.length>0?n.$broadcast("Dashboard.TagsToGraph",u.dashboard.tagsToGraph):n.$broadcast("Dashboard.TagsToGraph",null);return};u.tagFilterFunction=function(n){return(u.widget.searchText||"")!=""?n.JBTStandardObservation.Name.toLowerCase().indexOf((u.widget.searchText||"").toLowerCase())>-1:!0};i.$watch("vm.widget.searchText",function(n,t){(t||"")!=(n||"")&&(console.log("searchText change = Old = "+t+" New = "+n),u.widget.WidgetResource.DefaultSearchText=n,o(),h.SignalAllClientsInGroup("Admin",u.widget.Id+" SearchText Modification",u.widget.searchText))});t.GetJBTData().then(function(n){u.JBTData=n;u.Asset=u.JBTData.Assets.first(function(n){return n.Id==u.widget.WidgetResource.AssetId});u.gpu=u.Asset;y();u.widget.displaySettings.headingExtraTitle=v()});i.$watch("vm.widget.WidgetResource.GateSystemId",function(n,t){u.widget.WidgetResource.GateSystemId&&n!=t&&(u.gpu=null,o(),y())});u.SetDefaultNavPill=function(n){e(function(){u.widget.WidgetResource.DefaultNavPill=n;o()},100)};u.GenerateAmpsCharts=function(){tt();rt();ft();k();g()};u.GenerateVoltsCharts=function(){lt();vt();pt();ot();ht()};u.tagClicked=function(n){console.log("tag clicked = %O",n)};u.splitterIsSetup=!1;i.$on("WidgetResize",function(n,t){(u.widget.Id==t||t==0)&&(f.SetPanelBodyWithIdHeight(u.widget.Id),l(1))});i.$on("WidgetResize.Stop",function(n,t){(u.widget.Id==t||t==0)&&e(function(){f.SetPanelBodyWithIdHeight(u.widget.Id);l(1)},200)});i.$on("ResizeVirtualScrollContainers",function(){f.SetPanelBodyWithIdHeight(u.widget.Id);l(1)});i.$on("GraphWidgetAdded",function(n,t){u.dashboard.Id==t.ParentDashboardId&&(u.tagsToGraphObjects=[],u.tagsToGraph=[])});i.$on("Widget.AddTagsToGraph",function(){console.log("Widget.AddTagsToGraph event at GPU Summary");u.tagsToGraphObjects=[];u.tagsToGraph=[]});i.$on("dataService.TagUpdate",function(n,t){w(t);it(t);ut(t);et(t);d(t);nt(t);at(t);yt(t);wt(t);st(t);ct(t);p()});i.$on("Dashboard",function(n,t){if(console.log("gpuSummary Dashboard event. Modified Dashboard = %O",t),t.Id==u.dashboard.Id){u.dashboard=t;u.diffDays=Math.round(Math.abs((u.dashboard.derivedStartDate.getTime()-(new Date).getTime())/864e5))}});u.state=r;i.$$postDigest(function(){f.SetPanelBodyWithIdHeight(u.widget.Id)});u.meterRanges={ampsIn:{min:0,max:400,lowStart:0,lowEnd:10,highStart:300,HighEnd:400},ampsOut:{min:0,max:400,lowStart:0,lowEnd:10,highStart:300,HighEnd:400},voltsIn:{min:0,max:600,lowStart:0,lowEnd:10,highStart:500,HighEnd:600},voltsOut:{min:0,max:150,lowStart:0,lowEnd:50,highStart:130,HighEnd:150}}};return l.$inject=["$scope"],{restrict:"E",templateUrl:"app/widgetDirectives/gpuSummary.html",scope:{dashboard:"=",widget:"=",addTagsToGraphFunction:"&",setPanelHeadingColorFunction:"&",mode:"@"},controllerAs:"vm",controller:l,bindToController:!0}}])}(),function(){function n(n,t,i,r,u,f,e,o,s,h,c,l,a,v){var y=this;y.AddTagsToGraphModal=function(n){y.dashboard.tagsToGraph=n.concat(y.dashboard.tagsToGraph).distinct(function(n,t){return n.TagId==t.TagId}).where(function(n){return n.Enabled});console.log("Dashboard vm.dashboard.tagsToGraph = %O",y.dashboard.tagsToGraph);y.dashboard.tagsToGraph.length>0?i.$broadcast("Dashboard.TagsToGraph",y.dashboard.tagsToGraph):i.$broadcast("Dashboard.TagsToGraph",null)};y.state=t;y.widget=e.widget;y.assetId=e.assetId;y.dashboard=e.dashboard;y.showScreen=!1;h.activeClass="radio-active";f.GetJBTData().then(function(n){y.JBTData=n;y.gpu=n.Assets.first(function(n){return n.Id==y.assetId});y.panelTitle=y.widget.Name;y.panelSubtitle="esc to close";y.showScreen=!0});y.AddToDashboard=function(){f.GetEntityById("WidgetTypes",y.widget.WidgetResource.WidgetTypeId).then(function(n){return f.AddEntity("Widgets",{Name:"GPU Summary",WidgetTypeId:y.widget.WidgetResource.WidgetTypeId,ParentDashboardId:y.dashboard.Id,Width:n.InitialWidth,Height:n.InitialHeight,Row:100,Col:0,AssetId:y.widget.WidgetResource.AssetId,DefaultNavPill:"Amps",GateSystemId:y.widget.WidgetResource.GateSystemId,SiteId:y.widget.WidgetResource.SiteId,SplitLeftPercentage:50,SplitRightPercentage:50,SystemId:y.widget.WidgetResource.SystemId,TerminalSystemId:y.widget.WidgetResource.TerminalSystemId,ZoneSystemId:y.widget.WidgetResource.ZoneSystemId}).then(function(n){v.SignalAllClients("WidgetAdded",n)})})};c.bindTo(r).add({combo:"esc",description:"Cancel and close any input form",allowIn:["INPUT","SELECT","TEXTAREA"],callback:function(){t.go("^")}});console.log("GPUSummaryModalCtrl invoked = %O",y)}angular.module("app").controller("GPUSummaryModalCtrl",["$q","$state","$rootScope","$scope","securityService","dataService","$stateParams","utilityService","$timeout","uibButtonConfig","hotkeys","$interval","displaySetupService","signalR",n])}(),function(){var n=angular.module("app");n.directive("gsEquipmentHoursOfUsage",["dataService","utilityService","$state","hotkeys","displaySetupService","$timeout","$window","$interval","signalR","$odata",function(n,t,i,r,u,f,e,o){var s=function(t){function s(){return r.widgetSite=r.userSites.first(function(n){return n.Id==r.widget.WidgetResource.SiteId}),r.widgetSite?" - "+r.widgetSite.Name:void 0}function e(t){n.GetIOPSWebAPIResource("gSEquipmentUsage_TVF_Query").query({beginDate:r.dashboard.webApiParameterStartDate,endDate:r.dashboard.webApiParameterEndDate,siteId:r.widget.WidgetResource.SiteId},function(n){console.log("webApiParameterStartDate",r.dashboard.webApiParameterStartDate);console.log("webApiParameterEndDate",r.dashboard.webApiParameterEndDate);console.log("EquipmentUsage initial data = %O",n);r.chartData=n;t?(n.forEach(function(n){r.chart.series[0].data.first(function(t){return t.category==n.Gate})}),r.chart.redraw()):$(function(){u.SetWidgetPanelBodyDimensions(r.widget.Id);f(function(){h(n);u.SetLoneChartSize(r.widget.Id,r.chart)},100)});r.data=n;r.widget.displaySettings.headingExtraTitle=s()})}function h(t){var i={chart:{type:"column",renderTo:"gsEquipmentHoursOfUsage"+r.widget.Id},animation:!1,credits:{enabled:!1},title:{text:"Equipment Hours Of Usage Summary",style:{fontSize:".8em"}},xAxis:{type:"category",categories:t.select(function(n){return n.Gate}),labels:{autoRotation:[-10,-20,-30,-40,-50,-60,-70,-80,-90],style:{fontSize:"10px",wordWrap:"break word",fontFamily:"Verdana, sans-serif"}}},yAxis:{min:0,title:{text:"",style:{fontSize:"10px"}},stackLabels:{enabled:!0,formatter:function(){return Highcharts.numberFormat(this.total,1)},style:{fontWeight:"bold"}}},legend:{align:"center",verticalAlign:"bottom",x:0,y:0},tooltip:{headerFormat:"<b>{point.x}<\/b><br/>",pointFormat:"{series.name}: {point.y:.1f}<br/>Click for details"},plotOptions:{column:{stacking:"normal",dataLabels:{enabled:!0,formatter:function(){return Highcharts.numberFormat(this.y,1)}}},series:{cursor:"pointer",point:{events:{click:function(t){console.log("this = %O",this);console.log("window = %O",window);var i=this.category,u=this;n.GetIOPSWebAPIResource("gSEquipmentUsage_TVF_Query").query({beginDate:r.dashboard.webApiParameterStartDate,endDate:r.dashboard.webApiParameterEndDate,siteId:r.widget.WidgetResource.SiteId},function(n){console.log("data from OData Source = %O",angular.copy(n));hs.htmlExpand(null,{pageOrigin:{x:t.pageX||t.clientX,y:t.pageY||t.clientY},headingText:"All Gates Summary",maincontentText:"<table class='table table-condensed table-striped' style='font-size: .75em;'><thead><th>Gate<\/th><th>PBB Hours<\/th><th>PCA Hours<\/th><th>GPU Hours<\/th><th>PBB Times Used<\/th><th>PCA Times Used<\/th><th>GPU Times Used<\/th><\/thead><tbody>"+n.select(function(n){return"<tr><td>"+n.Gate+"<td>"+n.PBB_Hours.toFixed(1)+"<td>"+n.PCA_Hours.toFixed(1)+"<td>"+n.GPU_Hours.toFixed(1)+"<td>"+n.PBB_Times_Used+"<td>"+n.PCA_Times_Used+"<td>"+n.GPU_Times_Used+"<\/tr>"}).join("")+"<\/tbody><\/table>",width:400,height:window.outerHeight*.6})})}}},marker:{lineWidth:1}}},series:[{name:"PBBHours",data:t.select(function(n){return n.PBB_Hours})},{name:"PCAHours",data:t.select(function(n){return n.PCA_Hours})},{name:"GPUHours",data:t.select(function(n){return n.GPU_Hours})}]};console.log("chartOptions = %O",i);r.chart=Highcharts.chart("gsEquipmentHoursOfUsage"+r.widget.Id,i)}var r=this;console.log("gsEquipmentHoursOfUsage controller invoked. vm = %O",r);r.widget.headingBackground="linear-gradient(to bottom,#dedede, #fefefe)";r.widget.displaySettings={headingBackground:"linear-gradient(to bottom,#dedede, #fefefe)",headingExtraTitle:"",obscureGraphics:!0};t.$on("WidgetResize",function(n,t){(r.widget.Id==t||t==0)&&u.SetLoneChartSize(r.widget.Id,r.chart)});t.$on("WidgetResize.Stop",function(n,t){(r.widget.Id==t||t==0)&&o(function(){u.SetLoneChartSize(r.widget.Id,r.chart)},50,20)});t.$on("Dashboard",function(n,t){console.log("gsEquipmentHoursOfUsage Dashboard event. Modified Dashboard = %O",t);t.Id==r.dashboard.Id&&(r.dashboard=t,e(!1))});r.state=i;Highcharts.setOptions({global:{useUTC:!1}});n.GetJBTData().then(function(n){r.JBTData=n;var t=Global.User.ReaderOf.where(function(n){return n.split(".")[0]=="Site"}).select(function(n){return n.split(".")[1]});console.log("user site codes = %O",t);r.userSites=r.JBTData.Sites.where(function(n){return t.any(function(t){return t==n.Name})});console.log("vm.userSites = %O",r.userSites);r.userSites.length==1?(console.log("User only has a single Site"),r.widget.WidgetResource.SiteId=r.userSites[0].Id,r.widgetSite=r.userSites[0],e()):r.widget.WidgetResource.SiteId&&e();r.widget.displaySettings.headingExtraTitle=s()});t.$watch("vm.widget.WidgetResource.SiteId",function(n,t){r.widget.WidgetResource.SiteId&&r.userSites&&(r.widgetSite=r.userSites.first(function(n){return n.Id==r.widget.WidgetResource.SiteId}),console.log("vm.widget.WidgetResource.SiteId changed. Now = %O",r.widget),t!=n&&(r.widget.WidgetResource.$save(),e()))});r.updateInterval=o(function(){e()},12e4);t.$on("$destroy",function(){o.cancel(r.updateInterval)})};return s.$inject=["$scope"],{restrict:"E",templateUrl:"app/widgetDirectives/gsEquipmentHoursOfUsage.html?"+Date.now(),scope:{dashboard:"=",widget:"=",signalUpdateFunction:"&",setPanelHeadingColorFunction:"&",mode:"@"},controllerAs:"vm",controller:s,bindToController:!0}}])}(),function(){var n=angular.module("app");n.directive("gsEquipmentUsage",["dataService","utilityService","$state","hotkeys","displaySetupService","$timeout","$window","$interval","signalR","$odata",function(n,t,i,r,u,f,e,o){var s=function(t){function s(){return r.widgetSite=r.userSites.first(function(n){return n.Id==r.widget.WidgetResource.SiteId}),r.widgetSite?" - "+r.widgetSite.Name:void 0}function e(t){n.GetIOPSWebAPIResource("gSEquipmentUsage_TVF_Query").query({beginDate:r.dashboard.webApiParameterStartDate,endDate:r.dashboard.webApiParameterEndDate,siteId:r.widget.WidgetResource.SiteId},function(n){console.log("webApiParameterStartDate",r.dashboard.webApiParameterStartDate);console.log("webApiParameterEndDate",r.dashboard.webApiParameterEndDate);console.log("EquipmentUsage initial data = %O",n);r.chartData=n;t?(n.forEach(function(n){r.chart.series[0].data.first(function(t){return t.category==n.Gate}).update(n.PBB_Hours,!1)}),r.chart.redraw()):$(function(){u.SetWidgetPanelBodyDimensions(r.widget.Id);f(function(){c(n);u.SetLoneChartSize(r.widget.Id,r.chart)},100)});r.data=n;r.widget.displaySettings.headingExtraTitle=s()})}function c(t){var i={chart:{type:"column",renderTo:"gsEquipmentUsage"+r.widget.Id},animation:!1,credits:{enabled:!1},title:{text:"Equipment Cycle Count Summary",style:{fontSize:".8em"}},xAxis:{type:"category",categories:t.select(function(n){return n.Gate}),labels:{autoRotation:[-10,-20,-30,-40,-50,-60,-70,-80,-90],style:{fontSize:"10px",wordWrap:"break word",fontFamily:"Verdana, sans-serif"}}},yAxis:{min:0,title:{text:"",style:{fontSize:"10px"}},stackLabels:{enabled:!0,style:{fontWeight:"bold"}}},legend:{align:"center",verticalAlign:"bottom",x:0,y:0},tooltip:{headerFormat:"<b>{point.x}<\/b><br/>",pointFormat:"{series.name}: {point.y}<br/>Click for details"},plotOptions:{column:{stacking:"normal",dataLabels:{enabled:!0}},series:{cursor:"pointer",point:{events:{click:function(t){console.log("this = %O",this);console.log("window = %O",window);var i=this.category,u=this;n.GetIOPSWebAPIResource("gSEquipmentUsage_TVF_Query").query({beginDate:r.dashboard.webApiParameterStartDate,endDate:r.dashboard.webApiParameterEndDate,siteId:r.widget.WidgetResource.SiteId},function(n){console.log("data from OData Source = %O",angular.copy(n));hs.htmlExpand(null,{pageOrigin:{x:t.pageX||t.clientX,y:t.pageY||t.clientY},headingText:"All Gates Summary",maincontentText:"<table class='table table-condensed table-striped' style='font-size: .75em;'><thead><th>Gate<\/th><th>PBB Hours<\/th><th>PCA Hours<\/th><th>GPU Hours<\/th><th>PBB Times Used<\/th><th>PCA Times Used<\/th><th>GPU Times Used<\/th><\/thead><tbody>"+n.select(function(n){return"<tr><td>"+n.Gate+"<td>"+n.PBB_Hours.toFixed(2)+"<td>"+n.PCA_Hours.toFixed(2)+"<td>"+n.GPU_Hours.toFixed(2)+"<td>"+n.PBB_Times_Used+"<td>"+n.PCA_Times_Used+"<td>"+n.GPU_Times_Used+"<\/tr>"}).join("")+"<\/tbody><\/table>",width:400,height:window.outerHeight*.6})})}}},marker:{lineWidth:1}}},series:[{name:"PBBCycleCount",data:t.select(function(n){return n.PBB_Times_Used})},{name:"PCACycleCount",data:t.select(function(n){return n.PCA_Times_Used})},{name:"GPUCycleCount",data:t.select(function(n){return n.GPU_Times_Used})}]};console.log("chartOptions = %O",i);r.chart=Highcharts.chart("gsEquipmentUsage"+r.widget.Id,i)}var r=this,h;console.log("gsEquipmentUsage controller invoked. vm = %O",r);r.widget.headingBackground="linear-gradient(to bottom,#dedede, #fefefe)";r.widget.displaySettings={headingBackground:"linear-gradient(to bottom,#dedede, #fefefe)",headingExtraTitle:"",obscureGraphics:!0};t.$on("WidgetResize",function(n,t){(r.widget.Id==t||t==0)&&u.SetLoneChartSize(r.widget.Id,r.chart)});t.$on("WidgetResize.Stop",function(n,t){(r.widget.Id==t||t==0)&&o(function(){u.SetLoneChartSize(r.widget.Id,r.chart)},50,20)});t.$on("Dashboard",function(n,t){console.log("gsEquipmentUsage Dashboard event. Modified Dashboard = %O",t);t.Id==r.dashboard.Id&&(r.dashboard=t,e(!1))});r.state=i;Highcharts.setOptions({global:{useUTC:!1}});n.GetJBTData().then(function(n){r.JBTData=n;var t=Global.User.ReaderOf.where(function(n){return n.split(".")[0]=="Site"}).select(function(n){return n.split(".")[1]});console.log("user site codes = %O",t);r.userSites=r.JBTData.Sites.where(function(n){return t.any(function(t){return t==n.Name})});console.log("vm.userSites = %O",r.userSites);r.userSites.length==1?(console.log("User only has a single Site"),r.widget.WidgetResource.SiteId=r.userSites[0].Id,r.widgetSite=r.userSites[0],e()):r.widget.WidgetResource.SiteId&&e();r.widget.displaySettings.headingExtraTitle=s()});t.$watch("vm.widget.WidgetResource.SiteId",function(n,t){r.widget.WidgetResource.SiteId&&r.userSites&&(r.widgetSite=r.userSites.first(function(n){return n.Id==r.widget.WidgetResource.SiteId}),console.log("vm.widget.WidgetResource.SiteId changed. Now = %O",r.widget),t!=n&&(r.widget.WidgetResource.$save(),e()))});h=67;r.updateInterval=o(function(){e()},12e4);t.$on("$destroy",function(){o.cancel(r.updateInterval)})};return s.$inject=["$scope"],{restrict:"E",templateUrl:"app/widgetDirectives/gsEquipmentUsage.html?"+Date.now(),scope:{dashboard:"=",widget:"=",signalUpdateFunction:"&",setPanelHeadingColorFunction:"&",mode:"@"},controllerAs:"vm",controller:s,bindToController:!0}}])}(),function(){var n=angular.module("app");n.directive("gsEquipmentUtilizationSummary",["dataService","utilityService","$state","hotkeys","displaySetupService","$timeout","$window","$interval","signalR","$odata",function(n,t,i,r,u,f,e,o){var s=function(t){function h(){return r.widgetSite=r.userSites.first(function(n){return n.Id==r.widget.WidgetResource.SiteId}),r.widgetSite?" - "+r.widgetSite.Name:void 0}function e(){var t=r.dashboard.webApiParameterStartDate,i=r.dashboard.webApiParameterEndDate;n.GetIOPSWebAPIResource("GSEquipmentUsageByGate_TVF_Query").query({beginDate:t,endDate:i,siteId:r.widget.WidgetResource.SiteId,gate:"All"},function(n){r.PBBGatesPresent=n.sum(function(n){return n.PBB_Hours});r.PCAGatesPresent=n.sum(function(n){return n.PCA_Hours});r.GPUGatesPresent=n.sum(function(n){return n.GPU_Hours});r.PBBGatesUsed=n.sum(function(n){return n.PBB_Times_Used});r.PCAGatesUsed=n.sum(function(n){return n.PCA_Times_Used});r.GPUGatesUsed=n.sum(function(n){return n.GPU_Times_Used})});n.GetIOPSWebAPIResource("GSEquipmentUsage_TVF_Query").query({beginDate:t,endDate:i,siteId:r.widget.WidgetResource.SiteId},function(n){r.totalPBBHours=n.sum(function(n){return n.PBB_Hours}).toFixed(2);r.totalPCAHours=n.sum(function(n){return n.PCA_Hours}).toFixed(2);r.totalGPUHours=n.sum(function(n){return n.GPU_Hours}).toFixed(2);r.totalPBBTimesUsed=n.sum(function(n){return n.PBB_Times_Used});r.totalPCATimesUsed=n.sum(function(n){return n.PCA_Times_Used});r.totalGPUTimesUsed=n.sum(function(n){return n.GPU_Times_Used});var e,o,c,i,a=(new Date).toISOString().slice(0,10),v=t.toISOString().slice(0,10);i=v==a?1:Math.floor((Date.parse(a)-Date.parse(v))/864e5);console.log("days total",i);e=r.totalPBBHours!=0?parseFloat((r.totalPBBHours/(24*i*r.PBBGatesPresent)*100).toFixed(2)):"0%";o=r.totalPCAHours!=0?parseFloat((r.totalPCAHours/(24*i*r.PCAGatesPresent)*100).toFixed(2)):"0%";c=r.totalGPUHours!=0?parseFloat((r.totalGPUHours/(24*i*r.GPUGatesPresent)*100).toFixed(2)):"0%";r.usagePBB=e;r.usagePCA=o;r.usageGPU=c;r.chartData=n;$(function(){u.SetWidgetPanelBodyDimensions(r.widget.Id);f(function(){l(n);s(r.widget.Id,r.chart)},100)});r.data=n;r.widget.displaySettings.headingExtraTitle=h()})}function s(n,t){var i=u.GetWidgetPanelBodyDimensions(n);t&&t.setSize(i.width*.99,i.height*.6-10,!1)}function c(){this.series[0].icon||(this.series[0].icon=this.renderer.path(["M",-8,0,"L",8,0,"M",0,-8,"L",8,0,0,8]).attr({stroke:"#303030","stroke-linecap":"round","stroke-linejoin":"round","stroke-width":2,zIndex:10}).add(this.series[2].group));this.series[0].icon.translate(this.chartWidth/2-10,this.plotHeight/2-this.series[0].points[0].shapeArgs.innerR-(this.series[0].points[0].shapeArgs.r-this.series[0].points[0].shapeArgs.innerR)/2);this.series[1].icon||(this.series[1].icon=this.renderer.path(["M",-8,0,"L",8,0,"M",0,-8,"L",8,0,0,8,"M",8,-8,"L",16,0,8,8]).attr({stroke:"#ffffff","stroke-linecap":"round","stroke-linejoin":"round","stroke-width":2,zIndex:10}).add(this.series[2].group));this.series[1].icon.translate(this.chartWidth/2-10,this.plotHeight/2-this.series[1].points[0].shapeArgs.innerR-(this.series[1].points[0].shapeArgs.r-this.series[1].points[0].shapeArgs.innerR)/2);this.series[2].icon||(this.series[2].icon=this.renderer.path(["M",0,8,"L",0,-8,"M",-8,0,"L",0,-8,8,0]).attr({stroke:"#303030","stroke-linecap":"round","stroke-linejoin":"round","stroke-width":2,zIndex:10}).add(this.series[2].group));this.series[2].icon.translate(this.chartWidth/2-10,this.plotHeight/2-this.series[2].points[0].shapeArgs.innerR-(this.series[2].points[0].shapeArgs.r-this.series[2].points[0].shapeArgs.innerR)/2)}function l(){var n={chart:{type:"solidgauge",events:{render:c},renderTo:"gsEquipmentUtilizationSummary"+r.widget.Id},animation:!1,credits:{enabled:!1},title:{text:"Equipment Hours Of Usage",style:{fontSize:".8em"}},pane:{startAngle:0,endAngle:360,background:[{outerRadius:"112%",innerRadius:"88%",backgroundColor:Highcharts.Color(Highcharts.getOptions().colors[0]).setOpacity(.3).get(),borderWidth:0},{outerRadius:"87%",innerRadius:"63%",backgroundColor:Highcharts.Color(Highcharts.getOptions().colors[1]).setOpacity(.3).get(),borderWidth:0},{outerRadius:"62%",innerRadius:"38%",backgroundColor:Highcharts.Color(Highcharts.getOptions().colors[2]).setOpacity(.3).get(),borderWidth:0}]},yAxis:{min:0,max:100,lineWidth:0,tickPositions:[]},plotOptions:{solidgauge:{dataLabels:{enabled:!1},linecap:"round",stickyTracking:!1,rounded:!0}},tooltip:{borderWidth:0,backgroundColor:"none",shadow:!1,style:{fontSize:"8px"},pointFormat:'{series.name}<br><span style="font-size:2em; color: {point.color}; font-weight: bold">{point.y}%<\/span>',positioner:function(n){return{x:(this.chart.chartWidth-n)/2,y:this.chart.plotHeight/2+15}}},series:[{name:"PBB",data:[{color:Highcharts.getOptions().colors[0],radius:"112%",innerRadius:"88%",y:r.usagePBB}]},{name:"GPU",data:[{color:Highcharts.getOptions().colors[1],radius:"87%",innerRadius:"63%",y:r.usageGPU}]},{name:"PCA",data:[{color:Highcharts.getOptions().colors[2],radius:"62%",innerRadius:"38%",y:r.usagePCA}]}]};console.log("chartOptions = %O",n);r.chart=Highcharts.chart("gsEquipmentUtilizationSummary"+r.widget.Id,n)}var r=this;console.log("gsEquipmentUtilizationSummary controller invoked. vm = %O",r);r.widget.headingBackground="linear-gradient(to bottom,#dedede, #fefefe)";r.widget.displaySettings={headingBackground:"linear-gradient(to bottom,#dedede, #fefefe)",headingExtraTitle:"",obscureGraphics:!0};t.$on("WidgetResize",function(n,t){(r.widget.Id==t||t==0)&&(u.SetPanelBodyWithIdHeight(r.widget.Id),s(r.widget.Id,r.chart))});t.$on("WidgetResize.Stop",function(n,t){(r.widget.Id==t||t==0)&&o(function(){u.SetPanelBodyWithIdHeight(r.widget.Id);s(r.widget.Id,r.chart)},50,20)});t.$on("Dashboard",function(n,t){console.log("gsEquipmentUtilizationSummary Dashboard event. Modified Dashboard = %O",t);t.Id==r.dashboard.Id&&(r.dashboard=t,e())});r.state=i;Highcharts.setOptions({global:{useUTC:!1}});n.GetJBTData().then(function(n){r.JBTData=n;var t=Global.User.ReaderOf.where(function(n){return n.split(".")[0]=="Site"}).select(function(n){return n.split(".")[1]});console.log("user site codes = %O",t);r.userSites=r.JBTData.Sites.where(function(n){return t.any(function(t){return t==n.Name})});console.log("vm.userSites = %O",r.userSites);r.userSites.length==1?(console.log("User only has a single Site"),r.widget.WidgetResource.SiteId=r.userSites[0].Id,r.widgetSite=r.userSites[0],e()):r.widget.WidgetResource.SiteId&&e();r.widget.displaySettings.headingExtraTitle=h()});t.$watch("vm.widget.WidgetResource.SiteId",function(n,t){r.widget.WidgetResource.SiteId&&r.userSites&&(r.widgetSite=r.userSites.first(function(n){return n.Id==r.widget.WidgetResource.SiteId}),console.log("vm.widget.WidgetResource.SiteId changed. Now = %O",r.widget),t!=n&&(r.widget.WidgetResource.$save(),e()))});r.updateInterval=o(function(){e()},12e4);t.$on("$destroy",function(){o.cancel(r.updateInterval)})};return s.$inject=["$scope"],{restrict:"E",templateUrl:"app/widgetDirectives/gsEquipmentUtilizationSummary.html?"+Date.now(),scope:{dashboard:"=",widget:"=",signalUpdateFunction:"&",setPanelHeadingColorFunction:"&",mode:"@"},controllerAs:"vm",controller:s,bindToController:!0}}])}(),function(){var n=angular.module("app");n.directive("gsServiceCounters",["dataService","utilityService","$state","hotkeys","displaySetupService","$timeout","$window","$interval","signalR","$odata","$q",function(n,t,i,r,u,f,e,o,s,h,c){var l=function(t){function e(){return r.widgetSite=r.userSites.first(function(n){return n.Id==r.widget.WidgetResource.SiteId}),r.widgetSite&&r.GateSystem?" - "+r.widgetSite.Name+" - "+r.GateSystem.Name:void 0}function f(){var t=[];n.GetIOPSResource("Tags").select(["Id","JBTStandardObservationId","JBTStandardObservationName"]).filter("SiteId",r.widget.WidgetResource.SiteId).filter("GateName",r.GateSystem.Name).filter(h.Predicate.or([3782,13740,4504,3819,12455,12452,12374,3879,3795,3808,4001,4745,4002,4003,12578,4074,4075,3844,3789,3837,3843,3770,3820,14241,14388].select(function(n){return new h.Predicate("JBTStandardObservationId",n)}))).query().$promise.then(function(i){c.all(i.select(function(i){return n.GetIOPSResource("Observations").filter("TagId",i.Id).filter("Date",">=",r.dashboard.webApiParameterStartDate).filter("Date","<=",r.dashboard.webApiParameterEndDate).filter("BooleanValue",!0).count().$promise.then(function(n){t.push({Tag:i,Count:n.result})})})).then(function(){console.log("Here are the tags =%O",t)})});$(function(){u.SetWidgetPanelBodyDimensions(r.widget.Id)});r.data=t;r.showWidget=!0;r.widget.displaySettings.headingExtraTitle=e();console.log("In Vm.data  =%O ",r.data)}var r=this;console.log("gsServiceCounters controller invoked. vm = %O",r);r.widget.headingBackground="linear-gradient(to bottom,#dedede, #fefefe)";r.widget.displaySettings={headingBackground:"linear-gradient(to bottom,#dedede, #fefefe)",headingExtraTitle:"",obscureGraphics:!0};t.$on("WidgetResize",function(n,t){(r.widget.Id==t||t==0)&&u.SetLoneChartSize(r.widget.Id,r.chart)});t.$on("WidgetResize.Stop",function(n,t){(r.widget.Id==t||t==0)&&o(function(){},50,20)});t.$on("Dashboard",function(n,t){console.log("gsTopFiveAlarmTypes Dashboard event. Modified Dashboard = %O",t);t.Id==r.dashboard.Id&&(r.dashboard=t,f())});r.state=i;Highcharts.setOptions({global:{useUTC:!1}});n.GetJBTData().then(function(n){r.JBTData=n;var t=Global.User.ReaderOf.where(function(n){return n.split(".")[0]=="Site"}).select(function(n){return n.split(".")[1]});console.log("user site codes = %O",t);r.widget.WidgetResource.GateSystemId&&(r.GateSystem=r.JBTData.Systems.first(function(n){return n.Id==r.widget.WidgetResource.GateSystemId}));r.userSites=r.JBTData.Sites.where(function(n){return t.any(function(t){return t==n.Name})});console.log("vm.userSites = %O",r.userSites);r.userSites.length==1?(console.log("User only has a single Site"),r.widget.WidgetResource.SiteId=r.userSites[0].Id,r.widgetSite=r.userSites[0],f()):r.widget.WidgetResource.SiteId&&f();r.widget.displaySettings.headingExtraTitle=e()});t.$watch("vm.widget.WidgetResource.GateSystemId",function(t,i){r.widget.WidgetResource.GateSystemId&&r.widget.WidgetResource.SiteId&&t!=i&&(r.widget.WidgetResource.$save(),n.GetEntityById("SystemGroups",t).then(function(n){r.GateSystem=n;f()}))})};return l.$inject=["$scope"],{restrict:"E",templateUrl:"app/widgetDirectives/gsServiceCounters.html?"+Date.now(),scope:{dashboard:"=",widget:"=",signalUpdateFunction:"&",setPanelHeadingColorFunction:"&",mode:"@"},controllerAs:"vm",controller:l,bindToController:!0}}])}(),function(){var n=angular.module("app");n.directive("gsTopFiveAlarmTypes",["dataService","utilityService","$state","hotkeys","displaySetupService","$timeout","$window","$interval","signalR","$odata",function(n,t,i,r,u,f,e,o){var s=function(r){function h(){return e.widgetSite=e.userSites.first(function(n){return n.Id==e.widget.WidgetResource.SiteId}),e.widgetSite?" - "+e.widgetSite.Name:void 0}function s(t){n.GetIOPSWebAPIResource("top5ObservationExceptions").query({beginDate:e.dashboard.webApiParameterStartDate,endDate:e.dashboard.webApiParameterEndDate,siteId:e.widget.WidgetResource.SiteId},function(n){console.log("webApiParameterStartDate",e.dashboard.webApiParameterStartDate);console.log("webApiParameterEndDate",e.dashboard.webApiParameterEndDate);console.log("GSTop5AlarmTypes initial data = %O",n);e.chartData=n;t?(n.forEach(function(n){e.chart.series[0].data.first(function(t){return t.category==n.AlarmType}).update(n.AlarmCount,!1)}),e.chart.redraw()):$(function(){u.SetWidgetPanelBodyDimensions(e.widget.Id);f(function(){c(n);u.SetLoneChartSize(e.widget.Id,e.chart)},100)});e.data=n;e.widget.displaySettings.headingExtraTitle=h()})}function c(i){var r={chart:{type:"bar",renderTo:"gsTopFiveAlarmTypes"+e.widget.Id},animation:!1,credits:{enabled:!1},title:{text:"Top 5 Alarm Types",style:{fontSize:".8em"}},xAxis:{type:"category",categories:i.select(function(n){return n.AlarmType}),labels:{autoRotation:[-10,-20,-30,-40,-50,-60,-70,-80,-90],style:{fontSize:"10px",wordWrap:"break word",fontFamily:"Verdana, sans-serif"}}},yAxis:{min:0,title:{text:"",style:{fontSize:"10px"}},stackLabels:{enabled:!0,style:{fontWeight:"bold"}}},legend:{enabled:!1},tooltip:{pointFormat:"Alarm Count: <b>{point.y:.0f} Alarms<\/b><br/>Click for details"},plotOptions:{stacking:"normal",bar:{dataLabels:{enabled:!0}},series:{cursor:"pointer",point:{events:{click:function(i){var f,r,u;console.log("this = %O",this);console.log("window = %O",window);f=this.category;r=this;console.log("vm = %O",e);u=e.chartData.first(function(n){return n.AlarmType==f}).JBTStandardObservationIdList;console.log("JBTStandardObservationId:"+u);console.log("siteId:"+e.widget.WidgetResource.SiteId);n.GetIOPSResource("Tags").filter("SiteId",e.widget.WidgetResource.SiteId).filter("JBTStandardObservationId",u).filter("IsAlarm",!0).expandPredicate("ObservationExceptions").filter("ExceptionStartDate",">=",e.dashboard.webApiParameterStartDate).filter("ExceptionStartDate","<=",e.dashboard.webApiParameterEndDate).filter("DurationMS",">",0).finish().query().$promise.then(function(n){var u=n.selectMany(function(n){return n.ObservationExceptions});console.log("flattenedData",u);console.log("data from OData Source = %O",angular.copy(n));hs.htmlExpand(null,{pageOrigin:{x:i.pageX||i.clientX,y:i.pageY||i.clientY},headingText:r.y+" "+r.category+"s",maincontentText:"<table class='table table-condensed table-striped' style='font-size: .75em;'><thead><th>Alarm Date Time<\/th><th>Cleared Date Time<\/th><th>Alarm Text<\/th><th>Gate<\/th><th>Equipment<\/th><\/thead><tbody>"+u.select(function(i){var r=n.first(function(n){return n.Id==i.TagId});return"<tr><td>"+t.GetFormattedLocalDisplayDateFromUTCDate(i.ExceptionStartDate)+"<td>"+t.GetFormattedLocalDisplayDateFromUTCDate(i.ExceptionEndDate||"")+"<td>"+r.JBTStandardObservationName+"<td>"+r.GateName+"<td>"+r.AssetName+"<\/tr>"}).join("")+"<\/tbody><\/table>",width:700,height:window.outerHeight*.6})})}}},marker:{lineWidth:1}}},series:[{data:i.select(function(n){return n.AlarmCount})}]};console.log("chartOptions = %O",r);e.chart=Highcharts.chart("gsTopFiveAlarmTypes"+e.widget.Id,r)}var e=this;console.log("gsTopFiveAlarmTypes controller invoked. vm = %O",e);e.widget.headingBackground="linear-gradient(to bottom,#dedede, #fefefe)";e.widget.displaySettings={headingBackground:"linear-gradient(to bottom,#dedede, #fefefe)",headingExtraTitle:"",obscureGraphics:!0};r.$on("WidgetResize",function(n,t){(e.widget.Id==t||t==0)&&u.SetLoneChartSize(e.widget.Id,e.chart)});r.$on("WidgetResize.Stop",function(n,t){(e.widget.Id==t||t==0)&&o(function(){u.SetLoneChartSize(e.widget.Id,e.chart)},50,20)});r.$on("Dashboard",function(n,t){t.Id==e.dashboard.Id&&(e.dashboard=t,s(!1))});e.state=i;Highcharts.setOptions({global:{useUTC:!1}});n.GetJBTData().then(function(n){e.JBTData=n;var t=Global.User.ReaderOf.where(function(n){return n.split(".")[0]=="Site"}).select(function(n){return n.split(".")[1]});e.userSites=e.JBTData.Sites.where(function(n){return t.any(function(t){return t==n.Name})});console.log("vm.userSites = %O",e.userSites);e.userSites.length==1?(e.widget.WidgetResource.SiteId=e.userSites[0].Id,e.widgetSite=e.userSites[0],s()):e.widget.WidgetResource.SiteId&&s();e.widget.displaySettings.headingExtraTitle=h()});r.$watch("vm.widget.WidgetResource.SiteId",function(n,t){e.widget.WidgetResource.SiteId&&e.userSites&&(e.widgetSite=e.userSites.first(function(n){return n.Id==e.widget.WidgetResource.SiteId}),t!=n&&(e.widget.WidgetResource.$save(),s()))});e.updateInterval=o(function(){s()},12e4);r.$on("$destroy",function(){o.cancel(e.updateInterval)})};return s.$inject=["$scope"],{restrict:"E",templateUrl:"app/widgetDirectives/gsTopFiveAlarmTypes.html?"+Date.now(),scope:{dashboard:"=",widget:"=",signalUpdateFunction:"&",setPanelHeadingColorFunction:"&",mode:"@"},controllerAs:"vm",controller:s,bindToController:!0}}])}(),function(){var n=angular.module("app");n.directive("gsTopFiveAlarmTypesByEquipment",["dataService","utilityService","$state","hotkeys","displaySetupService","$timeout","$window","$interval","signalR","$odata",function(n,t,i,r,u,f,e,o){var s=function(r){function h(){return e.widgetSite=e.userSites.first(function(n){return n.Id==e.widget.WidgetResource.SiteId}),e.widgetSite?" - "+e.widgetSite.Name:void 0}function s(t){n.GetIOPSWebAPIResource("top5EquipmentWithMostAlarms").query({beginDate:e.dashboard.webApiParameterStartDate,endDate:e.dashboard.webApiParameterEndDate,siteId:e.widget.WidgetResource.SiteId},function(n){console.log("webApiParameterStartDate",e.dashboard.webApiParameterStartDate);console.log("webApiParameterEndDate",e.dashboard.webApiParameterEndDate);console.log("GSTop5AlarmTypes initial data = %O",n);e.chartData=n;t?(n.forEach(function(n){e.chart.series[0].data.first(function(t){return t.category==n.AlarmType}).update(n.AlarmCount,!1)}),e.chart.redraw()):$(function(){u.SetWidgetPanelBodyDimensions(e.widget.Id);f(function(){c(n);u.SetLoneChartSize(e.widget.Id,e.chart)},100)});e.data=n;e.widget.displaySettings.headingExtraTitle=h()})}function c(i){var r={chart:{type:"bar",renderTo:"gsTopFiveAlarmTypesByEquipment"+e.widget.Id},animation:!1,credits:{enabled:!1},title:{text:"Top 5 Equipment With Most Alarms",style:{fontSize:".8em"}},xAxis:{type:"category",categories:i.select(function(n){return n.display}),labels:{autoRotation:[-10,-20,-30,-40,-50,-60,-70,-80,-90],style:{fontSize:"10px",wordWrap:"break word",fontFamily:"Verdana, sans-serif"}}},yAxis:{min:0,title:{text:"",style:{fontSize:"10px"}},stackLabels:{enabled:!0,style:{fontWeight:"bold"}}},legend:{enabled:!1},tooltip:{pointFormat:"Alarm Count: <b>{point.y:.0f} Alarms<\/b><br/>Click for details"},plotOptions:{stacking:"normal",bar:{dataLabels:{enabled:!0}},series:{cursor:"pointer",point:{events:{click:function(i){var f,u,r;console.log("this = %O",this);console.log("window = %O",window);f=this.category;u=this;console.log("vm = %O",e);r=e.chartData.first(function(n){return n.display==f});console.log("GateName:"+r.Gate);console.log("AssetName:"+r.AlarmType);console.log("siteId:"+e.widget.WidgetResource.SiteId);n.GetIOPSResource("Tags").filter("SiteId",e.widget.WidgetResource.SiteId).filter("GateName",r.Gate).filter("AssetName",r.AlarmType).filter("IsAlarm",!0).expandPredicate("ObservationExceptions").filter("ExceptionStartDate",">=",e.dashboard.webApiParameterStartDate).filter("ExceptionStartDate","<=",e.dashboard.webApiParameterEndDate).filter("DurationMS",">",0).finish().query().$promise.then(function(n){var r=n.selectMany(function(n){return n.ObservationExceptions});console.log("flattenedData",r);console.log("data from OData Source = %O",angular.copy(n));hs.htmlExpand(null,{pageOrigin:{x:i.pageX||i.clientX,y:i.pageY||i.clientY},headingText:u.y+" "+u.category+" Alarms",maincontentText:"<table class='table table-condensed table-striped' style='font-size: .75em;'><thead><th>Alarm Date Time<\/th><th>Cleared Date Time<\/th><th>Alarm Text<\/th><\/thead><tbody>"+r.select(function(i){return"<tr><td>"+t.GetFormattedLocalDisplayDateFromUTCDate(i.ExceptionStartDate)+"<td>"+t.GetFormattedLocalDisplayDateFromUTCDate(i.ExceptionEndDate||"")+"<td>"+n.first(function(n){return n.Id==i.TagId}).JBTStandardObservationName+"<\/tr>"}).join("")+"<\/tbody><\/table>",width:500,height:window.outerHeight*.6})})}}},marker:{lineWidth:1}}},series:[{data:i.select(function(n){return n.AlarmCount})}]};console.log("chartOptions = %O",r);e.chart=Highcharts.chart("gsTopFiveAlarmTypesByEquipment"+e.widget.Id,r)}var e=this;console.log("gsTopFiveAlarmTypes controller invoked. vm = %O",e);e.widget.headingBackground="linear-gradient(to bottom,#dedede, #fefefe)";e.widget.displaySettings={headingBackground:"linear-gradient(to bottom,#dedede, #fefefe)",headingExtraTitle:"",obscureGraphics:!0};r.$on("WidgetResize",function(n,t){(e.widget.Id==t||t==0)&&u.SetLoneChartSize(e.widget.Id,e.chart)});r.$on("WidgetResize.Stop",function(n,t){(e.widget.Id==t||t==0)&&o(function(){u.SetLoneChartSize(e.widget.Id,e.chart)},50,20)});r.$on("Dashboard",function(n,t){console.log("gsTopFiveAlarmTypes Dashboard event. Modified Dashboard = %O",t);t.Id==e.dashboard.Id&&(e.dashboard=t,s(!1))});e.state=i;Highcharts.setOptions({global:{useUTC:!1}});n.GetJBTData().then(function(n){e.JBTData=n;var t=Global.User.ReaderOf.where(function(n){return n.split(".")[0]=="Site"}).select(function(n){return n.split(".")[1]});console.log("user site codes = %O",t);e.userSites=e.JBTData.Sites.where(function(n){return t.any(function(t){return t==n.Name})});console.log("vm.userSites = %O",e.userSites);e.userSites.length==1?(console.log("User only has a single Site"),e.widget.WidgetResource.SiteId=e.userSites[0].Id,e.widgetSite=e.userSites[0],s()):e.widget.WidgetResource.SiteId&&s();e.widget.displaySettings.headingExtraTitle=h()});r.$watch("vm.widget.WidgetResource.SiteId",function(n,t){e.widget.WidgetResource.SiteId&&e.userSites&&(e.widgetSite=e.userSites.first(function(n){return n.Id==e.widget.WidgetResource.SiteId}),console.log("vm.widget.WidgetResource.SiteId changed. Now = %O",e.widget),t!=n&&(e.widget.WidgetResource.$save(),s()))});e.updateInterval=o(function(){s()},12e4);r.$on("$destroy",function(){o.cancel(e.updateInterval)})};return s.$inject=["$scope"],{restrict:"E",templateUrl:"app/widgetDirectives/gsTopFiveAlarmTypesByEquipment.html?"+Date.now(),scope:{dashboard:"=",widget:"=",signalUpdateFunction:"&",setPanelHeadingColorFunction:"&",mode:"@"},controllerAs:"vm",controller:s,bindToController:!0}}])}(),function(){var n=angular.module("app");n.directive("iframeWidget",["dataService","utilityService","$state","hotkeys","displaySetupService","$timeout","$window","$interval","signalR","uibButtonConfig","$sce",function(n,t,i,r,u,f,e,o,s,h,c){var l=function(n){function r(){var n=u.GetWidgetPanelBodyDimensions(t.widget.Id);$("#systemIFrame"+t.widget.Id).css("height",n.height)}var t=this;t.widget.headingBackground="linear-gradient(to bottom,#3eff3e, #eefeee)";t.widget.displaySettings={headingBackground:"linear-gradient(to bottom,#3eff3e, #eefeee)",tagDataSortField:"-LastObservationDate",headingExtraTitle:"",obscureGraphics:!0};t.bootstrapLabelColumns=2;t.bootstrapInputColumns=10;h.activeClass="radio-active";t.user=Global.User;u.SetWidgetPanelBodyDimensions(t.widget.Id);f(function(){r()},25);t.showWidget=!1;t.OpenSettingsIfNoURLAndCloseIfURLIsPresent=function(){if(console.log("vm.OpenSettingsIfNoURLAndCloseIfURLIsPresent "),t.widget.WidgetResource.TargetURL&&t.widget.WidgetResource.TargetURL!="")$("#gridster"+t.widget.Id).css("z-index","2"),$("#widget-settings-"+t.widget.WidgetResource.Id).slideUp();else{var i=$("#widget-settings-"+t.widget.WidgetResource.Id)[0].parentNode.parentNode.offsetParent,n=$(i).offset();n.width=$(i).width();$("#gridster"+t.widget.Id).css("z-index","35");$("#widget-settings-"+t.widget.WidgetResource.Id).css({left:n.left+20,top:n.top+35,width:500,"z-index":35});$("#widget-settings-"+t.widget.WidgetResource.Id).slideDown()}};f(function(){if(!t.widget.WidgetResource.TargetURL||t.widget.WidgetResource.TargetURL==""){var i=$("#widget-settings-"+t.widget.WidgetResource.Id)[0].parentNode.parentNode.offsetParent,n=$(i).offset();n.width=$(i).width();$("#gridster"+t.widget.Id).css("z-index","35");$("#widget-settings-"+t.widget.WidgetResource.Id).css({left:n.left+20,top:n.top+35,width:500,"z-index":35});$("#widget-settings-"+t.widget.WidgetResource.Id).slideToggle()}},200);n.$watch("vm.widget.WidgetResource.TargetURL",function(n,i){t.widget.WidgetResource.TargetURL&&t.widget.WidgetResource.TargetURL!=""&&n!=i&&(t.widget.WidgetResource.$save(),t.url=c.trustAsResourceUrl(t.widget.WidgetResource.TargetURL))});t.CloseSettings=function(){$("#widget-settings-"+t.widget.WidgetResource.Id).slideUp()};t.url=c.trustAsResourceUrl(t.widget.WidgetResource.TargetURL);n.$on("WidgetResize",function(n,i){(t.widget.Id==i||i==0)&&(u.SetPanelBodyWithIdHeight(t.widget.Id),r())});n.$on("WidgetResize.Stop",function(n,i){(t.widget.Id==i||i==0)&&o(function(){u.SetPanelBodyWithIdHeight(t.widget.Id);r()},50,20)});t.state=i;n.$$postDigest(function(){u.SetPanelBodyWithIdHeight(t.widget.Id)})};return l.$inject=["$scope"],{restrict:"E",templateUrl:"app/widgetDirectives/iframeWidget.html?"+Date.now(),scope:{dashboard:"=",widget:"=",mode:"@"},controllerAs:"vm",controller:l,bindToController:!0}}])}(),function(){var n=angular.module("app");n.directive("linearMeter",["dataService","utilityService","$state","hotkeys","displaySetupService","$timeout","$window","$interval","signalR","uibButtonConfig",function(){var n=function(n){function i(){var n=f(t.currentValue,1).toString();n.indexOf(".")<0&&(n+=".0");t.currentValueLabel=n}function r(){t.currentValue<t.lowRangeEndValue&&(t.lowRangeActive=!0,t.normalRangeActive=!1,t.highRangeActive=!1);t.currentValue>=t.lowRangeEndValue&&t.currentValue<t.highRangeStartValue&&(t.lowRangeActive=!1,t.normalRangeActive=!0,t.highRangeActive=!1);t.currentValue>=t.highRangeStartValue&&(t.lowRangeActive=!1,t.normalRangeActive=!1,t.highRangeActive=!0)}function u(){t.valuePercentagePosition=(t.currentValue-t.lowRangeStartValue-20)/(t.highRangeEndValue-t.lowRangeStartValue)*100;t.valuePercentagePosition>95&&(t.valuePercentagePosition=95);t.valuePercentagePosition<-5&&(t.valuePercentagePosition=-5);t.valuePercentagePosition+=3}function f(n,t){return+(Math.round(+(n.toString()+"e"+t)).toString()+"e"+-t)}var t=this;t.lowPercentageWidth=(t.lowRangeEndValue-t.lowRangeStartValue)/(t.maxScale-t.minScale)*100;t.highPercentageWidth=(t.highRangeEndValue-t.highRangeStartValue)/(t.maxScale-t.minScale)*100;t.midPercentageWidth=100-t.lowPercentageWidth-t.highPercentageWidth;t.lowRangeTitle="Low Range: "+t.lowRangeStartValue+" to "+t.lowRangeEndValue;t.normalRangeTitle="Normal Range: "+t.lowRangeEndValue+" to "+t.highRangeStartValue;t.highRangeTitle="High Range: "+t.highRangeStartValue+" to "+t.highRangeEndValue;i();u();r();n.$watch("vm.currentValue",function(){u();i();r()})};return n.$inject=["$scope"],{restrict:"E",templateUrl:"app/widgetDirectives/linearMeter.html?"+Date.now(),scope:{lowRangeStartValue:"=",lowRangeEndValue:"=",highRangeStartValue:"=",highRangeEndValue:"=",minScale:"=",maxScale:"=",lowRangeActiveColor:"@",highRangeActiveColor:"@",normalRangeActiveColor:"@",id:"@",label:"@",units:"@",currentValue:"="},controllerAs:"vm",controller:n,bindToController:!0}}])}(),function(){var n=angular.module("app");n.directive("pbbSummary",["$rootScope","dataService","utilityService","$state","hotkeys","displaySetupService","$timeout","$window","$interval","signalR","uibButtonConfig",function(n,t,i,r,u,f,e,o,s,h,c){var l=function(i){function y(){if(u.Asset&&u.Asset.Site&&u.Asset.ParentSystem&&u.Asset.ParentSystem.Name)return" - "+u.Asset.Site.Name+" Gate "+u.Asset.ParentSystem.Name+(u.Asset.ModelGenericName?" - "+u.Asset.ModelGenericName:"")}function o(){var n=angular.copy(u.widget.WidgetResource);angular.equals(u.originalWidgetResource,n)||(u.widget.WidgetResource.$save(),u.originalWidgetResource=n)}function p(){t.GetJBTData().then(function(n){u.JBTData=n;u.pbb=u.JBTData.Assets.first(function(n){return n.ParentSystemId==u.widget.WidgetResource.GateSystemId&&n.Name=="PBB"});u.Asset=u.pbb;u.widget.WidgetResource.GateSystemId&&(u.GateSystem=u.JBTData.Systems.first(function(n){return n.Id==u.widget.WidgetResource.GateSystemId}));u.widget.WidgetResource.AssetId=u.pbb.Id;u.widget.displaySettings.headingExtraTitle=y();o();t.GetAllSignalRObservationFormattedTagsForAssetIdIntoInventory(u.pbb.Id).then(function(){u.AssetGraphics=t.cache.assetGraphics.where(function(n){return n.AssetId==u.pbb.Id});u.AssetGraphics.forEach(function(n){n.AssetGraphicVisibleValues=t.cache.assetGraphicVisibleValues.where(function(t){return t.AssetGraphicId==n.Id&&t.JBTStandardObservationId});n.showImage=!1});e(function(){b();a(5)},100);u.pbb.Tags.forEach(function(n){w(n)});u.pbb.Tags=u.pbb.Tags.distinct(function(n,t){return n.TagId==t.TagId});u.atLeastOneGraphicIsVisible=v();u.widget.displaySettings.obscureGraphics=!v();u.widget.displaySettings.headingExtraTitle=y();u.alarms||(u.alarms=[]);u.warnings||(u.warnings=[]);u.pbb.Tags=t.cache.tags.where(function(n){return n.AssetId==u.pbb.Id});var n=[4331,4445,4765,12255];u.alarms=u.pbb.Tags.where(function(t){return t.AssetId==u.widget.WidgetResource.AssetId&&t.IsAlarm&&!n.any(function(n){return n==t.JBTStandardObservationId})});u.warnings=u.pbb.Tags.where(function(n){return n.AssetId==u.widget.WidgetResource.AssetId&&n.IsWarning});u.commLossTag=u.pbb.Tags.first(function(t){return n.any(function(n){return n==t.JBTStandardObservationId})});u.widget.displaySettings.commLossTag=u.commLossTag;console.log("PBB vm.alarms = %O",u.alarms);u.widget.searchText=u.widget.WidgetResource.DefaultSearchText||"";l();e(function(){u.showWidget=!0},100)})})}function a(n){s(function(){f.SetWidgetPanelBodyDimensions(u.widget.Id);var t=f.GetWidgetPanelBodyDimensions(u.widget.Id),i=f.GetDivDimensionsById("nav-pills"+u.widget.Id),n=0;t&&(n=u.widget.WidgetResource.IsModalPopUp?t.height-i.height-20:t.height-i.height-3,$("#tab-content"+u.widget.Id).css("height",n),$("#repeater-container-data"+u.widget.Id).css("height",n),$("#repeater-container-alarms"+u.widget.Id).css("height",n),$("#repeater-container-warnings"+u.widget.Id).css("height",n),u.showTags=!0)},50,n)}function l(){if(u.alarms&&u.alarms.length>0&&u.alarms.any(function(n){return n.ValueWhenActive==n.Value})){u.widget.displaySettings.headingBackground="linear-gradient(to bottom,#FF0000, #FFDDDD)";return}u.widget.displaySettings.headingBackground=v()&&(!u.commLossTag||u.commLossTag.Value!="1")?"linear-gradient(to bottom,#3eff3e, #eefeee)":"linear-gradient(to bottom,#dedede, #fefefe)"}function v(){return u.AssetGraphics?u.AssetGraphics.any(function(n){return n.showImage}):!1}function b(){u.splitterIsSetup||i.$$postDigest(function(){f.SetPanelBodyWithIdHeight(u.widget.Id);i.$$postDigest(function(){u.widget.WidgetResource.SplitLeftPercentage=u.widget.WidgetResource.SplitLeftPercentage||50;u.widget.WidgetResource.SplitRightPercentage=u.widget.WidgetResource.SplitRightPercentage||50;try{u.splitter=Split(["#containerData"+u.widget.Id,"#containerGraphics"+u.widget.Id],{elementStyle:function(n,t,i){return{"flex-basis":"calc("+t+"% - "+i+"px)"}},gutterStyle:function(n,t){return{"flex-basis":t+"px","background-image":"url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAUAAAAeCAYAAADkftS9AAAAIklEQVQoU2M4c+bMfxAGAgYYmwGrIIiDjrELjpo5aiZeMwF+yNnOs5KSvgAAAABJRU5ErkJggg==')","background-repeat":"no-repeat","background-position":"50%","background-color":"transparent",cursor:"col-resize"}},sizes:[u.widget.WidgetResource.SplitLeftPercentage,u.widget.WidgetResource.SplitRightPercentage],minSize:0,onDragEnd:function(){var n=u.splitter.getSizes();u.widget.WidgetResource.SplitLeftPercentage=n[0];u.widget.WidgetResource.SplitRightPercentage=n[1];o()},onDrag:function(){}})}catch(n){}});u.splitterIsSetup=!0})}function w(n){n&&u.pbb&&n.AssetId==u.pbb.Id&&u.AssetGraphics&&u.AssetGraphics.forEach(function(t){t.AssetGraphicVisibleValues.forEach(function(t){+t.JBTStandardObservationId==+n.JBTStandardObservationId&&(t.showImage=+n.Value==+t.ValueWhenVisible||n.Value==t.ValueWhenVisible)});t.showImage=t.AssetGraphicVisibleValues.length>0&&t.AssetGraphicVisibleValues.all(function(n){return n.showImage})});u.widget.displaySettings.obscureGraphics=!v();l()}var u=this;u.widget.displaySettings={headingBackground:"linear-gradient(to bottom,#dedede, #fefefe)",tagDataSortField:"-PLCLocalDate",alarmDataSortField:"-PLCLocalDate",warningsDataSortField:"-PLCLocalDate",headingExtraTitle:"",obscureGraphics:!0,headingSearchField:!0};u.originalWidgetResource=angular.copy(u.widget.WidgetResource);i.$watch("vm.widget.searchText",function(n,t){(t||"")!=(n||"")&&(console.log("searchText change = Old = "+t+" New = "+n),u.widget.WidgetResource.DefaultSearchText=n,o(),h.SignalAllClientsInGroup("Admin",u.widget.Id+" SearchText Modification",u.widget.searchText))});u.SetDefaultNavPillAlarms=function(){e(function(){u.widget.WidgetResource.DefaultNavPill="Alarms";o()},100)};u.SetDefaultNavPillWarnings=function(){e(function(){u.widget.WidgetResource.DefaultNavPill="Warnings";o()},100)};u.SetDefaultNavPillData=function(){e(function(){u.widget.WidgetResource.DefaultNavPill="Data";o()},100)};u.alarmFilterFunction=function(n){return n.ValueWhenActive==n.Value};u.tagFilterFunction=function(n){return(u.widget.searchText||"")!=""&&n.JBTStandardObservation&&n.JBTStandardObservation.Name?n.JBTStandardObservation.Name.toLowerCase().indexOf((u.widget.searchText||"").toLowerCase())>-1:n.JBTStandardObservation?!0:!1};u.tagsToGraph=[];u.bootstrapLabelColumns=2;u.bootstrapInputColumns=10;c.activeClass="radio-active";u.user=Global.User;f.SetWidgetPanelBodyDimensions(u.widget.Id);u.showWidget=!1;u.SetSortField=function(n){var t=performance.now();u.widget.displaySettings.tagDataSortField=u.widget.displaySettings.tagDataSortField.substr(1,50)==n||u.widget.displaySettings.tagDataSortField==n?u.widget.displaySettings.tagDataSortField.substr(0,1)=="-"?n:"-"+n:n};u.SetAlarmSortField=function(n){var t=performance.now();u.widget.displaySettings.alarmDataSortField=u.widget.displaySettings.alarmDataSortField.substr(1,50)==n||u.widget.displaySettings.alarmDataSortField==n?u.widget.displaySettings.alarmDataSortField.substr(0,1)=="-"?n:"-"+n:n};u.SetWarningSortField=function(n){var t=performance.now();u.widget.displaySettings.warningDataSortField=u.widget.displaySettings.warningDataSortField.substr(1,50)==n||u.widget.displaySettings.warningDataSortField==n?u.widget.displaySettings.warningDataSortField.substr(0,1)=="-"?n:"-"+n:n};u.scrolledToEnd=function(){console.log("pbb Data Scrolled to end")};u.OpenSettingsIfNoAssetAndCloseIfAssetIsPresent=function(){u.pbb||r.go(".widgetSettings",{widget:u.widget})};u.ProcessTagsToGraph=function(){u.tagsToGraphObjects=[];u.tagsToGraph.forEach(function(n,t){u.tagsToGraphObjects.push({TagId:t,Enabled:n})});console.log("vm in vm.ProcessTagsToGraph = %O",u);u.dashboard.tagsToGraph=u.tagsToGraphObjects.concat(u.dashboard.tagsToGraph).distinct(function(n,t){return n.TagId==t.TagId}).where(function(n){return n.Enabled});console.log("Dashboard vm.dashboard.tagsToGraph = %O",u.dashboard.tagsToGraph);u.dashboard.tagsToGraph.length>0?n.$broadcast("Dashboard.TagsToGraph",u.dashboard.tagsToGraph):n.$broadcast("Dashboard.TagsToGraph",null);return};t.GetJBTData().then(function(n){u.JBTData=n;u.Asset=u.JBTData.Assets.first(function(n){return n.Id==u.widget.WidgetResource.AssetId});u.pbb=u.Asset;p();u.widget.displaySettings.headingExtraTitle=y()});i.$watch("vm.widget.WidgetResource.GateSystemId",function(n,i){u.widget.WidgetResource.GateSystemId&&n!=i&&(u.pbb=null,o(),t.GetEntityById("SystemGroups",n).then(function(n){u.GateSystem=n}),p())});u.splitterIsSetup=!1;i.$on("WidgetResize",function(n,t){(u.widget.Id==t||t==0)&&(f.SetPanelBodyWithIdHeight(u.widget.Id),a(1))});i.$on("ResizeVirtualScrollContainers",function(){f.SetPanelBodyWithIdHeight(u.widget.Id);a(1)});i.$on("WidgetResize.Stop",function(n,t){(u.widget.Id==t||t==0)&&e(function(){f.SetPanelBodyWithIdHeight(u.widget.Id);a(1)},200)});i.$on("GraphWidgetAdded",function(n,t){u.dashboard.Id==t.ParentDashboardId&&(u.tagsToGraphObjects=[],u.tagsToGraph=[])});i.$on("Widget.AddTagsToGraph",function(){u.tagsToGraphObjects=[];u.tagsToGraph=[]});i.$on("dataService.TagUpdate",function(n,t){w(t);l();return});u.tagOrderByLastChange=!0;u.SetTagOrderByLastChange=function(){u.tagOrderByLastChange=!0;u.tagOrderByCustom=!1};u.SetTagOrderByCustom=function(){u.tagOrderByLastChange=!1;u.tagOrderByCustom=!0};i.$on("Dashboard",function(n,t){if(t.Id==u.dashboard.Id){u.dashboard=t;u.diffDays=Math.round(Math.abs((u.dashboard.derivedStartDate.getTime()-(new Date).getTime())/864e5))}});u.state=r;i.$$postDigest(function(){f.SetPanelBodyWithIdHeight(u.widget.Id)})};return l.$inject=["$scope"],{restrict:"E",templateUrl:"app/widgetDirectives/pbbSummary.html",scope:{dashboard:"=",widget:"=",addTagsToGraphFunction:"&",setPanelHeadingColorFunction:"&",mode:"@"},controllerAs:"vm",controller:l,bindToController:!0}}])}(),function(){function n(n,t,i,r,u,f,e,o,s,h,c,l,a,v){console.log("PBBSummaryModalCtrl invoked");var y=this;y.state=t;y.widget=e.widget;y.assetId=e.assetId;y.dashboard=e.dashboard;y.showScreen=!1;h.activeClass="radio-active";f.GetJBTData().then(function(n){y.JBTData=n;y.gpu=n.Assets.first(function(n){return n.Id==y.assetId});y.panelTitle=y.widget.Name;y.panelSubtitle="esc to close";y.showScreen=!0});y.AddToDashboard=function(){f.GetEntityById("WidgetTypes",y.widget.WidgetResource.WidgetTypeId).then(function(n){return f.AddEntity("Widgets",{Name:"PBB Summary",WidgetTypeId:y.widget.WidgetResource.WidgetTypeId,ParentDashboardId:y.dashboard.Id,Width:n.InitialWidth,Height:n.InitialHeight,Row:100,Col:0,AssetId:y.widget.WidgetResource.AssetId,DefaultNavPill:"Press",GateSystemId:y.widget.WidgetResource.GateSystemId,SiteId:y.widget.WidgetResource.SiteId,SplitLeftPercentage:50,SplitRightPercentage:50,SystemId:y.widget.WidgetResource.SystemId,TerminalSystemId:y.widget.WidgetResource.TerminalSystemId,ZoneSystemId:y.widget.WidgetResource.ZoneSystemId}).then(function(n){v.SignalAllClients("WidgetAdded",n)})})};c.bindTo(r).add({combo:"esc",description:"Cancel and close any input form",allowIn:["INPUT","SELECT","TEXTAREA"],callback:function(){t.go("^")}})}angular.module("app").controller("PBBSummaryModalCtrl",["$q","$state","$rootScope","$scope","securityService","dataService","$stateParams","utilityService","$timeout","uibButtonConfig","hotkeys","$interval","displaySetupService","signalR",n])}(),function(){var n=angular.module("app");n.directive("pcaSummary",["$rootScope","dataService","utilityService","$state","hotkeys","displaySetupService","$timeout","$window","$interval","signalR","uibButtonConfig","$location",function(n,t,i,r,u,f,e,o,s,h,c){var l=function(i){function y(){if(u.Asset&&u.Asset.Site&&u.Asset.ParentSystem)return" - "+u.Asset.Site.Name+" Gate "+u.Asset.ParentSystem.Name+(u.Asset.ModelGenericName?" - "+u.Asset.ModelGenericName:"")}function o(){var n=angular.copy(u.widget.WidgetResource);angular.equals(u.originalWidgetResource,n)||(u.widget.WidgetResource.$save(),u.originalWidgetResource=n)}function p(){u.pca=u.JBTData.Assets.first(function(n){return n.ParentSystemId==u.widget.WidgetResource.GateSystemId&&n.Name=="PCA"});u.Asset=u.pca;u.widget.WidgetResource.AssetId=u.pca.Id;o();u.widget.displaySettings.headingExtraTitle=y();t.GetAllSignalRObservationFormattedTagsForAssetIdIntoInventory(u.pca.Id).then(function(){u.AssetGraphics=t.cache.assetGraphics.where(function(n){return n.AssetId==u.pca.Id});u.AssetGraphics.forEach(function(n){n.AssetGraphicVisibleValues=t.cache.assetGraphicVisibleValues.where(function(t){return t.AssetGraphicId==n.Id&&t.JBTStandardObservationId});n.showImage=!1});e(function(){b();l(5)},50);u.pca.Tags.forEach(function(n){w(n)});u.atLeastOneGraphicIsVisible=v();u.widget.displaySettings.obscureGraphics=!v();u.widget.displaySettings.headingExtraTitle=y();u.GenerateTemperatureCharts();u.GeneratePressureCharts();u.alarms||(u.alarms=[]);u.warnings||(u.warnings=[]);u.pca.Tags=t.cache.tags.where(function(n){return n.AssetId==u.pca.Id});var n=[4331,4445,4765,12255];u.alarms=u.pca.Tags.where(function(t){return t.AssetId==u.widget.WidgetResource.AssetId&&t.IsAlarm&&!n.any(function(n){return n==t.JBTStandardObservationId})});u.warnings=u.pca.Tags.where(function(n){return n.AssetId==u.widget.WidgetResource.AssetId&&n.IsWarning});u.commLossTag=u.pca.Tags.first(function(t){return n.any(function(n){return n==t.JBTStandardObservationId})});u.widget.displaySettings.commLossTag=u.commLossTag;a();e(function(){u.showWidget=!0},100);u.widget.searchText=u.widget.WidgetResource.DefaultSearchText||"";e(function(){$(function(){$('[data-toggle="tooltip"]').tooltip({html:!0})})},50)})}function l(n){s(function(){f.SetWidgetPanelBodyDimensions(u.widget.Id);var t=f.GetWidgetPanelBodyDimensions(u.widget.Id),i=f.GetDivDimensionsById("nav-pills"+u.widget.Id),n=0;t&&(n=u.widget.WidgetResource.IsModalPopUp?t.height-i.height-20:t.height-i.height-3,$("#tab-content"+u.widget.Id).css("height",n),$("#repeater-container-data"+u.widget.Id).css("height",n),$("#repeater-container-alarms"+u.widget.Id).css("height",n),$("#repeater-container-warnings"+u.widget.Id).css("height",n),u.showTags=!0)},50,n||1)}function a(){if(u.alarms&&u.alarms.length>0&&u.alarms.any(function(n){return n.ValueWhenActive==n.Value})){u.widget.displaySettings.headingBackground="linear-gradient(to bottom,#FF0000, #FFDDDD)";return}u.widget.displaySettings.headingBackground=v()&&(!u.commLossTag||u.commLossTag.Value!="1")?"linear-gradient(to bottom,#3eff3e, #eefeee)":"linear-gradient(to bottom,#dedede, #fefefe)"}function v(){return u.AssetGraphics?u.AssetGraphics.any(function(n){return n.showImage}):!1}function b(){u.splitterIsSetup||i.$$postDigest(function(){f.SetPanelBodyWithIdHeight(u.widget.Id);i.$$postDigest(function(){u.widget.WidgetResource.SplitLeftPercentage=u.widget.WidgetResource.SplitLeftPercentage||50;u.widget.WidgetResource.SplitRightPercentage=u.widget.WidgetResource.SplitRightPercentage||50;u.splitter=Split(["#containerData"+u.widget.Id,"#containerGraphics"+u.widget.Id],{elementStyle:function(n,t,i){return{"flex-basis":"calc("+t+"% - "+i+"px)"}},gutterStyle:function(n,t){return{"flex-basis":t+"px","background-image":"url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAUAAAAeCAYAAADkftS9AAAAIklEQVQoU2M4c+bMfxAGAgYYmwGrIIiDjrELjpo5aiZeMwF+yNnOs5KSvgAAAABJRU5ErkJggg==')","background-repeat":"no-repeat","background-position":"50%","background-color":"transparent",cursor:"col-resize"}},sizes:[u.widget.WidgetResource.SplitLeftPercentage,u.widget.WidgetResource.SplitRightPercentage],minSize:0,onDragEnd:function(){var n=u.splitter.getSizes();u.widget.WidgetResource.SplitLeftPercentage=n[0];u.widget.WidgetResource.SplitRightPercentage=n[1];o()}});u.splitterIsSetup=!0})})}function w(n){n&&u.pca&&n.AssetId==u.pca.Id&&u.AssetGraphics&&u.AssetGraphics.forEach(function(t){t.AssetGraphicVisibleValues.forEach(function(t){t.JBTStandardObservationId==n.JBTStandardObservationId&&(t.showImage=+n.Value==+t.ValueWhenVisible||n.Value==t.ValueWhenVisible)});t.showImage=t.AssetGraphicVisibleValues.length>0&&t.AssetGraphicVisibleValues.all(function(n){return n.showImage})});u.widget.displaySettings.obscureGraphics=!v()}function k(n){u.ambientDataTag&&n.TagId==u.ambientDataTag.TagId&&(u.ambientAirTemperature=+u.ambientDataTag.Value>250?+u.ambientDataTag.Value/10:+u.ambientDataTag.Value)}function d(n){u.dischargeDataTag&&n.TagId==u.dischargeDataTag.TagId&&(u.dischargeAirTemperature=+u.dischargeDataTag.Value>250?+u.dischargeDataTag.Value/10:+u.dischargeDataTag.Value)}function g(n){u.cabinDataTag&&n.TagId==u.cabinDataTag.TagId&&(u.cabinAirTemperature=+u.cabinDataTag.Value>250?+u.cabinDataTag.Value/10:+u.cabinDataTag.Value)}function nt(n){u.primary1CompressorDataTag&&n.TagId==u.primary1CompressorDataTag.TagId&&(u.primary1CompressorPressure=+u.primary1CompressorDataTag.Value)}function tt(n){u.primary1CompressorSuctionDataTag&&n.TagId==u.primary1CompressorSuctionDataTag.TagId&&(u.primary1CompressorSuction=+u.primary1CompressorSuctionDataTag.Value)}function it(n){u.primary2CompressorDataTag&&n.TagId==u.primary2CompressorDataTag.TagId&&(u.primary2CompressorPressure=+u.primary2CompressorDataTag.Value)}function rt(n){u.primary2CompressorSuctionDataTag&&n.TagId==u.primary2CompressorSuctionDataTag.TagId&&(u.primary2CompressorSuction=+u.primary2CompressorSuctionDataTag.Value)}function ut(n){u.secondary1CompressorDataTag&&n.TagId==u.secondary1CompressorDataTag.TagId&&(u.secondary1CompressorPressure=+u.secondary1CompressorDataTag.Value)}function ft(n){u.secondary1CompressorSuctionDataTag&&n.TagId==u.secondary1CompressorSuctionDataTag.TagId&&(u.secondary1CompressorSuction=+u.secondary1CompressorSuctionDataTag.Value)}function et(n){u.secondary2CompressorDataTag&&n.TagId==u.secondary2CompressorDataTag.TagId&&(u.secondary2CompressorPressure=+u.secondary2CompressorDataTag.Value)}function ot(n){u.secondary2CompressorSuctionDataTag&&n.TagId==u.secondary2CompressorSuctionDataTag.TagId&&(u.secondary2CompressorSuction=+u.secondary2CompressorSuctionDataTag.Value)}function st(){u.ambientDataTag=u.pca.Tags.where(function(n){return[4084].any(function(t){return t==n.JBTStandardObservationId})}).orderByDescending(function(n){return n.PLCLocalDate}).first();u.ambientDataTag&&(u.ambientAirTemperature=+u.ambientDataTag.Value>250?+u.ambientDataTag.Value/10:+u.ambientDataTag.Value)}function ht(){u.dischargeDataTag=u.pca.Tags.where(function(n){return[2736].any(function(t){return t==n.JBTStandardObservationId})}).orderByDescending(function(n){return n.PLCLocalDate}).first();u.dischargeDataTag&&(u.dischargeAirTemperature=+u.dischargeDataTag.Value>250?+u.dischargeDataTag.Value/10:+u.dischargeDataTag.Value)}function ct(){u.cabinDataTag=u.pca.Tags.where(function(n){return[4063,3920,4342].any(function(t){return t==n.JBTStandardObservationId})}).where(function(n){return+n.Value>2}).orderByDescending(function(n){return n.PLCLocalDate}).first();u.cabinDataTag&&(u.cabinAirTemperature=+u.cabinDataTag.Value>250?+u.cabinDataTag.Value/10:+u.cabinDataTag.Value)}function lt(){u.primary1CompressorDataTag=u.pca.Tags.where(function(n){return[4076,3908,4053,3848].any(function(t){return t==n.JBTStandardObservationId})}).orderByDescending(function(n){return n.PLCLocalDate}).first();u.primary1CompressorDataTag&&(u.primary1CompressorPressure=+u.primary1CompressorDataTag.Value)}function at(){u.primary1CompressorSuctionDataTag=u.pca.Tags.where(function(n){return[3912,3987,4019,4057,4080,12306,12310,2863,3731,4695,3797].any(function(t){return t==n.JBTStandardObservationId})}).orderByDescending(function(n){return n.PLCLocalDate}).first();u.primary1CompressorSuctionDataTag&&(u.primary1CompressorSuction=+u.primary1CompressorSuctionDataTag.Value)}function vt(){u.primary2CompressorDataTag=u.pca.Tags.where(function(n){return[4077,3909,4079,4054].any(function(t){return t==n.JBTStandardObservationId})}).orderByDescending(function(n){return n.PLCLocalDate}).first();u.primary2CompressorDataTag&&(u.primary2CompressorPressure=+u.primary2CompressorDataTag.Value)}function yt(){u.primary2CompressorSuctionDataTag=u.pca.Tags.where(function(n){return[3913,4020,2253,4081,12297,12299].any(function(t){return t==n.JBTStandardObservationId})}).orderByDescending(function(n){return n.PLCLocalDate}).first();u.primary2CompressorSuctionDataTag&&(u.primary2CompressorSuction=+u.primary2CompressorSuctionDataTag.Value)}function pt(){u.secondary1CompressorDataTag=u.pca.Tags.where(function(n){return[4078,3910,4664].any(function(t){return t==n.JBTStandardObservationId})}).orderByDescending(function(n){return n.PLCLocalDate}).first();u.secondary1CompressorDataTag&&(u.secondary1CompressorPressure=+u.secondary1CompressorDataTag.Value)}function wt(){u.secondary1CompressorSuctionDataTag=u.pca.Tags.where(function(n){return[3914,4666,3849,12304,12308,4082].any(function(t){return t==n.JBTStandardObservationId})}).orderByDescending(function(n){return n.PLCLocalDate}).first();u.secondary1CompressorSuctionDataTag&&(u.secondary1CompressorSuction=+u.secondary1CompressorSuctionDataTag.Value)}function bt(){u.secondary2CompressorDataTag=u.pca.Tags.where(function(n){return[3911].any(function(t){return t==n.JBTStandardObservationId})}).orderByDescending(function(n){return n.PLCLocalDate}).first();u.secondary2CompressorDataTag&&(u.secondary2CompressorPressure=+u.secondary1CompressorDataTag.Value)}function kt(){u.secondary2CompressorSuctionDataTag=u.pca.Tags.where(function(n){return[12298,1874,4083,3915].any(function(t){return t==n.JBTStandardObservationId})}).orderByDescending(function(n){return n.PLCLocalDate}).first();u.secondary2CompressorSuctionDataTag&&(u.secondary2CompressorSuction=+u.secondary2CompressorSuctionDataTag.Value)}var u=this;u.widget.displaySettings={headingBackground:"linear-gradient(to bottom,#dedede, #fefefe)",tagDataSortField:"-PLCLocalDate",alarmDataSortField:"-PLCLocalDate",warningsDataSortField:"-PLCLocalDate",headingExtraTitle:"",obscureGraphics:!0,commLossTag:u.commLossTag,headingSearchField:!0};u.scrolledToEnd=function(){};u.tagFilterFunction=function(n){return(u.widget.searchText||"")!=""?n.JBTStandardObservation.Name.toLowerCase().indexOf((u.widget.searchText||"").toLowerCase())>-1:!0};u.alarmFilterFunction=function(n){return n.ValueWhenActive==n.Value};u.tagClicked=function(n){console.log("tag clicked = %O",n)};i.$watch("vm.widget.searchText",function(n,t){(t||"")!=(n||"")&&(console.log("searchText change = Old = "+t+" New = "+n),u.widget.WidgetResource.DefaultSearchText=n,o(),h.SignalAllClientsInGroup("Admin",u.widget.Id+" SearchText Modification",u.widget.searchText))});u.originalWidgetResource=angular.copy(u.widget.WidgetResource);u.tagsToGraph=[];u.bootstrapLabelColumns=2;u.bootstrapInputColumns=10;c.activeClass="radio-active";u.user=Global.User;f.SetWidgetPanelBodyDimensions(u.widget.Id);u.showWidget=!1;u.SetSortField=function(n){var t=performance.now();u.widget.displaySettings.tagDataSortField=u.widget.displaySettings.tagDataSortField.substr(1,50)==n||u.widget.displaySettings.tagDataSortField==n?u.widget.displaySettings.tagDataSortField.substr(0,1)=="-"?n:"-"+n:n};u.SetAlarmSortField=function(n){var t=performance.now();u.widget.displaySettings.alarmDataSortField=u.widget.displaySettings.alarmDataSortField.substr(1,50)==n||u.widget.displaySettings.alarmDataSortField==n?u.widget.displaySettings.alarmDataSortField.substr(0,1)=="-"?n:"-"+n:n};u.SetWarningSortField=function(n){var t=performance.now();u.widget.displaySettings.warningDataSortField=u.widget.displaySettings.warningDataSortField.substr(1,50)==n||u.widget.displaySettings.warningDataSortField==n?u.widget.displaySettings.warningDataSortField.substr(0,1)=="-"?n:"-"+n:n};u.OpenSettingsIfNoAssetAndCloseIfAssetIsPresent=function(){console.log("Opening settings vm.Asset = %O",u.Asset);u.pca||r.go(".widgetSettings",{widget:u.widget})};u.ProcessTagsToGraph=function(){u.tagsToGraphObjects=[];u.tagsToGraph.forEach(function(n,t){u.tagsToGraphObjects.push({TagId:t,Enabled:n})});console.log("vm in vm.ProcessTagsToGraph = %O",u);u.dashboard.tagsToGraph=u.tagsToGraphObjects.concat(u.dashboard.tagsToGraph).distinct(function(n,t){return n.TagId==t.TagId}).where(function(n){return n.Enabled});console.log("Dashboard vm.dashboard.tagsToGraph = %O",u.dashboard.tagsToGraph);u.dashboard.tagsToGraph.length>0?n.$broadcast("Dashboard.TagsToGraph",u.dashboard.tagsToGraph):n.$broadcast("Dashboard.TagsToGraph",null);return};t.GetJBTData().then(function(n){u.JBTData=n;u.Asset=u.JBTData.Assets.first(function(n){return n.Id==u.widget.WidgetResource.AssetId});u.pca=u.Asset;p();u.widget.displaySettings.headingExtraTitle=y()});i.$watch("vm.widget.WidgetResource.GateSystemId",function(n,t){u.widget.WidgetResource.GateSystemId&&n!=t&&(u.pca=null,o(),p())});u.GenerateTemperatureCharts=function(){st();ht();ct();l()};u.GeneratePressureCharts=function(){lt();at();vt();yt();pt();wt();bt();kt();l()};u.SetDefaultNavPillTemp=function(){e(function(){u.widget.WidgetResource.DefaultNavPill="Temp";o()},100)};u.SetDefaultNavPillPress=function(){e(function(){u.widget.WidgetResource.DefaultNavPill="Press";o()},100)};u.SetDefaultNavPillData=function(){e(function(){u.widget.WidgetResource.DefaultNavPill="Data";o()},100)};u.SetDefaultNavPillAlarms=function(){e(function(){u.widget.WidgetResource.DefaultNavPill="Alarms";o()},100)};u.SetDefaultNavPillWarnings=function(){e(function(){u.widget.WidgetResource.DefaultNavPill="Warnings";o()},100)};u.alarmFilterFunction=function(n){return n.ValueWhenActive==n.Value};u.splitterIsSetup=!1;i.$on("WidgetResize",function(n,t){(u.widget.Id==t||t==0)&&(f.SetPanelBodyWithIdHeight(u.widget.Id),l(1))});i.$on("WidgetResize.Stop",function(n,t){(u.widget.Id==t||t==0)&&e(function(){f.SetPanelBodyWithIdHeight(u.widget.Id);l(1)},200)});i.$on("ResizeVirtualScrollContainers",function(){f.SetPanelBodyWithIdHeight(u.widget.Id);l(1)});i.$on("GraphWidgetAdded",function(n,t){u.dashboard.Id==t.ParentDashboardId&&(u.tagsToGraphObjects=[],u.tagsToGraph=[])});i.$on("Widget.AddTagsToGraph",function(){console.log("Widget.AddTagsToGraph event at PCA Summary");u.tagsToGraphObjects=[];u.tagsToGraph=[]});i.$on("dataService.TagUpdate",function(n,t){w(t);k(t);d(t);g(t);nt(t);tt(t);it(t);rt(t);ut(t);ft(t);et(t);ot(t);a();return});u.tagOrderByLastChange=!0;u.SetTagOrderByLastChange=function(){u.tagOrderByLastChange=!0;u.tagOrderByCustom=!1};u.SetTagOrderByCustom=function(){u.tagOrderByLastChange=!1;u.tagOrderByCustom=!0};i.$on("Dashboard",function(n,t){if(console.log("pcaSummary Dashboard event. Modified Dashboard = %O",t),t.Id==u.dashboard.Id){u.dashboard=t;u.diffDays=Math.round(Math.abs((u.dashboard.derivedStartDate.getTime()-(new Date).getTime())/864e5))}});u.state=r;i.$$postDigest(function(){f.SetPanelBodyWithIdHeight(u.widget.Id)})};return l.$inject=["$scope"],{restrict:"E",templateUrl:"app/widgetDirectives/pcaSummary.html",scope:{dashboard:"=",widget:"=",addTagsToGraphFunction:"&",setPanelHeadingColorFunction:"&",mode:"@"},controllerAs:"vm",controller:l,bindToController:!0}}])}(),function(){function n(n,t,i,r,u,f,e,o,s,h,c,l,a,v){console.log("PCASummaryModalCtrl invoked");var y=this;y.state=t;y.widget=e.widget;y.assetId=e.assetId;y.dashboard=e.dashboard;console.log("PCASummaryModalCtrl widget = %O",y.widget);y.showScreen=!1;h.activeClass="radio-active";f.GetJBTData().then(function(n){y.JBTData=n;y.pca=n.Assets.first(function(n){return n.Id==y.assetId});y.panelTitle=y.widget.Name;y.panelSubtitle="esc to close";y.showScreen=!0});y.AddToDashboard=function(){f.GetEntityById("WidgetTypes",y.widget.WidgetResource.WidgetTypeId).then(function(n){return f.AddEntity("Widgets",{Name:"PCA Summary",WidgetTypeId:y.widget.WidgetResource.WidgetTypeId,ParentDashboardId:y.dashboard.Id,Width:n.InitialWidth,Height:n.InitialHeight,Row:100,Col:0,AssetId:y.widget.WidgetResource.AssetId,DefaultNavPill:"Press",GateSystemId:y.widget.WidgetResource.GateSystemId,SiteId:y.widget.WidgetResource.SiteId,SplitLeftPercentage:50,SplitRightPercentage:50,SystemId:y.widget.WidgetResource.SystemId,TerminalSystemId:y.widget.WidgetResource.TerminalSystemId,ZoneSystemId:y.widget.WidgetResource.ZoneSystemId}).then(function(n){v.SignalAllClients("WidgetAdded",n)})})};c.bindTo(r).add({combo:"esc",description:"Cancel and close any input form",allowIn:["INPUT","SELECT","TEXTAREA"],callback:function(){t.go("^")}})}angular.module("app").controller("PCASummaryModalCtrl",["$q","$state","$rootScope","$scope","securityService","dataService","$stateParams","utilityService","$timeout","uibButtonConfig","hotkeys","$interval","displaySetupService","signalR",n])}(),function(){var n=angular.module("app");n.directive("rawTagDataForAsset",["dataService","utilityService","$state","hotkeys","displaySetupService","$timeout","$window","$interval","signalR","uibButtonConfig",function(n,t,i,r,u,f,e,o,s,h){var c=function(t){function e(){if(r.Asset)return" - "+r.Asset.Site.Name+" Gate "+r.Asset.ParentSystem.Name+" - "+r.Asset.Name+(r.Asset.ModelGenericName?" - "+r.Asset.ModelGenericName:"")}function s(){n.GetAllSignalRObservationFormattedTagsForAssetIdIntoInventory(r.widget.WidgetResource.AssetId).then(function(){f(function(){r.widgetDimensions=u.GetWidgetPanelBodyDimensions(r.widget.Id);u.SetPanelBodyWithIdHeight(r.widget.Id)},50);console.log("Monitoring asset = %O",r.Asset)})}var r=this;r.state=i;r.alarms=[];r.widgetDimensions=u.GetWidgetPanelBodyDimensions(r.widget.Id);r.columnHideWidth1=980;r.columnHideWidth2=600;t.$$postDigest(function(){r.widgetDimensions=u.GetWidgetPanelBodyDimensions(r.widget.Id);u.SetPanelBodyWithIdHeight(r.widget.Id)});r.widget.displaySettings={headingBackground:"linear-gradient(to bottom,#dedede, #fefefe)",tagDataSortField:"TagName",headingExtraTitle:e(),obscureGraphics:!0};r.tagsToGraph=[];h.activeClass="radio-active";r.headingUpdateInterval=o(function(){r.widget.displaySettings.headingExtraTitle=e()},500);t.$on("$destroy",function(){o.cancel(r.headingUpdateInterval)});r.showWidget=!1;r.SetSortField=function(n){var t=performance.now();r.widget.displaySettings.tagDataSortField=r.widget.displaySettings.tagDataSortField.substr(1,50)==n||r.widget.displaySettings.tagDataSortField==n?r.widget.displaySettings.tagDataSortField.substr(0,1)=="-"?n:"-"+n:n};r.ProcessTagsToGraph=function(){r.tagsToGraphObjects=[];r.tagsToGraph.forEach(function(n,t){r.tagsToGraphObjects.push({TagId:t,Enabled:n})});r.addTagsToGraphFunction()(r.tagsToGraphObjects);return};t.$on("Dashboard",function(n,t){t.Id==r.dashboard.Id&&(r.dashboard=t)});n.GetJBTData().then(function(n){r.JBTData=n;r.Asset=r.JBTData.Assets.first(function(n){return n.Id==r.widget.WidgetResource.AssetId});console.log("rawTagData Asset = %O",r.Asset);s();r.widget.displaySettings.headingExtraTitle=e()});t.$watch("vm.widget.WidgetResource.AssetId",function(n,t){console.log("AssetId changed - was "+t+" now "+n);n!=t&&n>0&&(console.log("Asset Id was different"),r.widget.WidgetResource.AssetId=+n,r.widget.WidgetResource.$save(),r.Asset=r.JBTData.Assets.first(function(t){return t.Id==+n}),s(),r.widget.displaySettings.headingExtraTitle=e())});r.OpenSettingsIfNoAssetAndCloseIfAssetIsPresent=function(){console.log("Opening settings vm.Asset = %O",r.Asset);r.Asset||i.go(".widgetSettings",{widget:r.widget})};r.leastId=0;t.$on("WidgetResize",function(n,t){(r.widget.Id==t||t==0)&&(r.widgetDimensions=u.GetWidgetPanelBodyDimensions(r.widget.Id),u.SetPanelBodyWithIdHeight(r.widget.Id))});t.$on("WidgetResize.Stop",function(n,t){(r.widget.Id==t||t==0)&&o(function(){r.widgetDimensions=u.GetWidgetPanelBodyDimensions(r.widget.Id);u.SetPanelBodyWithIdHeight(r.widget.Id)},50,20)});t.$on("GraphWidgetAdded",function(n,t){r.dashboard.Id==t.ParentDashboardId&&(r.tagsToGraphObjects=[],r.tagsToGraph=[])});t.$on("Widget.AddTagsToGraph",function(){console.log("Widget.AddTagsToGraph event at PCA Summary");r.tagsToGraphObjects=[];r.tagsToGraph=[]});r.scrolledToEnd=function(){console.log("Scrolled to end fired")}};return c.$inject=["$scope"],{restrict:"E",templateUrl:"app/widgetDirectives/rawTagDataForAsset.html?"+Date.now(),scope:{dashboard:"=",widget:"=",widgetId:"@",addTagsToGraphFunction:"&",signalUpdateFunction:"&",setPanelHeadingColorFunction:"&",mode:"@"},controllerAs:"vm",controller:c,bindToController:!0}}])}(),function(){var n=angular.module("app");n.directive("reports",["dataService","utilityService","$state","hotkeys","displaySetupService","$timeout","$window","$interval","signalR",function(n,t,i,r,u,f,e,o){var s=function(r){function c(){if(e.widgetSite)return" - "+e.widgetSite.Name}function s(){u.SetPanelBodyWithIdHeight(e.widget.Id);n.GetIOPSResource("Reports").expandPredicate("ReportRuns").filter("UserId",Global.User.Id).finish().query().$promise.then(function(n){h(n);l(n);e.reports=n.where(function(n){return n.Type=="GS"&&e.widgetSite.HasGates||n.Type=="BHS"&&e.widgetSite.HasBaggageHandling});u.SetPanelBodyWithIdHeight(e.widget.Id);e.widgetDimensions=u.GetWidgetPanelBodyDimensions(e.widget.Id);r.$$postDigest(function(){f(function(){u.SetPanelBodyWithIdHeight(e.widget.Id)},1)});e.widget.displaySettings.headingExtraTitle=c()})}function l(n){n.forEach(function(n){switch(n.Type){case"GS":n.Category="Gate Systems";break;case"BHS":n.Category="Baggage Handling";break;default:n.Category=""}})}function h(n){n.forEach(function(n){n.LastRunDate=n.ReportRuns.length>0?n.ReportRuns[0].Date:null})}var e=this;e.state=i;e.widgetDimensions=u.GetWidgetPanelBodyDimensions(e.widget.Id);e.widget.displaySettings={headingBackground:"linear-gradient(to bottom,#dedede, #fefefe)",headingExtraTitle:"",obscureGraphics:!0};e.columnwidths={Name:30,Category:30,Description:10,LastRunDate:10,Run:12};e.RunReport=function(i){var r=-((new Date).getTimezoneOffset()/60);window.open(i.RSURL+"&accessToken="+encodeURIComponent(Global.User.ODataAccessToken)+"&offset="+r+"&siteId="+e.widget.WidgetResource.SiteId);window.open(i.RSURL);i.ReportRuns.length==0?n.AddEntity("ReportRuns",{Date:t.GetOdataUpdateableCurrentDateTime(),UserId:Global.User.Id,ReportId:i.Id}).then(function(n){i.ReportRuns.push(n);h(e.reports)}):n.GetEntityById("ReportRuns",i.GSReportRuns[0].Id).then(function(n){n.Date=t.GetOdataUpdateableCurrentDateTime();n.$save();i.GSReportRuns[0]=n;h(e.reports)})};r.$on("Reports",function(t,i){i=n.GetJsonFromSignalR(i);console.log("Reports event. Report = %O",i);s()});e.sortField="Name";e.SetSortField=function(n){e.sortField=e.sortField.substr(1,50)==n||e.sortField==n?e.sortField.substr(0,1)=="-"?n:"-"+n:n};n.GetJBTData().then(function(n){e.JBTData=n;var t=Global.User.ReaderOf.where(function(n){return n.split(".")[0]=="Site"}).select(function(n){return n.split(".")[1]});e.userSites=e.JBTData.Sites.where(function(n){return t.any(function(t){return t==n.Name})});e.userSites.length==1?(console.log("User only has a single Site"),e.widget.WidgetResource.SiteId=e.userSites[0].Id,e.widgetSite=e.userSites[0],s()):e.widget.WidgetResource.SiteId&&s();e.widget.displaySettings.headingExtraTitle=c()});r.$watch("vm.widget.WidgetResource.SiteId",function(n,t){e.widget.WidgetResource.SiteId&&e.userSites&&(e.widgetSite=e.userSites.first(function(n){return n.Id==e.widget.WidgetResource.SiteId}),t!=n&&(e.widget.WidgetResource.$save(),s()))});r.$on("WidgetResize",function(n,t){(e.widget.Id==t||t==0)&&(e.widgetDimensions=u.GetWidgetPanelBodyDimensions(e.widget.Id),u.SetPanelBodyWithIdHeight(e.widget.Id))});r.$on("WidgetResize.Stop",function(n,t){(e.widget.Id==t||t==0)&&o(function(){e.widgetDimensions=u.GetWidgetPanelBodyDimensions(e.widget.Id);u.SetPanelBodyWithIdHeight(e.widget.Id)},50,20)})};return s.$inject=["$scope"],{restrict:"E",templateUrl:"app/widgetDirectives/reports.html?"+Date.now(),scope:{dashboard:"=",widget:"=",widgetId:"@",signalUpdateFunction:"&",setPanelHeadingColorFunction:"&",mode:"@"},controllerAs:"vm",controller:s,bindToController:!0}}])}(),function(){var n=angular.module("app");n.directive("siteActiveAlarms",["dataService","utilityService","$state","hotkeys","displaySetupService","$timeout","$window","$interval","signalR","uibButtonConfig","$odata",function(n,t,i,r,u,f,e,o,s,h,c){var l=function(r){function b(){return e.widgetSite=e.userSites.first(function(n){return n.Id==e.widget.WidgetResource.SiteId}),e.widgetSite?" - "+e.widgetSite.Name:void 0}function a(){if(e.widgetDimensions=u.GetWidgetPanelBodyDimensions(e.widget.Id),e.widgetDimensions){var n=e.widgetDimensions.width*y,t=e.widgetDimensions.height*y*1.5,i=n>t?t:n;e.largeTextSize=i;e.largeTextSize>p&&(e.largeTextSize=p)}}function v(){n.GetIOPSResource("Tags").filter("SiteId",e.widget.WidgetResource.SiteId).filter(c.Predicate.or([new c.Predicate("IsAlarm",!0),new c.Predicate("IsCritical",!0)])).filter("LastObservationTextValue","1").expandPredicate("JBTStandardObservation").expand("GSJBTStandardObservationIdExclusionListFromCurrentAlarms").finish().filter(new c.Func("indexof","Name","|"),">",1).query().$promise.then(function(t){e.widget.displaySettings.headingExtraTitle=b();t=t.where(function(n){return!n.JBTStandardObservation.GSJBTStandardObservationIdExclusionListFromCurrentAlarms.length>0});n.PlaceTagsIntoInventory(t);e.activeAlarms||(e.activeAlarms=[]);e.activeAlarms=n.cache.tags.where(function(n){return t.any(function(t){return t.Id==n.TagId})});console.log("Alarm tags = %O",e.activeAlarms);o(function(){u.SetPanelBodyWithIdHeight(e.widget.Id);l(e.widget.Id,e.chart);a()},25,20)})}function s(i){console.log("Getting chart data");n.GetIOPSWebAPIResource(e.diffDays>5?"gSAlertCountByDay":"gSAlertCountByHour").query({siteId:e.widget.WidgetResource.SiteId,beginDate:e.dashboard.webApiParameterStartDate,endDate:e.dashboard.webApiParameterEndDate},function(n){console.log("gSAlertCountByxxxx initial data = %O",n);e.chartData=n.select(function(n){return[t.GetLocalDateFromUTCDate(new Date(n.TimeStamp)).getTime(),n.AlarmCount]});i?(e.chart.series[0].setData(e.chartData),e.chart.setTitle({text:e.diffDays>5?"Alarms Per Day":"Alarms Per Hour"})):k();l(e.widget.Id,e.chart);a()})}function l(n,t){var i=u.GetWidgetPanelBodyDimensions(n);i&&t&&t.setSize(i.width*.8,i.height*.4-10,!1)}function k(){$(function(){u.SetWidgetPanelBodyDimensions(e.widget.Id);f(function(){d();l(e.widget.Id,e.chart)},100)})}function d(){e.chart=Highcharts.chart("containerSiteActiveAlarms"+e.widget.Id,{chart:{type:"spline",animation:!1,marginRight:10,events:{load:function(){e.chartSeries=this.series[0]}}},animation:!1,credits:{enabled:!1},title:{text:e.diffDays>5?"Alarms Per Day":"Alarms Per Hour",style:{fontSize:".8em"}},xAxis:{type:"datetime",dateTimeLabelFormats:{day:e.diffDays>5?"%m/%d":"%m/%d %H:00",month:"%b '%y"},labels:{autoRotation:[-10,-20,-30,-40,-50,-60,-70,-80,-90],style:{fontSize:"10px",fontFamily:"Verdana, sans-serif"}}},yAxis:{title:{text:""},plotLines:[{value:0,width:1,color:"#808080"}]},tooltip:{formatter:function(){return"<b>"+this.series.name+"<\/b><br/>"+Highcharts.dateFormat(e.diffDays>5?"%m/%d/%Y":"%m/%d/%Y %H:00",this.x)+"<br/>"+Highcharts.numberFormat(this.y,0)+" Alarms"}},legend:{enabled:!1},exporting:{enabled:!0},series:[{name:"Alarms",data:e.chartData}]})}var e=this,w,y,p;console.log("siteActiveAlarms directive controller invoked. vm = %O",e);e.widget.headingBackground="linear-gradient(to bottom,#dedede, #fefefe)";e.widget.displaySettings={headingBackground:"linear-gradient(to bottom,#dedede, #fefefe)",headingExtraTitle:"",obscureGraphics:!0};e.user=Global.User;e.canCloseAlarm=Global.User.AuthorizedActivities.any(function(n){return n=="AuthorizedActivity.AdministerSystem"});e.closeAlarm=function(i){alertify.set({labels:{ok:"Yes, Close this Alarm",cancel:"Cancel, I don't want to do this"},buttonFocus:"cancel"});alertify.confirm("Are you SURE you want to close this alarm?",function(r){if(r)return n.AddEntity("ChronologicalRawTagValueLogKepwareReceivers",{ObservationDateTime:t.GetOdataUpdateableCurrentDateTime(),Value:"0",TagName:i.TagName});toastr.info(location.Name,"Alarm was NOT closed!")})};e.widgetDimensions=u.GetWidgetPanelBodyDimensions(e.widget.Id);w=864e5;e.diffDays=Math.round(Math.abs((e.dashboard.derivedStartDate.getTime()-(new Date).getTime())/w));e.bootstrapLabelColumns=2;e.bootstrapInputColumns=10;h.activeClass="radio-active";e.user=Global.User;u.SetWidgetPanelBodyDimensions(e.widget.Id);e.showWidget=!1;e.OpenSettingsIfNoTerminalAndCloseIfTerminalIsPresent=function(){console.log("Opening settings vm.terminalSystem = %O",e.terminalSystem);e.terminalSystem||i.go(".widgetSettings",{widget:e.widget})};n.GetJBTData().then(function(n){e.JBTData=n;var t=e.user.ReaderOf.where(function(n){return n.split(".")[0]=="Site"}).select(function(n){return n.split(".")[1]});console.log("user site codes = %O",t);e.userSites=e.JBTData.Sites.where(function(n){return t.any(function(t){return t==n.Name})});console.log("vm.userSites = %O",e.userSites);e.userSites.length==1?(console.log("User only has a single Site"),e.widget.WidgetResource.SiteId=e.userSites[0].Id,e.widgetSite=e.userSites[0],v(),s()):e.widget.WidgetResource.SiteId&&(e.widgetSite=e.userSites.first(function(n){return n.Id==e.widget.WidgetResource.SiteId}),v(),s());console.log("vm.widgetSite = %O",e.widgetSite)});r.$watch("vm.widget.WidgetResource.SiteId",function(n,t){e.widget.WidgetResource.SiteId&&e.userSites&&(e.widgetSite=e.userSites.first(function(n){return n.Id==e.widget.SiteId}),console.log("vm.widget.WidgetResource.SiteId changed. Now = %O",e.widget),t!=n&&(e.terminals=null,e.terminalSystem=null,e.widget.WidgetResource.$save(),e.activeAlarms=[],v(),s()))});y=.01;p=20;r.$on("$destroy",function(){o.cancel(e.updateInterval)});r.$on("WidgetResize",function(n,t){(e.widget.Id==t||t==0)&&(u.SetPanelBodyWithIdHeight(e.widget.Id),l(e.widget.Id,e.chart),a())});r.$on("WidgetResize.Stop",function(n,t){(e.widget.Id==t||t==0)&&o(function(){u.SetPanelBodyWithIdHeight(e.widget.Id);l(e.widget.Id,e.chart);a()},50,20)});r.$on("Dashboard",function(n,t){if(console.log("siteActiveAlarms Dashboard event. Modified Dashboard = %O",t),t.Id==e.dashboard.Id){e.dashboard=t;e.diffDays=Math.round(Math.abs((e.dashboard.derivedStartDate.getTime()-(new Date).getTime())/864e5));s(!0)}});e.state=i;Highcharts.setOptions({global:{useUTC:!1}});e.chartDataInterval=o(function(){s()},3e5);r.$on("$destroy",function(){o.cancel(e.chartDataInterval)});e.tableDataInterval=o(function(){v()},3e4);r.$on("$destroy",function(){o.cancel(e.tableDataInterval)});n.GetIOPSCollection("GSJBTStandardObservationIdExclusionListFromCurrentAlarms").then(function(n){e.exclusionList=n;console.log("vm.exclusionList = %O",e.exclusionList)});r.$on("dataService.TagUpdate",function(n,t){t.SiteId==e.widget.WidgetResource.SiteId&&(t.IsAlarm||t.IsCritical)&&t.TagName.indexOf("|")>=3&&!e.exclusionList.any(function(n){return t.JBTStandardObservationId==n.jbtStandardObservationId})&&(+t.Value==1&&(e.activeAlarms?e.activeAlarms.push(t):(e.activeAlarms=[],e.activeAlarms.push(t))),+t.Value==0&&e.activeAlarms&&(e.activeAlarms=e.activeAlarms.where(function(n){return n.TagId!=t.TagId})))});e.sortField="-PLCLocalDate";e.SetSortField=function(n){var t=performance.now();e.sortField=e.sortField.substr(1,50)==n||e.sortField==n?e.sortField.substr(0,1)=="-"?n:"-"+n:n}};return l.$inject=["$scope"],{restrict:"E",templateUrl:"app/widgetDirectives/siteActiveAlarms.html?"+Date.now(),scope:{dashboard:"=",widget:"=",mode:"@"},controllerAs:"vm",controller:l,bindToController:!0}}])}(),function(){var n=angular.module("app");n.directive("siteActiveWarnings",["dataService","utilityService","$state","hotkeys","displaySetupService","$timeout","$window","$interval","signalR","uibButtonConfig","$odata",function(n,t,i,r,u,f,e,o,s,h,c){var l=function(r){function b(){return e.widgetSite=e.userSites.first(function(n){return n.Id==e.widget.WidgetResource.SiteId}),e.widgetSite?" - "+e.widgetSite.Name:void 0}function a(){if(e.widgetDimensions=u.GetWidgetPanelBodyDimensions(e.widget.Id),e.widgetDimensions){var n=e.widgetDimensions.width*y,t=e.widgetDimensions.height*y*1.5,i=n>t?t:n;e.largeTextSize=i;e.largeTextSize>p&&(e.largeTextSize=p)}}function v(){n.GetIOPSResource("Tags").filter("SiteId",e.widget.WidgetResource.SiteId).filter(c.Predicate.or([new c.Predicate("IsWarning",!0)])).filter("LastObservationTextValue","1").expandPredicate("JBTStandardObservation").expand("GSJBTStandardObservationIdExclusionListFromCurrentAlarms").finish().filter(new c.Func("indexof","Name","|"),">",1).query().$promise.then(function(t){e.widget.displaySettings.headingExtraTitle=b();t=t.where(function(n){return!n.JBTStandardObservation.GSJBTStandardObservationIdExclusionListFromCurrentAlarms.length>0});n.PlaceTagsIntoInventory(t);e.activeWarnings||(e.activeWarnings=[]);e.activeWarnings=n.cache.tags.where(function(n){return t.any(function(t){return t.Id==n.TagId})});o(function(){u.SetPanelBodyWithIdHeight(e.widget.Id);l(e.widget.Id,e.chart);a()},25,20)})}function s(i){n.GetIOPSWebAPIResource(e.diffDays>5?"gSAlertCountByDay":"gSAlertCountByHour").query({siteId:e.widget.WidgetResource.SiteId,beginDate:e.dashboard.webApiParameterStartDate,endDate:e.dashboard.webApiParameterEndDate},function(n){e.chartData=n.select(function(n){return[t.GetLocalDateFromUTCDate(new Date(n.TimeStamp)).getTime(),n.WarningCount]});i?(e.chart.series[0].setData(e.chartData),e.chart.setTitle({text:e.diffDays>5?"Warnings Per Day":"Warnings Per Hour"})):k();l(e.widget.Id,e.chart);a()})}function l(n,t){var i=u.GetWidgetPanelBodyDimensions(n);t&&t.setSize(i.width*.8,i.height*.4-10,!1)}function k(){$(function(){u.SetWidgetPanelBodyDimensions(e.widget.Id);f(function(){d();l(e.widget.Id,e.chart)},100)})}function d(){e.chart=Highcharts.chart("containerSiteActiveWarnings"+e.widget.Id,{chart:{type:"spline",animation:!1,marginRight:10,events:{load:function(){e.chartSeries=this.series[0]}}},animation:!1,credits:{enabled:!1},title:{text:e.diffDays>5?"Warnings Per Day":"Warnings Per Hour",style:{fontSize:".8em"}},xAxis:{type:"datetime",dateTimeLabelFormats:{day:e.diffDays>5?"%m/%d":"%m/%d %H:00",month:"%b '%y"},labels:{autoRotation:[-10,-20,-30,-40,-50,-60,-70,-80,-90],style:{fontSize:"10px",fontFamily:"Verdana, sans-serif"}}},yAxis:{title:{text:""},plotLines:[{value:0,width:1,color:"#808080"}]},tooltip:{formatter:function(){return"<b>"+this.series.name+"<\/b><br/>"+Highcharts.dateFormat(e.diffDays>5?"%m/%d/%Y":"%m/%d/%Y %H:00",this.x)+"<br/>"+Highcharts.numberFormat(this.y,0)+" Warnings"}},legend:{enabled:!1},exporting:{enabled:!0},series:[{name:"Warnings",data:e.chartData}]})}var e=this,w,y,p;console.log("siteActiveWarnings directive controller invoked. vm = %O",e);e.searchText="";e.widget.displaySettings={headingBackground:"linear-gradient(to bottom,#dedede, #fefefe)",headingExtraTitle:"",obscureGraphics:!0};e.filter=function(n){var t=e.searchText.toUpperCase();return n.Asset.ParentSystem.Name.toUpperCase().indexOf(t)>-1||n.Asset.Name.toUpperCase().indexOf(t)>-1||n.JBTStandardObservation.Name.toUpperCase().indexOf(t)>-1};e.user=Global.User;e.canCloseWarning=Global.User.AuthorizedActivities.any(function(n){return n=="AuthorizedActivity.AdministerSystem"});e.closeWarning=function(i){alertify.set({labels:{ok:"Yes, Close this Warning",cancel:"Cancel, I don't want to do this"},buttonFocus:"cancel"});alertify.confirm("Are you SURE you want to close this warning?",function(r){if(r)return n.AddEntity("ChronologicalRawTagValueLogKepwareReceivers",{ObservationDateTime:t.GetOdataUpdateableCurrentDateTime(),Value:"0",TagName:i.TagName});toastr.info(location.Name,"Warning was NOT closed!")})};e.widgetDimensions=u.GetWidgetPanelBodyDimensions(e.widget.Id);w=864e5;e.diffDays=Math.round(Math.abs((e.dashboard.derivedStartDate.getTime()-(new Date).getTime())/w));e.bootstrapLabelColumns=2;e.bootstrapInputColumns=10;h.activeClass="radio-active";e.user=Global.User;u.SetWidgetPanelBodyDimensions(e.widget.Id);e.showWidget=!1;e.OpenSettingsIfNoTerminalAndCloseIfTerminalIsPresent=function(){console.log("Opening settings vm.terminalSystem = %O",e.terminalSystem);e.terminalSystem||i.go(".widgetSettings",{widget:e.widget})};n.GetJBTData().then(function(n){e.JBTData=n;var t=e.user.ReaderOf.where(function(n){return n.split(".")[0]=="Site"}).select(function(n){return n.split(".")[1]});console.log("user site codes = %O",t);e.userSites=e.JBTData.Sites.where(function(n){return t.any(function(t){return t==n.Name})});console.log("vm.userSites = %O",e.userSites);e.userSites.length==1?(console.log("User only has a single Site"),e.widget.WidgetResource.SiteId=e.userSites[0].Id,e.widgetSite=e.userSites[0],v(),s()):e.widget.WidgetResource.SiteId&&(e.widgetSite=e.userSites.first(function(n){return n.Id==e.widget.WidgetResource.SiteId}),v(),s());console.log("vm.widgetSite = %O",e.widgetSite)});r.$watch("vm.widget.WidgetResource.SiteId",function(n,t){e.widget.WidgetResource.SiteId&&e.userSites&&(e.widgetSite=e.userSites.first(function(n){return n.Id==e.widget.SiteId}),console.log("vm.widget.WidgetResource.SiteId changed. Now = %O",e.widget),t!=n&&(e.terminals=null,e.terminalSystem=null,e.widget.WidgetResource.$save(),e.activeAlarms=[],v(),s()))});y=.0065;p=20;r.$on("WidgetResize",function(n,t){(e.widget.Id==t||t==0)&&(u.SetPanelBodyWithIdHeight(e.widget.Id),l(e.widget.Id,e.chart),a())});r.$on("WidgetResize.Stop",function(n,t){(e.widget.Id==t||t==0)&&o(function(){u.SetPanelBodyWithIdHeight(e.widget.Id);l(e.widget.Id,e.chart);a()},50,20)});r.$on("Dashboard",function(n,t){if(console.log("siteActiveWarnings Dashboard event. Modified Dashboard = %O",t),t.Id==e.dashboard.Id){e.dashboard=t;e.diffDays=Math.round(Math.abs((e.dashboard.derivedStartDate.getTime()-(new Date).getTime())/864e5));s(!0)}});e.state=i;Highcharts.setOptions({global:{useUTC:!1}});r.$on("dataService.TagUpdate",function(n,t){t.SiteId==e.widget.WidgetResource.SiteId&&t.IsWarning&&t.TagName.indexOf("|")>=3&&(+t.Value==1&&(e.activeWarnings?e.activeWarnings.push(t):(e.activeWarnings=[],e.activeWarnings.push(t))),+t.Value==0&&e.activeWarnings&&(e.activeWarnings=e.activeWarnings.where(function(n){return n.TagId!=t.TagId})))});e.chartDataInterval=o(function(){s()},3e5);r.$on("$destroy",function(){o.cancel(e.chartDataInterval)});e.tableDataInterval=o(function(){v()},3e4);r.$on("$destroy",function(){o.cancel(e.tableDataInterval)});e.sortField="-PLCLocalDate";e.SetSortField=function(n){var t=performance.now();e.sortField=e.sortField.substr(1,50)==n||e.sortField==n?e.sortField.substr(0,1)=="-"?n:"-"+n:n}};return l.$inject=["$scope"],{restrict:"E",templateUrl:"app/widgetDirectives/siteActiveWarnings.html?"+Date.now(),scope:{dashboard:"=",widget:"=",mode:"@"},controllerAs:"vm",controller:l,bindToController:!0}}])}(),function(){var n=angular.module("app");n.directive("siteDataStream",["dataService","utilityService","$state","hotkeys","displaySetupService","$timeout","$window","$interval","signalR",function(n,t,i,r,u,f,e,o){var s=function(t){function e(){console.log("Load Data");r.updateInterval=o(function(){f()},1e3);t.$on("$destroy",function(){o.cancel(r.updateInterval)});f();t.$$postDigest(function(){u.SetPanelDimensions()})}function f(){n.GetTags().then(function(n){r.totalChangeCount=0;var t;r.searchText&&(t=r.searchText.toUpperCase());r.tags=n.where(function(n){return r.userSites.any(function(t){return n.SiteId==t.Id})}).where(function(n){return r.searchText==""||!r.searchText?!0:n.TagName.toUpperCase().indexOf(t)>=0||n.Asset.ParentSystem.Name.toUpperCase().indexOf(t)>=0||n.JBTStandardObservation.Name.toUpperCase().indexOf(t)>=0}).orderByDescending(function(n){return n.PLCUTCDateMS}).take(100);r.widgetDimensions=u.GetWidgetPanelBodyDimensions(r.widget.Id);u.SetPanelBodyWithIdHeight(r.widget.Id)})}var r=this;r.columnWidths={company:4,terminal:4,zone:4,gate:4,equipment:4,tagId:5,tagName:40,observationName:25,date:20,value:80,dataChangeCount:15};r.widgetDimensions=u.GetWidgetPanelBodyDimensions(r.widget.Id);r.dataService=n;n.GetJBTData().then(function(n){r.JBTData=n;var t=Global.User.ReaderOf.where(function(n){return n.split(".")[0]=="Site"}).select(function(n){return n.split(".")[1]});console.log("user site codes = %O",t);r.userSites=r.JBTData.Sites.where(function(n){return t.any(function(t){return t==n.Name})});console.log("vm.userSites = %O",r.userSites);e()});t.$on("WidgetResize",function(n,t){(r.widget.Id==t||t==0)&&(r.widgetDimensions=u.GetWidgetPanelBodyDimensions(r.widget.Id),u.SetPanelBodyWithIdHeight(r.widget.Id))});t.$on("WidgetResize.Stop",function(n,t){(r.widget.Id==t||t==0)&&o(function(){r.widgetDimensions=u.GetWidgetPanelBodyDimensions(r.widget.Id);u.SetPanelBodyWithIdHeight(r.widget.Id)},50,20)});r.buttonPanelWidth=20;r.state=i;u.SetPanelDimensions();r.tags=[]};return s.$inject=["$scope"],{restrict:"E",templateUrl:"app/widgetDirectives/siteDataStream.html?"+Date.now(),scope:{dashboard:"=",widget:"=",widgetId:"@",signalUpdateFunction:"&",setPanelHeadingColorFunction:"&",mode:"@"},controllerAs:"vm",controller:s,bindToController:!0}}])}(),function(){var n=angular.module("app");n.directive("siteGateSummary",["dataService","utilityService","$state","hotkeys","displaySetupService","$timeout","$window","$interval","signalR","uibButtonConfig","$odata",function(n,t,i,r,u,f,e,o,s,h,c){var l=function(r){function p(){if(e.widgetSite)return" - "+e.widgetSite.Name}function w(){var u=e.dashboard.widgets.where(function(n){return!n.IsModalPopUp}),n,i,r,t;return console.log("nonPopUpWidgets = %O",e.dashboard.widgets),n=u.max(function(n){return n.row+n.sizeY}),console.log("Lowest point = %O",n),i=u.where(function(t){return t.row+t.sizeY==n}),console.log("lowestPointWidgets = %O",i),r=i.max(function(n){return n.col+n.sizeX}),console.log("furthestRightPoint = %O",r),t=+r,t>=30&&(t=0),{row:n,col:t}}function v(n,t){e.childWidget={sizeX:n.Width,sizeY:n.Height,row:n.Row,col:n.Col,prevRow:n.Row,prevCol:n.Col,Id:n.Id,Name:n.Name,WidgetResource:n,HasChanged:!1};console.log("State transition commanded");switch(t.Name){case"PCA":i.go(".pcaSummaryModal",{widget:e.childWidget,assetId:t.Id,dashboard:e.dashboard});break;case"GPU":i.go(".gpuSummaryModal",{widget:e.childWidget,assetId:t.Id,dashboard:e.dashboard});break;case"PBB":i.go(".pbbSummaryModal",{widget:e.childWidget,assetId:t.Id,dashboard:e.dashboard})}}function y(){e.showWidget=!0;n.GetIOPSResource("Tags").filter("SiteId",e.widget.WidgetResource.SiteId).filter(c.Predicate.or([12374,2736,1942,12484,4331,4445,4765,12255].select(function(n){return new c.Predicate("JBTStandardObservationId",n)}))).select(["SiteId","Id","LastObservationDate","AssetId","LastObservationId","JBTStandardObservationId","Name","LastObservationTextValue","IsCritical","IsWarning","IsAlarm","ValueWhenActive","AssetName","GateName"]).orderBy("Name").query().$promise.then(function(t){n.PlaceTagsIntoInventory(t);console.log("siteGateTags for [12374, 2736, 1942, 12484, 4331, 4445, 4765, 12255] std ids data = %O",t.orderBy(function(n){return n.GateName}));e.assetIds=t.select(function(n){return n.AssetId.toString()}).distinct().join(",");n.GetAllSignalRObservationFormattedTagsForAssetIdIntoInventoryByListOfAssetIds(e.assetIds,!0).then(function(){var r,i;e.widget.assetIds=e.assetIds;r=t.groupBy(function(n){return n.GateName});e.gateTagGroups=r.select(function(n){var t=e.JBTData.Assets.first(function(t){return t.Id==(n.first(function(n){return n.AssetName=="PCA"})?n.first(function(n){return n.AssetName=="PCA"}).AssetId:0)}),r=e.JBTData.Assets.first(function(t){return t.Id==(n.first(function(n){return n.AssetName=="PBB"})?n.first(function(n){return n.AssetName=="PBB"}).AssetId:0)}),i=e.JBTData.Assets.first(function(t){return t.Id==(n.first(function(n){return n.AssetName=="GPU"})?n.first(function(n){return n.AssetName=="GPU"}).AssetId:0)}),u={PCAAsset:t,PBBAsset:r,GPUAsset:i,GateName:n.key,SortField:!isFinite(n.key.substring(0,1))&&isFinite(n.key.substring(1,50))?n.key.substring(0,1)+n.key.substring(1,50).padStart(4,"0"):n.key,GateSystem:e.JBTData.Systems.first(function(t){return t.SiteId==e.widget.WidgetResource.SiteId&&t.TypeId==3&&t.Name==n.key}),PCAUnitOnTag:t?t.Tags.where(function(n){return n.JBTStandardObservationId==12374}).orderByDescending(function(n){return n.ObservationUTCDateMS}).first():null,GPUUnitOnTag:i?i.Tags.where(function(n){return n.JBTStandardObservationId==12374}).orderByDescending(function(n){return n.ObservationUTCDateMS}).first():null,PBBUnitOnTag:r?r.Tags.where(function(n){return n.JBTStandardObservationId==12374}).orderByDescending(function(n){return n.ObservationUTCDateMS}).first():null,DischargeTemperatureTag:t?t.Tags.where(function(n){return n.JBTStandardObservationId==2736}).orderByDescending(function(n){return n.ObservationUTCDateMS}).first():null,AverageAmpsOutTag:i?i.Tags.where(function(n){return n.JBTStandardObservationId==1942}).orderByDescending(function(n){return n.ObservationUTCDateMS}).first():null};return a(u.DischargeTemperatureTag),a(u.AverageAmpsOutTag),u}).orderBy(function(n){return n.SortField});i=[4331,4445,4765,12255];e.gateTagGroups.forEach(function(t){t.PBBAsset&&(t.PBBAsset.AlarmTags=t.PBBAsset.Tags.where(function(n){return n.IsAlarm}),l(t.PBBAsset),t.PBBAsset.AlarmActiveTag=n.cache.tags.first(function(n){return+n.AssetId==+t.PBBAsset.Id&&n.JBTStandardObservationId==12323}),t.PBBAsset.AlarmActiveTag&&(t.PBBAsset.AlarmActiveTag.ValueWhenActive=t.PBBAsset.AlarmActiveTag.ValueWhenActive||"1"),t.PBBAsset.CommLossTag=n.cache.tags.first(function(n){return+n.AssetId==+t.PBBAsset.Id&&i.any(function(t){return t==n.JBTStandardObservationId})}));t.PCAAsset&&(t.PCAAsset.AlarmTags=t.PCAAsset.Tags.where(function(n){return n.IsAlarm}),l(t.PCAAsset),t.PCAAsset.AlarmActiveTag=n.cache.tags.first(function(n){return+n.AssetId==+t.PCAAsset.Id&&n.JBTStandardObservationId==12324}),t.PCAAsset.AlarmActiveTag&&(t.PCAAsset.AlarmActiveTag.ValueWhenActive=t.PCAAsset.AlarmActiveTag.ValueWhenActive||"1"),t.PCAAsset.CommLossTag=n.cache.tags.first(function(n){return+n.AssetId==+t.PCAAsset.Id&&i.any(function(t){return t==n.JBTStandardObservationId})}));t.GPUAsset&&(t.GPUAsset.AlarmTags=t.GPUAsset.Tags.where(function(n){return n.IsAlarm}),l(t.GPUAsset),t.GPUAsset.AlarmActiveTag=n.cache.tags.first(function(n){return+n.AssetId==+t.GPUAsset.Id&&n.JBTStandardObservationId==12325}),t.GPUAsset&&t.GPUAsset.AlarmActiveTag&&(t.GPUAsset.AlarmActiveTag.ValueWhenActive=t.GPUAsset.AlarmActiveTag.ValueWhenActive||"1"),t.GPUAsset.CommLossTag=n.cache.tags.first(function(n){return+n.AssetId==+t.GPUAsset.Id&&i.any(function(t){return t==n.JBTStandardObservationId})}))});console.log("vm.gateTagGroups = %O",e.gateTagGroups);u.SetPanelBodyWithIdHeight(e.widget.Id);e.showWidget=!0});e.widget.displaySettings.headingExtraTitle=p()});b()}function b(){n.GetIOPSResource("Widgets").filter("ParentWidgetId",e.widget.WidgetResource.Id).filter("SiteId",e.widget.WidgetResource.SiteId).query().$promise.then(function(n){e.subWidgets=n;console.log("vm.subWidgets = %O",e.subWidgets)})}function k(n){n&&(n.DisplayValue=t.SecondsToString(+n.LastObservationTextValue))}function a(n){n&&(n.DisplayValue=+n.Value>0?t.ToFixed(+n.Value,1):"0.0")}function l(n){n.alarmActive=!1;n.alarmActive=n.AlarmTags.any(function(n){return n.ValueWhenActive+""==n.Value+""})}function d(n){n&&e.gateTagGroups&&(n.SiteId==81473&&n.TagName.indexOf("Counter")==-1&&console.log("Test Tag "+n.Asset.Name+" - "+n.JBTStandardObservation.Name+" - "+n.Value+" = %O",n),e.gateTagGroups.forEach(function(t){var i=t.PCAUnitOnTag&&t.PCAUnitOnTag.TagId==n.TagId?t.PCAUnitOnTag:t.GPUUnitOnTag&&t.GPUUnitOnTag.TagId==n.TagId?t.GPUUnitOnTag:t.PBBUnitOnTag&&t.PBBUnitOnTag.TagId==n.TagId?t.PBBUnitOnTag:t.DischargeTemperatureTag&&t.DischargeTemperatureTag.TagId==n.TagId?t.DischargeTemperatureTag:t.AverageAmpsOutTag&&t.AverageAmpsOutTag.TagId==n.TagId?t.AverageAmpsOutTag:t.HookupDurationSecondsTag&&t.HookupDurationSecondsTag.TagId==n.TagId?t.HookupDurationSecondsTag:null;i&&(a(i),a(i))}))}var e=this;e.widget.displaySettings={headingBackground:"linear-gradient(to bottom,#dedede, #fefefe)",headingExtraTitle:"",obscureGraphics:!0};e.utilityService=t;e.showSettings=!1;f(function(){},2e3);e.bootstrapLabelColumns=2;e.bootstrapInputColumns=10;h.activeClass="radio-active";e.user=Global.User;u.SetWidgetPanelBodyDimensions(e.widget.Id);e.showWidget=!1;e.AddToDashboard=function(t){var i=t.Name=="PCA"?42:t.Name=="PBB"?49:t.Name=="GPU"?50:0;return n.GetEntityById("WidgetTypes",i).then(function(r){var o=e.JBTData.Systems.first(function(n){return n.Id==t.ParentSystemId}),f=e.JBTData.Systems.first(function(n){return n.Id==o.ParentSystemId}),h=e.JBTData.Systems.first(function(n){return n.Id==f.ParentSystemId}),u=w();return console.log("New Position calculation = %O",u),n.AddEntity("Widgets",{Name:r.Name,WidgetTypeId:i,ParentDashboardId:e.dashboard.Id,Width:r.InitialWidth,Height:r.InitialHeight,Row:u.row-r.InitialHeight+10,Col:u.col,AssetId:t.Id,DefaultNavPill:t.Name=="PCA"?"Press":t.Name=="GPU"?"Amps":"Data",SiteId:t.SiteId,SplitLeftPercentage:50,SplitRightPercentage:50,SystemId:t.ParentSystemId,GateSystemId:t.ParentSystemId,ZoneSystemId:f.Id,TerminalSystemId:h.Id}).then(function(n){return s.SignalAllClients("WidgetAdded",n),!0})})};e.AddWidgetGroupToDashboard=function(t){console.log("Summary Group to add = %O",t);var i=t.PBBAsset?t.PBBAsset.Id.toString()+",":"";t.PCAAsset&&(i+=t.PCAAsset?t.PCAAsset.Id.toString()+",":"");t.GPUAsset&&(i+=t.GPUAsset?t.GPUAsset.Id.toString()+",":"");console.log("AssetIdList = "+i);n.GetAllSignalRObservationFormattedTagsForAssetIdIntoInventoryByListOfAssetIds(i,!1).then(function(){e.AddToDashboard(t.PBBAsset).then(function(){e.AddToDashboard(t.PCAAsset).then(function(){e.AddToDashboard(t.GPUAsset)})})})};e.OpenSummaryWidget=function(t){console.log("Opening summary widget for asset  %O",t);console.log("subWidgets = %O",e.subWidgets);var i=e.subWidgets.first(function(n){return n.AssetId==t.Id});if(i){console.log("Subwidget in cache = %O",i);v(i,t);return}console.log("sub widget was not in cache - getting from oData");n.GetIOPSResource("Widgets").filter("ParentWidgetId",e.widget.Id).filter("AssetId",t.Id).query().$promise.then(function(i){if(i.length==1){console.log("Existing child widget = %O",i);var r=i[0];v(r,t)}else n.GetIOPSResource("SystemGroups").filter("Id",t.ParentSystemId).expandPredicate("Parent").expand("Parent").finish().query().$promise.then(function(i){var r=i[0],u;console.log("Gate System Chain = %O",r);u={Name:t.ParentSystem.Name+" - "+t.Name+" Summary",WidgetTypeId:t.Name=="PCA"?42:t.Name=="GPU"?50:t.Name=="PBB"?49:0,ParentDashboardId:e.dashboard.Id,AssetId:t.Id,SystemId:t.ParentSystemId,SiteId:t.SiteId,Width:0,Height:0,Row:0,Col:0,TerminalSystemId:r.Parent.Parent.Id,ZoneSystemId:r.Parent.Id,GateSystemId:r.Id,SplitLeftPercentage:50,SplitRightPercentage:50,ParentWidgetId:e.widget.Id,IsModalPopUp:!0};n.AddEntity("Widgets",u).then(function(n){v(n,t)})})})};e.OpenSettingsIfNoSiteAndCloseIfSiteIsPresent=function(){e.widgetSite||i.go(".widgetSettings",{widget:e.widget})};n.GetJBTData().then(function(n){e.JBTData=n;var t=e.user.ReaderOf.where(function(n){return n.split(".")[0]=="Site"}).select(function(n){return n.split(".")[1]});e.userSites=e.JBTData.Sites.where(function(n){return t.any(function(t){return t==n.Name})});e.userSites.length==1?(e.widget.WidgetResource.SiteId=e.userSites[0].Id,e.widgetSite=e.userSites[0],y()):e.widget.WidgetResource.SiteId&&(e.widgetSite=e.JBTData.Sites.first(function(n){return n.Id==e.widget.WidgetResource.SiteId}),y());e.widget.displaySettings.headingExtraTitle=p()});r.$watch("vm.widget.WidgetResource.SiteId",function(n,t){e.widget.WidgetResource.SiteId&&e.userSites&&(e.widgetSite=e.userSites.first(function(n){return n.Id==e.widget.WidgetResource.SiteId}),t!=n&&(e.widget.WidgetResource.$save(),y()))});r.$on("WidgetResize",function(n,t){(e.widget.Id==t||t==0)&&u.SetPanelBodyWithIdHeight(e.widget.Id)});r.$on("WidgetResize.Stop",function(n,t){(e.widget.Id==t||t==0)&&o(function(){u.SetPanelBodyWithIdHeight(e.widget.Id)},50,20)});r.$on("dataService.TagUpdate",function(n,t){d(t);e.gateTagGroups&&t.IsAlarm&&e.gateTagGroups.forEach(function(n){n.PBBAsset&&n.PBBAsset.Id==t.AssetId&&l(n.PBBAsset);n.PCAAsset&&n.PCAAsset.Id==t.AssetId&&l(n.PCAAsset);n.GPUAsset&&n.GPUAsset.Id==t.AssetId&&l(n.GPUAsset)})});e.state=i;e.durationInterval=o(function(){e.gateTagGroups&&e.gateTagGroups.forEach(function(n){n.HookupDurationSecondsTag&&+n.HookupDurationSecondsTag.LastObservationTextValue>0&&(n.HookupDurationSecondsTag.LastObservationTextValue=+n.HookupDurationSecondsTag.LastObservationTextValue,n.HookupDurationSecondsTag.LastObservationTextValue+=1,k(n.HookupDurationSecondsTag))})},1e3);r.$on("$destroy",function(){o.cancel(e.durationInterval)});r.$$postDigest(function(){u.SetPanelBodyWithIdHeight(e.widget.Id)})};return l.$inject=["$scope"],{restrict:"E",templateUrl:"app/widgetDirectives/siteGateSummary.html?"+Date.now(),scope:{dashboard:"=",widget:"=",mode:"@"},controllerAs:"vm",controller:l,bindToController:!0}}])}(),function(){var n=angular.module("app");n.directive("tagGraph",["dataService","utilityService","$state","hotkeys","displaySetupService","$timeout","$window","$interval","signalR","$q","$rootScope",function(n,t,i,r,u,f,e,o,s,h,c){var l=function(r){function a(n,t){if(n){var i=+(Math.round(+(n.toString()+"e"+t)).toString()+"e"+-t);return i||n}}function s(n){e.loadingMessageArray.push(n);console.log("ZZZ - "+n.message)}function l(){var i,o;console.log();i=new Date(e.dashboard.derivedStartDate);i=t.GetUTCQueryDate(i);o=new Date(e.dashboard.derivedEndDate);o=t.GetUTCQueryDate(o);n.GetIOPSResource("WidgetGraphTags").filter("WidgetId",e.widget.Id).expandPredicate("Tag").expandPredicate("Asset").expand("Site").expand("System").finish().select(["Id","JBTStandardObservationName"]).finish().query().$promise.then(function(i){var c,l,o;e.GraphTagsData=i;e.loadingMessageArray=[];console.log("Raw WidgetGraphTags Data = %O",i);c=new Date;c.setHours(0,0,0,0);l=t.GetUTCQueryDate(c);console.log("dashboard = %O",e.dashboard);o=0;h.all(i.select(function(i){return s({number:o++,message:"Loading Aggregated and Latest "+i.Tag.Asset.Site.Name+" "+i.Tag.Asset.System.Name+" "+i.Tag.Asset.Name+" "+i.Tag.JBTStandardObservationName}),n.GetIOPSResource("Observations").filter("TagId",i.Tag.Id).filter("Date",">",l).filter("Date","<",e.dashboard.oDataFilterEndDate).select(["Date","FloatValue"]).orderBy("Date").query().$promise.then(function(n){n.forEach(function(n){n.Date=t.GetLocalDateFromUTCDate(n.Date)});var r=e.GraphTagsData.first(function(n){return n.TagId==i.TagId});e.GraphTagsData.first(function(n){return n.TagId==i.TagId}).MarginObservations=n.select(function(n){return[n.Date.getTime(),a(n.FloatValue,1)||0]}).orderBy(function(n){return n.MillisecondsDate});s({number:o++,message:"Latest Loaded "+i.Tag.Asset.Site.Name+" "+i.Tag.Asset.System.Name+" "+i.Tag.Asset.Name+" "+i.Tag.JBTStandardObservationName+"  "+n.length+" pts"})})}).concat(i.select(function(t){return n.GetIOPSResource("ObservationAggregatedHighChartValues").filter("TagId",t.Tag.Id).filter("Day",">=",e.dashboard.oDataFilterStartDate).filter("Day","<=",e.dashboard.oDataFilterEndDate).orderBy("Day").query().$promise.then(function(n){var r,i,u;s({number:o++,message:"Aggregated Values Loaded "+t.Tag.Asset.Site.Name+" "+t.Tag.Asset.System.Name+" "+t.Tag.Asset.Name+" "+t.Tag.JBTStandardObservationName});r=performance.now();i=n.selectMany(function(n){return n.TagValues.split("|").where(function(n){return n.length>5}).select(function(n){var t=n.split(",");return[+t[0],+t[1]||0]})});t.AggregateObservations=i;u=performance.now();s({number:o++,message:"Aggregated Value Pair Gen Time for: "+t.Tag.Asset.Site.Name+" "+t.Tag.Asset.System.Name+" "+t.Tag.Asset.Name+" "+t.Tag.JBTStandardObservationName+" "+i.length+" pts = "+(u-r)})})}))).then(function(){var n=.2,h=1.5,i;e.seriesData=e.GraphTagsData.where(function(n){return n.MarginObservations||n.AggregateObservations}).select(function(i){var u,f,r,c;return s({number:o++,message:"Generating Complete Series for: "+i.Tag.Asset.Site.Name+" "+i.Tag.Asset.System.Name+" "+i.Tag.Asset.Name+" "+i.Tag.JBTStandardObservationName+" "+(c-u)}),u=performance.now(),f=i.AggregateObservations.concat(i.MarginObservations).orderBy(function(n){return n[0]}),console.log("DataPairs = %O",f),i.isDigital=v(f),r={connectNulls:!0,tagId:i.Tag.Id,digitalStepValue:n,isDigital:i.isDigital,name:i.Tag.Asset.Site.Name+" "+i.Tag.Asset.System.Name+" "+i.Tag.Asset.Name+" "+i.Tag.JBTStandardObservationName,data:i.AggregateObservations.concat(i.MarginObservations).orderBy(function(n){return n[0]}).select(function(t){return e.pointCount++,[t[0],i.isDigital?(t[1]||0)+n:a(t[1],1)]})},r.name+=" ("+t.FormatNumberWithCommas(r.data.length)+" points)",c=performance.now(),console.log("Series Object = %O",r),s({number:o++,message:"Complete Series Generation Time for: "+r.name+" "+r.data.length+" pts = "+(c-u)}),i.isDigital&&(r.step="left",n=n+=h),r});e.allDataIsDigital=e.GraphTagsData.all(function(n){return n.isDigital});console.log("WidgetGraphTags Data with observations = %O",e.GraphTagsData);console.log("Series Data = %O",e.seriesData);i=0;e.seriesData.forEach(function(n){i+=n.data.length});e.pointCount=i;e.widget.displaySettings.headingExtraTitle=" - "+t.FormatNumberWithCommas(i)+" Points in Chart";s({number:o++,message:"Creating Chart"});p();f(function(){u.SetLoneChartSize(e.widget.Id,e.chart)},10);console.log("vm.dashboard = %O",e.dashboard);e.dashboard.DashboardTimeScope.Days<8&&r.$on("dataService.TagUpdate",function(n,t){if(e.GraphTagsData&&e.chart&&e.GraphTagsData.any(function(n){return n.TagId==t.TagId})){var i=e.chart.series.first(function(n){return n.options.tagId==t.TagId});i&&(i.addPoint([t.ObservationLocalDate.getTime(),i.options.isDigital?+t.Value+i.options.digitalStepValue:+t.Value],!0,!1),e.chart.redraw(),e.chartDataUpdatePending=!0)}})})})}function v(n){var t=n.take(100).distinct(function(n,t){return(n[1]||0)==(t[1]||0)});return console.log("distinctData = %O",t),t.length==2}function y(){var n=0,t=9999999999999;return e.GraphTagsData.where(function(n){return n.Observations}).forEach(function(i){i.Observations.forEach(function(i){i.FloatValue>n&&(n=i.FloatValue);i.FloatValue<t&&(t=i.FloatValue)})}),n-t>20?"logarithmic":"linear"}function p(){console.log("CreateChart called");var n={chart:{zoomType:"x"},rangeSelector:{enabled:!0,allButtonsEnabled:!0,buttons:[{type:"all",text:"All"}],buttonTheme:{width:60},selected:5},title:{text:"",style:{fontSize:".8em"}},navigator:{enabled:!1,handles:{backgroundColor:"yellow",borderColor:"red"},adaptToUpdatedData:!1},legend:{enabled:!0,labelFormatter:function(){return this.name}},credits:{enabled:!1},yAxis:{type:y(),labels:{enabled:!e.allDataIsDigital,formatter:function(){return this.value}},plotLines:[{value:0,width:2,color:"silver"}]},xAxis:{type:"datetime",visible:!e.allDataIsDigital},plotOptions:{series:{turboThreshold:1e3,showInNavigator:!0,marker:{enabled:!1},states:{hover:{enabled:!1}}},line:{events:{legendItemClick:function(){console.log("%O",this);this.visible&&e.AskUserCheckForDeleteSeries(this)}},showInLegend:!0,lineWidth:1}},tooltip:{pointFormatter:function(){return'<span style="color:'+this.color+'">'+this.series.name+"<\/span>: <b>"+(this.series.options.isDigital?this.y-this.series.options.digitalStepValue:t.ToFixed(this.y,1))+"<\/b><br/><\/span>"},valueDecimals:2,split:!0,shared:!1},series:e.seriesData};e.allDataIsDigital&&(n.yAxis.gridLineWidth=0,n.yAxis.minorGridLineWidth=0);e.chart=Highcharts.stockChart("tagGraph"+e.widget.Id,n)}var e=this;console.log("tagGraph controller invoked");e.widget.displaySettings={headingBackground:"linear-gradient(to bottom,#dedede, #fefefe)",headingExtraTitle:"",obscureGraphics:!0};e.resizeEventCounter=0;e.pointCount=0;e.pointCountResizeIntervalLevel=5e4;e.resizeInterval=o(function(){e.resizeEventCounter>0&&(u.SetLoneChartSize(e.widget.Id,e.chart),e.resizeEventCounter=0)},500);r.$on("WidgetResize",function(n,t){(e.widget.Id==t||t==0)&&(e.pointCount<e.pointCountResizeIntervalLevel?(u.SetLoneChartSize(e.widget.Id,e.chart),console.log("set size")):e.resizeEventCounter++)});r.$on("$destroy",function(){o.cancel(e.resizeInterval);o.cancel(e.chartUpdateInterval)});r.$on("Dashboard",function(n,t){console.log("bhsTopFiveJamDevicesWithLongestDuration Dashboard event. Modified Dashboard = %O",t);t.Id==e.dashboard.Id&&(e.dashboard=t,l(!1))});r.$on("Dashboard.TagsToGraph",function(n,t){e.widget.tagsToGraph=t});r.$on("Widget.AddTagsToGraph",function(t,i){i.Id==e.widget.Id&&h.all(e.widget.tagsToGraph.select(function(t){return n.AddEntity("WidgetGraphTags",{WidgetId:e.widget.Id,TagId:t.TagId})})).then(function(){c.$broadcast("GraphWidgetAdded",e.widget);e.widget.tagsToGraph=null;e.dashboard.tagsToGraph=[];l()})});e.state=i;Highcharts.setOptions({global:{useUTC:!1}});e.AskUserCheckForDeleteSeries=function(t){alertify.set({labels:{ok:"Just Hide Tag",cancel:"Remove Tag From Chart"},buttonFocus:"ok"});var i=t.name;alertify.confirm(i,function(i){if(i)console.log("hide");else{console.log("remove");var r=t.options.tagId;t.remove();n.GetIOPSResource("WidgetGraphTags").filter("TagId",r).filter("WidgetId",e.widget.Id).query().$promise.then(function(n){n[0].Id=-n[0].Id;n[0].$save().then(function(){})})}})};e.chartDataUpdatePending=!1;e.chartUpdateInterval=o(function(){e.chartDataUpdatePending&&(e.chart.redraw(),e.chartDataUpdatePending=!1)},1e3);l()};return l.$inject=["$scope"],{restrict:"E",templateUrl:"app/widgetDirectives/tagGraph.html?"+Date.now(),scope:{dashboard:"=",widget:"=",signalUpdateFunction:"&",setPanelHeadingColorFunction:"&",mode:"@"},controllerAs:"vm",controller:l,bindToController:!0}}])}(),function(){var n=angular.module("app");n.directive("terminalOverview",["dataService","utilityService","$state","hotkeys","displaySetupService","$timeout","$window","$interval","signalR","uibButtonConfig","$odata","$q",function(n,t,i,r,u,f,e,o,s,h){var c=function(t){function e(){if(r.terminalSystem)return" - "+r.terminalSystem.Site.Name+" Terminal "+r.terminalSystem.Name}function f(){r.widget.WidgetResource.SiteId&&(console.log("Getting the terminals for the widget site"),r.terminals=r.JBTData.Systems.where(function(n){return n.SiteId==r.widget.WidgetResource.SiteId&&n.Type=="Terminal"}))}function s(){n.GetIOPSWebAPIResource("TerminalOverviewGraphicsAndTags").query({terminalSystemId:r.widget.WidgetResource.TerminalSystemId},function(t){var i=t.select(function(n){return n.AssetId.toString()}).distinct().join(",");r.widget.assetIds=i;r.terminalGraphics=t;t.forEach(function(n){n.showImage=+n.LastObservationTextValue==+(n.ValueWhenVisible?n.ValueWhenVisible:"99999999")?!0:!1;n.showImage});r.terminalSystem=r.JBTData.Systems.first(function(n){return n.Id==r.widget.WidgetResource.TerminalSystemId});console.log("vm.terminalSystem = %O",r.terminalSystem);console.log("TerminalOverviewGraphicsAndTags initial data = %O",t.orderBy(function(n){return n.ImageURL}));n.PlaceTerminalGraphicsTagsIntoInventory(t);r.widget.displaySettings.headingExtraTitle=e();r.showWidget=!0;u.SetPanelBodyWithIdHeight(r.widget.Id)})}function c(n){n&&r.terminalGraphics&&r.terminalGraphics.forEach(function(t){+t.JBTStandardObservationId==+n.JBTStandardObservationId&&+n.TagId==+t.TagId&&(t.LastObservationTextValue=n.Value,t.LastObservationId=n.LastObservationId,t.LastObservationDate=n.LastObservationDate,t.showImage=+n.Value==+(t.ValueWhenVisible?t.ValueWhenVisible:99999999)?!0:!1)})}var r=this;console.log("Terminal Overview directive invoked");r.widget.displaySettings={headingBackground:"linear-gradient(to bottom,#dedede, #fefefe)",headingExtraTitle:"",obscureGraphics:!0};r.bootstrapLabelColumns=2;r.bootstrapInputColumns=10;h.activeClass="radio-active";r.user=Global.User;u.SetWidgetPanelBodyDimensions(r.widget.Id);r.showWidget=!1;r.OpenSettingsIfNoTerminalAndCloseIfTerminalIsPresent=function(){console.log("Opening settings vm.terminalSystem = %O",r.terminalSystem);r.terminalSystem||i.go(".widgetSettings",{widget:r.widget})};n.GetJBTData().then(function(n){r.JBTData=n;var t=r.user.ReaderOf.where(function(n){return n.split(".")[0]=="Site"}).select(function(n){return n.split(".")[1]});console.log("user site codes = %O",t);r.userSites=r.JBTData.Sites.where(function(n){return t.any(function(t){return t==n.Name})});console.log("vm.userSites = %O",r.userSites);r.userSites.length==1?(console.log("User only has a single Site"),r.widget.WidgetResource.SiteId=r.userSites[0].Id,r.widgetSite=r.userSites[0],f()):r.widget.WidgetResource.SiteId&&f()});t.$watch("vm.widget.WidgetResource.SiteId",function(n,t){r.widget.WidgetResource.SiteId&&r.userSites&&(r.widgetSite=r.userSites.first(function(n){return n.Id==r.widget.SiteId}),console.log("vm.widget.WidgetResource.SiteId changed. Now = %O",r.widget),t!=n&&(r.terminals=null,r.terminalSystem=null,r.widget.WidgetResource.$save(),f()))});t.$watch("vm.widget.WidgetResource.TerminalSystemId",function(n,t){r.widget.WidgetResource.TerminalSystemId&&(console.log("vm.widget.WidgetResource.TerminalSystemId changed. Old = %O",t),console.log("vm.widget.WidgetResource.TerminalSystemId changed. New = %O",n),n!=t&&r.widget.WidgetResource.$save(),s())});t.$on("WidgetResize",function(n,t){(r.widget.Id==t||t==0)&&u.SetPanelBodyWithIdHeight(r.widget.Id)});t.$on("WidgetResize.Stop",function(n,t){(r.widget.Id==t||t==0)&&o(function(){u.SetPanelBodyWithIdHeight(r.widget.Id)},50,20)});t.$on("dataService.TagUpdate",function(n,t){c(t)});r.state=i;t.$$postDigest(function(){u.SetPanelBodyWithIdHeight(r.widget.Id)})};return c.$inject=["$scope"],{restrict:"E",templateUrl:"app/widgetDirectives/terminalOverview.html?"+Date.now(),scope:{dashboard:"=",widget:"=",addTagsToGraphFunction:"&",setPanelHeadingColorFunction:"&",mode:"@"},controllerAs:"vm",controller:c,bindToController:!0}}])}(),function(){var n=angular.module("app");n.directive("ticketCounterThroughput",["dataService","utilityService","$state","hotkeys","displaySetupService","$timeout","$window","$interval","signalR","$q",function(n,t,i,r,u,f,e,o){var s=function(i){function s(){r.diffDays=Math.round(Math.abs((r.dashboard.derivedStartDate.getTime()-(new Date).getTime())/864e5))}function h(){return{beginDate:r.dashboard.webApiParameterStartDate,endDate:r.dashboard.webApiParameterEndDate,siteId:81463}}function e(){n.GetIOPSWebAPIResource(r.diffDays>5?"BHSLocationThroughputHistoryByDay":"BHSLocationThroughputHistoryByHour").query({beginDate:r.dashboard.webApiParameterStartDate,endDate:r.dashboard.webApiParameterEndDate,location:"TicketCounter"},function(n){r.sectionsGrouped=n.groupBy(function(n){return n.Section}).select(function(n){return{Name:n.key,Data:n.select(function(n){return n.BagCount>r.sparklineYAxisMax&&(r.sparklineYAxisMax=n.BagCount),{Day:t.GetLocalDateFromUTCDate(n.ThroughputDay||n.ThroughputHour),BagCount:n.BagCount}})}});f(function(){r.sectionsGrouped.forEach(function(n){try{n.Chart=new Highcharts.Chart(p(n))}catch(t){}})},10)})}function p(n){return{chart:{renderTo:"sparkLineContainer"+r.widget.Id+n.Name,backgroundColor:null,borderWidth:0,type:"area",margin:0,marginRight:0,marginBottom:-5,style:{overflow:"visible"},skipClone:!0},animation:!1,credits:{enabled:!1},title:{text:"",style:{fontSize:".8em"}},xAxis:{type:"datetime",labels:{enabled:!1},lineWidth:0,gridLineWidth:0,minorGridLineWidth:0,lineColor:"transparent",title:{text:null},startOnTick:!1,endOnTick:!1,tickPositions:[]},yAxis:{max:r.sparklineYAxisMax,gridLineWidth:0,minorGridLineWidth:0,lineColor:"transparent",endOnTick:!1,startOnTick:!1,labels:{enabled:!1},title:{text:null},tickPositions:[0]},legend:{enabled:!1},tooltip:{formatter:function(){return Highcharts.dateFormat(r.diffDays>5?"%m/%d/%Y":"%m/%d/%Y %H:00",this.point.x)+"<br/>"+Highcharts.numberFormat(this.y,0,".",",")+" Bags"},hideDelay:0},plotOptions:{series:{animation:!1,lineWidth:1,shadow:!1,states:{hover:{lineWidth:1}},marker:{radius:1,states:{hover:{radius:2}}},fillOpacity:.25},column:{negativeColor:"#910000",borderColor:"silver"}},exporting:{enabled:!1},series:[{name:"Throughput",animation:!1,data:n.Data.select(function(n){return[new Date(n.Day).getTime(),n.BagCount]}),pointStart:1,dataLabels:{enabled:!1}}]}}function w(){return{chart:{type:"column",renderTo:"containerTicketCounterThroughputBar"+r.widget.Id},animation:!1,credits:{enabled:!1},title:{text:"",style:{fontSize:".8em"}},xAxis:{type:"category",labels:{autoRotation:[-10,-20,-30,-40,-50,-60,-70,-80,-90],style:{fontSize:"10px",fontFamily:"Verdana, sans-serif"}}},yAxis:{min:0,title:{text:""}},legend:{enabled:!1},tooltip:{pointFormat:"Throughput: <b>{point.y:.0f} bags<\/b>"},series:c()}}function b(){return{chart:{type:"pie",renderTo:"containerTicketCounterThroughputPie"+r.widget.Id},animation:!1,credits:{enabled:!1},title:{text:r.accurateTicketCounterThroughput||"...  Bags",style:{fontSize:"1.75em",fontWeight:"bold"}},xAxis:{type:"category",labels:{autoRotation:[-10,-20,-30,-40,-50,-60,-70,-80,-90],style:{fontSize:"10px",fontFamily:"Verdana, sans-serif"}}},yAxis:{min:0,title:{text:"Throuput (bags)"}},legend:{enabled:!0},tooltip:{pointFormat:"Throughput: <b>{point.y:.0f} bags<\/b>"},exporting:{enabled:!1},series:c()}}function c(){return[{name:"Throughput",animation:!1,data:r.chartData,dataLabels:{enabled:!1,rotation:0,color:"#FFFFFF",align:"right",fontSize:".7em",format:"{point.y:.0f}",y:10,style:{fontSize:"13px",fontFamily:"Verdana, sans-serif"}}}]}function l(n,t){var i=u.GetWidgetPanelBodyDimensions(n);t.setSize(i.width*.75-45,i.height*.25-10,!1)}function a(n,t){var i=u.GetWidgetPanelBodyDimensions(n);t.setSize(i.width*.25+40,i.height*.25,!1)}function k(){$(function(){u.SetWidgetPanelBodyDimensions(r.widget.Id);f(function(){r.chartPie=new Highcharts.Chart(b());a(r.widget.Id,r.chartPie)},100)})}function d(){$(function(){u.SetWidgetPanelBodyDimensions(r.widget.Id);f(function(){r.chartBar=new Highcharts.Chart(w());l(r.widget.Id,r.chartBar)})})}function v(){n.GetIOPSWebAPIResource("BHSLocationThroughput").query({beginDate:r.dashboard.webApiParameterStartDate,endDate:r.dashboard.webApiParameterEndDate,location:"TicketCounter"},function(n){r.data=n;var t=r.data.orderBy(function(n){return n.Section}).select(function(n){return[n.Section,n.BagCount]});r.chartPie.series[0].setData(t);t=r.data.orderBy(function(n){return n.Section}).select(function(n){return[n.Section,n.BagCount]});r.chartBar.series[0].setData(t);r.totalBags=r.data.sum(function(n){return n.BagCount})});n.GetIOPSWebAPIResource("BHSTotalSystemThroughput").query(h(),function(n){r.accurateTicketCounterThroughput=n.where(function(n){return n.Location=="TicketCounter"}).sum(function(n){return n.BagCount});r.chartPie?r.chartPie.setTitle({text:t.FormatNumberWithCommas(r.accurateTicketCounterThroughput)+" Bags"}):o(function(){r.accurateTicketCounterThroughput=r.data.where(function(n){return n.Location=="TicketCounter"});r.chartPie.setTitle({text:t.FormatNumberWithCommas(r.accurateTicketCounterThroughput)+" Bags"})},200,20)})}var r=this,y;s();u.SetWidgetPanelBodyDimensions(r.widget.Id);n.GetIOPSWebAPIResource("BHSLocationThroughput").query({beginDate:r.dashboard.webApiParameterStartDate,endDate:r.dashboard.webApiParameterEndDate,location:"TicketCounter"},function(n){r.data=n;r.chartData=n.orderBy(function(n){return n.Section}).select(function(n){return[n.Section,n.BagCount]});r.totalBags=r.data.sum(function(n){return n.BagCount});k();d()});n.GetIOPSWebAPIResource("BHSTotalSystemThroughput").query(h(),function(n){return r.accurateTicketCounterThroughput=n.where(function(n){return n.Location=="TicketCounter"}).sum(function(n){return n.BagCount}),r.chartPie?r.chartPie.setTitle({text:t.FormatNumberWithCommas(r.accurateTicketCounterThroughput)+" Bags"}):r.chartPie&&o(function(){r.chartPie.setTitle({text:t.FormatNumberWithCommas(r.accurateTicketCounterThroughput)+" Bags"})},200,20),n});r.sparklineYAxisMax=0;e();i.$on("Dashboard",function(n,t){t.Id==r.dashboard.Id&&(r.dashboard=t,s(),v(),r.sparklineYAxisMax=0,e())});y=u.GetWidgetPanelBodyDimensions(r.widget.Id);i.$on("System.ClockTick15",function(){v();r.sparklineYAxisMax=0;e()});i.$on("WidgetResize",function(n,t){(r.widget.Id==t||t==0)&&(a(r.widget.Id,r.chartPie),l(r.widget.Id,r.chartBar))})};return s.$inject=["$scope"],{restrict:"E",templateUrl:"app/widgetDirectives/ticketCounterThroughput.html?"+Date.now(),scope:{dashboard:"=",widget:"=",signalUpdateFunction:"&",setPanelHeadingColorFunction:"&",mode:"@"},controllerAs:"vm",controller:s,bindToController:!0}}])}(),function(){function n(n,t,i,r,u,f,e,o,s,h,c,l,a,v){function p(){var n=angular.copy(y.widget.WidgetResource);angular.equals(y.originalWidgetResource,n)||(console.log("Saving widget resource........"),console.log("Original WidgetResource = %O",y.originalWidgetResource),console.log("Changed WidgetResource = %O",n),y.widget.WidgetResource.$save(),y.originalWidgetResource=n)}function w(){y.widget.WidgetResource.SiteId&&(console.log("Getting the terminals for the widget site"),y.terminals=y.JBTData.Systems.where(function(n){return n.SiteId==y.widget.WidgetResource.SiteId&&n.Type=="Terminal"}),y.terminals.length==1&&(y.terminalSystem=y.terminals[0],y.widget.WidgetResource.TerminalSystemId=y.terminalSystem.Id))}function k(){y.terminals&&y.widget.WidgetResource.TerminalSystemId&&(console.log("Getting the zone (area system) for the widget terminal"),y.zones=y.JBTData.Systems.where(function(n){return n.Type=="Zone"&&n.ParentSystemId==y.widget.WidgetResource.TerminalSystemId}).where(function(n){return y.JBTData.Systems.any(function(t){return t.Type=="Gate"&&t.ParentSystemId==n.Id&&t.Assets.any(function(n){return n.Name=="PBB"})})}).orderBy(function(n){return n.Name}),y.zones.length==1&&(y.zoneSystem=y.zones[0],y.widget.WidgetResource.ZoneSystemId=y.zoneSystem.Id),b())}function b(){y.zones&&y.widget.WidgetResource.ZoneSystemId&&(console.log("Getting the gate (gate system) for the widget zone"),y.gates=y.JBTData.Systems.where(function(n){return n.Type=="Gate"}).where(function(n){return n.ParentSystemId==y.widget.WidgetResource.ZoneSystemId}).where(function(n){return y.JBTData.Assets.any(function(t){return t.ParentSystemId==n.Id&&t.Name=="PBB"})}).orderBy(function(n){return n.Name}),y.gates.length==0&&(y.gateSystem=y.gates[0],y.widget.WidgetResource.GateSystemId=y.gateSystem.Id),p())}function d(){console.log("GetAllAssetsForGate() for the gate.");f.GetJBTData().then(function(n){y.JBTData=n;y.previousAssetId=y.widget.WidgetResource.AssetId;console.log("Previous AssetId = "+y.previousAssetId);y.widget.WidgetResource.GateSystemId&&f.GetEntityById("SystemGroups",y.widget.WidgetResource.GateSystemId).then(function(n){y.GateSystem=n});y.assets=y.JBTData.Assets.where(function(n){return n.ParentSystemId==y.widget.WidgetResource.GateSystemId}).orderBy(function(n){return n.Name});y.previousAssetId&&(y.previousAsset=y.JBTData.Assets.first(function(n){return n.Id==y.previousAssetId}),console.log("Previous asset present = %O",y.previousAsset),y.asset=y.assets.first(function(n){return n.Name==y.previousAsset.Name}),y.widget.WidgetResource.AssetId=y.asset.Id);p()})}var y=this;y.state=t;y.bootstrapLabelColumns=4;y.bootstrapInputColumns=8;y.showScreen=!1;h.activeClass="radio-active";y.widget=e.widget;r.$on("$destroy",function(){console.log("Destroyed settings controller");i.$broadcast("ResizeVirtualScrollContainers",null)});console.log("Settings controller widget = %O",y.widget);switch(y.widget.WidgetResource.WidgetType.AngularDirectiveName){case"siteGateSummary":case"reports":case"siteActiveAlarms":case"siteActiveWarnings":case"gsTopFiveAlarmTypes":case"gsTopFiveAlarmTypesByEquipment":case"gsEquipmentUsage":case"gsEquipmentHoursOfUsage":case"gsEquipmentUtilizationSummary":y.selectSite=!0;y.selectTerminal=y.selectZone=y.selectGate=y.selectAsset=y.selectBHS=!1;break;case"terminalOverview":y.selectSite=y.selectTerminal=!0;y.selectZone=y.selectGate=y.selectAsset=y.selectBHS=!1;break;case"rawTagDataForAsset":y.selectSite=y.selectTerminal=y.selectZone=y.selectGate=y.selectAsset=!0;y.selectBHS=!1;break;case"pcaSummary":case"pbbSummary":case"gpuSummary":case"gsServiceCounters":y.selectSite=y.selectTerminal=y.selectZone=y.selectGate=!0;y.selectAsset=!1}y.originalWidgetResource=angular.copy(y.widget.WidgetResource);y.user=Global.User;y.panelTitle="Widget Settings for : "+y.widget.WidgetResource.Name;y.panelSubtitle="esc to return to dashboard";r.$$postDigest(function(){y.showScreen=!0;console.log("vm = %O",y)});y.selectTerminal&&r.$watch("vm.widget.WidgetResource.SiteId",function(n,t){y.widget.WidgetResource.SiteId&&y.userSites&&(y.widgetSite=y.userSites.first(function(n){return n.Id==y.widget.SiteId}),console.log("vm.widget.WidgetResource.SiteId changed. Now = %O",y.widget),t!=n&&(y.terminals=null,y.terminalSystem=null,y.widget.WidgetResource.$save(),w()))});y.selectZone&&r.$watch("vm.widget.WidgetResource.TerminalSystemId",function(n,t){y.widget.WidgetResource.TerminalSystemId&&(console.log("vm.widget.WidgetResource.TerminalSystemId changed. Old = %O",t),console.log("vm.widget.WidgetResource.TerminalSystemId changed. New = %O",n),n!=t&&(y.widget.WidgetResource.ZoneSystemId=null,y.widget.WidgetResource.GateSystemId=null,y.zones=null,y.gates=null,y.pbb=null,p()),k())});f.GetJBTData().then(function(n){y.JBTData=n;var t=y.user.ReaderOf.where(function(n){return n.split(".")[0]=="Site"}).select(function(n){return n.split(".")[1]});console.log("user site codes = %O",t);y.userSites=y.JBTData.Sites.where(function(n){return t.any(function(t){return t==n.Name})}).where(function(n){return!y.selectTerminal||n.Systems.any(function(n){return n.TypeId==1})});console.log("vm.userSites = %O",y.userSites);y.userSites.length==1&&(console.log("User only has a single Site"),y.widget.WidgetResource.SiteId=y.userSites[0].Id);y.selectTerminal&&w()});y.selectGate&&r.$watch("vm.widget.WidgetResource.ZoneSystemId",function(n,t){y.widget.WidgetResource.ZoneSystemId&&(n!=t&&(y.widget.WidgetResource.GateSystemId=null,p()),b())});y.selectAsset&&(r.$watch("vm.widget.WidgetResource.GateSystemId",function(n,t){y.widget.WidgetResource.GateSystemId&&(n!=t&&(y.asset=null,p()),d())}),r.$watch("vm.widget.WidgetResource.AssetId",function(n,t){y.widget.WidgetResource.AssetId&&(console.log("vm.widget.WidgetResource.AssetId changed. Now = %O",y.widget),n!=t&&(y.previousAssetId=n,y.asset=y.JBTData.Assets.first(function(t){return t.Id==n}),p()))}));c.bindTo(r).add({combo:"ctrl+s",description:"Save and Close any form data input form",allowIn:["INPUT","SELECT","TEXTAREA"],callback:function(){event.preventDefault();y.Save()}}).add({combo:"esc",description:"Cancel and close any input form",allowIn:["INPUT","SELECT","TEXTAREA"],callback:function(){t.go("^")}});y.Save=function(){console.log("Widget Model to save = %O",y.widget);y.widget.WidgetResource.$save().then(function(){v.SignalAllClients("WidgetSettings",y.widget);t.go("^")})}}angular.module("app").controller("WidgetSettingsCtrl",["$q","$state","$rootScope","$scope","securityService","dataService","$stateParams","utilityService","$timeout","uibButtonConfig","hotkeys","$interval","displaySetupService","signalR",n])}(),function(){var n=angular.module("app");n.directive("companies",["$rootScope","dataService","utilityService","$state","hotkeys","displaySetupService","$timeout","$window","$interval","signalR","uibButtonConfig","$location","$q",function(n,t,i,r,u,f,e,o,s,h,c,l,a){var v=function(n){function y(){return{Name:"",Description:""}}function p(){i.editModel.Id>0&&(i.entity.Id=i.editModel.Id);i.entity.Name=i.editModel.Name;i.entity.ShortName=i.editModel.ShortName;i.entity.Description=i.editModel.Description;i.entity.Address=i.editModel.Address}function v(){e(function(){$("#"+i.widget.Id+"-"+i.entityName+"-"+i.focusFieldName).focus()},50)}function o(){var n=angular.copy(i.widget.WidgetResource);angular.equals(i.originalWidgetResource,n)||(console.log("Saving widget resource........"),console.log("Original WidgetResource = %O",i.originalWidgetResource),console.log("Changed WidgetResource = %O",n),i.widget.WidgetResource.$save(),i.originalWidgetResource=n)}function w(){console.log("Entry into "+i.entityCollectionName+" GetData()");t.GetIOPSResource("Companies").expandPredicate("SiteCompanies").expand("Site").finish().query().$promise.then(function(n){console.log("Companies Data = %O",n);i.entities=n.orderBy(function(n){return n.Name});e(function(){l(5);b();i.showEntities=!0;i.widget.searchText=i.widget.WidgetResource.DefaultSearchText||"";(i.widget.WidgetResource.DefaultIdSelectedForEdit||0)>0&&i.selectEntity(i.entities.first(function(n){return n.Id==i.widget.WidgetResource.DefaultIdSelectedForEdit}))},50)})}function l(n){s(function(){f.SetWidgetPanelBodyDimensions(i.widget.Id);var t=f.GetWidgetPanelBodyDimensions(i.widget.Id),n=0;t&&(n=t.height-3,$("#containerdata"+i.widget.Id).css("height",n),$("#repeater-container-data"+i.widget.Id).css("height",n),$("#container-edit"+i.widget.Id).css("height",n-20),$("#widget-edit-pane-panel-body"+i.widget.Id).css("height",n-20),$("#edit-pane-backdrop"+i.widget.Id).css("height",n-20))},50,n||1)}function b(){i.splitterIsSetup||n.$$postDigest(function(){f.SetPanelBodyWithIdHeight(i.widget.Id);n.$$postDigest(function(){i.widget.WidgetResource.SplitLeftPercentage=i.widget.WidgetResource.SplitLeftPercentage||50;i.widget.WidgetResource.SplitRightPercentage=i.widget.WidgetResource.SplitRightPercentage||50;i.splitter=Split(["#containerData"+i.widget.Id,"#containerEdit"+i.widget.Id],{elementStyle:function(n,t,i){return{"flex-basis":"calc("+t+"% - "+i+"px)"}},gutterStyle:function(n,t){return{"flex-basis":t+"px","background-image":"url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAUAAAAeCAYAAADkftS9AAAAIklEQVQoU2M4c+bMfxAGAgYYmwGrIIiDjrELjpo5aiZeMwF+yNnOs5KSvgAAAABJRU5ErkJggg==')","background-repeat":"no-repeat","background-position":"50%","background-color":"transparent",cursor:"col-resize"}},sizes:[i.widget.WidgetResource.SplitLeftPercentage||50,i.widget.WidgetResource.SplitRightPercentage||50],minSize:0,onDragEnd:function(){var n=i.splitter.getSizes();i.widget.WidgetResource.SplitLeftPercentage=n[0];i.widget.WidgetResource.SplitRightPercentage=n[1];o()}});i.splitterIsSetup=!0})})}var i=this;console.log("Global object = %O",Global);i.entityName="Company";i.entityCollectionName="Companies";i.focusFieldName="Name";console.log(i.entityCollectionName+" Controller invoked");console.log(i.entityCollectionName+" 1");u.bindTo(n).add({combo:"ctrl+s",description:"Save and Close any form data input form",allowIn:["INPUT","SELECT","TEXTAREA"],callback:function(){event.preventDefault();i.saveEntity()}}).add({combo:"esc",description:"Cancel and close any input form",allowIn:["INPUT","SELECT","TEXTAREA"],callback:function(){i.entity=null;i.showEditPane=!1}});i.widget.displaySettings={headingBackground:"linear-gradient(to bottom,#dedede, #fefefe)",headingExtraTitle:"",headingPlusButton:!0,headingPlusButtonTitle:"Add New "+i.entityName,addEntityFunction:function(){i.add()},headingSearchField:!0};t.GetJBTData().then(function(n){i.JBTData=n});i.delete=function(n){var u=i.JBTData.Companies.first(function(t){return t.Id==n.Id}),r,f;if(console.log("cacheCompany = %O",u),i.JBTData.Assets.any(function(t){return t.CompanyId==n.Id})||i.JBTData.Systems.any(function(t){return t.CompanyId==n.Id})||u.Sites.length>0){r="<strong>Company cannot be deleted!<\/strong><br><br>";i.JBTData.Assets.any(function(t){return t.CompanyId==n.Id})&&(r+="It still has Assets associated with it!<br>");i.JBTData.Systems.any(function(t){return t.CompanyId==n.Id})&&(r+="It still has Systems associated with it!<br>");u.Sites.length>0&&(r+="It still has Sites associated with it!");alertify.set({labels:{ok:"Ok",cancel:"Cancel, I don't want to do this"},buttonFocus:"cancel"});alertify.alert(r,function(){toastr.success(location.Name,"Company was NOT deleted!");return});return}alertify.set({labels:{ok:"Yes, Delete the "+i.entityName,cancel:"Cancel, I don't want to do this"},buttonFocus:"cancel"});f="Are you SURE you want to delete this "+i.entityName+"? ";alertify.confirm(f,function(r){r?(h.SignalAllClientsInGroup("Admin",i.entityName+" Delete",n),t.DeleteEntity(i.entityCollectionName,n),toastr.success(location.Name,i.entityName+" was deleted!")):toastr.info(location.Name,i.entityName+" was NOT deleted!")})};i.add=function(){i.editModel=y();i.entity=angular.copy(i.editModel);i.editPanelTitle="New "+i.entityName;i.showEditPane=!0;v()};i.cancelSaveEntity=function(){i.entity=null;i.editModel=null;i.widget.WidgetResource.DefaultIdSelectedForEdit=0;o();i.showEditPane=!1};i.selectEntity=function(n){n&&(!i.editModel||i.editModel&&i.editModel.Id!=n.Id)&&(console.log("Selected entity to edit = %O",n),i.editModel=angular.copy(n),i.editModel.associatedSiteIds=[],n.SiteCompanies.forEach(function(n){i.editModel.associatedSiteIds[n.Site.Id]=!0}),console.log("vm.editModel = %O",i.editModel),i.entity=n,i.widget.WidgetResource.DefaultIdSelectedForEdit=n.Id,o(),i.editPanelTitle="Editing "+i.entityName,i.showEditPane=!0,v(),console.log("vm.entity = %O",i.entity))};i.saveEntity=function(){var n=[];i.editModel.associatedSiteIds.forEach(function(t,i){n.push({SiteId:i,Enabled:t})});p();i.entity.Id;console.log("Company to save = %O",i.editModel);(i.editModel.Id?t.GetEntityById(i.entityCollectionName,i.entity.Id).then(function(n){return n.Name=i.editModel.Name,n.ShortName=i.editModel.ShortName,n.Description=i.editModel.Description,n.Address=i.editModel.Address,n.$save()}):t.AddEntity(i.entityCollectionName,i.editModel)).then(function(r){i.entityFromSave=r;console.log("entity returned from the save operation = %O",r);a.all(i.entity.SiteCompanies.where(function(n){return!i.editModel.associatedSiteIds[n.SiteId]}).select(function(n){return console.log("Site Company to remove from Company entity = %O",n),t.GetIOPSResource("SiteCompanies").filter("CompanyId",i.entity.Id).filter("SiteId",n.SiteId).query().$promise.then(function(n){var t=n.first();return t.Id=-t.Id,t.$save()})}).concat(n.where(function(n){return n.Enabled&&!i.entity.SiteCompanies.any(function(t){return t.SiteId==n.SiteId})}).select(function(n){return console.log("Site Company to add to Company entity = %O",n),t.AddEntity("SiteCompanies",{SiteId:n.SiteId,CompanyId:i.entity.Id})}))).then(function(){h.SignalAllClientsInGroup("Admin",i.entityName+(i.editModel.Id?" Update":" Add"),r);i.showEditPane=!1;i.entity=null;i.editModel=null})})};n.$on(i.entityName+" Add",function(n,t){console.log(i.entityName+" Add Event. New Entity = %O",t);i.entities.push(t);i.entities=i.entities.orderBy(function(n){return n.Name})});n.$on(i.entityName+" Update",function(n,r){console.log(i.entityName+" Update Event. Updated Entity = %O",r);t.GetIOPSResource(i.entityCollectionName).expandPredicate("SiteCompanies").expand("Site").finish().filter("Id",r.Id).query().$promise.then(function(n){var t=n.first();console.log("Updated entity retrieved from DB = %O",t);i.entities=[t].concat(i.entities).distinct(function(n,t){return n.Id==t.Id}).orderBy(function(n){return n.Name});console.log("New entities collection = %O",i.entities);t.Id==(i.editModel?i.editModel.Id:0)&&(i.editModel=angular.copy(t),i.editModel.associatedSiteIds=[],t.SiteCompanies.forEach(function(n){i.editModel.associatedSiteIds[n.Site.Id]=!0}))})});n.$on(i.entityName+" Delete",function(n,t){console.log(i.entityName+" Delete Event. Deleted Entity = %O",t);console.log("vm.entities = %O",i.entities);i.entities=i.entities.where(function(n){return n.Id!=t.Id})});n.$watch("vm.editModel",function(n,t){(t||"")!=(n||"")&&(console.log("$scope.$watch vm.editModel change triggered"),console.log("Old Value = %O",t),console.log("New Value = %O",t),n&&n.Id&&(console.log("vm.editModelChanged. newValue = %O",n),h.SignalAllClientsInGroup("Admin",i.entityName+" EditModel Modification",{editModel:i.editModel,widgetId:i.widget.Id})))});n.$watch("vm.widget.WidgetResource",function(n){n&&n.Id&&h.SignalAllClientsInGroup("Admin",i.entityName+" EditModel Modification",i.editModel)});n.$watch("vm.widget.searchText",function(n,t){(t||"")!=(n||"")&&(console.log("searchText change = Old = "+t+" New = "+n),i.widget.WidgetResource.DefaultSearchText=n,o(),h.SignalAllClientsInGroup("Admin",i.widget.Id+" SearchText Modification",i.widget.searchText))});n.$on(i.entityName+" EditModel Modification",function(n,t){t&&(console.log(i.entityName+" Edit Model Modification. Modified Entity = %O",t),t.editModel.Id==(i.editModel?i.editModel.Id:0)&&t.widgetId!=i.widget.Id&&(i.editModel=t.editModel,console.log("vm.editModel reassigned from event. editModel now = %O",i.editModel)))});n.$on(i.widget.Id+" SearchText Modification",function(n,t){i.widget.searchText=t});i.showWidget=!0;i.originalWidgetResource=angular.copy(i.widget.WidgetResource);i.widget.WidgetResource.SplitLeftPercentage=i.widget.WidgetResource.SplitLeftPercentage||50;o();i.bootstrapLabelColumns=3;i.bootstrapInputColumns=9;c.activeClass="radio-active";i.user=Global.User;console.log("Initial vm.widget = %O",i.widget);f.SetWidgetPanelBodyDimensions(i.widget.Id);i.SetSortField=function(n){var t=performance.now();i.widget.displaySettings.tagDataSortField=i.widget.displaySettings.tagDataSortField.substr(1,50)==n||i.widget.displaySettings.tagDataSortField==n?i.widget.displaySettings.tagDataSortField.substr(0,1)=="-"?n:"-"+n:n};console.log(i.entityCollectionName+" 3");w();i.splitterIsSetup=!1;n.$on("WidgetResize",function(n,t){(i.widget.Id==t||t==0)&&(f.SetPanelBodyWithIdHeight(i.widget.Id),l(1))});n.$on("WidgetResize.Stop",function(n,t){(i.widget.Id==t||t==0)&&e(function(){f.SetPanelBodyWithIdHeight(i.widget.Id);l(1)},200)});n.$on("ResizeVirtualScrollContainers",function(){f.SetPanelBodyWithIdHeight(i.widget.Id);l(1)});i.state=r;n.$$postDigest(function(){f.SetPanelBodyWithIdHeight(i.widget.Id)})};return v.$inject=["$scope"],{restrict:"E",templateUrl:"app/widgetDirectives/adminMaintenance/companies.html?"+Date.now(),scope:{dashboard:"=",widget:"=",mode:"@"},controllerAs:"vm",controller:v,bindToController:!0}}])}(),function(){var n=angular.module("app");n.directive("modules",["$rootScope","dataService","utilityService","$state","hotkeys","displaySetupService","$timeout","$window","$interval","signalR","uibButtonConfig","$location",function(n,t,i,r,u,f,e,o,s,h,c){var l=function(n){function p(){console.log("Entry into "+o.entityCollectionName+" GetData()");t.GetIOPSResource(o.entityCollectionName).expandPredicate("CreatorUser").expand("Person").finish().expandPredicate("LastModifiedUser").expand("Person").finish().orderBy("Name").query().$promise.then(function(n){o.entities=n;console.log(n);e(function(){a(5);k();o.showEntities=!0;o.widget.searchText=o.widget.WidgetResource.DefaultSearchText||"";(o.widget.WidgetResource.DefaultIdSelectedForEdit||0)>0&&o.selectEntity(o.entities.first(function(n){return n.Id==o.widget.WidgetResource.DefaultIdSelectedForEdit}))},50)})}function w(){return{Name:"",Description:"",Mnemonic:"",CreationDate:i.GetOdataUpdateableCurrentDateTime(),CreatorUserId:Global.User.Id}}function b(){o.entity.Mnemonic=o.editModel.Mnemonic;o.entity.Name=o.editModel.Name;o.entity.Description=o.editModel.Description;o.entity.Id?(o.entity.LastModifiedUserId=Global.User.Id,o.entity.LastModifiedDate=i.GetOdataUpdateableCurrentDateTime()):(o.entity.CreatorUserId=Global.User.Id,o.entity.CreationDate=i.GetOdataUpdateableCurrentDateTime())}function v(n){t.GetIOPSResource(o.entityCollectionName).filter("Id",n).expandPredicate("CreatorUser").expand("Person").finish().expandPredicate("LastModifiedUser").expand("Person").finish().query().$promise.then(function(n){console.log("Data from odata expansion = %O",n);var t=n.first();console.log("Updated entity from db = %O",t);o.entities=[t].concat(o.entities).distinct(function(n,t){return n.Id==t.Id}).orderBy(function(n){return n.Name});t.Id==(o.editModel?o.editModel.Id:0)&&(o.editModel=angular.copy(t))})}function y(){e(function(){$("#"+o.widget.Id+"-"+o.entityName+"-"+o.focusFieldName).focus()},50)}function l(){var n=angular.copy(o.widget.WidgetResource);angular.equals(o.originalWidgetResource,n)||(console.log("Saving widget resource........"),console.log("Original WidgetResource = %O",o.originalWidgetResource),console.log("Changed WidgetResource = %O",n),o.widget.WidgetResource.$save(),o.originalWidgetResource=n)}function a(n){s(function(){f.SetWidgetPanelBodyDimensions(o.widget.Id);var t=f.GetWidgetPanelBodyDimensions(o.widget.Id),n=0;t&&(n=t.height-3,$("#containerdata"+o.widget.Id).css("height",n),$("#repeater-container-data"+o.widget.Id).css("height",n),$("#container-edit"+o.widget.Id).css("height",n-20),$("#widget-edit-pane-panel-body"+o.widget.Id).css("height",n-20),$("#edit-pane-backdrop"+o.widget.Id).css("height",n-20))},50,n||1)}function k(){o.splitterIsSetup||n.$$postDigest(function(){f.SetPanelBodyWithIdHeight(o.widget.Id);n.$$postDigest(function(){o.widget.WidgetResource.SplitLeftPercentage=o.widget.WidgetResource.SplitLeftPercentage||50;o.widget.WidgetResource.SplitRightPercentage=o.widget.WidgetResource.SplitRightPercentage||50;o.splitter=Split(["#containerData"+o.widget.Id,"#containerEdit"+o.widget.Id],{elementStyle:function(n,t,i){return{"flex-basis":"calc("+t+"% - "+i+"px)"}},gutterStyle:function(n,t){return{"flex-basis":t+"px","background-image":"url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAUAAAAeCAYAAADkftS9AAAAIklEQVQoU2M4c+bMfxAGAgYYmwGrIIiDjrELjpo5aiZeMwF+yNnOs5KSvgAAAABJRU5ErkJggg==')","background-repeat":"no-repeat","background-position":"50%","background-color":"transparent",cursor:"col-resize"}},sizes:[o.widget.WidgetResource.SplitLeftPercentage||50,o.widget.WidgetResource.SplitRightPercentage||50],minSize:0,onDrag:function(){var n=o.splitter.getSizes();o.widgetDimensions.width==0&&(o.widgetDimensions=f.GetWidgetPanelBodyDimensions(o.widget.Id));o.listPaneWidth=o.widgetDimensions.width*(n[0]/100)},onDragEnd:function(){var n=o.splitter.getSizes();o.widget.WidgetResource.SplitLeftPercentage=n[0];o.widget.WidgetResource.SplitRightPercentage=n[1];o.widgetDimensions.width==0&&(o.widgetDimensions=f.GetWidgetPanelBodyDimensions(o.widget.Id));o.listPaneWidth=o.widgetDimensions.width*(o.widget.WidgetResource.SplitLeftPercentage/100);l()}});o.splitterIsSetup=!0})})}var o=this;o.entityName="Module";o.entityCollectionName="Modules";o.focusFieldName="Mnemonic";console.log(o.entityCollectionName+" Controller invoked");o.widgetDimensions=f.GetWidgetPanelBodyDimensions(o.widget.Id);o.listPaneWidth=o.widgetDimensions.width*(o.widget.WidgetResource.SplitLeftPercentage/100);o.columnHideWidth1=600;o.columnHideWidth2=600;console.log(o.entityCollectionName+" 1");u.bindTo(n).add({combo:"ctrl+s",description:"Save and Close any form data input form",allowIn:["INPUT","SELECT","TEXTAREA"],callback:function(){event.preventDefault();o.saveEntity()}}).add({combo:"esc",description:"Cancel and close any input form",allowIn:["INPUT","SELECT","TEXTAREA"],callback:function(){o.entity=null;o.showEditPane=!1}});o.widget.displaySettings={headingBackground:"linear-gradient(to bottom,#dedede, #fefefe)",headingExtraTitle:"",headingPlusButton:!0,headingPlusButtonTitle:"Add New "+o.entityName,addEntityFunction:function(){o.add()},headingSearchField:!0};o.add=function(){o.entity=o.editModel=w();o.editPanelTitle="New "+o.entityName;o.showEditPane=!0;y()};o.saveEntity=function(){console.log("saveEntity() - vm.editModel = %O",o.editModel);b();(o.editModel.Id?t.GetEntityById(o.entityCollectionName,o.entity.Id).then(function(n){return n.Name=o.editModel.Name,n.Mnemonic=o.editModel.Mnemonic,n.Description=o.editModel.Description,n.LastModifiedUserId=Global.User.Id,n.LastModifiedDate=i.GetOdataUpdateableCurrentDateTime(),n.$save()}):t.AddEntity(o.entityCollectionName,o.editModel)).then(function(n){o.entity=null;h.SignalAllClientsInGroup("Admin",o.entityName+(o.editModel.Id?" Update":" Add"),n);o.showEditPane=!1})};o.delete=function(n){alertify.set({labels:{ok:"Yes, Delete the "+o.entityName,cancel:"Cancel, I don't want to do this"},buttonFocus:"cancel"});var i="Are you SURE you want to delete this "+o.entityName+"? ";alertify.confirm(i,function(i){i?(n.Id==o.entity.Id&&(o.entity=null,o.editModel=null,o.showEditPane=!1),h.SignalAllClientsInGroup("Admin",o.entityName+" Delete",n),t.DeleteEntity(o.entityCollectionName,n),toastr.success(location.Name,o.entityName+" was deleted!")):toastr.info(location.Name,o.entityName+" was NOT deleted!")})};n.$on(o.entityName+" Add",function(n,t){console.log(o.entityName+" Add Event. New Entity = %O",t);v(t.Id)});n.$on(o.entityName+" Update",function(n,t){console.log(o.entityName+" Update Event. Updated Entity = %O",t);v(t.Id)});n.$on(o.entityName+" Delete",function(n,t){console.log(o.entityName+" Delete Event. Deleted Entity = %O",t);console.log("vm.entities = %O",o.entities);o.entities=o.entities.where(function(n){return n.Id!=t.Id})});n.$watch("vm.editModel",function(n){n&&n.Id&&h.SignalAllClientsInGroup("Admin",o.entityName+" EditModel Modification",o.editModel)});n.$watch("vm.widget.WidgetResource",function(n){n&&n.Id&&h.SignalAllClientsInGroup("Admin",o.entityName+" EditModel Modification",o.editModel)});n.$watch("vm.widget.searchText",function(n,t){(t||"")!=(n||"")&&(console.log("searchText change = Old = "+t+" New = "+n),o.widget.WidgetResource.DefaultSearchText=n,l(),h.SignalAllClientsInGroup("Admin",o.widget.Id+" SearchText Modification",o.widget.searchText))});n.$on(o.entityName+" EditModel Modification",function(n,t){t&&(console.log(o.entityName+" Edit Model Modification. Modified Entity = %O",t),t.Id==(o.editModel?o.editModel.Id:0)&&(o.editModel=t))});n.$on(o.widget.Id+" SearchText Modification",function(n,t){o.widget.searchText=t});n.$on("WidgetResize",function(n,t){(o.widget.Id==t||t==0)&&(o.widgetDimensions=f.GetWidgetPanelBodyDimensions(o.widget.Id),o.listPaneWidth=o.widgetDimensions.width*(o.widget.WidgetResource.SplitLeftPercentage/100),f.SetPanelBodyWithIdHeight(o.widget.Id),a(1))});n.$on("WidgetResize.Stop",function(n,t){(o.widget.Id==t||t==0)&&e(function(){o.widgetDimensions=f.GetWidgetPanelBodyDimensions(o.widget.Id);o.listPaneWidth=o.widgetDimensions.width*(o.widget.WidgetResource.SplitLeftPercentage/100);console.log("vm.listPaneWidth = "+o.listPaneWidth);f.SetPanelBodyWithIdHeight(o.widget.Id);a(1)},200)});n.$on("ResizeVirtualScrollContainers",function(){f.SetPanelBodyWithIdHeight(o.widget.Id);a(1)});o.cancelSaveEntity=function(){o.entity=null;o.widget.WidgetResource.DefaultIdSelectedForEdit=0;l();o.showEditPane=!1};o.selectEntity=function(n){n&&(o.editModel=angular.copy(n),o.entity=n,o.widget.WidgetResource.DefaultIdSelectedForEdit=n.Id,l(),o.editPanelTitle="Editing "+o.entityName,o.showEditPane=!0,y(),console.log("Selected Entity = %O",o.editModel))};o.showWidget=!0;o.originalWidgetResource=angular.copy(o.widget.WidgetResource);o.widget.WidgetResource.SplitLeftPercentage=o.widget.WidgetResource.SplitLeftPercentage||50;l();o.bootstrapLabelColumns=3;o.bootstrapInputColumns=9;c.activeClass="radio-active";o.user=Global.User;console.log("Initial vm.widget = %O",o.widget);f.SetWidgetPanelBodyDimensions(o.widget.Id);o.SetSortField=function(n){var t=performance.now();o.widget.displaySettings.tagDataSortField=o.widget.displaySettings.tagDataSortField.substr(1,50)==n||o.widget.displaySettings.tagDataSortField==n?o.widget.displaySettings.tagDataSortField.substr(0,1)=="-"?n:"-"+n:n};p();o.splitterIsSetup=!1;o.state=r;n.$$postDigest(function(){f.SetPanelBodyWithIdHeight(o.widget.Id)})};return l.$inject=["$scope"],{restrict:"E",templateUrl:"app/widgetDirectives/adminMaintenance/modules.html?"+Date.now(),scope:{dashboard:"=",widget:"=",mode:"@"},controllerAs:"vm",controller:l,bindToController:!0}}])}(),function(){var n=angular.module("app");n.directive("people",["$rootScope","dataService","utilityService","$state","hotkeys","displaySetupService","$timeout","$window","$interval","signalR","uibButtonConfig","$location","$q",function(n,t,i,r,u,f,e,o,s,h,c,l,a){var v=function(n){function y(){return{Name:"",Description:""}}function p(){i.editModel.Id>0&&(i.entity.Id=i.editModel.Id);i.entity.Name=i.editModel.Name;i.entity.ShortName=i.editModel.ShortName;i.entity.Description=i.editModel.Description;i.entity.Address=i.editModel.Address}function v(){e(function(){$("#"+i.widget.Id+"-"+i.entityName+"-"+i.focusFieldName).focus()},50)}function o(){var n=angular.copy(i.widget.WidgetResource);angular.equals(i.originalWidgetResource,n)||(console.log("Saving widget resource........"),console.log("Original WidgetResource = %O",i.originalWidgetResource),console.log("Changed WidgetResource = %O",n),i.widget.WidgetResource.$save(),i.originalWidgetResource=n)}function w(){console.log("Entry into "+i.entityCollectionName+" GetData()");t.GetIOPSResource("Companies").expandPredicate("SiteCompanies").expand("Site").finish().query().$promise.then(function(n){console.log("Companies Data = %O",n);i.entities=n.orderBy(function(n){return n.Name});e(function(){l(5);b();i.showEntities=!0;i.widget.searchText=i.widget.WidgetResource.DefaultSearchText||"";(i.widget.WidgetResource.DefaultIdSelectedForEdit||0)>0&&i.selectEntity(i.entities.first(function(n){return n.Id==i.widget.WidgetResource.DefaultIdSelectedForEdit}))},50)})}function l(n){s(function(){f.SetWidgetPanelBodyDimensions(i.widget.Id);var t=f.GetWidgetPanelBodyDimensions(i.widget.Id),n=0;t&&(n=t.height-3,$("#containerdata"+i.widget.Id).css("height",n),$("#repeater-container-data"+i.widget.Id).css("height",n),$("#container-edit"+i.widget.Id).css("height",n-20),$("#widget-edit-pane-panel-body"+i.widget.Id).css("height",n-20),$("#edit-pane-backdrop"+i.widget.Id).css("height",n-20))},50,n||1)}function b(){i.splitterIsSetup||n.$$postDigest(function(){f.SetPanelBodyWithIdHeight(i.widget.Id);n.$$postDigest(function(){i.widget.WidgetResource.SplitLeftPercentage=i.widget.WidgetResource.SplitLeftPercentage||50;i.widget.WidgetResource.SplitRightPercentage=i.widget.WidgetResource.SplitRightPercentage||50;i.splitter=Split(["#containerData"+i.widget.Id,"#containerEdit"+i.widget.Id],{elementStyle:function(n,t,i){return{"flex-basis":"calc("+t+"% - "+i+"px)"}},gutterStyle:function(n,t){return{"flex-basis":t+"px","background-image":"url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAUAAAAeCAYAAADkftS9AAAAIklEQVQoU2M4c+bMfxAGAgYYmwGrIIiDjrELjpo5aiZeMwF+yNnOs5KSvgAAAABJRU5ErkJggg==')","background-repeat":"no-repeat","background-position":"50%","background-color":"transparent",cursor:"col-resize"}},sizes:[i.widget.WidgetResource.SplitLeftPercentage||50,i.widget.WidgetResource.SplitRightPercentage||50],minSize:0,onDragEnd:function(){var n=i.splitter.getSizes();i.widget.WidgetResource.SplitLeftPercentage=n[0];i.widget.WidgetResource.SplitRightPercentage=n[1];o()}});i.splitterIsSetup=!0})})}var i=this;i.entityName="Company";i.entityCollectionName="Companies";i.focusFieldName="Name";console.log(i.entityCollectionName+" Controller invoked");console.log(i.entityCollectionName+" 1");u.bindTo(n).add({combo:"ctrl+s",description:"Save and Close any form data input form",allowIn:["INPUT","SELECT","TEXTAREA"],callback:function(){event.preventDefault();i.saveEntity()}}).add({combo:"esc",description:"Cancel and close any input form",allowIn:["INPUT","SELECT","TEXTAREA"],callback:function(){i.entity=null;i.showEditPane=!1}});i.widget.displaySettings={headingBackground:"linear-gradient(to bottom,#dedede, #fefefe)",headingExtraTitle:"",headingPlusButton:!0,headingPlusButtonTitle:"Add New "+i.entityName,addEntityFunction:function(){i.add()},headingSearchField:!0};t.GetJBTData().then(function(n){i.JBTData=n});i.delete=function(n){var u=i.JBTData.Companies.first(function(t){return t.Id==n.Id}),r,f;if(console.log("cacheCompany = %O",u),i.JBTData.Assets.any(function(t){return t.CompanyId==n.Id})||i.JBTData.Systems.any(function(t){return t.CompanyId==n.Id})||u.Sites.length>0){r="<strong>Company cannot be deleted!<\/strong><br><br>";i.JBTData.Assets.any(function(t){return t.CompanyId==n.Id})&&(r+="It still has Assets associated with it!<br>");i.JBTData.Systems.any(function(t){return t.CompanyId==n.Id})&&(r+="It still has Systems associated with it!<br>");u.Sites.length>0&&(r+="It still has Sites associated with it!");alertify.set({labels:{ok:"Ok",cancel:"Cancel, I don't want to do this"},buttonFocus:"cancel"});alertify.alert(r,function(){toastr.success(location.Name,"Company was NOT deleted!");return});return}alertify.set({labels:{ok:"Yes, Delete the "+i.entityName,cancel:"Cancel, I don't want to do this"},buttonFocus:"cancel"});f="Are you SURE you want to delete this "+i.entityName+"? ";alertify.confirm(f,function(r){r?(h.SignalAllClientsInGroup("Admin",i.entityName+" Delete",n),t.DeleteEntity(i.entityCollectionName,n),toastr.success(location.Name,i.entityName+" was deleted!")):toastr.info(location.Name,i.entityName+" was NOT deleted!")})};i.add=function(){i.editModel=y();i.entity=angular.copy(i.editModel);i.editPanelTitle="New "+i.entityName;i.showEditPane=!0;v()};i.cancelSaveEntity=function(){i.entity=null;i.editModel=null;i.widget.WidgetResource.DefaultIdSelectedForEdit=0;o();i.showEditPane=!1};i.selectEntity=function(n){n&&(!i.editModel||i.editModel&&i.editModel.Id!=n.Id)&&(console.log("Selected entity to edit = %O",n),i.editModel=angular.copy(n),i.editModel.associatedSiteIds=[],n.SiteCompanies.forEach(function(n){i.editModel.associatedSiteIds[n.Site.Id]=!0}),console.log("vm.editModel = %O",i.editModel),i.entity=n,i.widget.WidgetResource.DefaultIdSelectedForEdit=n.Id,o(),i.editPanelTitle="Editing "+i.entityName,i.showEditPane=!0,v(),console.log("vm.entity = %O",i.entity))};i.saveEntity=function(){var n=[];i.editModel.associatedSiteIds.forEach(function(t,i){n.push({SiteId:i,Enabled:t})});p();i.entity.Id;console.log("Company to save = %O",i.editModel);(i.editModel.Id?t.GetEntityById(i.entityCollectionName,i.entity.Id).then(function(n){return n.Name=i.editModel.Name,n.ShortName=i.editModel.ShortName,n.Description=i.editModel.Description,n.Address=i.editModel.Address,n.$save()}):t.AddEntity(i.entityCollectionName,i.editModel)).then(function(r){i.entityFromSave=r;console.log("entity returned from the save operation = %O",r);a.all(i.entity.SiteCompanies.where(function(n){return!i.editModel.associatedSiteIds[n.SiteId]}).select(function(n){return console.log("Site Company to remove from Company entity = %O",n),t.GetIOPSResource("SiteCompanies").filter("CompanyId",i.entity.Id).filter("SiteId",n.SiteId).query().$promise.then(function(n){var t=n.first();return t.Id=-t.Id,t.$save()})}).concat(n.where(function(n){return n.Enabled&&!i.entity.SiteCompanies.any(function(t){return t.SiteId==n.SiteId})}).select(function(n){return console.log("Site Company to add to Company entity = %O",n),t.AddEntity("SiteCompanies",{SiteId:n.SiteId,CompanyId:i.entity.Id})}))).then(function(){h.SignalAllClientsInGroup("Admin",i.entityName+(i.editModel.Id?" Update":" Add"),r);i.showEditPane=!1;i.entity=null;i.editModel=null})})};n.$on(i.entityName+" Add",function(n,t){console.log(i.entityName+" Add Event. New Entity = %O",t);i.entities.push(t);i.entities=i.entities.orderBy(function(n){return n.Name})});n.$on(i.entityName+" Update",function(n,r){console.log(i.entityName+" Update Event. Updated Entity = %O",r);t.GetIOPSResource(i.entityCollectionName).expandPredicate("SiteCompanies").expand("Site").finish().filter("Id",r.Id).query().$promise.then(function(n){var t=n.first();console.log("Updated entity retrieved from DB = %O",t);i.entities=[t].concat(i.entities).distinct(function(n,t){return n.Id==t.Id}).orderBy(function(n){return n.Name});console.log("New entities collection = %O",i.entities);t.Id==(i.editModel?i.editModel.Id:0)&&(i.editModel=angular.copy(t),i.editModel.associatedSiteIds=[],t.SiteCompanies.forEach(function(n){i.editModel.associatedSiteIds[n.Site.Id]=!0}))})});n.$on(i.entityName+" Delete",function(n,t){console.log(i.entityName+" Delete Event. Deleted Entity = %O",t);console.log("vm.entities = %O",i.entities);i.entities=i.entities.where(function(n){return n.Id!=t.Id})});n.$watch("vm.editModel",function(n,t){(t||"")!=(n||"")&&(console.log("$scope.$watch vm.editModel change triggered"),console.log("Old Value = %O",t),console.log("New Value = %O",t),n&&n.Id&&(console.log("vm.editModelChanged. newValue = %O",n),h.SignalAllClientsInGroup("Admin",i.entityName+" EditModel Modification",{editModel:i.editModel,widgetId:i.widget.Id})))});n.$watch("vm.widget.WidgetResource",function(n){n&&n.Id&&h.SignalAllClientsInGroup("Admin",i.entityName+" EditModel Modification",i.editModel)});n.$watch("vm.widget.searchText",function(n,t){(t||"")!=(n||"")&&(console.log("searchText change = Old = "+t+" New = "+n),i.widget.WidgetResource.DefaultSearchText=n,o(),h.SignalAllClientsInGroup("Admin",i.widget.Id+" SearchText Modification",i.widget.searchText))});n.$on(i.entityName+" EditModel Modification",function(n,t){t&&(console.log(i.entityName+" Edit Model Modification. Modified Entity = %O",t),t.editModel.Id==(i.editModel?i.editModel.Id:0)&&t.widgetId!=i.widget.Id&&(i.editModel=t.editModel,console.log("vm.editModel reassigned from event. editModel now = %O",i.editModel)))});n.$on(i.widget.Id+" SearchText Modification",function(n,t){i.widget.searchText=t});i.showWidget=!0;i.originalWidgetResource=angular.copy(i.widget.WidgetResource);i.widget.WidgetResource.SplitLeftPercentage=i.widget.WidgetResource.SplitLeftPercentage||50;o();i.bootstrapLabelColumns=3;i.bootstrapInputColumns=9;c.activeClass="radio-active";i.user=Global.User;console.log("Initial vm.widget = %O",i.widget);f.SetWidgetPanelBodyDimensions(i.widget.Id);i.SetSortField=function(n){var t=performance.now();i.widget.displaySettings.tagDataSortField=i.widget.displaySettings.tagDataSortField.substr(1,50)==n||i.widget.displaySettings.tagDataSortField==n?i.widget.displaySettings.tagDataSortField.substr(0,1)=="-"?n:"-"+n:n};console.log(i.entityCollectionName+" 3");w();i.splitterIsSetup=!1;n.$on("WidgetResize",function(n,t){(i.widget.Id==t||t==0)&&(f.SetPanelBodyWithIdHeight(i.widget.Id),l(1))});n.$on("WidgetResize.Stop",function(n,t){(i.widget.Id==t||t==0)&&e(function(){f.SetPanelBodyWithIdHeight(i.widget.Id);l(1)},200)});n.$on("ResizeVirtualScrollContainers",function(){f.SetPanelBodyWithIdHeight(i.widget.Id);l(1)});i.state=r;n.$$postDigest(function(){f.SetPanelBodyWithIdHeight(i.widget.Id)})};return v.$inject=["$scope"],{restrict:"E",templateUrl:"app/widgetDirectives/adminMaintenance/people.html?"+Date.now(),scope:{dashboard:"=",widget:"=",mode:"@"},controllerAs:"vm",controller:v,bindToController:!0}}])}(),function(){function n(n,t,i,r,u,f,e,o,s,h,c,l,a,v){function w(){f.GetIOPSResource("Widgets").filter("ParentDashboardId",+e.DashboardId).query().$promise.then(function(t){y.widgetsOnDashboard=t;console.log("widgetsOnDashboard = %O",t);n.all([f.GetIOPSResource("WidgetTypes").expand("WidgetTypeTabGroup").query().$promise.then(function(n){y.widgetTypeGroups=n.where(function(n){return n.IsAvailableToAll||u.UserHasAuthorizedActivity("AuthorizedActivity.AdministerSystem")&&n.IsAvailableToAdmin}).groupBy(function(n){return n.WidgetTypeTabGroup?n.WidgetTypeTabGroup.Name:"Misc"}).select(function(n){return{Name:n.key,WidgetTypeTabGroupId:n.first()&&n.first().WidgetTypeTabGroup&&n.first().WidgetTypeTabGroup.Id||"Misc",WidgetTypes:n.select(function(n){return n})}})}),f.GetEntityById("Dashboards",+e.DashboardId).then(function(n){y.dashboardFromDB=n})]).then(function(){console.log("vm = %O",y);y.dashboardFromDB.DefaultWidgetTypeTabGroupId||(y.dashboardFromDB.DefaultWidgetTypeTabGroupId=y.widgetTypeGroups.first().WidgetTypeTabGroupId,y.dashboardFromDB.$save());y.showScreen=!0;a.SetPanelDimensions(20)})})}var y,p;console.log("AddWidgetCtrl invoked");y=this;y.state=t;y.bootstrapLabelColumns=4;y.bootstrapInputColumns=8;y.showScreen=!1;h.activeClass="radio-active";s(function(){i.$broadcast("ResizeVirtualScrollContainers",null)},1e3);e.DashboardId<0&&(e.DashboardId=0);r.$on("$destroy",function(){i.$broadcast("ResizeVirtualScrollContainers",null)});y.SetDefaultNavPill=function(n){y.dashboardFromDB.DefaultWidgetTypeTabGroupId=n;y.dashboardFromDB.$save()};y.columnWidths={name:35,description:65};w();y.columnWidths={categoryPath:35,name:20,description:50};c.bindTo(r).add({combo:"ctrl+s",description:"Save and Close any form data input form",allowIn:["INPUT","SELECT","TEXTAREA"],callback:function(){event.preventDefault();y.Save()}}).add({combo:"esc",description:"Cancel and close any input form",allowIn:["INPUT","SELECT","TEXTAREA"],callback:function(){t.go("^")}});y.widgetTypeIdsToAdd=[];p=40;y.AddWidget=function(t){p+=10;n.when(t.AngularDirectiveName=="dashboard"?f.GetEntityById("Dashboards",e.DashboardId).then(function(n){return f.AddEntity("Dashboards",{CreatorUserId:Global.User.Id,Name:"Widget Panel",CustomStartDate:n.CustomStartDate,CustomEndDate:n.CustomEndDate,TimeScopeId:n.TimeScopeId,ParentDashboardId:n.Id})}):!1).then(function(n){return console.log("New Embedded Dashboard = %O",n),f.AddEntity("Widgets",{Name:t.Name,WidgetTypeId:t.Id,ParentDashboardId:e.DashboardId,EmbeddedDashboardId:n?n.Id:null,Width:t.InitialWidth,Height:t.InitialHeight,SplitLeftPercentage:50,SplitRightPercentage:50,Row:100,Col:0}).then(function(n){v.SignalAllClients("WidgetAdded",n)})})};y.Close=function(){t.go("^")}}angular.module("app").controller("AddWidgetCtrl",["$q","$state","$rootScope","$scope","securityService","dataService","$stateParams","utilityService","$timeout","uibButtonConfig","hotkeys","$interval","displaySetupService","signalR",n])}(),function(){function n(n,t,i,r,u,f,e,o){var s=this;s.dashboardId=o.DashboardId}angular.module("app").controller("DashboardCtrl",["$scope","$rootScope","$state","displaySetupService","dataService","signalR","$interval","$stateParams","$timeout","$q","uibButtonConfig","utilityService",n])}(),function(){function n(n,t,i,r,u,f,e,o,s,h,c,l,a,v){console.log("EditDashboardCtrl invoked");var y=this;y.state=t;r.$on("$destroy",function(){console.log("Destroyed settings controller");i.$broadcast("ResizeVirtualScrollContainers",null)});y.bootstrapLabelColumns=4;y.bootstrapInputColumns=8;y.showScreen=!1;h.activeClass="radio-active";e.DashboardId<0&&(e.DashboardId=0);(e.DashboardId>0?f.GetEntityById("Dashboards",e.DashboardId):n.when({CreatorUserId:Global.User.Id})).then(function(n){f.GetIOPSCollection("DashboardTimeScopes").then(function(t){y.DashboardTimeScopes=t;y.dashboard=n;y.dashboard.CustomStartDate&&(y.dashboard.CustomStartDate=o.GetUTCQueryDate(y.dashboard.CustomStartDate));y.dashboard.CustomEndDate&&(y.dashboard.CustomEndDate=o.GetUTCQueryDate(y.dashboard.CustomEndDate));y.endDate=o.GetUTCQueryDate(y.dashboard.CustomEndDate);y.showScreen=!0;(y.dashboard.CustomStartDate||y.dashboard.CustomEndDate)&&(y.dashboard.TimeScopeId=null);console.log("dashboard = %O",y.dashboard)})});c.bindTo(r).add({combo:"ctrl+s",description:"Save and Close any form data input form",allowIn:["INPUT","SELECT","TEXTAREA"],callback:function(){event.preventDefault();y.Save()}}).add({combo:"esc",description:"Cancel and close any input form",allowIn:["INPUT","SELECT","TEXTAREA"],callback:function(){t.go("^")}});r.$watch("vm.dashboard.TimeScopeId",function(n){n>0&&(y.dashboard.CustomStartDate=null,y.dashboard.CustomEndDate=null)});r.$watch("vm.dashboard.CustomStartDate",function(){y.dashboard&&y.dashboard.CustomStartDate&&y.dashboard.CustomEndDate&&(y.dashboard.TimeScopeId=null)});r.$watch("vm.dashboard.CustomEndDate",function(){y.dashboard&&y.dashboard.CustomStartDate&&y.dashboard.CustomEndDate&&(y.dashboard.TimeScopeId=null)});y.Save=function(){y.dashboard.TimeScopeId&&y.dashboard.TimeScopeId>0&&(y.dashboard.CustomStartDate=null,y.dashboard.CustomEndDate=null);y.dashboard.CustomStartDate&&(y.dashboard.CustomStartDate=o.GetNonUTCQueryDate(y.dashboard.CustomStartDate));y.dashboard.CustomEndDate&&(y.dashboard.CustomEndDate=o.GetNonUTCQueryDate(y.dashboard.CustomEndDate));y.dashboard.TimeScopeId||y.dashboard.CustomStartDate||y.dashboard.CustomEndDate||(y.dashboard.TimeScopeId=6);console.log("vm.dashboard = %O",y.dashboard);(e.DashboardId>0?y.dashboard.$save():f.AddEntity("Dashboards",y.dashboard)).then(function(n){f.GetExpandedDashboardById(n.Id).then(function(n){v.SignalAllClients("Dashboard",n);t.go("^")})})}}angular.module("app").controller("EditDashboardCtrl",["$q","$state","$rootScope","$scope","securityService","dataService","$stateParams","utilityService","$timeout","uibButtonConfig","hotkeys","$interval","displaySetupService","signalR",n])}(),function(){function n(n,t,i,r,u,f,e,o,s,h,c,l,a,v){console.log("EditWidgetCtrl invoked");var y=this;y.state=t;y.bootstrapLabelColumns=4;y.bootstrapInputColumns=8;y.showScreen=!1;h.activeClass="radio-active";e.DashboardId<0&&(e.DashboardId=0);f.GetEntityById("Widgets",e.WidgetId).then(function(n){y.widget=n;y.showScreen=!0;console.log("widget = %O",y.widget)});c.bindTo(r).add({combo:"ctrl+s",description:"Save and Close any form data input form",allowIn:["INPUT","SELECT","TEXTAREA"],callback:function(){event.preventDefault();y.Save()}}).add({combo:"esc",description:"Cancel and close any input form",allowIn:["INPUT","SELECT","TEXTAREA"],callback:function(){t.go("^")}});y.Save=function(){y.widget.$save().then(function(n){v.SignalAllClients("Widget",n);t.go("^");s(function(){t.go("^");s(function(){t.go("home.app.dashboard",{DashboardId:e.DashboardId})},10)},10)})}}angular.module("app").controller("EditWidgetCtrl",["$q","$state","$rootScope","$scope","securityService","dataService","$stateParams","utilityService","$timeout","uibButtonConfig","hotkeys","$interval","displaySetupService","signalR",n])}();angular.module("app").controller("AppCtrl",["$scope","signalR","securityService",function(n,t,i){var r=this;n.$on("securityService:authenticated",function(n,t){console.log("AppCtrl authenticated event received. User = %O",t);r.showMenu=i.showMenu});r.state="unauthorized";r.signIn=function(){r.state="authorized"}}]),function(){function n(n,t,i,r){function f(){u.loadingMessage+="."}var u=this;u.displaySetupService=t;u.loadingMessage="Is Initializing for Performance ";u.dataService=r;u.updateInterval=i(function(){f()},500);n.$on("$destroy",function(){i.cancel(u.updateInterval)})}angular.module("app").controller("BlankCtrl",["$scope","displaySetupService","$interval","dataService",n])}(),function(){function n(n,t,i,r,u,f){var e=this;e.displaySetupService=t;i.bindTo(n).add({combo:"esc",description:"Cancel and close any input form",allowIn:["INPUT","SELECT","TEXTAREA"],callback:function(){r.current.name.split(".").length>3&&r.go("^")}});e.Logout=function(){u.remove("currentUser");f.currentUser=null;document.location=webRoot}}angular.module("app").controller("HeaderCtrl",["$scope","displaySetupService","hotkeys","$state","store","securityService",n])}(),function(){function n(n,t,i,r,u,f,e,o,s){function c(n){i.go("home.app.dashboard",{DashboardId:h.dashboards.skip(n-1).first().Id})}function v(){u.GetIOPSCollection("Dashboards","CreatorUserId",Global.User.Id).then(function(n){n||(h.noDashboardsMessage="You do not yet have any dashboards created. To create a dashboard, please click on the New button above.");h.dashboards=n.where(function(n){return!n.ParentDashboardId}).orderBy(function(n){return n.Ordinal});h.showMenu=!0;console.log("Setting the menu as visible");h.dashboards&&h.dashboards.length>0&&i.go("home.app.dashboard",{DashboardId:h.dashboards.first().Id})});u.IsReady()&&u.GetJBTData().then(function(n){function f(n){var u=n.Sites.select(function(t){return{Id:t.Id,Name:t.Name,TypeId:12,Type:"Airport",Types:n.Systems.where(function(n){return n.SiteId==t.Id&&!n.ParentSystemId}).select(function(t){var i={Id:t.Id,Name:t.Name,TypeId:t.SystemType.Id,Type:t.SystemType.LongName?t.SystemType.LongName:t.SystemType.Name,Types:r(t.Id,n),Assets:n.Assets.where(function(n){return n.ParentSystemId==t.Id})};return i.Assets&&i.Assets.length>0&&(i.Types=i.Types.concat(i.Assets.select(function(t){return{Id:t.Id,Name:t.Name,TypeId:t.AssetTypeId,Type:n.AssetTypes.first(function(n){return n.Id==t.AssetTypeId}).Name,Types:[],Assets:[]}}))),i})}});u=i(u);h.typePaths=[];t(u,"Site");h.typePaths=h.typePaths.distinct().orderBy(function(n){return n});e(h.typePaths,function(n){h.typesTree=n})}function e(n,t){var r=0,i=[];_.each(n,function(n){var u=n.split("."),t;u.shift();t=i;_.each(u,function(i){var u=_.findWhere(t,{name:i});if(u)t=u.children;else{var f=!1,o=n.split(".").select(function(n){return f?"":(n==i&&(f=!0),n)}).where(function(n){return n!=""}).join("."),e={id:Date.now()+r++,label:i,description:"",state:"home.app.widgetTypes",stateParams:{Path:o},showChildren:!1,name:i,children:[]};t.push(e);t=e.children}})});t(i)}function t(n,i){n.forEach(function(n){n.Types.length>0?t(n.Types,i+"."+n.Type):h.typePaths.push(i+(n.Type?"."+n.Type:""))})}function i(n){return n.selectMany(function(n){return n.Types&&n.Types.length>0&&i(n.Types),n.Types})}function r(n,t){return t.Systems.where(function(t){return t.ParentSystemId==n}).select(function(n){var i={Id:n.Id,Name:n.Name,TypeId:n.SystemType.Id,Type:n.SystemType.LongName?n.SystemType.LongName:n.SystemType.Name,Types:r(n.Id,t),Assets:t.Assets.where(function(t){return t.ParentSystemId==n.Id})};return i.Assets&&i.Assets.length>0&&(i.Types=i.Types.concat(i.Assets.select(function(n){var i=t.AssetTypes.first(function(t){return t.Id==n.AssetTypeId});return{Id:n.Id,Name:n.Name,TypeId:n.AssetTypeId,Type:i?i.Name:null,Types:[],Assets:[]}}))),i})}if(n&&n.Sites){var o=n.Sites.where(function(n){return!(n.Name.substr(0,10)=="Simulation"||!n.Name=="BNA")}).select(function(n){return{id:"assetMonitorForSite"+n.Name,label:n.Name+" Gate Assets",description:"",state:"home.app.gateMonitorForSite",stateParams:{SiteId:n.Id}}}),s=n.Sites.where(function(n){return n.Systems.any(function(n){return n.Type=="BHS"&&n.ParentSystemId==null})}).select(function(n){return{id:"assetBHSMonitorForSite"+n.Name,label:n.Name+" Scanner Performance and Alarms",description:"",state:"home.app.bhsAlarms"}});h.widgetTypesTree=f(n)}h.menu=[{id:"admin",label:"iOPS Administration",description:"",state:".admin",showChildren:!0,hideMenuChoice:!Global.User.AuthorizedActivities.contains("AuthorizedActivity.AdministerSystem"),children:[{id:"sec",label:"Security",description:"",showChildren:!1,children:[{id:"users",label:"Users",description:"",state:"home.app.users"}]},{id:"systemTables",label:"System Tables",description:"",showChildren:!1,children:[{id:"companies",label:"Companies",description:"",state:"home.app.companies"},{id:"people",label:"People",description:"",state:"home.app.people"},{id:"assetModels",label:"Asset Model Types",description:"",state:"home.app.assetModels"},{id:"tags",label:"Tags",description:"",state:"home.app.tags"},{id:"widgetTypes",label:"Widget Types",description:"",state:".widgetTypes",children:[{id:"widgetTypesSite",label:"Site",description:"",state:"home.app.widgetTypes",stateParams:{Path:"Site"},children:h.typesTree}]}]},{id:"dataFlow",label:"Data Flow Monitoring",description:"",showChildren:!1,children:[{id:"liveTagCellMonitor",label:"Overall System Activity",description:"",state:"home.app.liveObservationIndicatorTableCells"},{id:"liveTagDataMonitor",label:"Data Update Stream",description:"",state:"home.app.liveTagDataMonitor"},]}]}];u.menu=h.menu})}var h=this,l,a;h.state=i;h.menuTitle="Options";h.showMenu=!1;t.$on("securityService:authenticated",function(n,t){console.log("MenuCtrl authenticated event received. User = %O",t)});s.bindTo(n).add({combo:"ctrl+1",allowIn:["INPUT","SELECT","TEXTAREA"],callback:function(){event.preventDefault();c(1)}}).add({combo:"ctrl+2",allowIn:["INPUT","SELECT","TEXTAREA"],callback:function(){event.preventDefault();c(2)}}).add({combo:"ctrl+3",allowIn:["INPUT","SELECT","TEXTAREA"],callback:function(){event.preventDefault();c(3)}}).add({combo:"ctrl+4",allowIn:["INPUT","SELECT","TEXTAREA"],callback:function(){event.preventDefault();c(4)}}).add({combo:"ctrl+5",allowIn:["INPUT","SELECT","TEXTAREA"],callback:function(){event.preventDefault();c(5)}}).add({combo:"ctrl+6",allowIn:["INPUT","SELECT","TEXTAREA"],callback:function(){event.preventDefault();c(6)}}).add({combo:"ctrl+7",allowIn:["INPUT","SELECT","TEXTAREA"],callback:function(){event.preventDefault();c(7)}}).add({combo:"ctrl+8",allowIn:["INPUT","SELECT","TEXTAREA"],callback:function(){event.preventDefault();c(8)}}).add({combo:"ctrl+9",allowIn:["INPUT","SELECT","TEXTAREA"],callback:function(){event.preventDefault();c(9)}});t.$on("Dashboard",function(n,t){t.CreatorUserId!=Global.User.Id||t.ParentDashboardId||(h.dashboards=[t].concat(h.dashboards).distinct(function(n,t){return n.Id==t.Id}).orderBy(function(n){return n.Ordinal}))});t.$on("Dashboard.Deleted",function(n,t){console.log("Event Dashboard.Deleted = %O",t);h.dashboards=h.dashboards.where(function(n){return n.Id!=t.Id})});h.data=u;h.noDashboardsMessage=!1;h.deleteDashboard=function(n){console.log("dashboard to Delete = %O",n);alertify.set({labels:{ok:"Yes, Delete the Dashboard",cancel:"Cancel, I don't want to do this"},buttonFocus:"cancel"});alertify.confirm("Are you SURE you want to delete this dashboard? ",function(t){t?n.Id&&u.GetIOPSCollection("Widgets","ParentDashboardId",n.Id).then(function(t){console.log("Widgets to delete = %O",t);e.all(t.select(function(n){return u.GetIOPSCollection("WidgetGraphTags","WidgetId",n.Id).then(function(t){return t&&t.length>0?e.all(t.select(function(n){return n.Id=-n.Id,n.$save()})).then(function(){return console.log("Delete widget"),n.Id=-n.Id,n.$save()}):(n.Id=-n.Id,n.$save())})})).then(function(){u.GetEntityById("Dashboards",n.Id).then(function(t){t.Id=-t.Id;t.$save().then(function(){o.SignalAllClients("Dashboard.Deleted",n);toastr.success(n.Name,"Dashboard was deleted!")})})})}):toastr.info(n.Name,"Dashboard was NOT deleted!")})};l=function(n,t){var r=t.children(),i=t.clone();return i.children().each(function(n){$(this).width(r.eq(n).width())}),i};a=function(){u.GetIOPSCollection("Dashboards","CreatorUserId",Global.User.Id).then(function(n){h.dbDashboards=n.where(function(n){return!n.ParentDashboardId});var t=0;$("#dashboardsTable tbody tr").each(function(){var n=$(this).attr("itemid");t++;h.dbDashboards&&h.dbDashboards.forEach(function(i){i.Id==n&&i.Ordinal!=t&&(i.Ordinal=t,i.$save(),h.dashboards.forEach(function(i){i.Id==n&&(i.Ordinal=t)}))})})})};f(function(){$("#dashboardsTable tbody").sortable({helper:l,stop:a}).disableSelection()},150);t.$on("dataService.ready",function(){console.log("Setting up menu...");v()});u.IsReady()&&(console.log("Setting up menu..."),v());h.ActivateState=function(n){n.state>""&&(console.log("Menu State = "+n.state),i.go(n.state,n.stateParams))};r.SetPanelDimensions()}angular.module("app").controller("MenuCtrl",["$scope","$rootScope","$state","displaySetupService","dataService","$timeout","$q","signalR","hotkeys",n])}(),function(){function n(n,t,i,r,u,f,e,o,s,h,c,l){var a=this,v;a.username="";a.password="";a.currentUser={};o.suppressAllSiteHeaders=!0;u(function(){o.suppressAllSiteHeaders=!1},20);a.PasswordChangeToken=s.GetQuerystringParameterByName("pwt");a.PasswordChangeToken&&(r.remove("currentUser"),f.currentUser=null);v=0;a.ShowLoginPanel=!1;a.showRegisterButtons=!1;a.LoginWithUsernameAndPassword=function(){console.log("Processing login via username and password...");a.loginType="username";f.LoginUserWithUsernameAndPassword(a.username,e.trustAsHtml(a.password))};a.RegisterNewUser=function(){a.loginType="username";f.RegisterNewUser(a.username,a.password,a.firstName,a.lastName,a.companyName,a.email,a.telephone)};a.LoginUserWithAccessToken=function(){if(console.log("Processing login via access token..."),!f.GetCurrentUser()||!f.GetCurrentUser().ODataAccessToken){console.log("No current user found in local store. Seting login panel to be visible.");a.ShowLoginPanel=!0;return}console.log("Processing login via access token...");f.LoginUserWithAccessToken().then(function(n){n})};a.SetNewPassword=function(){var n=f.GetCurrentUser();h.GetEntityById("iOPSUsers",n.Id).then(function(n){n.PasswordHash=a.passwordChoice1;n.WillEncryptPasswordOnFirstLogin=!0;n.PasswordChangeLoginToken=null;n.PasswordChangeLoginTokenDate=null;n.$save().then(function(n){a.PasswordChangeToken="";f.currentUser=n;r.set("currentUser",n);l.SignalAllClientsInGroup("Admin","iOPSUser",n);f.LoginUserWithUsernameAndPassword(n.Username,e.trustAsHtml(a.passwordChoice1))})})};n.$on("securityService:accessTokenInvalid",function(n,t){console.log("LoginCtrl accessToken Invalid event received. User = %O",t);a.currentUser=t;a.ShowLoginPanel=!0});n.$on("securityService:authenticated",function(n,t){a.currentUser=f.GetCurrentUser();a.ShowLoginPanel=!1;a.PasswordChangeToken>""?(a.ShowLoginPanel=!0,f.showMenu=!1,a.pwUser=t):(f.showMenu=!0,i.go("home.app"))});t.$on("securityService:unauthenticated",function(t,i){console.log("LoginCtrl unauthenticated event received");alertify.alert("Username or Password is not valid.");a.username="";a.password="";a.currentUser=i;a.isPanelVisible=!0;n.$apply()});n.$on("logout",function(){console.log("LoginCtrl logout event received");a.username="";a.password="";r.remove("currentUser");f.currentUser=null;top.location.href="/";a.isPanelVisible=!0});n.$on("securityService.invalidAccount",function(){alertify.alert("Username or Password is not valid!");s.GetQuerystringParameterByName("pwt")==""&&(console.log("LoginCtrl logout event received"),a.username="",a.password="",r.remove("currentUser"),f.currentUser=null,i.go("home"),a.isPanelVisible=!0)});u(function(){$(function(){var n=150;$("#login-form-link").click(function(t){$("#login-form").delay(n).fadeIn(n);$("#register-form").fadeOut(n);$("#register-form-link").removeClass("active");$(this).addClass("active");t.preventDefault()});$("#register-form-link").click(function(t){$("#register-form").delay(n).fadeIn(n);$("#login-form").fadeOut(n);$("#login-form-link").removeClass("active");$(this).addClass("active");t.preventDefault()})});n.$apply()},200);a.LoginUserWithAccessToken=function(){if(a.PasswordChangeToken==""&&(!f.GetCurrentUser()||!f.GetCurrentUser().ODataAccessToken)&&a.PasswordChangeToken==""){console.log("No current user found in local store. Seting login panel to be visible.");a.ShowLoginPanel=!0;return}f.LoginUserWithAccessToken().then(function(n){if(n&&n!=""){if(a.pwUser=n,n.PasswordChangeLoginToken&&a.PasswordChangeToken>""){a.PasswordChangeToken=n.PasswordChangeLoginToken;a.ShowLoginPanel=!0;f.showMenu=!1;return}}else a.PasswordChangeToken="",r.remove("currentUser"),f.currentUser=null,document.location=webRoot})};a.LoginUserWithAccessToken()}angular.module("app").controller("LoginCtrl",["$scope","$rootScope","$state","store","$timeout","securityService","$sce","displaySetupService","utilityService","dataService","$interval","signalR",n])}(),function(){function n(n,t,i,r,u,f,e,o){function h(){u.GetAreas().then(function(n){s.areas=n.where(function(n){return!i.BuildingId||n.BuildingId==i.BuildingId});o(function(){r.SetPanelDimensions()});r.SetPanelDimensions();console.log("vm.areas = %O",s.areas)})}console.log("AreasCtrl conroller invoked.");var s=this;s.columnWidths={company:10,building:10,name:80};s.buttonPanelWidth=70;s.state=t;r.SetPanelDimensions();i.BuildingId&&(s.previousScreenName="Buildings",s.building=u.cache.buildings.first(function(n){return n.Id==i.BuildingId}));h();s.scrolledToEnd=function(){console.log("scrolled to end")}}angular.module("app").controller("AreasCtrl",["$scope","$state","$stateParams","displaySetupService","dataService","signalR","$interval","$timeout",n])}(),function(){function n(n,t,i,r,u,f,e,o,s,h,c,l,a,v){var y=this;y.state=t;y.bootstrapLabelColumns=4;y.bootstrapInputColumns=8;y.showScreen=!1;h.activeClass="radio-active";e.AssetModelId<0&&(e.AssetModelId=0);e.AssetModelId>0?f.GetEntityById("AssetModels",e.AssetModelId).then(function(n){y.assetModel=n;y.panelTitle="iOPS Asset Model Type: "+y.assetModel.Name+" - ";y.panelSubtitle="Editing Existing Asset Model Type";r.$$postDigest(function(){a.SetPanelDimensions(10);y.showScreen=!0;console.log("vm = %O",y)})}):(y.assetModel={Id:0},y.panelTitle="New Asset Model Type",y.panelSubtitle="Enter a new Asset Model Type for iOPS",y.showScreen=!0);c.bindTo(r).add({combo:"ctrl+s",description:"Save and Close any form data input form",allowIn:["INPUT","SELECT","TEXTAREA"],callback:function(){event.preventDefault();y.Save()}}).add({combo:"esc",description:"Cancel and close any input form",allowIn:["INPUT","SELECT","TEXTAREA"],callback:function(){t.go("^")}});y.Save=function(){console.log("Asset Model to save = %O",y.assetModel);(y.assetModel.Id>0?f.GetEntityById("AssetModels",y.assetModel.Id).then(function(n){return n.Name=y.assetModel.Name,n.Size=y.assetModel.Size,n.Description=y.assetModel.Description,n.GraphicsPath=y.assetModel.GraphicsPath,n.$save()}):f.AddEntity("AssetModels",y.assetModel)).then(function(n){v.SignalAllClientsInGroup("Admin","AssetModel",n);t.go("^")})}}angular.module("app").controller("AssetModelEditCtrl",["$q","$state","$rootScope","$scope","securityService","dataService","$stateParams","utilityService","$timeout","uibButtonConfig","hotkeys","$interval","displaySetupService","signalR",n])}(),function(){function n(n,t,i,r){console.log("AssetModelsCtrl conroller invoked.");var u=this;u.columnWidths={name:20,description:50,graphicsPath:30};u.buttonPanelWidth=20;u.state=t;i.SetPanelDimensions();u.assetModels=r.GetCache().assetModels;console.log("assetModels = %O",u.assetModels);n.$on("AssetModel",function(n,t){console.log("AssetModel change. AssetModel = %O",t);u.assetModels=[t].concat(u.assetModels).distinct(function(n,t){return n.Id==t.Id})});u.scrolledToEnd=function(){console.log("scrolled to end")}}angular.module("app").controller("AssetModelsCtrl",["$scope","$state","displaySetupService","dataService","signalR","$interval","$q",n])}(),function(){function n(n,t,i,r){function f(){r.GetAssets().then(function(n){u.assets=n})}console.log("AssetsCtrl conroller invoked.");var u=this;u.columnWidths={assetId:10,site:10,company:7,building:5,area:5,gate:6,name:10,dataChange:60,dataChangeCount:15};i.SetPanelDimensions();n.$on("dataService.ready",function(){f()});r.IsReady&&f();u.scrolledToEnd=function(){console.log("scrolled to end")}}angular.module("app").controller("AssetsCtrl",["$scope","$state","displaySetupService","dataService","signalR","$interval","$timeout",n])}(),function(){function n(n,t,i,r,u){function e(){f.buildings=r.cache.buildings}console.log("BuildingsCtrl conroller invoked.");var f=this;f.columnWidths={site:25,name:60};f.buttonPanelWidth=20;f.state=t;i.SetPanelDimensions();n.$on("dataService.cache.ready",function(){e()});(r.cache.ready||r.cache.buildings.length>1)&&e();f.buildings||r.GetBuildings().then(function(n){f.buildings=n});f.delete=function(n){r.GetBuilding(n.Id).then(function(){alertify.set({labels:{ok:"Yes, Delete the Building",cancel:"Cancel, I don't want to do this"},buttonFocus:"cancel"});alertify.confirm("Are you SURE you want to delete this building? ",function(n){n?(airport.$delete().then(function(){u.SignalAllClients("Building Changed",null)}),toastr.success(location.Name,"Building was deleted!")):toastr.info(location.Name,"Building was NOT deleted!")})})};f.save=function(n){r.GetBuilding(n.Id).then(function(n){n.$update().then(function(){u.SignalAllClients("Building Changed",null)})})};f.scrolledToEnd=function(){console.log("scrolled to end")}}angular.module("app").controller("BuildingsCtrl",["$scope","$state","displaySetupService","dataService","signalR","$interval",n])}(),function(){function n(n,t,i,r){function f(){u.assetInventory=r.cache.expandedAssets.select(function(n){return{data:n,lastChange:"",changeCounter:0}});console.log("vm.assetInventory = %O",u.assetInventory);n.$$postDigest(function(){i.SetPanelDimensions()});n.$on("observation",function(t,i){i=i.split(",").last().split("|").select(function(n){return{name:n.split("^").first(),value:n.split("^").last()}});var f=i.first(function(n){return n.name=="AssetId"}),e=f.value,r=u.assetInventory.first(function(n){return+n.data.Id==e}),o=i.first(function(n){return n.name=="Date"}).value+"  Tag:"+i.first(function(n){return n.name=="TagName"}).value.trim()+"  Value:"+i.first(function(n){return n.name=="Value"}).value;r&&n.$apply(function(){r.changeCounter++;r.lastChange=o;u.assets=u.assetInventory.where(function(n){return n.dataChangeCount>0})})})}console.log("ChangingAssetsCtrl conroller invoked.");var u=this;u.columnWidths={company:10,gate:6,name:10,dataChange:70,dataChangeCount:15};u.buttonPanelWidth=20;u.state=t;i.SetPanelDimensions();n.$on("dataService.cache.ready",function(){f()});r.cache.ready&&f();u.scrolledToEnd=function(){console.log("scrolled to end")}}angular.module("app").controller("ChangingAssetsCtrl",["$scope","$state","displaySetupService","dataService","signalR","$interval","$timeout",n])}(),function(){function n(n,t,i,r,u,f,e,o,s,h,c,l,a,v){var y=this;y.state=t;y.bootstrapLabelColumns=4;y.bootstrapInputColumns=8;y.showScreen=!1;h.activeClass="radio-active";e.CompanyId<0&&(e.CompanyId=0);f.GetJBTData().then(function(n){y.sites=n.Sites.where(function(n){return n.Name.length<10})});e.CompanyId>0?f.GetIOPSResource("Companies").expandPredicate("SiteCompanies").expand("Site").finish().get(e.CompanyId).$promise.then(function(n){y.company=n;y.company.associatedSiteIds=[];y.company.SiteCompanies.forEach(function(n){y.company.associatedSiteIds[n.Site.Id]=!0});y.panelTitle="iOPS Company: "+y.company.Name+" - "+y.company.ShortName;y.panelSubtitle="Editing Existing Company";r.$$postDigest(function(){a.SetPanelDimensions(10);y.showScreen=!0;console.log("vm = %O",y)})}):(y.company={Id:0},y.panelTitle="New Company",y.panelSubtitle="Enter a new Company for iOPS",y.showScreen=!0);c.bindTo(r).add({combo:"ctrl+s",description:"Save and Close any form data input form",allowIn:["INPUT","SELECT","TEXTAREA"],callback:function(){event.preventDefault();y.Save()}}).add({combo:"esc",description:"Cancel and close any input form",allowIn:["INPUT","SELECT","TEXTAREA"],callback:function(){t.go("^")}});y.Save=function(){var i=[];console.log("Company to save = %O",y.company);y.company.associatedSiteIds.forEach(function(n,t){i.push({SiteId:t,Enabled:n})});f.GetEntityById("Companies",y.company.Id).then(function(r){r.Name=y.company.Name;r.ShortName=y.company.ShortName;r.Description=y.company.Description;r.Address=y.company.Address;r.$save().then(function(r){n.all(y.company.SiteCompanies.where(function(n){return!y.company.associatedSiteIds[n.SiteId]}).select(function(n){return f.GetIOPSResource("SiteCompanies").filter("CompanyId",y.company.Id).filter("SiteId",n.SiteId).query().$promise.then(function(n){var t=n.first();return t.Id=-t.Id,t.$save()})}),n.all(i.where(function(n){return n.Enabled&&!y.company.SiteCompanies.any(function(t){return t.SiteId==n.SiteId})}).select(function(n){return f.AddEntity("SiteCompanies",{Id:0,SiteId:n.SiteId,CompanyId:y.company.Id})}))).then(function(){v.SignalAllClientsInGroup("Admin","Company",r);t.go("^")})})})}}angular.module("app").controller("CompanyEditCtrl",["$q","$state","$rootScope","$scope","securityService","dataService","$stateParams","utilityService","$timeout","uibButtonConfig","hotkeys","$interval","displaySetupService","signalR",n])}(),function(){function n(n,t,i,r){function f(){u.gates=r.cache.gates}console.log("GatesCtrl conroller invoked.");var u=this;u.columnWidths={name:50,address:50};u.buttonPanelWidth=70;u.state=t;i.SetPanelDimensions();n.$on("dataService.cache.ready",function(){f()});(r.cache.ready||r.cache.gates.length>1)&&f();u.gates||r.GetGates().then(function(n){u.gates=n});u.scrolledToEnd=function(){console.log("scrolled to end")}}angular.module("app").controller("GatesCtrl",["$scope","$state","displaySetupService","dataService","signalR","$interval",n])}(),function(){function n(n,t,i,r){console.log("GraphicsCatalogCtrl conroller invoked.");var u=this;u.columnWidths={company:10,equipment:10,tagId:5,tagName:50,observationName:25,date:20,value:80,dataChangeCount:15};u.buttonPanelWidth=20;u.state=t;i.SetPanelDimensions();console.log("Load Data");r.GetIOPSResource("Sites").expandPredicate("SystemGroups").expand().finish();n.$$postDigest(function(){i.SetPanelDimensions()});u.searchText="";u.scrolledToEnd=function(){console.log("scrolled to end")}}angular.module("app").controller("GraphicsCatalogCtrl",["$scope","$state","displaySetupService","dataService","signalR","$interval","$timeout",n])}(),function(){function n(n,t,i,r,u){function e(){r.GetIOPSResource("People").expandPredicate("iOPSUsers").expandPredicate("SiteDataReaders").expand("Site").finish().finish().orderBy("FamilyName").query().$promise.then(function(n){console.log("People = %O",n);f.people=n})}console.log("PeopleCtrl conroller invoked.");var f=this;f.columnWidths={name:10,email:10,phone:30,title:25,company:25,associatedSites:20};f.buttonPanelWidth=170;f.state=t;i.SetPanelDimensions();e();f.delete=function(n){console.log("Person to Delete = %O",n);alertify.set({labels:{ok:"Yes, Delete the Person",cancel:"Cancel, I don't want to do this"},buttonFocus:"cancel"});alertify.confirm("Are you SURE you want to delete this person? ",function(t){t?(n.Id=-n.Id,n.$save().then(function(){n.Id=-n.Id;u.SignalAllClients("Person.Deleted",n)}),toastr.success(location.Name,"Person was deleted!")):toastr.info(location.Name,"Person was NOT deleted!")})};n.$on("Person",function(n,t){console.log("Event Person");r.GetIOPSResource("People").expandPredicate("iOPSUsers").expandPredicate("SiteDataReaders").expand("Site").finish().finish().get(t.Id).$promise.then(function(n){f.people=[n].concat(f.people).distinct(function(n,t){return n.Id==t.Id})})});f.scrolledToEnd=function(){console.log("scrolled to end")}}angular.module("app").controller("PeopleCtrl",["$scope","$state","displaySetupService","dataService","signalR","$interval",n])}(),function(){function n(n,t,i,r,u,f,e,o,s,h,c,l,a,v){var y=this;y.state=t;y.bootstrapLabelColumns=4;y.bootstrapInputColumns=8;y.showScreen=!1;h.activeClass="radio-active";e.CompanyId<0&&(e.CompanyId=0);n.all([f.GetStateAbbreviations().then(function(n){y.unitedStates=n}),e.PersonId>0?f.GetIOPSResource("People").get(e.PersonId).$promise.then(function(n){console.log("Person to edit = %O",n);y.person=n}):n.when(!0)]).then(function(){y.person?(y.panelTitle="iOPS Person: ",y.panelSubtitle="Editing Existing Person"):(y.person={Id:0},y.panelTitle="iOPS Person: ",y.panelSubtitle="Adding New Person");r.$$postDigest(function(){a.SetPanelDimensions(10);y.showScreen=!0;console.log("vm = %O",y)})});c.bindTo(r).add({combo:"ctrl+s",description:"Save and Close any form data input form",allowIn:["INPUT","SELECT","TEXTAREA"],callback:function(){event.preventDefault();y.Save()}}).add({combo:"esc",description:"Cancel and close any input form",allowIn:["INPUT","SELECT","TEXTAREA"],callback:function(){t.go("^")}});y.Save=function(){f.GetEntityById("People",y.person.Id).then(function(n){n.FamilyName=y.person.FamilyName;n.GivenName=y.person.GivenName;n.MiddleName=y.person.MiddleName;n.StreetAddress1=y.person.StreetAddress1;n.StreetAddress2=y.person.StreetAddress2;n.CountryId=y.person.CountryId;n.Phone=y.person.Phone;n.Email=y.person.Email;n.Title=y.person.Title;n.City=y.person.City;n.State=y.person.State;n.ZipCode=y.person.ZipCode;n.$save().then(function(n){v.SignalAllClientsInGroup("Admin","Person",n);t.go("^")})})}}angular.module("app").controller("PersonEditCtrl",["$q","$state","$rootScope","$scope","securityService","dataService","$stateParams","utilityService","$timeout","uibButtonConfig","hotkeys","$interval","displaySetupService","signalR",n])}(),function(){function n(n,t,i,r,u){function e(n){n.forEach(function(n){n.sitesList=n.SiteCompanies.select(function(n){return n.Site.Name}).join(", ")})}function o(){r.GetIOPSResource("Companies").expandPredicate("SiteCompanies").expand("Site").finish().query().$promise.then(function(n){e(n);console.log("Companies = %O",n);f.companies=n;r.GetJBTData().then(function(n){f.sites=n.Sites.where(function(n){return n.Name.length<10}).orderBy(function(n){return n.Name});f.JBTData=n})})}console.log("SitesCtrl conroller invoked.");var f=this;f.columnWidths={name:10,shortName:10,description:30,sitesList:25,address:25};f.buttonPanelWidth=170;f.state=t;i.SetPanelDimensions();o();f.delete=function(n){var t,i;if(console.log("Company to Delete = %O",n),f.JBTData.Assets.any(function(t){return t.CompanyId==n.Id})||f.JBTData.Systems.any(function(t){return t.CompanyId==n.Id})||n.SiteCompanies.length>0){t="Company cannot be deleted! ";f.JBTData.Assets.any(function(t){return t.CompanyId==n.Id})&&(t+="It still has Assets associated with it!");f.JBTData.Systems.any(function(t){return t.CompanyId==n.Id})&&(t+="It still has Systems associated with it!");n.SiteCompanies.length>0&&(t+="It still has Companies associated with it!");alertify.alert(t,function(){toastr.success(location.Name,"Company was NOT deleted!");return});return}alertify.set({labels:{ok:"Yes, Delete the Company",cancel:"Cancel, I don't want to do this"},buttonFocus:"cancel"});i="Are you SURE you want to delete this company? ";alertify.confirm(i,function(t){t?(n.Id=-n.Id,n.$save().then(function(){n.Id=-n.Id;u.SignalAllClients("Company.Deleted",n)}),toastr.success(location.Name,"Company was deleted!")):toastr.info(location.Name,"Company was NOT deleted!")})};n.$on("Company",function(n,t){console.log("Event Company");r.GetIOPSResource("Companies").expandPredicate("SiteCompanies").expand("Site").finish().get(t.Id).$promise.then(function(n){n.sitesList=n.SiteCompanies.select(function(n){return n.Site.Name}).join(", ");f.companies=[n].concat(f.companies).distinct(function(n,t){return n.Id==t.Id})})});f.scrolledToEnd=function(){console.log("scrolled to end")}}angular.module("app").controller("SitesCtrl",["$scope","$state","displaySetupService","dataService","signalR","$interval",n])}(),function(){function n(n,t,i,r,u,f){function o(){console.log("Load Data");e.updateInterval=f(function(){s()},250);n.$on("$destroy",function(){f.cancel(e.updateInterval)});s();n.$$postDigest(function(){i.SetPanelDimensions()})}function s(){r.GetTags().then(function(n){e.totalChangeCount=0;e.tags=n.where(function(n){return e.searchText==""||n.Name.toUpperCase().indexOf(e.searchText.toUpperCase())>-1}).orderBy(function(n){return n.Name})})}console.log("TagsCtrl conroller invoked.");var e=this;e.columnWidths={company:10,equipment:10,tagId:5,tagName:50,observationName:25,date:20,value:80,dataChangeCount:15};n.$on("dataService.ready",function(){o()});r.IsReady&&o();e.buttonPanelWidth=20;e.state=t;i.SetPanelDimensions();e.tags=[];e.searchText="";e.scrolledToEnd=function(){console.log("scrolled to end")}}angular.module("app").controller("TagsCtrl",["$scope","$state","displaySetupService","dataService","signalR","$interval","$timeout",n])}(),function(){function n(n,t,i,r,u,f,e,o,s,h,c,l,a,v){function p(){return n.all([y.user.SiteDataReaders?n.all(y.user.SiteDataReaders.where(function(n){return!y.user.enabledSiteIds[n.SiteId]}).select(function(n){return f.GetIOPSResource("SiteDataReaders").filter("iOPSUserId",y.user.Id).filter("SiteId",n.SiteId).query().$promise.then(function(n){var t=n.first();return t.Id=-t.Id,t.$save()})})):n.when(!0),n.all(y.enabledSiteIdObjects.where(function(n){return n.Enabled&&!y.user.SiteDataReaders.any(function(t){return t.SiteId==n.SiteId})}).select(function(n){return f.AddEntity("SiteDataReaders",{Id:0,SiteId:n.SiteId,iOPSUserId:y.user.Id})})),n.all(y.user.UserAuthorizedActivities?y.user.UserAuthorizedActivities.where(function(n){return!y.user.authorizedActivityIds[n.AuthorizableActivityId]}).select(function(n){return f.GetIOPSResource("UserAuthorizedActivities").filter("iOPSUserId",y.user.Id).filter("AuthorizableActivityId",n.AuthorizableActivityId).query().$promise.then(function(n){var t=n.first();return t.Id=-t.Id,t.$save()})}):n.when(!0)),n.all(y.authorizedActivityIdObjects.where(function(n){return n.Enabled&&y.user.UserAuthorizedActivities&&!y.user.UserAuthorizedActivities.any(function(t){return t.AuthorizableActivityId==n.AuthorizableActivityId})}).select(function(n){return f.AddEntity("UserAuthorizedActivities",{Id:0,AuthorizableActivityId:n.AuthorizableActivityId,iOPSUserId:y.user.Id})}))]).then(function(){v.SignalAllClientsInGroup("Admin","iOPSUser",y.odataUser);t.go("^")})}var y=this;y.state=t;y.bootstrapLabelColumns=4;y.bootstrapInputColumns=8;y.showScreen=!1;h.activeClass="radio-active";e.UserId<0&&(e.UserId=0);n.all([e.UserId>0?f.GetIOPSResource("iOPSUsers").expand("Person").expandPredicate("UserAuthorizedActivities").expand("AuthorizableActivity").finish().expandPredicate("SiteDataReaders").expand("Site").finish().get(e.UserId).$promise.then(function(n){y.user=n;console.log("vm.user = %O",y.user)}):n.when(function(){y.user={Id:0,Person:{}}}),f.GetStateAbbreviations().then(function(n){y.unitedStates=n}),f.GetJBTData().then(function(n){y.JBTData=n;y.sites=n.Sites.where(function(n){return n.Name.length<10})}),f.GetAuthorizableActivities().then(function(n){y.authorizableActivities=n})]).then(function(){e.UserId>0?(y.panelTitle="Username: "+y.user.Username+" - "+y.user.Person.GivenName+" "+y.user.Person.FamilyName,y.panelSubtitle="Editing Existing User",y.user.Person.StateId=y.user.Person.State?y.unitedStates.first(function(n){return n.Abbreviation==y.user.Person.State}).Id:1,y.user.authorizedActivityIds=[],y.user.UserAuthorizedActivities.forEach(function(n){y.user.authorizedActivityIds[n.AuthorizableActivity.Id]=!0}),y.user.enabledSiteIds=[],y.user.SiteDataReaders.forEach(function(n){y.user.enabledSiteIds[n.Site.Id]=!0}),r.$$postDigest(function(){a.SetPanelDimensions(10);o.SetupSelectpickerDropdown(r,"vm.user.Person.StateId");y.showScreen=!0;console.log("vm = %O",y)}),r.$watch("vm.user.Person.Email",function(n){n.indexOf("@")>0&&console.log("New email detected")})):(y.user={Id:0,Person:{}},y.user.authorizedActivityIds=[],y.authorizableActivities.forEach(function(n){y.user.authorizedActivityIds[n.Id]=!1}),y.user.enabledSiteIds=[],y.sites.forEach(function(n){y.user.enabledSiteIds[n.Id]=!1}),y.panelTitle="New User",y.panelSubtitle="Enter a new User for iOPS",y.showScreen=!0,r.$$postDigest(function(){a.SetPanelDimensions(10);o.SetupSelectpickerDropdown(r,"vm.user.Person.StateId");y.showScreen=!0;console.log("vm = %O",y)}),r.$watch("vm.user.Person.Email",function(n){n&&n.indexOf("@")>0&&(console.log("New email detected"),f.GetIOPSCollection("People","Email",y.user.Person.Email).then(function(n){var t=n.first();t&&(t.StateId=t.State?y.unitedStates.first(function(n){return n.Abbreviation==t.State}).Id:1,y.user.Person=t,o.SetupSelectpickerDropdown(r,"vm.user.Person.StateId"))}))}))});c.bindTo(r).add({combo:"ctrl+s",description:"Save and Close any form data input form",allowIn:["INPUT","SELECT","TEXTAREA"],callback:function(){event.preventDefault();y.Save()}}).add({combo:"esc",description:"Cancel and close any input form",allowIn:["INPUT","SELECT","TEXTAREA"],callback:function(){t.go("^")}});y.Save=function(){(!y.user.Person.Email||!y.user.Person.Email>"")&&alertify.alert("User MUST have an email address",function(){return});y.enabledSiteIdObjects=[];y.user.enabledSiteIds||(y.user.enabledSiteIds=[]);y.user.enabledSiteIds.forEach(function(n,t){y.enabledSiteIdObjects.push({SiteId:t,Enabled:n})});y.authorizedActivityIdObjects=[];y.user.authorizedActivityIds.forEach(function(n,t){y.authorizedActivityIdObjects.push({AuthorizableActivityId:t,Enabled:n})});console.log("enabledSiteIdObjects = %O",y.enabledSiteIdObjects);f.GetIOPSCollection("People","Email",y.user.Person.Email).then(function(n){var t=n.first();return t?(t.GivenName=y.user.Person.GivenName,t.MiddleName=y.user.Person.MiddleName,t.FamilyName=y.user.Person.FamilyName,t.StreetAddress1=y.user.Person.StreetAddress1,t.StreetAddress2=y.user.Person.StreetAddress2,t.Phone=y.user.Person.Phone,t.Email=y.user.Person.Email,t.Title=y.user.Person.Title,t.City=y.user.Person.City,t.State=y.user.Person.State,t.ZipCode=y.user.Person.ZipCode,t.$save()):f.AddEntity("People",{GivenName:y.user.Person.GivenName,MiddleName:y.user.Person.MiddleName,FamilyName:y.user.Person.FamilyName,StreetAddress1:y.user.Person.StreetAddress1,StreetAddress2:y.user.Person.StreetAddress2,Phone:y.user.Person.Phone,Email:y.user.Person.Email,Title:y.user.Person.Title,City:y.user.Person.City,State:y.user.Person.State,ZipCode:y.user.Person.ZipCode})}).then(function(n){y.odataPerson=n;console.log("Person who was saved = %O",n);(y.user.Id>0?f.GetEntityById("iOPSUsers",y.user.Id).then(function(n){return n.Username=y.user.Username,n.Active=!0,n.$save()}):f.AddEntity("iOPSUsers",{Id:0,Username:y.user.Username,PersonId:y.odataPerson.Id,Active:!0})).then(function(n){y.odataUser=n;y.user.Id=y.odataUser.Id;y.odataUser.Username=y.user.Username;p()})})}}angular.module("app").controller("UserEditCtrl",["$q","$state","$rootScope","$scope","securityService","dataService","$stateParams","utilityService","$timeout","uibButtonConfig","hotkeys","$interval","displaySetupService","signalR",n])}(),function(){function n(n,t,i,r,u,f,e,o,s,h,c,l,a,v){function p(){return n.all([y.user.SiteDataReaders?n.all(y.user.SiteDataReaders.where(function(n){return!y.user.enabledSiteIds[n.SiteId]}).select(function(n){return f.GetIOPSResource("SiteDataReaders").filter("iOPSUserId",y.user.Id).filter("SiteId",n.SiteId).query().$promise.then(function(n){var t=n.first();return t.Id=-t.Id,t.$save()})})):n.when(!0),n.all(y.enabledSiteIdObjects.where(function(n){return n.Enabled&&!y.user.SiteDataReaders.any(function(t){return t.SiteId==n.SiteId})}).select(function(n){return f.AddEntity("SiteDataReaders",{Id:0,SiteId:n.SiteId,iOPSUserId:y.user.Id})})),n.all(y.user.UserAuthorizedActivities?y.user.UserAuthorizedActivities.where(function(n){return!y.user.authorizedActivityIds[n.AuthorizableActivityId]}).select(function(n){return f.GetIOPSResource("UserAuthorizedActivities").filter("iOPSUserId",y.user.Id).filter("AuthorizableActivityId",n.AuthorizableActivityId).query().$promise.then(function(n){var t=n.first();return t.Id=-t.Id,t.$save()})}):n.when(!0)),n.all(y.authorizedActivityIdObjects.where(function(n){return n.Enabled&&y.user.UserAuthorizedActivities&&!y.user.UserAuthorizedActivities.any(function(t){return t.AuthorizableActivityId==n.AuthorizableActivityId})}).select(function(n){return f.AddEntity("UserAuthorizedActivities",{Id:0,AuthorizableActivityId:n.AuthorizableActivityId,iOPSUserId:y.user.Id})}))]).then(function(){v.SignalAllClientsInGroup("Admin","iOPSUser",y.odataUser);t.go("^")})}var y=this;y.state=t;y.bootstrapLabelColumns=4;y.bootstrapInputColumns=8;y.showScreen=!1;h.activeClass="radio-active";e.UserId<0&&(e.UserId=0);n.all([e.UserId>0?f.GetIOPSResource("iOPSUsers").expand("Person").expandPredicate("UserAuthorizedActivities").expand("AuthorizableActivity").finish().expandPredicate("SiteDataReaders").expand("Site").finish().get(e.UserId).$promise.then(function(n){y.user=n;console.log("vm.user = %O",y.user)}):n.when(function(){y.user={Id:0,Person:{}}}),f.GetStateAbbreviations().then(function(n){y.unitedStates=n}),f.GetJBTData().then(function(n){y.JBTData=n;y.sites=n.Sites.where(function(n){return n.Name.length<10})}),f.GetAuthorizableActivities().then(function(n){y.authorizableActivities=n})]).then(function(){e.UserId>0?(y.panelTitle="Username: "+y.user.Username+" - "+y.user.Person.GivenName+" "+y.user.Person.FamilyName,y.panelSubtitle="Editing Existing User",y.user.Person.StateId=y.user.Person.State?y.unitedStates.first(function(n){return n.Abbreviation==y.user.Person.State}).Id:1,y.user.authorizedActivityIds=[],y.user.UserAuthorizedActivities.forEach(function(n){y.user.authorizedActivityIds[n.AuthorizableActivity.Id]=!0}),y.user.enabledSiteIds=[],y.user.SiteDataReaders.forEach(function(n){y.user.enabledSiteIds[n.Site.Id]=!0}),r.$$postDigest(function(){a.SetPanelDimensions(10);o.SetupSelectpickerDropdown(r,"vm.user.Person.StateId");y.showScreen=!0;console.log("vm = %O",y)}),r.$watch("vm.user.Person.Email",function(n){n.indexOf("@")>0&&console.log("New email detected")})):(y.user={Id:0,Person:{}},y.user.authorizedActivityIds=[],y.authorizableActivities.forEach(function(n){y.user.authorizedActivityIds[n.Id]=!1}),y.user.enabledSiteIds=[],y.sites.forEach(function(n){y.user.enabledSiteIds[n.Id]=!1}),y.panelTitle="New User",y.panelSubtitle="Enter a new User for iOPS",y.showScreen=!0,r.$$postDigest(function(){a.SetPanelDimensions(10);o.SetupSelectpickerDropdown(r,"vm.user.Person.StateId");y.showScreen=!0;console.log("vm = %O",y)}),r.$watch("vm.user.Person.Email",function(n){n&&n.indexOf("@")>0&&(console.log("New email detected"),f.GetIOPSCollection("People","Email",y.user.Person.Email).then(function(n){var t=n.first();t&&(t.StateId=t.State?y.unitedStates.first(function(n){return n.Abbreviation==t.State}).Id:1,y.user.Person=t,o.SetupSelectpickerDropdown(r,"vm.user.Person.StateId"))}))}))});c.bindTo(r).add({combo:"ctrl+s",description:"Save and Close any form data input form",allowIn:["INPUT","SELECT","TEXTAREA"],callback:function(){event.preventDefault();y.Save()}}).add({combo:"esc",description:"Cancel and close any input form",allowIn:["INPUT","SELECT","TEXTAREA"],callback:function(){t.go("^")}});y.Save=function(){(!y.user.Person.Email||!y.user.Person.Email>"")&&alertify.alert("User MUST have an email address",function(){return});y.enabledSiteIdObjects=[];y.user.enabledSiteIds||(y.user.enabledSiteIds=[]);y.user.enabledSiteIds.forEach(function(n,t){y.enabledSiteIdObjects.push({SiteId:t,Enabled:n})});y.authorizedActivityIdObjects=[];y.user.authorizedActivityIds.forEach(function(n,t){y.authorizedActivityIdObjects.push({AuthorizableActivityId:t,Enabled:n})});console.log("enabledSiteIdObjects = %O",y.enabledSiteIdObjects);f.GetIOPSCollection("People","Email",y.user.Person.Email).then(function(n){var t=n.first();return t?(t.GivenName=y.user.Person.GivenName,t.MiddleName=y.user.Person.MiddleName,t.FamilyName=y.user.Person.FamilyName,t.StreetAddress1=y.user.Person.StreetAddress1,t.StreetAddress2=y.user.Person.StreetAddress2,t.Phone=y.user.Person.Phone,t.Email=y.user.Person.Email,t.Title=y.user.Person.Title,t.City=y.user.Person.City,t.State=y.user.Person.State,t.ZipCode=y.user.Person.ZipCode,t.$save()):f.AddEntity("People",{GivenName:y.user.Person.GivenName,MiddleName:y.user.Person.MiddleName,FamilyName:y.user.Person.FamilyName,StreetAddress1:y.user.Person.StreetAddress1,StreetAddress2:y.user.Person.StreetAddress2,Phone:y.user.Person.Phone,Email:y.user.Person.Email,Title:y.user.Person.Title,City:y.user.Person.City,State:y.user.Person.State,ZipCode:y.user.Person.ZipCode})}).then(function(n){y.odataPerson=n;console.log("Person who was saved = %O",n);(y.user.Id>0?f.GetEntityById("iOPSUsers",y.user.Id).then(function(n){return n.Username=y.user.Username,n.Active=!0,n.$save()}):f.AddEntity("iOPSUsers",{Id:0,Username:y.user.Username,PersonId:y.odataPerson.Id,Active:!0})).then(function(n){y.odataUser=n;y.user.Id=y.odataUser.Id;y.odataUser.Username=y.user.Username;p()})})}}angular.module("app").controller("UserEditCtrl",["$q","$state","$rootScope","$scope","securityService","dataService","$stateParams","utilityService","$timeout","uibButtonConfig","hotkeys","$interval","displaySetupService","signalR",n])}(),function(){function n(n,t,i,r,u,f,e){function s(n){n.forEach(function(n){n.SitesList=n.SiteDataReaders.select(function(n){return n.Site.Name}).join(", ");n.PrivilegesList=n.UserAuthorizedActivities.select(function(n){return n.AuthorizableActivity.Description}).join(", ");n.accountStatus=[];n.Active?n.accountStatus.push("Active"):n.accountStatus.push("Disabled");n.PasswordChangeLoginToken&&n.accountStatus.push("Pending Password Set Via Email");n.connectedClients=u.connectedClients.where(function(t){return t.User.User.Username==n.Username})})}console.log("UsersCtrl conroller invoked.");var o=this;o.columnWidths={name:10,company:6,username:6,email:15,phone:10,privileges:20,accountStatus:15,loggedInStatus:15,sites:15};o.buttonPanelWidth=20;o.state=t;i.SetPanelDimensions();r.GetUsers().then(function(n){s(n);o.users=n;console.log("Users for listing = %O",n)});o.sendPasswordResetEmail=function(n){r.GetEntityById("iOPSUsers",n.Id).then(function(n){n.GeneratePasswordChangeLoginTokenOnSave=1;n.$save().then(function(n){console.log("iOPS User with password change token = %O",n);r.GetEntityById("People",n.PersonId).then(function(t){r.AddEntity("DatabaseMailQueues",{Subject:"iOPS Pro - Set Password",Recipients:t.Email,Body:["JBT Aerotech has been requested to forward you a password reset link. Please click on the link below to set a new password for your account on the iOPSPro asset monitoring system","",'<a href="https://www.iOPSPro.com?pwt='+n.PasswordChangeLoginToken+'">Reset my  JBT iOPS Pro password<\/a>'].join("<br>")})});u.SignalAllClientsInGroup("Admin","iOPSUser",n)})})};o.messageToUser=function(n){var t=prompt("Message to Send:");u.SignalSpecificClient(n.ClientId,"System.InformationalMessage",t)};o.ackAlert=function(n){var t=prompt("Message to Send:");u.SignalSpecificClient(n.ClientId,"System.AlertMessage",t)};o.deleteUser=function(n){alertify.set({labels:{ok:"Yes, Delete the User",cancel:"Cancel, I don't want to do this"},buttonFocus:"cancel"});alertify.confirm("Are you SURE you want to delete this User? All security settings will also be deleted! ",function(t){if(t)e.all([r.GetIOPSCollection("UserAuthorizedActivities","iOPSUserId",n.Id).then(function(n){return r.DeleteEntities(n)}),r.GetIOPSCollection("SiteDataReaders","iOPSUserId",n.Id).then(function(n){return r.DeleteEntities(n)})]).then(function(){r.GetEntityById("iOPSUsers",n.Id).then(function(n){n.Id=-n.Id;n.$save().then(function(){toastr.success(location.Name,"User was deleted!");n.Id=-n.Id;u.SignalAllClients("iOPSUser.Delete",n)})})});else toastr.info(location.Name,"User was NOT deleted!")})};o.scrolledToEnd=function(){};n.$on("iOPSUser",function(){console.log("Event iOPSUser");r.GetUsers().then(function(n){s(n);o.users=n})});n.$on("System.ClientConnectionEstablished",function(){console.log("Event System.ClientConnectionEstablished");r.GetUsers().then(function(n){s(n);o.users=n})});n.$on("System.SignalR.ClientDisconnected",function(){console.log("Event System.ClientDisconnected");r.GetUsers().then(function(n){s(n);o.users=n})});n.$on("iOPSUser.Delete",function(n,t){console.log("Event iOPSUser.Delete");o.users=o.users.where(function(n){return n.Id!=t.Id})})}angular.module("app").controller("UsersCtrl",["$scope","$state","displaySetupService","dataService","signalR","$interval","$q",n])}(),function(){function n(n,t,i,r,u,f,e,o,s,h,c,l,a,v){var y=this;y.state=n;y.bootstrapLabelColumns=4;y.bootstrapInputColumns=8;y.showScreen=!1;s.activeClass="radio-active";y.initialHeights=mx.range(3,31).toArray();y.initialWidths=mx.range(3,31).toArray();y.Path=f.Path;y.panelHeadingSubtitle="For widget that is related to "+f.Path.split(".").join(" --> ")+"s";f.WidgetTypeId>0?(v.all([u.GetEntityById("WidgetTypes",f.WidgetTypeId).then(function(n){y.widgetType=n}),u.GetIOPSCollection("WidgetTypeTabGroups").then(function(n){y.widgetTypeTabGroups=n})]).then(function(){y.originalWidgetType=angular.copy(y.widgetType);y.panelTitle=""+y.widgetType.CategoryPath+" - "+y.widgetType.Name;y.isAvailableToAdmin=y.widgetType.IsAvailableToAdmin?1:0;y.isAvailableToAll=y.widgetType.IsAvailableToAll?1:0;y.hasSettings=y.widgetType.HasSettings?1:0;y.showScreen=!0;console.log("widgetTypeEdit Controller = %O",y);console.log("vm.widgetType = %O",y.widgetType)}),u.GetEntityById("WidgetTypes",f.WidgetTypeId).then(function(n){y.widgetType=n})):(y.widgetType={Id:0,CategoryPath:y.Path},u.GetIOPSCollection("WidgetTypeTabGroups").then(function(n){y.widgetTypeTabGroups=n}),y.panelTitle="New Widget Type",y.showScreen=!0,console.log("vm.widgetType = %O",y.widgetType));h.bindTo(i).add({combo:"ctrl+s",description:"Save and Close any form data input form",allowIn:["INPUT","SELECT","TEXTAREA"],callback:function(){event.preventDefault();y.Save()}}).add({combo:"esc",description:"Cancel and close any input form",allowIn:["INPUT","SELECT","TEXTAREA"],callback:function(){n.go("^")}});y.Save=function(){y.widgetType.IsAvailableToAdmin=y.isAvailableToAdmin==1?!0:!1;y.widgetType.IsAvailableToAll=y.isAvailableToAll==1?!0:!1;y.widgetType.IsHiddenSystemType=y.isHiddenSystemType==1?!0:!1;y.widgetType.HasSettings=y.hasSettings==1?!0:!1;(y.widgetType.Id>0?y.widgetType.$save():u.AddEntity("WidgetTypes",y.widgetType)).then(function(t){a.SignalAllClientsInGroup("Admin","WidgetType",t);n.go("^")})}}angular.module("app").controller("WidgetTypeEditCtrl",["$state","$rootScope","$scope","securityService","dataService","$stateParams","utilityService","$timeout","uibButtonConfig","hotkeys","$interval","displaySetupService","signalR","$q",n])}(),function(){function n(n,t,i,r,u,f,e,o){function h(){i.Path&&u.GetIOPSResource("WidgetTypes").filter("CategoryPath",i.Path).expand("WidgetTypeTabGroup").query().$promise.then(function(n){s.widgetTypes=n.orderBy(function(n){return n.DevelopmentPriority});s.showPanel=!0})}var s,c,l;console.log("WidgetTypesCtrl conroller invoked.");s=this;s.columnWidths={name:15,tabGroup:15,description:25,initialHeight:8,initialWidth:8,creationDate:25,angularDirectiveName:20,adminStatus:10,allStatus:10,hiddenStatus:10};s.buttonPanelWidth=20;s.panelTitle="iOPS System Widget Type Registration";i.Path&&(s.Path=i.Path,s.panelSubtitle="For widgets that are related to "+i.Path.split(".").join(" --> ")+"s");console.log("Path Parameter = "+i.Path);s.state=t;r.SetPanelDimensions();s.showPanel=!1;h();c=function(n,t){var r=t.children(),i=t.clone();return i.children().each(function(n){$(this).width(r.eq(n).width())}),i};l=function(){u.GetIOPSResource("WidgetTypes").expand("WidgetTypeTabGroups").then(function(n){s.dbWt=n;var t=0;$("#widgetTypesTable tbody tr").each(function(){var n=$(this).attr("itemid");t++;s.dbWt&&s.dbWt.forEach(function(i){i.Id==n&&i.Ordinal!=t&&(i.DevelopmentPriority=t,i.$save(),s.widgetTypes.forEach(function(i){i.Id==n&&(i.DevelopmentPriority=t)}))})})})};o(function(){$("#widgetTypesTable tbody").sortable({helper:c,stop:l}).disableSelection()},150);n.$on("WidgetType",function(){console.log("Event WidgetType");h()});s.scrolledToEnd=function(){console.log("scrolled to end")}}angular.module("app").controller("WidgetTypesCtrl",["$scope","$state","$stateParams","displaySetupService","dataService","signalR","$interval","$timeout",n])}(),function(){function n(n,t,i,r,u,f){function s(){console.log("Load Data");e.messagesPerSecond=r.Statistics.SignalR.MessagesPerSecond;n.$on("$destroy",function(){f.cancel(e.chartUpdateInterval);f.cancel(e.dataUpdateInterval)});e.dataUpdateInterval=f(function(){o()},100);e.chartUpdateInterval=f(function(){if(e.chartSeries){var n=(new Date).getTime(),t=r.Statistics.SignalR.MessagesPerSecond;e.chartSeries.addPoint([n,t],!0,!0)}o()},1e3);o();n.$$postDigest(function(){i.SetPanelDimensions()})}function o(){r.GetSites().then(function(n){n.select(function(n){n.Assets&&(n.Tags=n.Assets.selectMany(function(n){return n.Tags}))});e.sites=n.orderByDescending(function(n){return n.Tags.length})})}console.log("LiveObservationIndicatorTableCellsCtrl conroller invoked.");var e=this;e.dataService=r;n.$on("dataService.ready",function(){s()});r.IsReady()&&s();e.buttonPanelWidth=20;e.state=t;i.SetPanelDimensions();Highcharts.setOptions({global:{useUTC:!1}});e.chart=Highcharts.chart("container1",{chart:{type:"spline",animation:Highcharts.svg,marginRight:10,events:{load:function(){e.chartSeries=this.series[0]}}},title:{text:"Observations Per Second"},xAxis:{type:"datetime",tickPixelInterval:150},yAxis:{title:{text:"Value"},plotLines:[{value:0,width:1,color:"#808080"}]},tooltip:{formatter:function(){return"<b>"+this.series.name+"<\/b><br/>"+Highcharts.dateFormat("%Y-%m-%d %H:%M:%S",this.x)+"<br/>"+Highcharts.numberFormat(this.y,2)}},legend:{enabled:!1},exporting:{enabled:!1},series:[{name:"Observations Per Sec",data:function(){for(var t=[],i=(new Date).getTime(),n=-750;n<=0;n+=1)t.push({x:i+n*1e3,y:0});return t}()}]})}angular.module("app").controller("LiveObservationIndicatorTableCellsCtrl",["$scope","$state","displaySetupService","dataService","signalR","$interval","$timeout","utilityService",n])}(),function(){function n(n,t,i,r,u,f,e){function s(){console.log("Load Data");o.updateInterval=e(function(){h()},1e3);n.$on("$destroy",function(){e.cancel(o.updateInterval)});h();n.$$postDigest(function(){r.SetPanelDimensions()})}function h(){u.GetTags().then(function(n){o.totalChangeCount=0;var t;o.searchText&&(t=o.searchText.toUpperCase());o.tags=n.where(function(n){return o.searchText==""||!o.searchText?!0:n.TagName.toUpperCase().indexOf(t)>=0||n.Asset.ParentSystem.Name.toUpperCase().indexOf(t)>=0||n.JBTStandardObservation.Name.toUpperCase().indexOf(t)>=0}).orderByDescending(function(n){return n.PLCUTCDateMS}).take(100)})}console.log("LiveTagDataMonitorCtrl conroller invoked.");var o=this;o.columnWidths={company:4,terminal:4,zone:4,gate:4,equipment:4,tagId:5,tagName:40,observationName:25,date:20,value:80,dataChangeCount:15};o.dataService=u;n.$on("dataService.ready",function(){s()});u.IsReady&&s();o.buttonPanelWidth=20;o.state=t;r.SetPanelDimensions();o.tags=[];o.scrolledToEnd=function(){}}angular.module("app").controller("LiveTagDataMonitorCtrl",["$scope","$state","$stateParams","displaySetupService","dataService","signalR","$interval","$timeout","utilityService",n])}();